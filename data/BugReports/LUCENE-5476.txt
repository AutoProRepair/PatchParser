<!doctype html>
<html lang="en">
 <head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=Edge"> 
  <meta name="application-name" content="JIRA" data-name="jira" data-version="7.6.3">
  <meta name="ajs-viewissue-use-history-api" content="false"> 
  <meta name="ajs-jira-base-url" content="https://issues.apache.org/jira"> 
  <meta name="ajs-serverRenderedViewIssue" content="true"> 
  <meta name="ajs-dev-mode" content="false"> 
  <meta name="ajs-context-path" content="/jira"> 
  <meta name="ajs-version-number" content="7.6.3"> 
  <meta name="ajs-build-number" content="76005"> 
  <meta name="ajs-is-beta" content="false"> 
  <meta name="ajs-is-rc" content="false"> 
  <meta name="ajs-is-snapshot" content="false"> 
  <meta name="ajs-is-milestone" content="false"> 
  <meta name="ajs-remote-user" content=""> 
  <meta name="ajs-remote-user-fullname" content=""> 
  <meta name="ajs-user-locale" content="en_UK"> 
  <meta name="ajs-user-locale-group-separator" content=","> 
  <meta name="ajs-app-title" content="ASF JIRA"> 
  <meta name="ajs-keyboard-shortcuts-enabled" content="true"> 
  <meta name="ajs-keyboard-accesskey-modifier" content="Ctrl+Alt"> 
  <meta name="ajs-enabled-dark-features" content="[&quot;com.atlassian.jira.agile.darkfeature.editable.detailsview&quot;,&quot;nps.survey.inline.dialog&quot;,&quot;com.atlassian.jira.agile.darkfeature.edit.closed.sprint.enabled&quot;,&quot;jira.plugin.devstatus.phasetwo&quot;,&quot;jira.frother.reporter.field&quot;,&quot;atlassian.rest.xsrf.legacy.enabled&quot;,&quot;jira.issue.status.lozenge&quot;,&quot;com.atlassian.jira.config.BIG_PIPE&quot;,&quot;com.atlassian.jira.projects.issuenavigator&quot;,&quot;com.atlassian.jira.config.PDL&quot;,&quot;jira.plugin.devstatus.phasetwo.enabled&quot;,&quot;atlassian.aui.raphael.disabled&quot;,&quot;app-switcher.new&quot;,&quot;frother.assignee.field&quot;,&quot;com.atlassian.jira.projects.ProjectCentricNavigation.Switch&quot;,&quot;sd.internal.base.off.thread.on.completion.events.enabled&quot;,&quot;jira.onboarding.cyoa&quot;,&quot;com.atlassian.jira.agile.darkfeature.kanplan.enabled&quot;,&quot;sd.slavalue.record.updated.date.enabled&quot;,&quot;com.atlassian.jira.config.ProjectConfig.MENU&quot;,&quot;com.atlassian.jira.projects.sidebar.DEFER_RESOURCES&quot;,&quot;com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions.enabled&quot;,&quot;com.atlassian.jira.agile.darkfeature.sprint.goal.enabled&quot;,&quot;jira.zdu.admin-updates-ui&quot;,&quot;jira.zdu.jmx-monitoring&quot;,&quot;sd.sla.improved.rendering.enabled&quot;,&quot;sd.canned.responses.enabled&quot;,&quot;sd.new.settings.sidebar.location.disabled&quot;,&quot;jira.zdu.cluster-upgrade-state&quot;,&quot;com.atlassian.jira.agile.darkfeature.splitissue&quot;,&quot;com.atlassian.jira.config.CoreFeatures.LICENSE_ROLES_ENABLED&quot;,&quot;com.atlassian.feedback.feedback-button-move-to-header-enable&quot;,&quot;jira.export.csv.enabled&quot;]"> 
  <meta name="ajs-in-admin-mode" content="false"> 
  <meta name="ajs-is-sysadmin" content="false"> 
  <meta name="ajs-is-admin" content="false"> 
  <meta name="ajs-outgoing-mail-enabled" content="true"> 
  <meta name="ajs-date-relativize" content="true"> 
  <meta name="ajs-date-time" content="HH:mm"> 
  <meta name="ajs-date-day" content="EEEE HH:mm"> 
  <meta name="ajs-date-dmy" content="dd/MMM/yy"> 
  <meta name="ajs-date-complete" content="dd/MMM/yy HH:mm"> 
  <script type="text/javascript">var AJS=AJS||{};AJS.debug=true;</script> 
  <meta id="atlassian-token" name="atlassian-token" content="A5KQ-2QAV-T4JA-FDED|faf9418c89dc583dcbca41b77f98131b1635094c|lout"> 
  <link rel="shortcut icon" href="/jira/s/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/_/favicon.ico"> 
  <!--[if IE]><![endif]--> 
  <script type="text/javascript">
    (function() {
        var contextPath = '/jira';
        var eventBuffer = [];

        function printDeprecatedMsg() {
            if (console && console.warn) {
                console.warn('DEPRECATED JS - contextPath global variable has been deprecated since 7.4.0. Use `wrm/context-path` module instead.');
            }
        }

        function sendEvent(analytics, postfix) {
            analytics.send({
                name: 'js.globals.contextPath.' + postfix
            });
        }

        function sendDeprecatedEvent(postfix) {
            try {
                var analytics = require('jira/analytics');
                if (eventBuffer.length) {
                    eventBuffer.forEach(function(value) {
                        sendEvent(analytics, value);
                    });
                    eventBuffer = [];
                }

                if (postfix) {
                    sendEvent(analytics, postfix);
                }
            } catch(ex) {
                eventBuffer.push(postfix);
                setTimeout(sendDeprecatedEvent, 1000);
            }
        }

        Object.defineProperty(window, 'contextPath', {
            get: function() {
                printDeprecatedMsg();
                sendDeprecatedEvent('get');
                return contextPath;
            },
            set: function(value) {
                printDeprecatedMsg();
                sendDeprecatedEvent('set');
                contextPath = value;
            }
        });
    })();

</script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"/jira\"";
WRM._unparsedData["jira.webresources:feature-flags.feature-flag-data"]="{\"enabled-feature-keys\":[\"com.atlassian.jira.agile.darkfeature.editable.detailsview\",\"nps.survey.inline.dialog\",\"com.atlassian.jira.agile.darkfeature.edit.closed.sprint.enabled\",\"jira.plugin.devstatus.phasetwo\",\"jira.frother.reporter.field\",\"atlassian.rest.xsrf.legacy.enabled\",\"jira.issue.status.lozenge\",\"com.atlassian.jira.config.BIG_PIPE\",\"com.atlassian.jira.projects.issuenavigator\",\"com.atlassian.jira.config.PDL\",\"jira.plugin.devstatus.phasetwo.enabled\",\"atlassian.aui.raphael.disabled\",\"app-switcher.new\",\"frother.assignee.field\",\"com.atlassian.jira.projects.ProjectCentricNavigation.Switch\",\"sd.internal.base.off.thread.on.completion.events.enabled\",\"jira.onboarding.cyoa\",\"com.atlassian.jira.agile.darkfeature.kanplan.enabled\",\"sd.slavalue.record.updated.date.enabled\",\"com.atlassian.jira.config.ProjectConfig.MENU\",\"com.atlassian.jira.projects.sidebar.DEFER_RESOURCES\",\"com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions.enabled\",\"com.atlassian.jira.agile.darkfeature.sprint.goal.enabled\",\"jira.zdu.admin-updates-ui\",\"jira.zdu.jmx-monitoring\",\"sd.sla.improved.rendering.enabled\",\"sd.canned.responses.enabled\",\"sd.new.settings.sidebar.location.disabled\",\"jira.zdu.cluster-upgrade-state\",\"com.atlassian.jira.agile.darkfeature.splitissue\",\"com.atlassian.jira.config.CoreFeatures.LICENSE_ROLES_ENABLED\",\"com.atlassian.feedback.feedback-button-move-to-header-enable\",\"jira.export.csv.enabled\"],\"feature-flag-states\":{\"sd.customer.profile.multi.languages\":true,\"sd.customer.portal.transitions\":true,\"sd.customer.portal.transitions.config\":true,\"sd.custom.email.stripping.rules\":false,\"sd.sla.lucene.issue.id.callback.performance\":true,\"sd.new.settings.sidebar.location\":true,\"sd.workload.report.paginator\":true,\"sd.experimental.portal.search.algorithm.default.1\":false,\"sd.customer.portal.help.center.agent.announcement\":true,\"sd.sla.improved.rendering\":false,\"sd.experimental.portal.search.algorithm.default.2\":false,\"sd.customer.feedback.validate.reporter.on.token\":true,\"sd.custom.email.notifications.utf8.csat.star\":true,\"sd.who.create.customers.by.email.setting\":true,\"com.atlassian.jira.issuetable.move.links.hidden\":true,\"jira.renderer.consider.variable.format\":true,\"sd.stats.event.tracking\":true,\"sd.password.helper.dialog\":true,\"sd.canned.responses\":false,\"sd.portal.help.center.customer.signup.secondary.email\":true,\"sd.custom.email.notifications.manage.language\":true,\"sd.use.search.by.permissions\":true,\"sd.slavalue.record.updated.date\":false,\"sd.report.custom.date.range\":false,\"sd.kb.article.helpfulness.report\":false,\"com.atlassian.jira.agile.darkfeature.sprint.goal\":false,\"sd.custom.email.notifications.styling\":true,\"sd.workinghours.new.page.bulldog.1\":false,\"sd.customer.portal.two.step.login\":false,\"sd.automation.psmq.async.executor\":true,\"sd.customer.org.list.page.lazy.search\":true,\"sd.approval.requested.when.handler\":true,\"sd.request.type.field.rest.api.filtering.bugfix\":true,\"sd.automation.then.action.auto.answer.approval\":true,\"com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions\":false,\"sla.will.only.be.paused.if.they.are.already.started\":true,\"sd.kb.comment.share.stats.collection\":true,\"com.atlassian.jira.upgrade.startup.fix.index\":true,\"sd.customer.orgs.group.participants\":true,\"sd.portal.help.center.customer.signup\":true,\"sd.sla.agent.jql.security.restricted\":true,\"sd.test.feature.flag.x\":true,\"sd.test.feature.flag.y\":false,\"sd.cluster.safe.mail.channel.shutdown\":true,\"sd.email.channel.folders\":false,\"sd.email.analytics.open\":false,\"sd.kb.project.creation.create.link.space\":true,\"sd.workinghours.new.page\":false,\"sd.confluence.anonymous.permission.fix\":true,\"com.atlassian.jira.issuetable.draggable\":true,\"sd.customer.portal.project.agent.announcement\":true,\"sd.automation.audit.log\":true,\"jira.jql.suggestrecentfields\":false,\"sd.canned.responses.check.index.startup\":false,\"sd.new.project.templates\":true,\"sd.custom.email.notifications.custom.rules.simple.ui\":false,\"sd.custom.email.notifications.cut.over\":true,\"sd.dismiss.all.misconfiguration.warnings.setting\":true,\"com.atlassian.jira.agile.darkfeature.optimistic.transitions\":true,\"sd.sla.configurations.export\":true,\"sd.canned.responses.variable.substitution\":true,\"com.atlassian.jira.agile.darkfeature.kanplan\":false,\"sd.internal.base.off.thread.on.completion.events\":false,\"sd.customer.portal.prioties.per.project.fix\":true,\"jira.instrumentation.laas\":false,\"sd.kb.self.service.report\":false,\"sla.improved.request.handling\":true,\"sd.no.schedule.async.upgrade.tasks\":true,\"sd.kb.primary.nav\":true,\"com.atlassian.jira.agile.darkfeature.edit.closed.sprint\":false,\"sd.kb.issueview.panel.phase2\":true,\"sd.email.outsider.comments\":true,\"jira.create.linked.issue\":true,\"sd.kb.issueview.panel\":true,\"jira.sal.host.connect.accessor.existing.transaction.will.create.transactions\":true,\"sd.approvals.light.weight\":false,\"sd.automation.then.webhook\":true,\"sd.respect.inline.edit.issue.off\":true,\"jira.jql.smartautoselectfirst\":false,\"sd.global.portal.search.atlassian.only.tracking\":false,\"sd.automation.if.condition.comment.primary.action\":true,\"jira.priorities.per.project\":true,\"sd.inline.noformat.renderer\":true,\"sd.customer.request.type.create.edit.screens\":true}}";
WRM._unparsedData["jira.webresources:default-comment-security-level.DefaultCommentSecurityLevelHelpLink"]="{\"extraClasses\":\"default-comment-level-help\",\"title\":\"Commenting on an Issue\",\"url\":\"https://docs.atlassian.com/jira/jcore-docs-076/Editing+and+collaborating+on+issues#Editingandcollaboratingonissues-restrictacomment\",\"isLocal\":false}";
WRM._unparsedData["jira.webresources:dateFormatProvider.allFormats"]="{\"dateFormats\":{\"meridiem\":[\"AM\",\"PM\"],\"eras\":[\"BC\",\"AD\"],\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"monthsShort\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"weekdaysShort\":[\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\",\"Sat\"],\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]},\"lookAndFeelFormats\":{\"relativize\":\"true\",\"time\":\"HH:mm\",\"day\":\"EEEE HH:mm\",\"dmy\":\"dd/MMM/yy\",\"complete\":\"dd/MMM/yy HH:mm\"}}";
WRM._unparsedData["com.atlassian.jira.jira-issue-nav-components:issueviewer.features"]="{\"rteEnabled\":true}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-dnd-attachment-plugin:dnd-issue-drop-zone.thumbnail-mime-types"]="\"image/png,image/vnd.wap.wbmp,image/x-png,image/jpeg,image/bmp,image/gif\"";
WRM._unparsedData["com.atlassian.jira.plugins.jira-dnd-attachment-plugin:dnd-issue-drop-zone.upload-limit"]="\"62914560\"";
WRM._unparsedData["com.atlassian.plugins.helptips.jira-help-tips:help-tip-manager.JiraHelpTipData"]="{\"anonymous\":true}";
WRM._unparsedData["com.atlassian.jira.jira-view-issue-plugin:controller-subtasks.controller.subtasks.parameters"]="{\"url\":\"/rest/api/2/issue/{issueId}/subtask/move\"}";
WRM._unparsedData["com.atlassian.analytics.analytics-client:policy-update-init.policy-update-data-provider"]="false";
WRM._unparsedData["com.atlassian.analytics.analytics-client:programmatic-analytics-init.programmatic-analytics-data-provider"]="false";
WRM._unparsedData["com.atlassian.servicedesk.servicedesk-canned-responses-plugin:canned-responses-data-provider.data"]="{\"substitutionVariables\":{\"issue.summary\":\"Issue summary\",\"issue.description\":\"Issue description\",\"issue.key\":\"Issue key\",\"issue.reporter.name\":\"Issue reporter\",\"issue.resolution\":\"Issue resolution\",\"request.url\":\"Request URL\",\"request.status\":\"Request status\"}}";
WRM._unparsedData["jira.webresources:avatar-picker.data"]="{}";
WRM._unparsedData["com.atlassian.feedback.jira-feedback-plugin:button-resources-init.data"]="{\"jira.feedback.plugin.issue.collector.core\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"jira.feedback.plugin.issue.collector.default\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"jira.feedback.plugin.issue.collector.service.desk\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?locale=en-UK&collectorId=a698db21\",\"jira.feedback.plugin.issue.collector.software\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"isHeaderFeedbackButtonEnabled\":true}";
WRM._unparsedData["com.atlassian.jira.jira-header-plugin:dismissedFlags.flags"]="{\"dismissed\":[]}";
WRM._unparsedData["com.atlassian.jira.jira-header-plugin:newsletter-signup-tip-init.newsletterSignup"]="{\"signupDescription\":\"Get updates, inspiration and best practices from the team behind JIRA.\",\"formUrl\":\"https://www.atlassian.com/apis/exact-target/{0}/subscribe?mailingListId=1401671\",\"signupTitle\":\"Sign up!\",\"signupId\":\"newsletter-signup-tip\",\"showNewsletterTip\":false}";
WRM._unparsedData["com.atlassian.jira.project-templates-plugin:project-templates-plugin-resources.ptAnalyticsData"]="{\"instanceCreatedDate\":\"2011-01-31\"}";
WRM._unparsedData["com.atlassian.servicedesk.core-ui:util-help-links.help-links"]="{\"help\":{\"email.settings\":\"https://docs.atlassian.com/jira/jsd-docs-039/Receiving+requests+by+email\",\"managing.queues\":\"https://docs.atlassian.com/jira/jsd-docs-039/Setting+up+queues+for+your+team\",\"email.setup\":\"https://docs.atlassian.com/jira/jsd-docs-039/Receiving+requests+by+email\",\"request.settings.help.bubble\":\"https://docs.atlassian.com/jira/jsd-docs-039/Managing+access+to+your+service+desk\",\"email.settings.suitablerequest\":\"https://docs.atlassian.com/jira/jsd-docs-039/Receiving+requests+by+email#Receivingrequestsbyemail-suitablerequest\",\"sla.import.help\":\"https://docs.atlassian.com/jira/jsd-docs-039/Importing+SLAs\",\"documentation.home\":\"https://docs.atlassian.com/jira/jsd-docs-039/JIRA+Service+Desk+Documentation\",\"default\":\"https://docs.atlassian.com/jira/jsd-docs-039/\",\"create.space.help\":\"https://docs.atlassian.com/jira/jsd-docs-039/Serving+customers+with+a+knowledge+base#serving-customers-with-a-knowledge-base-createpermission\",\"email.settings.troubleshooting\":\"https://docs.atlassian.com/jira/jsd-docs-039/Troubleshooting+issues+with+the+email+channel\",\"admin.notifications.config\":\"https://docs.atlassian.com/jira/jsd-docs-039/Managing+service+desk+notifications\",\"troubleshoot.requesttype\":\"https://docs.atlassian.com/jira/jsd-docs-039/Troubleshooting+issues+with+request+types\",\"approvals.configuration\":\"https://docs.atlassian.com/jira/jsd-docs-039/Configuring+JIRA+Service+Desk+approvals\",\"setting.up.reports\":\"https://docs.atlassian.com/jira/jsd-docs-039/Setting+up+service+desk+reports\",\"public.signup\":\"https://docs.atlassian.com/jira/jsd-docs-039/Configuring+public+signup\",\"knowledge.base\":\"https://docs.atlassian.com/jira/jsd-docs-039/Serving+customers+with+a+knowledge+base\",\"resolve.permission.scheme.errors\":\"https://docs.atlassian.com/jira/jsd-docs-039/Resolving+permission+scheme+errors\",\"getting.started\":\"https://docs.atlassian.com/jira/jsd-docs-039/Getting+started+with+JIRA+Service+Desk\",\"getting.started.agent\":\"https://docs.atlassian.com/jira/jsd-docs-039/Getting+started+for+service+desk+agents\",\"invite.customers\":\"https://docs.atlassian.com/jira/jsd-docs-039/Managing+access+to+your+service+desk\"},\"kb\":{\"default\":\"https://confluence.atlassian.com/display/SDKB/\",\"troubleshooting.user.management.issues\":\"https://confluence.atlassian.com/display/SDKB/Troubleshooting+issues+with+service+desk+user+management\",\"legacytransition\":\"https://confluence.atlassian.com/display/SDKB/Replacing+legacy+automatic+transitions+with+automation+rules\",\"umtroubleshoot\":\"https://confluence.atlassian.com/display/SDKB/Troubleshooting+issues+with+service+desk+user+management\"}}";
WRM._unparsedData["com.atlassian.servicedesk.core-ui:util-base-url.base-url"]="\"https://issues.apache.org/jira\"";
WRM._unparsedData["com.atlassian.jira.plugins.jira-wiki-editor:wiki-editor-resources.help-data"]="{\"showHelp\":true,\"editorDocumentationUrl\":[\"https://docs.atlassian.com/jira/jcore-docs-076/Visual+editing\"],\"editorDocumentationTitle\":[\"Show me documentation for the visual editor\"]}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-wiki-editor:wiki-editor-resources.thumbnails-allowed"]="false";
WRM._unparsedData["jira.webresources:user-message-flags.adminLockout"]="{}";
WRM._unparsedData["jira.request.correlation-id"]="\"7f02a26e9e6f13\"";
WRM._unparsedData["project-id"]="12310110";
WRM._unparsedData["project-key"]="\"LUCENE\"";
WRM._unparsedData["project-name"]="\"Lucene - Core\"";
WRM._unparsedData["project-type"]="\"software\"";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:generic-filters"]="[{\"id\":\"allissues\",\"jql\":\"project = \\\"{0}\\\" ORDER BY {1}\",\"defaultOrderby\":\"created DESC\",\"label\":\"All issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[]},{\"id\":\"allopenissues\",\"jql\":\"project = \\\"{0}\\\" AND resolution = Unresolved ORDER BY {1}\",\"defaultOrderby\":\"priority DESC, updated DESC\",\"label\":\"Open issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"resolution\"]},{\"id\":\"doneissues\",\"jql\":\"project = \\\"{0}\\\" AND statusCategory = Done ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Done issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":false,\"fields\":[\"status\"]},{\"id\":\"recentlyviewed\",\"jql\":\"project = \\\"{0}\\\" AND issuekey in issueHistory() ORDER BY {1}\",\"defaultOrderby\":\"lastViewed DESC\",\"label\":\"Viewed recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"issuekey\"]},{\"id\":\"addedrecently\",\"jql\":\"project = \\\"{0}\\\" AND created \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"created DESC\",\"label\":\"Created recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"created\"]},{\"id\":\"resolvedrecently\",\"jql\":\"project = \\\"{0}\\\" AND resolutiondate \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Resolved recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":false,\"fields\":[\"resolutiondate\"]},{\"id\":\"updatedrecently\",\"jql\":\"project = \\\"{0}\\\" AND updated \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Updated recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"updated\"]}]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:default-filter-priority"]="[\"allopenissues\",\"allissues\"]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:can-manage-filters"]="false";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:project-filters"]="[]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:can-create-issues"]="false";
WRM._unparsedData["projectId"]="12310110";
WRM._unparsedData["projectKey"]="\"LUCENE\"";
WRM._unparsedData["projectType"]="\"software\"";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:server-rendered"]="true";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/a8a4711bc3f2eb261d8c8fd9fbcbba8b-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1fca1750044f2777c977e8d8cc023344/_/download/contextbatch/css/_super/batch.css" data-wrm-key="_super" data-wrm-batch-type="context" media="all"> 
  <link type="text/css" rel="stylesheet" href="/jira/s/1a6b21131945f6f49ff48336b49ca3fe-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/37a6e594cbbfd462a8a54d5aa11475c1/_/download/contextbatch/css/project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super/batch.css?agile_global_admin_condition=true&amp;hc-enabled=true&amp;is-server-instance=true&amp;jag=true&amp;jira.create.linked.issue=true&amp;nps-acknowledged=true&amp;richediton=true&amp;sd_operational=true" data-wrm-key="project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super" data-wrm-batch-type="context" media="all"> 
  <link type="text/css" rel="stylesheet" href="/jira/s/611672383f6cab00ab202241ba6f9d68-T/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/7.6.3/_/download/batch/com.atlassian.feedback.jira-feedback-plugin:button-resources-init/com.atlassian.feedback.jira-feedback-plugin:button-resources-init.css" data-wrm-key="com.atlassian.feedback.jira-feedback-plugin:button-resources-init" data-wrm-batch-type="resource" media="all"> 
  <script type="text/javascript" src="/jira/s/d8484c9183f546511a8e336a8779bcd9-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1fca1750044f2777c977e8d8cc023344/_/download/contextbatch/js/_super/batch.js?locale=en-UK" data-wrm-key="_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d3b35d835f8f46fc3b53bb4db7f85158-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/37a6e594cbbfd462a8a54d5aa11475c1/_/download/contextbatch/js/project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super/batch.js?agile_global_admin_condition=true&amp;hc-enabled=true&amp;is-server-instance=true&amp;jag=true&amp;jira.create.linked.issue=true&amp;locale=en-UK&amp;nps-acknowledged=true&amp;richediton=true&amp;sd_operational=true" data-wrm-key="project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/71d42e74136d842a3ef4d5d136484843-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/871d45c9f322a22cb3aa9b7948a69803/_/download/contextbatch/js/atl.global,-_super/batch.js?locale=en-UK" data-wrm-key="atl.global,-_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:calendar-en/jira.webresources:calendar-en.js" data-wrm-key="jira.webresources:calendar-en" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:calendar-localisation-moment/jira.webresources:calendar-localisation-moment.js" data-wrm-key="jira.webresources:calendar-localisation-moment" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/7.6.3/_/download/batch/com.atlassian.feedback.jira-feedback-plugin:button-resources/com.atlassian.feedback.jira-feedback-plugin:button-resources.js" data-wrm-key="com.atlassian.feedback.jira-feedback-plugin:button-resources" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/95a4826c265852f4904f1e0e7300df68-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/e0de73613a1027de08f3da6a45e1d1a2/_/download/contextbatch/css/jira.global.look-and-feel,-_super/batch.css" data-wrm-key="jira.global.look-and-feel,-_super" data-wrm-batch-type="context" media="all"> 
  <script type="text/javascript" src="/jira/rest/api/1.0/shortcuts/76005/944bb39eced1b35cfc7194aa02eb5a5a/shortcuts.js?context=issuenavigation&amp;context=issueaction"></script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.jira.jira-issue-nav-components:inline-edit-enabled"]="true";
WRM._unparsedData["should-display-chaperone"]="false";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/15712b600e9aecf72ffd9fd3704a0c78-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/6b22a15c7b83f87a47b1757076f43542/_/download/contextbatch/css/com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue/batch.css?jira.create.linked.issue=true&amp;richediton=true&amp;sd_operational=true" data-wrm-key="com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue" data-wrm-batch-type="context" media="all"> 
  <script type="text/javascript" src="/jira/s/5a8f0f8b8aa8f96a4f0f7e9e248d62f3-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/6b22a15c7b83f87a47b1757076f43542/_/download/contextbatch/js/com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue/batch.js?jira.create.linked.issue=true&amp;locale=en-UK&amp;richediton=true&amp;sd_operational=true" data-wrm-key="com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue" data-wrm-batch-type="context" data-initially-rendered></script> 
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
  <meta name="ajs-can-search-users" content="false"> 
  <meta name="ajs-can-edit-watchers" content="false"> 
  <meta name="ajs-default-avatar-url" content="https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10453"> 
  <meta name="ajs-issue-project-type" content="software"> 
  <meta name="ajs-issue-key" content="LUCENE-5476"> 
  <meta name="ajs-server-view-issue-is-editable" content="false"> 
  <title>[LUCENE-5476] Facet sampling - ASF JIRA</title> 
  <link rel="search" type="application/opensearchdescription+xml" href="/jira/osd.jsp" title="[LUCENE-5476] Facet sampling - ASF JIRA"> 
 </head> 
 <body id="jira" class="aui-layout aui-theme-default " data-version="7.6.3"> 
  <div id="page"> 
   <header id="header" role="banner"> 
    <script>
require(["jquery", "jira/license-banner"], function ($, licenseBanner) {
    $(function () {
        licenseBanner.showLicenseBanner("");
        licenseBanner.showLicenseFlag("");
    });
});
</script> 
    <nav class="aui-header aui-dropdown2-trigger-group" role="navigation">
     <div class="aui-header-inner">
      <div class="aui-header-before">
       <a class=" aui-dropdown2-trigger app-switcher-trigger" aria-controls="app-switcher" aria-haspopup="true" role="button" tabindex="0" data-aui-trigger href="#app-switcher"><span class="aui-icon aui-icon-small aui-iconfont-appswitcher">Linked Applications</span></a>
       <div id="app-switcher" class="aui-dropdown2 aui-style-default" role="menu" aria-hidden="true" data-is-switcher="true" data-environment="{&quot;isUserAdmin&quot;:false,&quot;isAppSuggestionAvailable&quot;:false,&quot;isSiteAdminUser&quot;:false}">
        <div role="application">
         <div class="app-switcher-loading">
          Loading…
         </div>
        </div>
       </div>
      </div>
      <div class="aui-header-primary">
       <h1 id="logo" class="aui-header-logo aui-header-logo-custom"><a href="https://issues.apache.org/jira/secure/MyJiraHome.jspa"><img src="/jira/s/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/_/jira-logo-scaled.png" alt="ASF JIRA"></a></h1>
       <ul class="aui-nav">
        <li><a href="/jira/secure/Dashboard.jspa" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="home_link" aria-haspopup="true" aria-controls="home_link-content" title="View and manage your dashboards" accesskey="d">Dashboards</a>
         <div class="aui-dropdown2 aui-style-default" id="home_link-content" data-aui-dropdown2-ajax-key="home_link"></div></li>
        <li><a href="/jira/browse/LUCENE" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="browse_link" aria-haspopup="true" aria-controls="browse_link-content" title="View recent projects and browse a list of projects" accesskey="p">Projects</a>
         <div class="aui-dropdown2 aui-style-default" id="browse_link-content" data-aui-dropdown2-ajax-key="browse_link"></div></li>
        <li><a href="/jira/issues/" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="find_link" aria-haspopup="true" aria-controls="find_link-content" title="Search for issues and view recent issues" accesskey="i">Issues</a>
         <div class="aui-dropdown2 aui-style-default" id="find_link-content" data-aui-dropdown2-ajax-key="find_link"></div></li> 
       </ul>
      </div>
      <div class="aui-header-secondary">
       <ul class="aui-nav">
        <li id="quicksearch-menu"> 
         <form action="/jira/secure/QuickSearch.jspa" method="get" id="quicksearch" class="aui-quicksearch dont-default-focus ajs-dirty-warning-exempt"> 
          <input id="quickSearchInput" class="search" type="text" title="Search" placeholder="Search" name="searchString" accessKey="q"> 
          <input type="submit" class="hidden" value="Search"> 
         </form> </li> 
        <li><a class="jira-feedback-plugin" role="button" aria-haspopup="true" id="jira-header-feedback-link" href="#"><span class="aui-icon aui-icon-small jira-feedback-plugin-icon">Give feedback to Atlassian</span></a></li> 
        <li id="system-help-menu"> <a class="aui-nav-link aui-dropdown2-trigger" id="help_menu" aria-haspopup="true" aria-owns="system-help-menu-content" href="https://docs.atlassian.com/jira/jcore-docs-076/" target="$textUtils.htmlEncode($rootHelpMenuItem.params.target)" title="Help"><span class="aui-icon aui-icon-small aui-iconfont-help">Help</span></a> 
         <div id="system-help-menu-content" class="aui-dropdown2 aui-style-default"> 
          <div class="aui-dropdown2-section"> 
           <ul id="jira-help" class="aui-list-truncate"> 
            <li> <a id="view_core_help" class="aui-nav-link " title="Go to the online documentation for JIRA Core" href="https://docs.atlassian.com/jira/jcore-docs-076/" target="_blank">JIRA Core help</a> </li> 
            <li> <a id="keyshortscuthelp" class="aui-nav-link " title="Get more information about JIRA's Keyboard Shortcuts" href="/jira/secure/ViewKeyboardShortcuts!default.jspa" target="_blank">Keyboard Shortcuts</a> </li> 
            <li> <a id="view_about" class="aui-nav-link " title="Get more information about JIRA" href="/jira/secure/AboutPage.jspa">About JIRA</a> </li> 
            <li> <a id="view_credits" class="aui-nav-link " title="See who did what" href="/jira/secure/JiraCreditsPage!default.jspa" target="_blank">JIRA Credits</a> </li> 
           </ul> 
          </div> 
         </div> </li> 
        <li id="user-options"> <a class="aui-nav-link login-link" href="/jira/login.jsp?os_destination=%2Fbrowse%2FLUCENE-5476">Log In</a> 
         <div id="user-options-content" class="aui-dropdown2 aui-style-default"> 
          <div class="aui-dropdown2-section"> 
          </div> 
         </div> </li> 
       </ul>
      </div>
     </div>
     <!-- .aui-header-inner-->
    </nav>
    <!-- .aui-header --> 
   </header> 
   <section id="content" role="main"> 
    <big-pipe data-id="sidebar-id" unresolved></big-pipe>
    <div class="aui-sidebar  sidebar-placeholder">
     <div class="aui-sidebar-wrapper">
      <div class="aui-sidebar-body"></div>
      <div class="aui-sidebar-footer">
       <a class="aui-button aui-button-subtle aui-sidebar-toggle aui-sidebar-footer-tipsy" data-tooltip="Expand sidebar ( [ )" href="#"><span class="aui-icon aui-icon-small"></span></a>
      </div>
     </div>
    </div>
    <script id="projects-sidebar-init">
    require(['jira/projects/sidebar/expansion-manager'], function(expansionManager) {
        var scriptTag = document.getElementById('projects-sidebar-init');
        var sidebar = AJS.sidebar('.aui-sidebar');
        expansionManager(sidebar);
        scriptTag.parentElement.removeChild(scriptTag);
    });
    </script>
    <div class="aui-page-panel">
     <div class="aui-page-panel-inner">
      <div class="issue-navigator">
       <div class="content">
        <div class="issue-view">
         <div class="navigation-tools">
          <div class="pager-container"></div>
         </div>
         <div class="issue-container">
          <div id="issue-content" class="issue-edit-form">
           <header id="stalker" class="issue-header js-stalker">
            <div class="issue-header-content">
             <header class="aui-page-header">
              <div class="aui-page-header-inner">
               <div class="aui-page-header-image">
                <span id="12310110" class="aui-avatar aui-avatar-large aui-avatar-project"><span class="aui-avatar-inner"><img id="project-avatar" alt="Uploaded image for project: 'Lucene - Core'" src="https://issues.apache.org/jira/secure/projectavatar?pid=12310110&amp;avatarId=10061"></span></span>
               </div>
               <!-- .aui-page-header-image -->
               <div class="aui-page-header-main">
                <ol class="aui-nav aui-nav-breadcrumbs">
                 <li><a id="project-name-val" href="/jira/browse/LUCENE">Lucene - Core</a></li>
                 <li><a class="issue-link" data-issue-key="LUCENE-5476" href="/jira/browse/LUCENE-5476" id="key-val" rel="12697648">LUCENE-5476</a></li>
                </ol>
                <h1 id="summary-val">Facet sampling</h1>
               </div>
               <!-- .aui-page-header-main -->
               <div class="aui-page-header-actions">
                <div id="issue-header-pager"></div>
               </div>
               <!-- .aui-page-header-actions -->
              </div>
              <!-- .aui-page-header-inner -->
             </header>
             <!-- .aui-page-header -->
             <div class="command-bar">
              <div class="ops-cont">
               <div class="ops-menus aui-toolbar">
                <div class="toolbar-split toolbar-split-left">
                 <ul id="opsbar-ops-login-lnk_container" class="toolbar-group pluggable-ops">
                  <li class="toolbar-item"><a id="ops-login-lnk" title="Log In" class="toolbar-trigger" href="/jira/login.jsp?os_destination=%2Fbrowse%2FLUCENE-5476"><span class="trigger-label">Log In</span></a></li>
                 </ul>
                 <ul id="opsbar-opsbar-operations" class="toolbar-group pluggable-ops"></ul>
                 <ul id="opsbar-opsbar-transitions" class="toolbar-group pluggable-ops"></ul>
                 <ul id="opsbar-opsbar-admin" class="toolbar-group pluggable-ops"></ul>
                </div>
                <div class="toolbar-split toolbar-split-right">
                 <ul id="opsbar-jira.issue.tools" class="toolbar-group pluggable-ops">
                  <li class="toolbar-item">
                   <div>
                    <a href="#" id="viewissue-export" aria-owns="viewissue-export_drop" aria-haspopup="true" title="Export this issue in another format" class="toolbar-trigger aui-button aui-style-default aui-dropdown2-trigger"><span class="icon icon-default aui-icon aui-icon-small aui-iconfont-export"></span> <span class="dropdown-text">Export</span></a>
                    <div id="viewissue-export_drop" class="aui-style-default aui-dropdown2">
                     <ul>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-xml/LUCENE-5476/LUCENE-5476.xml" id="jira.issueviews:issue-xml"><span class="trigger-label">XML</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-word/LUCENE-5476/LUCENE-5476.doc" id="jira.issueviews:issue-word"><span class="trigger-label">Word</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-html/LUCENE-5476/LUCENE-5476.html" id="jira.issueviews:issue-html"><span class="trigger-label">Printable</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/com.atlassian.jira.plugins.jira-importers-plugin:issue-json/LUCENE-5476/LUCENE-5476.json" id="com.atlassian.jira.plugins.jira-importers-plugin:issue-json"><span class="trigger-label">JSON</span></a></li>
                     </ul>
                    </div>
                   </div></li>
                 </ul>
                </div>
               </div>
              </div>
             </div>
            </div>
           </header>
           <div class="issue-body-content">
            <div class="aui-group issue-body">
             <div class="aui-item issue-main-column">
              <div id="details-module" class="module toggle-wrap">
               <div id="details-module_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Details</h2>
               </div>
               <div class="mod-content"> 
                <ul id="issuedetails" class="property-list two-cols"> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Type:</strong> 
                   <span id="type-val" class="value"> <img alt="" height="16" src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21140&amp;avatarType=issuetype" title="Improvement - An improvement or enhancement to an existing feature or task." width="16"> Improvement </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Status:</strong> 
                   <span id="status-val" class="value"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done jira-issue-status-lozenge-max-width-medium" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </span> 
                  </div> </li> 
                 <li class="item new"> 
                  <div class="wrap"> 
                   <strong class="name">Priority:</strong> 
                   <span id="priority-val" class="value"> <img alt="" height="16" src="/jira/images/icons/priorities/major.svg" title="Major - Major loss of function." width="16"> Major </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Resolution:</strong> 
                   <span id="resolution-val" class="value resolved"> Fixed </span> 
                  </div> </li> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Affects Version/s:</strong> 
                   <span id="versions-val" class="value"> None </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Fix Version/s:</strong> 
                   <span id="fixfor-val" class="value"> <span class="shorten" id="fixVersions-field"> <a href="/jira/issues/?jql=project+%3D+LUCENE+AND+fixVersion+%3D+4.8" title="4.8 Major release after 4.7">4.8</a>, <a href="/jira/issues/?jql=project+%3D+LUCENE+AND+fixVersion+%3D+6.0" title="6.0 Major release after 5.5">6.0</a> </span> </span> 
                  </div> </li> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Component/s:</strong> 
                   <span id="components-val" class="value"> None </span> 
                  </div> </li> 
                 <li class="item full-width"> 
                  <div class="wrap" id="wrap-labels"> 
                   <strong class="name">Labels:</strong> 
                   <div class="labels-wrap value"> 
                    <span class="labels" id="labels-12697648-value">None</span> 
                   </div> 
                  </div> </li> 
                </ul> 
                <div id="customfieldmodule"> 
                 <div class="aui-tabs horizontal-tabs" id="customfield-tabs"> 
                  <div id="customfield-panel-1" class="tabs-pane active-pane"> 
                   <ul class="property-list"> 
                    <li id="rowForcustomfield_12310120" class="item"> 
                     <div class="wrap"> 
                      <strong title="Lucene Fields" class="name">Lucene Fields:</strong> 
                      <div id="customfield_12310120-val" class="value type-multicheckboxes" data-fieldtype="multicheckboxes" data-fieldtypecompletekey="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes"> 
                       <div class="shorten" id="customfield_12310120-field"> 
                        <span>New</span>, 
                        <span>Patch Available</span> 
                       </div> 
                      </div> 
                     </div> </li> 
                   </ul> 
                  </div> 
                 </div>
                </div> 
               </div>
              </div>
              <div id="descriptionmodule" class="module toggle-wrap">
               <div id="descriptionmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Description</h2>
               </div>
               <div class="mod-content">
                <div id="description-val" class="field-ignore-highlight"> 
                 <div class="user-content-block"> 
                  <p>With <a href="https://issues.apache.org/jira/browse/LUCENE-5339" title="Simplify the facet module APIs" class="issue-link" data-issue-key="LUCENE-5339"><del>LUCENE-5339</del></a> facet sampling disappeared. </p> 
                  <p>When trying to display facet counts on large datasets (&gt;10M documents) counting facets is rather expensive, as all the hits are collected and processed. </p> 
                  <p>Sampling greatly reduced this and thus provided a nice speedup. Could it be brought back?</p> 
                 </div> 
                </div> 
               </div>
              </div>
              <div id="dnd-metadata" class="module toggle-wrap">
               <div id="dnd-metadata_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Attachments</h2>
               </div>
               <div class="mod-content">
                <div id="dnd-metadata-webpanel" data-can-attach="false" data-project-type="software" data-upload-limit="62914560" data-thumbnails-allowed="false"></div>
               </div>
              </div>
              <div id="attachmentmodule" class="module toggle-wrap">
               <div id="attachmentmodule_heading" class="mod-header">
                <ul class="ops">
                 <li class="drop">
                  <div class="aui-dd-parent">
                   <a href="#" class="icon drop-menu js-default-dropdown" title="Options"><span>Options</span></a>
                   <div class="aui-dropdown-content aui-list">
                    <ul id="attachment-sorting-options" class="aui-list-section aui-first">
                     <li class="aui-list-item"><a id="attachment-sort-key-name" href="/jira/browse/LUCENE-5476?attachmentSortBy=fileName#attachmentmodule" class="aui-list-checked aui-checked aui-list-item-link" title="viewissue.subtasks.tab.show.all.name"><span>Sort By Name</span></a></li>
                     <li class="aui-list-item"><a id="attachment-sort-key-date" href="/jira/browse/LUCENE-5476?attachmentSortBy=dateTime#attachmentmodule" class="aui-list-checked aui-list-item-link" title="Sort By Date"><span>Sort By Date</span></a></li>
                    </ul>
                    <ul id="attachment-sorting-order-options" class="aui-list-section aui-last">
                     <li class="aui-list-item"><a id="attachment-sort-direction-asc" href="/jira/browse/LUCENE-5476?attachmentOrder=asc#attachmentmodule" class="aui-list-checked aui-checked aui-list-item-link" title="Ascending"><span>Ascending</span></a></li>
                     <li class="aui-list-item"><a id="attachment-sort-direction-desc" href="/jira/browse/LUCENE-5476?attachmentOrder=desc#attachmentmodule" class="aui-list-checked aui-list-item-link" title="Descending"><span>Descending</span></a></li>
                    </ul>
                   </div>
                  </div></li>
                </ul>
                <h2 class="toggle-title">Attachments</h2>
               </div>
               <div class="mod-content">
                <ol id="file_attachments" class="item-attachments" data-sort-key="fileName" data-sort-order="asc">
                 <li class="attachment-content js-file-attachment" data-attachment-id="12635559" data-issue-id="12697648" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12635559/LUCENE-5476.patch" draggable="true" data-downloadurl="text/plain:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12635559/LUCENE-5476.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-txt" title="Text File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12635559/LUCENE-5476.patch" title="Latest  19/Mar/14 16:07 - Shai Erera" draggable="true" data-downloadurl="text/plain:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12635559/LUCENE-5476.patch">LUCENE-5476.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-03-19T16:07:28.786Z">19/Mar/14 16:07</time>
                   </dd>
                   <dd class="attachment-size">
                    17 kB
                   </dd>
                   <dd class="attachment-author">
                    Shai Erera
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12635072" data-issue-id="12697648" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12635072/LUCENE-5476.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12635072/LUCENE-5476.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12635072/LUCENE-5476.patch" title=" 17/Mar/14 12:46 - Rob Audenaerde" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12635072/LUCENE-5476.patch">LUCENE-5476.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-03-17T12:46:22.046Z">17/Mar/14 12:46</time>
                   </dd>
                   <dd class="attachment-size">
                    17 kB
                   </dd>
                   <dd class="attachment-author">
                    Rob Audenaerde
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12635044" data-issue-id="12697648" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12635044/LUCENE-5476.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12635044/LUCENE-5476.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12635044/LUCENE-5476.patch" title=" 17/Mar/14 07:55 - Rob Audenaerde" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12635044/LUCENE-5476.patch">LUCENE-5476.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-03-17T07:55:01.388Z">17/Mar/14 07:55</time>
                   </dd>
                   <dd class="attachment-size">
                    17 kB
                   </dd>
                   <dd class="attachment-author">
                    Rob Audenaerde
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12633872" data-issue-id="12697648" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12633872/LUCENE-5476.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12633872/LUCENE-5476.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12633872/LUCENE-5476.patch" title=" 11/Mar/14 08:20 - Rob Audenaerde" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12633872/LUCENE-5476.patch">LUCENE-5476.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-03-11T08:20:05.483Z">11/Mar/14 08:20</time>
                   </dd>
                   <dd class="attachment-size">
                    15 kB
                   </dd>
                   <dd class="attachment-author">
                    Rob Audenaerde
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12633095" data-issue-id="12697648" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12633095/LUCENE-5476.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12633095/LUCENE-5476.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12633095/LUCENE-5476.patch" title=" 06/Mar/14 10:51 - Rob Audenaerde" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12633095/LUCENE-5476.patch">LUCENE-5476.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-03-06T10:51:03.006Z">06/Mar/14 10:51</time>
                   </dd>
                   <dd class="attachment-size">
                    14 kB
                   </dd>
                   <dd class="attachment-author">
                    Rob Audenaerde
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12633079" data-issue-id="12697648" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12633079/LUCENE-5476.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12633079/LUCENE-5476.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12633079/LUCENE-5476.patch" title=" 06/Mar/14 08:46 - Rob Audenaerde" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12633079/LUCENE-5476.patch">LUCENE-5476.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-03-06T08:46:07.160Z">06/Mar/14 08:46</time>
                   </dd>
                   <dd class="attachment-size">
                    15 kB
                   </dd>
                   <dd class="attachment-author">
                    Rob Audenaerde
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12632800" data-issue-id="12697648" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12632800/LUCENE-5476.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12632800/LUCENE-5476.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12632800/LUCENE-5476.patch" title=" 05/Mar/14 09:22 - Rob Audenaerde" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12632800/LUCENE-5476.patch">LUCENE-5476.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-03-05T09:22:33.707Z">05/Mar/14 09:22</time>
                   </dd>
                   <dd class="attachment-size">
                    12 kB
                   </dd>
                   <dd class="attachment-author">
                    Rob Audenaerde
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12632486" data-issue-id="12697648" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12632486/LUCENE-5476.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12632486/LUCENE-5476.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12632486/LUCENE-5476.patch" title=" 04/Mar/14 10:34 - Rob Audenaerde" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12632486/LUCENE-5476.patch">LUCENE-5476.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-03-04T10:34:25.673Z">04/Mar/14 10:34</time>
                   </dd>
                   <dd class="attachment-size">
                    8 kB
                   </dd>
                   <dd class="attachment-author">
                    Rob Audenaerde
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12632472" data-issue-id="12697648" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12632472/LUCENE-5476.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12632472/LUCENE-5476.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12632472/LUCENE-5476.patch" title=" 04/Mar/14 08:39 - Rob Audenaerde" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12632472/LUCENE-5476.patch">LUCENE-5476.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-03-04T08:39:29.274Z">04/Mar/14 08:39</time>
                   </dd>
                   <dd class="attachment-size">
                    7 kB
                   </dd>
                   <dd class="attachment-author">
                    Rob Audenaerde
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12632206" data-issue-id="12697648" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12632206/LUCENE-5476.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12632206/LUCENE-5476.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12632206/LUCENE-5476.patch" title=" 03/Mar/14 09:25 - Rob Audenaerde" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12632206/LUCENE-5476.patch">LUCENE-5476.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-03-03T09:25:47.653Z">03/Mar/14 09:25</time>
                   </dd>
                   <dd class="attachment-size">
                    8 kB
                   </dd>
                   <dd class="attachment-author">
                    Rob Audenaerde
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment earlier-version" data-attachment-id="12631743" data-issue-id="12697648" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12631743/LUCENE-5476.patch" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12631743/LUCENE-5476.patch"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12631743/LUCENE-5476.patch" title=" 28/Feb/14 14:25 - Rob Audenaerde" draggable="true" data-downloadurl="text/x-patch:LUCENE-5476.patch:https://issues.apache.org/jira/secure/attachment/12631743/LUCENE-5476.patch">LUCENE-5476.patch</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-02-28T14:25:18.100Z">28/Feb/14 14:25</time>
                   </dd>
                   <dd class="attachment-size">
                    7 kB
                   </dd>
                   <dd class="attachment-author">
                    Rob Audenaerde
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12632217" data-issue-id="12697648" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12632217/SamplingComparison_SamplingFacetsCollector.java" draggable="true" data-downloadurl="text/x-java:SamplingComparison_SamplingFacetsCollector.java:https://issues.apache.org/jira/secure/attachment/12632217/SamplingComparison_SamplingFacetsCollector.java"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-code" title="Java Source File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12632217/SamplingComparison_SamplingFacetsCollector.java" title="Latest  03/Mar/14 10:24 - Gilad Barkai" draggable="true" data-downloadurl="text/x-java:SamplingComparison_SamplingFacetsCollector.java:https://issues.apache.org/jira/secure/attachment/12632217/SamplingComparison_SamplingFacetsCollector.java">SamplingComparison_SamplingFacetsCollector.java</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-03-03T10:24:21.237Z">03/Mar/14 10:24</time>
                   </dd>
                   <dd class="attachment-size">
                    10 kB
                   </dd>
                   <dd class="attachment-author">
                    Gilad Barkai
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12631706" data-issue-id="12697648" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12631706/SamplingFacetsCollector.java" draggable="true" data-downloadurl="text/x-java:SamplingFacetsCollector.java:https://issues.apache.org/jira/secure/attachment/12631706/SamplingFacetsCollector.java"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-code" title="Java Source File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12631706/SamplingFacetsCollector.java" title="Latest  28/Feb/14 10:39 - Rob Audenaerde" draggable="true" data-downloadurl="text/x-java:SamplingFacetsCollector.java:https://issues.apache.org/jira/secure/attachment/12631706/SamplingFacetsCollector.java">SamplingFacetsCollector.java</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-02-28T10:39:24.982Z">28/Feb/14 10:39</time>
                   </dd>
                   <dd class="attachment-size">
                    4 kB
                   </dd>
                   <dd class="attachment-author">
                    Rob Audenaerde
                   </dd>
                  </dl></li>
                </ol>
               </div>
              </div>
              <div id="activitymodule" class="module toggle-wrap">
               <div id="activitymodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Activity</h2>
               </div>
               <div class="mod-content"> 
                <big-pipe data-id="activity-panel-pipe-id" style="height: 70px"> 
                 <div></div> 
                </big-pipe> 
               </div>
              </div>
             </div>
             <div id="viewissuesidebar" class="aui-item issue-side-column">
              <div id="peoplemodule" class="module toggle-wrap">
               <div id="peoplemodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">People</h2>
               </div>
               <div class="mod-content"> 
                <ul class="item-details" id="peopledetails"> 
                 <li class="people-details"> 
                  <dl> 
                   <dt>
                    Assignee:
                   </dt> 
                   <dd> 
                    <span id="assignee-val" class="view-issue-field"> <span class="user-hover" id="issue_summary_assignee_shaie" rel="shaie" data-user="{&quot;avatarUrl&quot;:&quot;https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10452&quot;,&quot;displayName&quot;:&quot;Shai Erera&quot;,&quot;emailAddress&quot;:&quot;serera@gmail.com&quot;,&quot;username&quot;:&quot;shaie&quot;}"> <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img src="https://issues.apache.org/jira/secure/useravatar?size=small&amp;avatarId=10452" alt="shaie"></span></span> Shai Erera </span> </span> 
                   </dd> 
                  </dl> 
                  <dl> 
                   <dt>
                    Reporter:
                   </dt> 
                   <dd> 
                    <span id="reporter-val" class="view-issue-field"> <span class="user-hover" id="issue_summary_reporter_robau" rel="robau" data-user="{&quot;avatarUrl&quot;:&quot;https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10452&quot;,&quot;displayName&quot;:&quot;Rob Audenaerde&quot;,&quot;emailAddress&quot;:&quot;rob@audenaerde.org&quot;,&quot;username&quot;:&quot;robau&quot;}"> <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img src="https://issues.apache.org/jira/secure/useravatar?size=small&amp;avatarId=10452" alt="robau"></span></span> Rob Audenaerde </span> </span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
                <ul class="item-details"> 
                 <li> 
                  <dl> 
                   <dt>
                    Votes:
                   </dt> 
                   <dd> 
                    <span id="vote-data" class="aui-badge vote-state-off">0</span> 
                    <span id="vote-label" title="You have to be logged in to vote for an issue.">Vote for this issue</span> 
                   </dd> 
                  </dl> 
                  <dl> 
                   <dt>
                    Watchers:
                   </dt> 
                   <dd> 
                    <span id="watcher-data" class="aui-badge watch-state-off">4</span> 
                    <span id="watch-label" title="You have to be logged in to watch an issue.">Start watching this issue</span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
               </div>
              </div>
              <div id="datesmodule" class="module toggle-wrap">
               <div id="datesmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Dates</h2>
               </div>
               <div class="mod-content"> 
                <ul class="item-details"> 
                 <li> 
                  <dl class="dates"> 
                   <dt>
                    Created:
                   </dt> 
                   <dd class="date user-tz" title="27/Feb/14 09:59"> 
                    <span data-name="Created" id="created-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2014-02-27T09:59:57+0000">27/Feb/14 09:59</time> </span> 
                   </dd> 
                  </dl> 
                  <dl class="dates"> 
                   <dt>
                    Updated:
                   </dt> 
                   <dd class="date user-tz" title="09/May/16 18:29"> 
                    <span data-name="Updated" id="updated-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2016-05-09T18:29:47+0000">09/May/16 18:29</time> </span> 
                   </dd> 
                  </dl> 
                  <dl class="dates"> 
                   <dt>
                    Resolved:
                   </dt> 
                   <dd class="date user-tz" title="20/Mar/14 11:36"> 
                    <span data-name="Resolved" id="resolutiondate-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2014-03-20T11:36:04+0000">20/Mar/14 11:36</time> </span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
               </div>
              </div>
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
     <!-- .aui-page-panel-inner -->
    </div>
    <!-- .aui-page-panel -->
    <div class="issue-navigator-init"></div> 
   </section> 
   <footer id="footer" role="contentinfo"> 
    <section class="footer-body"> 
     <ul class="atlassian-footer"> 
      <li> Atlassian JIRA <a class="seo-link" rel="nofollow" href="https://www.atlassian.com/software/jira">Project Management Software</a> <span id="footer-build-information">(v7.6.3#76005-<span title="8a4e38d34af948780dbf52044e7aafb13a7cae58" data-commit-id="8a4e38d34af948780dbf52044e7aafb13a7cae58}">sha1:8a4e38d</span>)</span> </li> 
      <li> <a id="about-link" rel="nofollow" href="/jira/secure/AboutPage.jspa/secure/AboutPage.jspa">About JIRA</a> </li> 
      <li> <a id="footer-report-problem-link" rel="nofollow" href="/jira/secure/CreateIssue!default.jspa">Report a problem</a> </li> 
     </ul> 
     <ul class="atlassian-footer"> 
      <li class="licensemessage"> Powered by a free Atlassian <a rel="nofollow" href="http://www.atlassian.com/software/jira">JIRA</a> open source license for n/a, Apache Software Foundation. Try JIRA - <a rel="nofollow" href="http://www.atlassian.com/software/jira">bug tracking software</a> for <i>your</i> team. </li> 
     </ul> 
     <div id="footer-logo">
      <a rel="nofollow" href="http://www.atlassian.com/">Atlassian</a>
     </div> 
    </section> 
    <fieldset class="hidden parameters"> 
     <input type="hidden" title="loggedInUser" value=""> 
     <input type="hidden" title="ajaxTimeout" value="The call to the JIRA server did not complete within the timeout period.  We are unsure of the result of this operation."> 
     <input type="hidden" title="JiraVersion" value="7.6.3"> 
     <input type="hidden" title="ajaxUnauthorised" value="You are not authorised to perform this operation. Please log in."> 
     <input type="hidden" title="baseURL" value="https://issues.apache.org/jira"> 
     <input type="hidden" title="ajaxCommsError" value="The JIRA server could not be contacted. This may be a temporary glitch or the server may be down. "> 
     <input type="hidden" title="ajaxServerError" value="The JIRA server was contacted but has returned an error response. We are unsure of the result of this operation."> 
     <input type="hidden" title="ajaxErrorCloseDialog" value="Close this dialog and press refresh in your browser"> 
     <input type="hidden" title="ajaxErrorDialogHeading" value="Communications Breakdown"> 
     <input type="hidden" title="dirtyMessage" value="You have entered new data on this page. If you navigate away from this page without first saving your data, the changes will be lost."> 
     <input type="hidden" title="dirtyDialogMessage" value="You have entered new data in this dialog. If you navigate away from this dialog without first saving your data, the changes will be lost. Click cancel to return to the dialog."> 
     <input type="hidden" title="keyType" value="Type"> 
     <input type="hidden" title="keyThen" value="then"> 
     <input type="hidden" title="dblClickToExpand" value="Double click to expand"> 
     <input type="hidden" title="actions" value="Actions"> 
     <input type="hidden" title="removeItem" value="Remove"> 
     <input type="hidden" title="workflow" value="Workflow"> 
     <input type="hidden" title="labelNew" value="New Label"> 
     <input type="hidden" title="issueActionsHint" value="Begin typing for available operations or press down to see all"> 
     <input type="hidden" title="closelink" value="Close"> 
     <input type="hidden" title="dotOperations" value="Operations"> 
     <input type="hidden" title="dotLoading" value="Loading..."> 
     <input type="hidden" title="frotherSuggestions" value="Suggestions"> 
     <input type="hidden" title="frotherNomatches" value="No Matches"> 
     <input type="hidden" title="multiselectVersionsError" value="{0} is not a valid version."> 
     <input type="hidden" title="multiselectComponentsError" value="{0} is not a valid component."> 
     <input type="hidden" title="multiselectGenericError" value="The value {0} is invalid."> 
    </fieldset> 
   </footer> 
  </div> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:bigpipe-js/jira.webresources:bigpipe-js.js" data-wrm-key="jira.webresources:bigpipe-js" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["activity-panel-pipe-id"]="\"\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n    \u003cdiv class=\\\"tabwrap tabs2\\\"\u003e\\n\\n        \u003cul id=\\\"issue-tabs\\\" class=\\\"tabs horizontal\\\"\u003e\\n                                \\n            \u003cli  data-id=\\\"all-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\" data-label=\\\"All\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-5476?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"all-tabpanel\\\" href=\\\"\\/jira\\/browse\\/LUCENE-5476?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\"\u003e\u003cstrong\u003eAll\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  class=\\\"active\\\" id=\\\"comment-tabpanel\\\"  data-id=\\\"comment-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel\\\" data-label=\\\"Comments\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-5476?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel\\\"\u003e\\n                            \u003cstrong tabindex=\\\"0\\\"\u003eComments\u003c\\/strong\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"worklog-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\" data-label=\\\"Work Log\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-5476?page=com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"worklog-tabpanel\\\" href=\\\"\\/jira\\/browse\\/LUCENE-5476?page=com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\"\u003e\u003cstrong\u003eWork Log\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"changehistory-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\" data-label=\\\"History\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-5476?page=com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"changehistory-tabpanel\\\" href=\\\"\\/jira\\/browse\\/LUCENE-5476?page=com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\"\u003e\u003cstrong\u003eHistory\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"activity-stream-issue-tab\\\" data-key=\\\"com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\" data-label=\\\"Activity\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-5476?page=com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"activity-stream-issue-tab\\\" href=\\\"\\/jira\\/browse\\/LUCENE-5476?page=com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\"\u003e\u003cstrong\u003eActivity\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"transitions-summary-tabpanel\\\" data-key=\\\"com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\" data-label=\\\"Transitions\\\" data-href=\\\"\\/jira\\/browse\\/LUCENE-5476?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"transitions-summary-tabpanel\\\" href=\\\"\\/jira\\/browse\\/LUCENE-5476?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\"\u003e\u003cstrong\u003eTransitions\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                \u003c\\/ul\u003e\\n\\n                    \u003cdiv class=\\\"sortwrap\\\"\u003e\\n                                    \u003ca class=\\\"issue-activity-sort-link ajax-activity-content\\\" rel=\\\"nofollow\\\" data-tab-sort data-order=\\\"desc\\\" href=\\\"\\/jira\\/browse\\/LUCENE-5476?actionOrder=desc\\\" title=\\\"Ascending order - Click to sort in descending order\\\"\u003e\\n                        \u003cspan class=\\\"aui-icon aui-icon-small aui-iconfont-up\\\"\u003eAscending order - Click to sort in descending order\u003c\\/span\u003e\\n                    \u003c\\/a\u003e\\n                            \u003c\\/div\u003e\\n            \u003c\\/div\u003e\\n    \u003cdiv class=\\\"issuePanelWrapper\\\"\u003e\\n        \u003cdiv class=\\\"issuePanelProgress\\\"\u003e\u003c\\/div\u003e\\n        \u003cdiv class=\\\"issuePanelContainer\\\" id=\\\"issue_actions_container\\\"\u003e\\n                                    \\n\\n\\n\u003cdiv id=\\\"comment-13914415\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13914415&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13914415\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_13914415_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13914415_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Feb\\/14 11:31\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-02-27T11:31:46+0000\'\u003e27\\/Feb\\/14 11:31\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e+1 to bring it back.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think we could expose methods that take a FBS and either sub-sample it in place, or return a new FBS?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_13914415_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13914415_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Feb\\/14 11:31\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-02-27T11:31:46+0000\'\u003e27\\/Feb\\/14 11:31\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    +1 to bring it back. \\n\\n I think we could expose methods that take a FBS and either sub-sample it in place, or return a new FBS?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13915650\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13915650&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13915650\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13915650_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13915650_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Feb\\/14 10:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-02-28T10:38:40+0000\'\u003e28\\/Feb\\/14 10:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'m currently expermenting with this. To increase the speed it seems logical to me the \u003ctt\u003eFacetsCollector\u003c\\/tt\u003e needs to return less hits. I have a slighly modified version that I will attach. \u003cbr\\/\u003e\\nIt uses a sampling technique that divides the total hits in to \'bins\' of a given size; and takes one sample of that bin. I have implemented it as keeping that one sample as \'hit\' of the search if it was a hit, and clearing all other bits.  See the attached file. \u003c\\/p\u003e\\n\\n\u003cp\u003eBy using this technique the distribution of the results should not be altered too much, while the performance gains can be significant. \u003c\\/p\u003e\\n\\n\u003cp\u003eA quick test revealed that for 1M results and binsize 500, the sampled version is twice as fast.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe problem it that the resulting {{FacetResult}}s are not correct, as the number of hits is reduced. This can be fixed afterwards for counting facets by multiplying with the binsize; but for other facets it will be more difficult or will require other approaches. \u003c\\/p\u003e\\n\\n\u003cp\u003eWhat do you think?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13915650_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13915650_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Feb\\/14 10:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-02-28T10:38:40+0000\'\u003e28\\/Feb\\/14 10:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'m currently expermenting with this. To increase the speed it seems logical to me the  FacetsCollector  needs to return less hits. I have a slighly modified version that I will attach.  \\nIt uses a sampling technique that divides the total hits in to \'bins\' of a given size; and takes one sample of that bin. I have implemented it as keeping that one sample as \'hit\' of the search if it was a hit, and clearing all other bits.  See the attached file.  \\n\\n By using this technique the distribution of the results should not be altered too much, while the performance gains can be significant.  \\n\\n A quick test revealed that for 1M results and binsize 500, the sampled version is twice as fast. \\n\\n The problem it that the resulting {{FacetResult}}s are not correct, as the number of hits is reduced. This can be fixed afterwards for counting facets by multiplying with the binsize; but for other facets it will be more difficult or will require other approaches.  \\n\\n What do you think?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13915729\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13915729&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13915729\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_13915729_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13915729_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Feb\\/14 12:43\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-02-28T12:43:00+0000\'\u003e28\\/Feb\\/14 12:43\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThis looks great!  \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eTo increase the speed it seems logical to me the FacetsCollector needs to return less hits.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003e\u003cb\u003efewer\u003c\\/b\u003e hits \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e  (Sorry, pet peeve).\u003c\\/p\u003e\\n\\n\u003cp\u003eMaybe, you could add a utility method on SamplingFacetsCollector to \\\"fixup\\\" the FacetResult assuming it\'s a simple count (e.g., multiply the aggregate by the bin size)?  The old sampling code (\u003ca href=\\\"https:\\/\\/svn.apache.org\\/repos\\/asf\\/lucene\\/dev\\/branches\\/lucene_solr_4_6\\/lucene\\/facet\\/src\\/java\\/org\\/apache\\/lucene\\/facet\\/sampling\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttps:\\/\\/svn.apache.org\\/repos\\/asf\\/lucene\\/dev\\/branches\\/lucene_solr_4_6\\/lucene\\/facet\\/src\\/java\\/org\\/apache\\/lucene\\/facet\\/sampling\u003c\\/a\u003e ) has something like this.\u003c\\/p\u003e\\n\\n\u003cp\u003eIt might be good to allow passing the random seed, for repeatable results?\u003c\\/p\u003e\\n\\n\u003cp\u003eAnother option, which would save the 2nd pass, would be to do the sampling during Docs.addDoc.\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso, instead of the bin-checking, you could just pull the next random double and check if it\'s &lt; 1.0\\/binSize?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_13915729_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13915729_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Feb\\/14 12:43\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-02-28T12:43:00+0000\'\u003e28\\/Feb\\/14 12:43\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    This looks great!   \\n\\n  To increase the speed it seems logical to me the FacetsCollector needs to return less hits.  \\n\\n  fewer  hits    (Sorry, pet peeve). \\n\\n Maybe, you could add a utility method on SamplingFacetsCollector to \\\"fixup\\\" the FacetResult assuming it\'s a simple count (e.g., multiply the aggregate by the bin size)?  The old sampling code ( https:\\/\\/svn.apache.org\\/repos\\/asf\\/lucene\\/dev\\/branches\\/lucene_solr_4_6\\/lucene\\/facet\\/src\\/java\\/org\\/apache\\/lucene\\/facet\\/sampling  ) has something like this. \\n\\n It might be good to allow passing the random seed, for repeatable results? \\n\\n Another option, which would save the 2nd pass, would be to do the sampling during Docs.addDoc. \\n\\n Also, instead of the bin-checking, you could just pull the next random double and check if it\'s &lt; 1.0\\/binSize?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13915762\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13915762&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13915762\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13915762_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13915762_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Feb\\/14 13:11\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-02-28T13:11:20+0000\'\u003e28\\/Feb\\/14 13:11\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThis looks like a great start! I have few comments\\/suggestions, based on the previous sampling impl:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eI think SamplingFC.createDocs should return a declared SampledDocs (see later) instead of anonymous class\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eCurrently that SampledDocs.getDocIdSet() creates a new sample on every call. This is bad not only from a performance point of view, but more because if there are few Facets* that call it, they will compute weights on different samples\\n\\t\u003cul\u003e\\n\\t\\t\u003cli\u003eInstead, I think that SampledDocs.getDocIdSet() should return the same sampled DIS, i.e. by caching it.\u003c\\/li\u003e\\n\\t\\t\u003cli\u003eAlso, I think it would be good if it exposes a getSampledDocIdSet which takes some parameters e.g. the sample size\u003c\\/li\u003e\\n\\t\\t\u003cli\u003eI think the original FBS should not be modified. E.g. in the previous sampling impl, you could compute the sampled top-facets but then return their exact counts by traversing the original matching docs and counting only them.\\n\\t\\t\u003cul\u003e\\n\\t\\t\\t\u003cli\u003eBut maybe we should leave that for later, it could be a different SFC impl. But still please don\'t compute the sample on every getDocIdSet() call.\u003c\\/li\u003e\\n\\t\\t\u003c\\/ul\u003e\\n\\t\\t\u003c\\/li\u003e\\n\\t\u003c\\/ul\u003e\\n\\t\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eThe old implementation let you specify different parameters such as sample size, minimum number of documents to evaluate, maximum number of documents to evaluate etc. I think those are important since defining e.g. 10% sample size could still cause you to process 10M docs, which is slow.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eI like that this impl samples per-segment as it allows to tune the sample on a per-segment basis. E.g. small segments (as in NRT) probably don\'t need to be sampled at all. If we allow passing different parameters such as sampleRatio, min\\/maxSampleSize, we could tune sampling per-segment.\u003c\\/p\u003e\\n\\n\u003cp\u003eI agree with Mike that we need to allow passing a seed for repeatability (I assume it will be important when testing). Maybe wrap all the parameters in a SamplingConfig? We can keep the sugar ctors on SFC to take only e.g. sampleRatio.\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso, one thing that we did in the old impl is not use Math.random() or Random at all. Rather some crazy formula was used to create faster samples. I don\'t say we need to do that now, but maybe drop a TODO. At any rate, I don\'t think we should use Math.random(), but rather init a Random once and call nextDouble(). This will also allow to reuse a seed.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13915762_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13915762_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Feb\\/14 13:11\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-02-28T13:11:20+0000\'\u003e28\\/Feb\\/14 13:11\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    This looks like a great start! I have few comments\\/suggestions, based on the previous sampling impl: \\n\\n \\n\\t I think SamplingFC.createDocs should return a declared SampledDocs (see later) instead of anonymous class \\n \\n\\n\\n \\n\\t Currently that SampledDocs.getDocIdSet() creates a new sample on every call. This is bad not only from a performance point of view, but more because if there are few Facets* that call it, they will compute weights on different samples\\n\\t \\n\\t\\t Instead, I think that SampledDocs.getDocIdSet() should return the same sampled DIS, i.e. by caching it. \\n\\t\\t Also, I think it would be good if it exposes a getSampledDocIdSet which takes some parameters e.g. the sample size \\n\\t\\t I think the original FBS should not be modified. E.g. in the previous sampling impl, you could compute the sampled top-facets but then return their exact counts by traversing the original matching docs and counting only them.\\n\\t\\t \\n\\t\\t\\t But maybe we should leave that for later, it could be a different SFC impl. But still please don\'t compute the sample on every getDocIdSet() call. \\n\\t\\t \\n\\t\\t \\n\\t \\n\\t \\n \\n\\n\\n \\n\\t The old implementation let you specify different parameters such as sample size, minimum number of documents to evaluate, maximum number of documents to evaluate etc. I think those are important since defining e.g. 10% sample size could still cause you to process 10M docs, which is slow. \\n \\n\\n\\n I like that this impl samples per-segment as it allows to tune the sample on a per-segment basis. E.g. small segments (as in NRT) probably don\'t need to be sampled at all. If we allow passing different parameters such as sampleRatio, min\\/maxSampleSize, we could tune sampling per-segment. \\n\\n I agree with Mike that we need to allow passing a seed for repeatability (I assume it will be important when testing). Maybe wrap all the parameters in a SamplingConfig? We can keep the sugar ctors on SFC to take only e.g. sampleRatio. \\n\\n Also, one thing that we did in the old impl is not use Math.random() or Random at all. Rather some crazy formula was used to create faster samples. I don\'t say we need to do that now, but maybe drop a TODO. At any rate, I don\'t think we should use Math.random(), but rather init a Random once and call nextDouble(). This will also allow to reuse a seed.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13915796\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13915796&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13915796\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13915796_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13915796_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Feb\\/14 13:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-02-28T13:49:55+0000\'\u003e28\\/Feb\\/14 13:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks guys for the feedback (also on my language skills, I need to improve my English \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/wink.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e)\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eIt might be good to allow passing the random seed, for repeatable results?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eYes! This is very sensible for testing and more \'stable\' screenresults and I will add this.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eAnother option, which would save the 2nd pass, would be to do the sampling during Docs.addDoc.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eI considered sampling on the \'addDocument\' but I figured it would be more expensive as then for each hit we need to do a random() calculation.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eI think SamplingFC.createDocs should return a declared SampledDocs (see later) instead of anonymous class\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eI also considered this. It is far better for clarity-sake but it also costs a copy of the original. I will try some approaches and will make sure the sampling is only done once. \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eI like that this impl samples per-segment as it allows to tune the sample on a per-segment basis. E.g. small segments (as in NRT) probably don\'t need to be sampled at all. If we allow passing different parameters such as sampleRatio, min\\/maxSampleSize, we could tune sampling per-segment.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eThis was more or less by accident, but indeed seems useful. All segments need the same ratio of sampling though, else it would be really hard to correct the counts afterwards. (Or am I missing something here?)\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eMaybe wrap all the parameters in a SamplingConfig?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eYes. Very useful and makes it more stable.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eThe old implementation let you specify different parameters such as sample size, minimum number of documents to evaluate, maximum number of documents to evaluate etc\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThe old style sampling indeed had a fixed sample size, which I found very useful. However, I have not yet found a way to implement this as I do not know the total number of results when I start facetting, so I cannot determine the samplingRatio.  I could of course first count all results, but that also impacts performance as I would need two passes. I will give it some more thought, but maybe you have an idea on how to accomplish this in a better way?\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13915796_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13915796_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Feb\\/14 13:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-02-28T13:49:55+0000\'\u003e28\\/Feb\\/14 13:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks guys for the feedback (also on my language skills, I need to improve my English  ) \\n\\n \\n It might be good to allow passing the random seed, for repeatable results?  \\n Yes! This is very sensible for testing and more \'stable\' screenresults and I will add this. \\n\\n \\n Another option, which would save the 2nd pass, would be to do the sampling during Docs.addDoc.  \\n I considered sampling on the \'addDocument\' but I figured it would be more expensive as then for each hit we need to do a random() calculation. \\n\\n \\n I think SamplingFC.createDocs should return a declared SampledDocs (see later) instead of anonymous class  \\n I also considered this. It is far better for clarity-sake but it also costs a copy of the original. I will try some approaches and will make sure the sampling is only done once.  \\n\\n \\n I like that this impl samples per-segment as it allows to tune the sample on a per-segment basis. E.g. small segments (as in NRT) probably don\'t need to be sampled at all. If we allow passing different parameters such as sampleRatio, min\\/maxSampleSize, we could tune sampling per-segment.  \\n This was more or less by accident, but indeed seems useful. All segments need the same ratio of sampling though, else it would be really hard to correct the counts afterwards. (Or am I missing something here?) \\n\\n \\n Maybe wrap all the parameters in a SamplingConfig?  \\n Yes. Very useful and makes it more stable. \\n\\n \\n The old implementation let you specify different parameters such as sample size, minimum number of documents to evaluate, maximum number of documents to evaluate etc  \\n\\n The old style sampling indeed had a fixed sample size, which I found very useful. However, I have not yet found a way to implement this as I do not know the total number of results when I start facetting, so I cannot determine the samplingRatio.  I could of course first count all results, but that also impacts performance as I would need two passes. I will give it some more thought, but maybe you have an idea on how to accomplish this in a better way? \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13915821\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13915821&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13915821\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13915821_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13915821_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Feb\\/14 14:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-02-28T14:25:18+0000\'\u003e28\\/Feb\\/14 14:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere is a patch (agains 4.7) that covers some of the feedback. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13915821_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13915821_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Feb\\/14 14:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-02-28T14:25:18+0000\'\u003e28\\/Feb\\/14 14:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here is a patch (agains 4.7) that covers some of the feedback.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13917072\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13917072&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13917072\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rcmuir\\\" id=\\\"commentauthor_13917072_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rcmuir\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rcmuir\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Robert Muir\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917072_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Mar\\/14 14:01\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-01T14:01:27+0000\'\u003e01\\/Mar\\/14 14:01\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eAlso, one thing that we did in the old impl is not use Math.random() or Random at all. Rather some crazy formula was used to create faster samples. I don\'t say we need to do that now, but maybe drop a TODO. At any rate, I don\'t think we should use Math.random(), but rather init a Random once and call nextDouble(). This will also allow to reuse a seed.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003exor-shift might be a good choice here.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rcmuir\\\" id=\\\"commentauthor_13917072_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rcmuir\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rcmuir\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Robert Muir\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917072_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Mar\\/14 14:01\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-01T14:01:27+0000\'\u003e01\\/Mar\\/14 14:01\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Also, one thing that we did in the old impl is not use Math.random() or Random at all. Rather some crazy formula was used to create faster samples. I don\'t say we need to do that now, but maybe drop a TODO. At any rate, I don\'t think we should use Math.random(), but rather init a Random once and call nextDouble(). This will also allow to reuse a seed.  \\n\\n xor-shift might be a good choice here.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13917158\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13917158&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13917158\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"gilad\\\" id=\\\"commentauthor_13917158_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=gilad\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"gilad\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Gilad Barkai\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917158_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Mar\\/14 19:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-01T19:00:20+0000\'\u003e01\\/Mar\\/14 19:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Gilad Barkai - 01\\/Mar\\/14 19:03\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eGreat effort!\u003c\\/p\u003e\\n\\n\u003cp\u003eI wish to throw in another part - the description of this issue is about sampling, but the implementation is about \u003cb\u003erandom\u003c\\/b\u003e sampling.\u003cbr\\/\u003e\\nThis is not always the case, nor it is very fast (indeed, calling 1M times Random.nextInt would be measurable by itself IMHO).\u003cbr\\/\u003e\\nA different sample could be (pseudo-code)\u003c\\/p\u003e\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e\u003cspan class=\\\"code-object\\\"\u003eint\u003c\\/span\u003e acceptedModulu = (\u003cspan class=\\\"code-object\\\"\u003eint\u003c\\/span\u003e)(1\\/sampleRatio);\\n\\n\u003cspan class=\\\"code-object\\\"\u003eint\u003c\\/span\u003e next() {\\n  \u003cspan class=\\\"code-keyword\\\"\u003edo\u003c\\/span\u003e {\\n    nextDoc = \u003cspan class=\\\"code-keyword\\\"\u003einner\u003c\\/span\u003e.next();\\n  } \u003cspan class=\\\"code-keyword\\\"\u003ewhile\u003c\\/span\u003e (nextDoc != NO_MORE_DOCX &amp;&amp; nextDoc % acceptedModulu != 0) ;\\n\\n  \u003cspan class=\\\"code-keyword\\\"\u003ereturn\u003c\\/span\u003e nextDoc;\\n}\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003eThis should be faster as a sampler, and perhaps saves us from creating a new \u003ctt\u003eDocIdSet\u003c\\/tt\u003e.\u003c\\/p\u003e\\n\\n\u003cp\u003eOne last thing - if I did the math right - the sample crafted by the code in the patch would be twice as large as the user may expect.\u003cbr\\/\u003e\\nFor a sample ratio of 0.1, the random.nextInt() would be called with 10, so the avg. \\\"jump\\\" is actually 5 - and every 5th document in the original set (again, in avg) would be selected, and not every 10th in avg. I think the random.nextInt should be called with twice the size it is called now (e.g 20, making the avg random selection 10).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"gilad\\\" id=\\\"commentauthor_13917158_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=gilad\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"gilad\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Gilad Barkai\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917158_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Mar\\/14 19:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-01T19:00:20+0000\'\u003e01\\/Mar\\/14 19:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Gilad Barkai - 01\\/Mar\\/14 19:03\\\"\u003eedited\u003c\\/span\u003e                   Great effort! \\n\\n I wish to throw in another part - the description of this issue is about sampling, but the implementation is about  random  sampling. \\nThis is not always the case, nor it is very fast (indeed, calling 1M times Random.nextInt would be measurable by itself IMHO). \\nA different sample could be (pseudo-code) \\n  \\n  int  acceptedModulu = ( int )(1\\/sampleRatio);\\n\\n int  next() {\\n   do  {\\n    nextDoc =  inner .next();\\n  }  while  (nextDoc != NO_MORE_DOCX &amp;&amp; nextDoc % acceptedModulu != 0) ;\\n\\n   return  nextDoc;\\n}\\n \\n  \\n\\n This should be faster as a sampler, and perhaps saves us from creating a new  DocIdSet . \\n\\n One last thing - if I did the math right - the sample crafted by the code in the patch would be twice as large as the user may expect. \\nFor a sample ratio of 0.1, the random.nextInt() would be called with 10, so the avg. \\\"jump\\\" is actually 5 - and every 5th document in the original set (again, in avg) would be selected, and not every 10th in avg. I think the random.nextInt should be called with twice the size it is called now (e.g 20, making the avg random selection 10).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13917165\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13917165&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13917165\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13917165_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917165_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Mar\\/14 19:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-01T19:16:23+0000\'\u003e01\\/Mar\\/14 19:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAbout the patch:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eSampledDocs should be static class, to not carry over the FC reference. We\'ve been bitten by such things in the past and I don\'t see a good reason to do it here.\u003c\\/li\u003e\\n\\t\u003cli\u003eThe \'sampling\' package may be an overkill? if we want to do it, need to add package.html. But I think you can wrap them all in a SFC now (SampledDocs and SamplingParams as static classes) as it\'s not a lot of code.\u003c\\/li\u003e\\n\\t\u003cli\u003eCould you take a look at the old tests and see if they can be ported to the new API?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eAbout the sampling itself, Rob referred me to this link \u003ca href=\\\"http:\\/\\/dmurphy747.wordpress.com\\/2011\\/03\\/23\\/xorshift-vs-random-performance-in-java\\/\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/dmurphy747.wordpress.com\\/2011\\/03\\/23\\/xorshift-vs-random-performance-in-java\\/\u003c\\/a\u003e where a simple implementation for PRNG is used, following XOR-Shift method. Could you take a look and see if it can be applied here instead of using Java\'s Random. According to the link, it performs 7 times faster...\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13917165_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917165_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Mar\\/14 19:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-01T19:16:23+0000\'\u003e01\\/Mar\\/14 19:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    About the patch: \\n\\n \\n\\t SampledDocs should be static class, to not carry over the FC reference. We\'ve been bitten by such things in the past and I don\'t see a good reason to do it here. \\n\\t The \'sampling\' package may be an overkill? if we want to do it, need to add package.html. But I think you can wrap them all in a SFC now (SampledDocs and SamplingParams as static classes) as it\'s not a lot of code. \\n\\t Could you take a look at the old tests and see if they can be ported to the new API? \\n \\n\\n\\n About the sampling itself, Rob referred me to this link  http:\\/\\/dmurphy747.wordpress.com\\/2011\\/03\\/23\\/xorshift-vs-random-performance-in-java\\/  where a simple implementation for PRNG is used, following XOR-Shift method. Could you take a look and see if it can be applied here instead of using Java\'s Random. According to the link, it performs 7 times faster...              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13917189\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13917189&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13917189\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_13917189_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917189_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Mar\\/14 20:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-01T20:57:15+0000\'\u003e01\\/Mar\\/14 20:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI don\'t think we need a sampling package (overkill), and I also don\'t think we need a separate \\\"config\\\" class (SamplingParams\\/Config) which will bring complexity\\/questions itself; I think it\'s a non-goal here to revive the previous sampling implementation with all of its complexity, nor to push all of this responsibility onto Rob, who\'s doing great work here.\u003c\\/p\u003e\\n\\n\u003cp\u003eRather, I think we should start simple (what Rob needs, here), commit that, and iterate from there, bringing back features as users need them.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_13917189_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917189_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Mar\\/14 20:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-01T20:57:15+0000\'\u003e01\\/Mar\\/14 20:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I don\'t think we need a sampling package (overkill), and I also don\'t think we need a separate \\\"config\\\" class (SamplingParams\\/Config) which will bring complexity\\/questions itself; I think it\'s a non-goal here to revive the previous sampling implementation with all of its complexity, nor to push all of this responsibility onto Rob, who\'s doing great work here. \\n\\n Rather, I think we should start simple (what Rob needs, here), commit that, and iterate from there, bringing back features as users need them.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13917304\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13917304&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13917304\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13917304_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917304_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Mar\\/14 06:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-02T06:57:53+0000\'\u003e02\\/Mar\\/14 06:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI agree Mike. Rob wrote though in a previous comment: \u003cem\u003e\\\"The old style sampling indeed had a fixed sample size, which I found very useful\\\"\u003c\\/em\u003e, so I assumed that\'s something he wants to push for in this issue as well. I\'m OK w\\/ re-introducing sampling in baby steps, but if Rob\'s goal is to use sampling + fixed sampling, then we should help him do that in this issue - there\'s no reason to break this into two issues?\u003c\\/p\u003e\\n\\n\u003cp\u003eRob, if you only want to introduce sampling ratio, then I agree with Mike that SamplingParams is an overkill for this issue. And in anyway I think a separate sampling package is an overkill as well. If sampling code grows, we can always refactor and move it under its own package.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13917304_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917304_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Mar\\/14 06:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-02T06:57:53+0000\'\u003e02\\/Mar\\/14 06:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I agree Mike. Rob wrote though in a previous comment:  \\\"The old style sampling indeed had a fixed sample size, which I found very useful\\\" , so I assumed that\'s something he wants to push for in this issue as well. I\'m OK w\\/ re-introducing sampling in baby steps, but if Rob\'s goal is to use sampling + fixed sampling, then we should help him do that in this issue - there\'s no reason to break this into two issues? \\n\\n Rob, if you only want to introduce sampling ratio, then I agree with Mike that SamplingParams is an overkill for this issue. And in anyway I think a separate sampling package is an overkill as well. If sampling code grows, we can always refactor and move it under its own package.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13917407\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13917407&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13917407\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13917407_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917407_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Mar\\/14 13:23\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-02T13:23:02+0000\'\u003e02\\/Mar\\/14 13:23\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Shai Erera - 02\\/Mar\\/14 13:26\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI reviewed createSample in the patch, and I think something\'s wrong with it. As I understand it, you set binsize to \u003ctt\u003e1.0\\/sampleRatio\u003c\\/tt\u003e, so if sR=0.1, binsize=10. This means that we should keep 1 out of every 10 matching documents. Then you iterate over the bitset, for every group of 10 documents you draw a representative index at random, and clear all other documents.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut what seems wrong is that the iteration advances through the \\\"bin\\\" irrespective of which documents were returned. So e.g. if the FBS has 100 docs total, and docs 5, 15, 25, 35, ... returned and say random.nextInt(binsize) picks all indexes but 5, if I understand the code correctly, all bits will be cleared! I double-checked with the following short main:\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e\u003cspan class=\\\"code-keyword\\\"\u003epublic\u003c\\/span\u003e \u003cspan class=\\\"code-keyword\\\"\u003estatic\u003c\\/span\u003e void main(\u003cspan class=\\\"code-object\\\"\u003eString\u003c\\/span\u003e[] args) \u003cspan class=\\\"code-keyword\\\"\u003ethrows\u003c\\/span\u003e Exception {\\n  Random random = \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e Random();\\n  FixedBitSet sampledBits = \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e FixedBitSet(100);\\n  \u003cspan class=\\\"code-keyword\\\"\u003efor\u003c\\/span\u003e (\u003cspan class=\\\"code-object\\\"\u003eint\u003c\\/span\u003e i = 5; i &lt; 100; i += 10) {\\n    sampledBits.set(i);\\n  }\\n  \u003cspan class=\\\"code-object\\\"\u003eint\u003c\\/span\u003e size = 100;\\n  \u003cspan class=\\\"code-object\\\"\u003eint\u003c\\/span\u003e binsize = 10;\\n\\n  \u003cspan class=\\\"code-object\\\"\u003eint\u003c\\/span\u003e countInBin = 0;\\n  \u003cspan class=\\\"code-object\\\"\u003eint\u003c\\/span\u003e randomIndex = random.nextInt(binsize);\\n  \u003cspan class=\\\"code-keyword\\\"\u003efor\u003c\\/span\u003e (\u003cspan class=\\\"code-object\\\"\u003eint\u003c\\/span\u003e i = 0; i &lt; size; i++) {\\n    countInBin++;\\n    \u003cspan class=\\\"code-keyword\\\"\u003eif\u003c\\/span\u003e (countInBin == binsize) {\\n      countInBin = 0;\\n      randomIndex = random.nextInt(binsize);\\n    }\\n    \u003cspan class=\\\"code-keyword\\\"\u003eif\u003c\\/span\u003e (sampledBits.get(i) &amp;&amp; !(countInBin == randomIndex)) {\\n      sampledBits.clear(i);\\n    }\\n  }\\n  \u003cspan class=\\\"code-keyword\\\"\u003efor\u003c\\/span\u003e (\u003cspan class=\\\"code-object\\\"\u003eint\u003c\\/span\u003e i = 0; i &lt; 100; i++) {\\n    \u003cspan class=\\\"code-keyword\\\"\u003eif\u003c\\/span\u003e (sampledBits.get(i)) {\\n      \u003cspan class=\\\"code-object\\\"\u003eSystem\u003c\\/span\u003e.out.print(i + \u003cspan class=\\\"code-quote\\\"\u003e\\\" \\\"\u003c\\/span\u003e);\\n    }\\n  }\\n  \u003cspan class=\\\"code-object\\\"\u003eSystem\u003c\\/span\u003e.out.println();\\n}\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003eAnd indeed in many iterations the main prints nothing, in some only 2-3 docs \\\"survive\\\" the sampling.\u003c\\/p\u003e\\n\\n\u003cp\u003eSo first I think Gilad\'s pseudo-code is more correct in that it iterates over the matching documents and I think you should do the same here. When you do that, you no longer need to check bits.get\u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/information.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e in order to decide if to clear it.\u003c\\/p\u003e\\n\\n\u003cp\u003eI wonder if your benchmark results are correct (unless you run a MatchAllDocsQuery?) &#8211; can you confirm that you indeed count 10% of the documents?\u003c\\/p\u003e\\n\\n\u003cp\u003eAnother point raised by Gilad is the method of sampling. While you implement random sampling, there are other methods like \\\"take the 10th document\\\" etc. which will be faster. I think one can experiment with these through an extension of SampledDocs.createSample (and SamplingFC.createDocs), but just in case you want to give such a simple sampling method a try, would be interesting to compare randomness with something simpler.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13917407_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917407_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Mar\\/14 13:23\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-02T13:23:02+0000\'\u003e02\\/Mar\\/14 13:23\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Shai Erera - 02\\/Mar\\/14 13:26\\\"\u003eedited\u003c\\/span\u003e                   I reviewed createSample in the patch, and I think something\'s wrong with it. As I understand it, you set binsize to  1.0\\/sampleRatio , so if sR=0.1, binsize=10. This means that we should keep 1 out of every 10 matching documents. Then you iterate over the bitset, for every group of 10 documents you draw a representative index at random, and clear all other documents. \\n\\n But what seems wrong is that the iteration advances through the \\\"bin\\\" irrespective of which documents were returned. So e.g. if the FBS has 100 docs total, and docs 5, 15, 25, 35, ... returned and say random.nextInt(binsize) picks all indexes but 5, if I understand the code correctly, all bits will be cleared! I double-checked with the following short main: \\n\\n  \\n  public   static  void main( String [] args)  throws  Exception {\\n  Random random =  new  Random();\\n  FixedBitSet sampledBits =  new  FixedBitSet(100);\\n   for  ( int  i = 5; i &lt; 100; i += 10) {\\n    sampledBits.set(i);\\n  }\\n   int  size = 100;\\n   int  binsize = 10;\\n\\n   int  countInBin = 0;\\n   int  randomIndex = random.nextInt(binsize);\\n   for  ( int  i = 0; i &lt; size; i++) {\\n    countInBin++;\\n     if  (countInBin == binsize) {\\n      countInBin = 0;\\n      randomIndex = random.nextInt(binsize);\\n    }\\n     if  (sampledBits.get(i) &amp;&amp; !(countInBin == randomIndex)) {\\n      sampledBits.clear(i);\\n    }\\n  }\\n   for  ( int  i = 0; i &lt; 100; i++) {\\n     if  (sampledBits.get(i)) {\\n       System .out.print(i +  \\\" \\\" );\\n    }\\n  }\\n   System .out.println();\\n}\\n \\n  \\n\\n And indeed in many iterations the main prints nothing, in some only 2-3 docs \\\"survive\\\" the sampling. \\n\\n So first I think Gilad\'s pseudo-code is more correct in that it iterates over the matching documents and I think you should do the same here. When you do that, you no longer need to check bits.get  in order to decide if to clear it. \\n\\n I wonder if your benchmark results are correct (unless you run a MatchAllDocsQuery?) &#8211; can you confirm that you indeed count 10% of the documents? \\n\\n Another point raised by Gilad is the method of sampling. While you implement random sampling, there are other methods like \\\"take the 10th document\\\" etc. which will be faster. I think one can experiment with these through an extension of SampledDocs.createSample (and SamplingFC.createDocs), but just in case you want to give such a simple sampling method a try, would be interesting to compare randomness with something simpler.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13917414\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13917414&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13917414\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13917414_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917414_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Mar\\/14 14:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-02T14:00:45+0000\'\u003e02\\/Mar\\/14 14:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Rob Audenaerde - 02\\/Mar\\/14 14:01\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks all for the insight!\u003c\\/p\u003e\\n\\n\u003cp\u003eMy implementation is not correct in the fact that I indeed run over all the bits in the returning FixedBitSet, and will work better when only looking at the set bits (the real results). The sampling I have implemented will sample the total set of documents which is correct in the MatchAllDocsQuery, but will behave worse and worse the fewer hits are returned; as the chance to sample a hit decreases fast. \u003c\\/p\u003e\\n\\n\u003cp\u003eThe reason I choose to do random sampling in bins instead of just using modulo is to prevent accidental periodicity-effects. For example, if a document is created each day and you sample with modulo 7, you only get the \'monday\' results. This can cause weird biased results. \u003c\\/p\u003e\\n\\n\u003cp\u003eSo my next tasks will be:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eimplement \u003ctt\u003exorshift\u003c\\/tt\u003e, as it  seems a good improvement over the \u003ctt\u003eMath.random()\u003c\\/tt\u003e (although I switched to hte faster \u003ctt\u003eRandom.nextInt( n )\u003c\\/tt\u003e).\u003c\\/li\u003e\\n\\t\u003cli\u003eonly sample the hits\u003c\\/li\u003e\\n\\t\u003cli\u003eremove the package\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13917414_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917414_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/Mar\\/14 14:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-02T14:00:45+0000\'\u003e02\\/Mar\\/14 14:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Rob Audenaerde - 02\\/Mar\\/14 14:01\\\"\u003eedited\u003c\\/span\u003e                   Thanks all for the insight! \\n\\n My implementation is not correct in the fact that I indeed run over all the bits in the returning FixedBitSet, and will work better when only looking at the set bits (the real results). The sampling I have implemented will sample the total set of documents which is correct in the MatchAllDocsQuery, but will behave worse and worse the fewer hits are returned; as the chance to sample a hit decreases fast.  \\n\\n The reason I choose to do random sampling in bins instead of just using modulo is to prevent accidental periodicity-effects. For example, if a document is created each day and you sample with modulo 7, you only get the \'monday\' results. This can cause weird biased results.  \\n\\n So my next tasks will be: \\n\\n \\n\\t implement  xorshift , as it  seems a good improvement over the  Math.random()  (although I switched to hte faster  Random.nextInt( n ) ). \\n\\t only sample the hits \\n\\t remove the package \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13917870\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13917870&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13917870\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13917870_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917870_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Mar\\/14 09:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-03T09:25:47+0000\'\u003e03\\/Mar\\/14 09:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere is a patch. \u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m not totally satisfied with it though. There are two loose ends:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eWhen a segment has many docids but very few hits, they might be skipped altogether. If this happens in many segments, the estimate gets more and more off\u003c\\/li\u003e\\n\\t\u003cli\u003eWhen a segment is small, there might be a few hits that are never touched as the randomIndex in the \'bin-o-hits\' is greater than the index of the hit.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eSome small performance indicators:\u003c\\/p\u003e\\n\\n\u003cp\u003eUsing an in memory index with 10M documents, retrieving 25% of them and using a samplingRatio of 0.001 (skipping the first call, average on the next three)\u003c\\/p\u003e\\n\\n\u003cp\u003eExact:  184 ms.\u003cbr\\/\u003e\\nSampled: 67 ms.\u003c\\/p\u003e\\n\\n\u003cp\u003eNot the 10-fold increase I had hoped for, but significantly faster.\u003c\\/p\u003e\\n\\n\u003cp\u003eBtw. for my use case the two problems I described above are not a real issue. I do a global count anyway, and use this to determine if the facets need to be sampled or not. When they need to be sampled, I know for sure that there are enough hits to give a proper estimate. The price of counting and sampling is lower than the price of retrieving exact facets.  \u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13917870_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917870_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Mar\\/14 09:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-03T09:25:47+0000\'\u003e03\\/Mar\\/14 09:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here is a patch.  \\n\\n I\'m not totally satisfied with it though. There are two loose ends: \\n\\n \\n\\t When a segment has many docids but very few hits, they might be skipped altogether. If this happens in many segments, the estimate gets more and more off \\n\\t When a segment is small, there might be a few hits that are never touched as the randomIndex in the \'bin-o-hits\' is greater than the index of the hit. \\n \\n\\n\\n Some small performance indicators: \\n\\n Using an in memory index with 10M documents, retrieving 25% of them and using a samplingRatio of 0.001 (skipping the first call, average on the next three) \\n\\n Exact:  184 ms. \\nSampled: 67 ms. \\n\\n Not the 10-fold increase I had hoped for, but significantly faster. \\n\\n Btw. for my use case the two problems I described above are not a real issue. I do a global count anyway, and use this to determine if the facets need to be sampled or not. When they need to be sampled, I know for sure that there are enough hits to give a proper estimate. The price of counting and sampling is lower than the price of retrieving exact facets.   \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13917888\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13917888&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13917888\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13917888_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917888_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Mar\\/14 09:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-03T09:52:41+0000\'\u003e03\\/Mar\\/14 09:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMore performance data:\u003c\\/p\u003e\\n\\n\u003cp\u003eExact: 185 ms.\u003cbr\\/\u003e\\nSampled with fixed interval : 51 ms.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe difference between random sampling with index in \'bins\' and a fixed interval is not really that big. Although I probably need a larger index to get a better comparison.  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13917888_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917888_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Mar\\/14 09:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-03T09:52:41+0000\'\u003e03\\/Mar\\/14 09:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    More performance data: \\n\\n Exact: 185 ms. \\nSampled with fixed interval : 51 ms. \\n\\n The difference between random sampling with index in \'bins\' and a fixed interval is not really that big. Although I probably need a larger index to get a better comparison.                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13917915\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13917915&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13917915\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"gilad\\\" id=\\\"commentauthor_13917915_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=gilad\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"gilad\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Gilad Barkai\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917915_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Mar\\/14 10:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-03T10:24:21+0000\'\u003e03\\/Mar\\/14 10:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eNice patch,\u003c\\/p\u003e\\n\\n\u003cp\u003eI was surprised by the gain - only 3.5 time the gain for 1\\/1000 of the documents... I think this is because the random generation takes to long?\u003c\\/p\u003e\\n\\n\u003cp\u003ePerhaps it is to heavy to call \u003ctt\u003e.get(docId)\u003c\\/tt\u003e on the original\\/clone and \u003ctt\u003e.clear()\u003c\\/tt\u003e for every bit.\u003c\\/p\u003e\\n\\n\u003cp\u003eI crafted some code for creating a new (cleared) \u003ctt\u003eFixedBitSet\u003c\\/tt\u003e instead of a clone, and setting only the sampled bits. With it, instead of going on ever document and calling \u003ctt\u003e.get(docId)\u003c\\/tt\u003e I used the iterator, which may be more efficient when it comes to skipping cleared bits (deleted docs?).\u003c\\/p\u003e\\n\\n\u003cp\u003eRan the code on a scenario as you described (Bitset sized at 10M, randomly selected 2.5M of it to be set, and than sampling a thousandth of it to 2,500 documents).\u003cbr\\/\u003e\\nThe results:\u003c\\/p\u003e\\n\u003cul\u003e\\n\\t\u003cli\u003enone-cloned + iterator: ~20ms\u003c\\/li\u003e\\n\\t\u003cli\u003ecloned + for loop on each docId: ~50ms\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e        \u003cspan class=\\\"code-object\\\"\u003eint\u003c\\/span\u003e countInBin = 0;\\n        \u003cspan class=\\\"code-object\\\"\u003eint\u003c\\/span\u003e randomIndex = random.nextInt(binsize);\\n        \u003cspan class=\\\"code-keyword\\\"\u003efinal\u003c\\/span\u003e DocIdSetIterator it = docIdSet.iterator();\\n\\n        \u003cspan class=\\\"code-keyword\\\"\u003etry\u003c\\/span\u003e {\\n          \u003cspan class=\\\"code-keyword\\\"\u003efor\u003c\\/span\u003e( \u003cspan class=\\\"code-object\\\"\u003eint\u003c\\/span\u003e doc = it.nextDoc(); doc != DocIdSetIterator.NO_MORE_DOCS; doc = it.nextDoc()) {\\n            \u003cspan class=\\\"code-keyword\\\"\u003eif\u003c\\/span\u003e (++countInBin == binsize) {\\n              countInBin = 0;\\n              randomIndex = random.nextInt(binsize);\\n            }\\n            \u003cspan class=\\\"code-keyword\\\"\u003eif\u003c\\/span\u003e (countInBin == randomIndex) {\\n              sampledBits.set(doc);\\n            }\\n          }\\n        } \u003cspan class=\\\"code-keyword\\\"\u003ecatch\u003c\\/span\u003e (IOException e) {\\n          \u003cspan class=\\\"code-comment\\\"\u003e\\/\\/ should not happen\\n\u003c\\/span\u003e          \u003cspan class=\\\"code-keyword\\\"\u003ethrow\u003c\\/span\u003e \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e RuntimeException(e);\\n        }\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003eAlso attaching the java file with a main() which compares the two implementations (original still named \u003ctt\u003ecreateSample()\u003c\\/tt\u003e and the proposed one \u003ctt\u003ecreateSample2()\u003c\\/tt\u003e. \u003c\\/p\u003e\\n\\n\u003cp\u003eHopefully, if this will be consistent, the sampling end-to-end should be closer the 10 factor gain as hoped for.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"gilad\\\" id=\\\"commentauthor_13917915_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=gilad\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"gilad\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Gilad Barkai\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917915_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Mar\\/14 10:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-03T10:24:21+0000\'\u003e03\\/Mar\\/14 10:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Nice patch, \\n\\n I was surprised by the gain - only 3.5 time the gain for 1\\/1000 of the documents... I think this is because the random generation takes to long? \\n\\n Perhaps it is to heavy to call  .get(docId)  on the original\\/clone and  .clear()  for every bit. \\n\\n I crafted some code for creating a new (cleared)  FixedBitSet  instead of a clone, and setting only the sampled bits. With it, instead of going on ever document and calling  .get(docId)  I used the iterator, which may be more efficient when it comes to skipping cleared bits (deleted docs?). \\n\\n Ran the code on a scenario as you described (Bitset sized at 10M, randomly selected 2.5M of it to be set, and than sampling a thousandth of it to 2,500 documents). \\nThe results: \\n \\n\\t none-cloned + iterator: ~20ms \\n\\t cloned + for loop on each docId: ~50ms \\n \\n\\n\\n  \\n          int  countInBin = 0;\\n         int  randomIndex = random.nextInt(binsize);\\n         final  DocIdSetIterator it = docIdSet.iterator();\\n\\n         try  {\\n           for (  int  doc = it.nextDoc(); doc != DocIdSetIterator.NO_MORE_DOCS; doc = it.nextDoc()) {\\n             if  (++countInBin == binsize) {\\n              countInBin = 0;\\n              randomIndex = random.nextInt(binsize);\\n            }\\n             if  (countInBin == randomIndex) {\\n              sampledBits.set(doc);\\n            }\\n          }\\n        }  catch  (IOException e) {\\n           \\/\\/ should not happen\\n            throw   new  RuntimeException(e);\\n        }\\n \\n  \\n\\n Also attaching the java file with a main() which compares the two implementations (original still named  createSample()  and the proposed one  createSample2() .  \\n\\n Hopefully, if this will be consistent, the sampling end-to-end should be closer the 10 factor gain as hoped for.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13917922\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13917922&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13917922\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_13917922_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917922_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Mar\\/14 10:40\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-03T10:40:23+0000\'\u003e03\\/Mar\\/14 10:40\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ePatch looks good, and those are nice performance results!\u003c\\/p\u003e\\n\\n\u003cp\u003eBut, can we please remove the SamplingParams class?  There are only 2\u003cbr\\/\u003e\\nparams now; if we get up to 6 or 7 params then maybe we should switch\u003cbr\\/\u003e\\nto a separate config class.  I think one ctor taking only sampleRatio,\u003cbr\\/\u003e\\nand then one other taking all params, is enough?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eWhen a segment has many docids but very few hits, they might be skipped altogether. If this happens in many segments, the estimate gets more and more off\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003eWhen a segment is small, there might be a few hits that are never touched as the randomIndex in the \'bin-o-hits\' is greater than the index of the hit.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think these limitations are acceptable?  In a large index, the\u003cbr\\/\u003e\\nnumber of such \\\"tiny\\\" segments should be a tiny percentage of the doc\u003cbr\\/\u003e\\nspace; if not, something serious is wrong.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cblockquote\u003e\u003cp\u003eAnother option, which would save the 2nd pass, would be to do the sampling during Docs.addDoc.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI considered sampling on the \'addDocument\' but I figured it would be\u003cbr\\/\u003e\\nmore expensive as then for each hit we need to do a random()\u003cbr\\/\u003e\\ncalculation.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHmm, I don\'t think the single-pass option would require\u003cbr\\/\u003e\\nxorshift.nextInt() on every call?  Couldn\'t you keep a countInBin\u003cbr\\/\u003e\\nfield in your SampledDocs, increment it on each Docs.addDoc, and when\u003cbr\\/\u003e\\nit\'s == randomIndex, add to the sampled bits and then pick a new\u003cbr\\/\u003e\\nrandomIndex?  This should save a 2nd pass iteration?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikemccand\\\" id=\\\"commentauthor_13917922_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikemccand\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikemccand\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Michael McCandless\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13917922_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Mar\\/14 10:40\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-03T10:40:23+0000\'\u003e03\\/Mar\\/14 10:40\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Patch looks good, and those are nice performance results! \\n\\n But, can we please remove the SamplingParams class?  There are only 2 \\nparams now; if we get up to 6 or 7 params then maybe we should switch \\nto a separate config class.  I think one ctor taking only sampleRatio, \\nand then one other taking all params, is enough? \\n\\n  When a segment has many docids but very few hits, they might be skipped altogether. If this happens in many segments, the estimate gets more and more off  \\n  When a segment is small, there might be a few hits that are never touched as the randomIndex in the \'bin-o-hits\' is greater than the index of the hit.  \\n\\n I think these limitations are acceptable?  In a large index, the \\nnumber of such \\\"tiny\\\" segments should be a tiny percentage of the doc \\nspace; if not, something serious is wrong. \\n\\n \\n  Another option, which would save the 2nd pass, would be to do the sampling during Docs.addDoc.  \\n\\n I considered sampling on the \'addDocument\' but I figured it would be \\nmore expensive as then for each hit we need to do a random() \\ncalculation.  \\n\\n Hmm, I don\'t think the single-pass option would require \\nxorshift.nextInt() on every call?  Couldn\'t you keep a countInBin \\nfield in your SampledDocs, increment it on each Docs.addDoc, and when \\nit\'s == randomIndex, add to the sampled bits and then pick a new \\nrandomIndex?  This should save a 2nd pass iteration?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13918017\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13918017&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13918017\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13918017_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13918017_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Mar\\/14 12:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-03T12:44:08+0000\'\u003e03\\/Mar\\/14 12:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Rob Audenaerde - 03\\/Mar\\/14 12:46\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eQuick update:\u003c\\/p\u003e\\n\\n\u003cp\u003eI implemented the single pass on the \'addDoc\' method using a fixed interval (which should be the fastest implementation I guess)\u003c\\/p\u003e\\n\\n\u003cp\u003eExact: 180ms\u003cbr\\/\u003e\\nSingle Pass (no-clone) Fixed Interval: 38ms. \u003c\\/p\u003e\\n\\n\u003cp\u003eThis is an almost 4.75x speed-up. \u003c\\/p\u003e\\n\\n\u003cp\u003eI will compare this later on with a single pass random indexed approach. \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eHmm, I don\'t think the single-pass option would require\u003cbr\\/\u003e\\nxorshift.nextInt() on every call? Couldn\'t you keep a countInBin\u003cbr\\/\u003e\\nfield in your SampledDocs, increment it on each Docs.addDoc, and when\u003cbr\\/\u003e\\nit\'s == randomIndex, add to the sampled bits and then pick a new\u003cbr\\/\u003e\\nrandomIndex? This should save a 2nd pass iteration?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYes I thought of this too. I will update this. I think I prefer the single pass option myself, as I do not need the original bitset and the faster option. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13918017_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13918017_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Mar\\/14 12:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-03T12:44:08+0000\'\u003e03\\/Mar\\/14 12:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Rob Audenaerde - 03\\/Mar\\/14 12:46\\\"\u003eedited\u003c\\/span\u003e                   Quick update: \\n\\n I implemented the single pass on the \'addDoc\' method using a fixed interval (which should be the fastest implementation I guess) \\n\\n Exact: 180ms \\nSingle Pass (no-clone) Fixed Interval: 38ms.  \\n\\n This is an almost 4.75x speed-up.  \\n\\n I will compare this later on with a single pass random indexed approach.  \\n\\n \\n Hmm, I don\'t think the single-pass option would require \\nxorshift.nextInt() on every call? Couldn\'t you keep a countInBin \\nfield in your SampledDocs, increment it on each Docs.addDoc, and when \\nit\'s == randomIndex, add to the sampled bits and then pick a new \\nrandomIndex? This should save a 2nd pass iteration?  \\n\\n Yes I thought of this too. I will update this. I think I prefer the single pass option myself, as I do not need the original bitset and the faster option.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13918164\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13918164&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13918164\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13918164_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13918164_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Mar\\/14 15:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-03T15:36:34+0000\'\u003e03\\/Mar\\/14 15:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e+1 for removing SamplingParams.\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m OK if the original collected hits is lost, let\'s just make sure we document this on the collector. Perhaps in the future (separate issue) we can add another collector (or enhance this one) to allow you to get both the original docs and the sampled docs.\u003c\\/p\u003e\\n\\n\u003cp\u003eI wonder what are the performance implications of sampling during collection or post collection. In the past, Mike and I saw that not interfering with collection improves performance, though what we measured was accessing the ordinals-DV during collection. Just wondering if in-collection performs better than post-collection. Especially if sampleRatio is low, it means we set far fewer hits on the FBS, just to clean most of them afterwards. On the other hand we add calls to random.nextInt\\/Double, so that\'s a tradeoff which would be good to measure. We don\'t even need random.nextDouble(), we can do what you\\/mike suggested above &#8211; work in \\\"bins\\\", for each bin draw a random index and discard all hits given to addDoc unless it is the binIndex.\u003c\\/p\u003e\\n\\n\u003cp\u003eI also think that if we keep the original FBS (whether we clone-and-clear, create-new-sampled-one or whatever), we should iterate on the matching docs and not all the bits. I don\'t see the logic of why that\'s good at all, unless the bitset.cardinality() is very big (like maybe 75% of the bitset size)? Of course, if we move to sample in-collection, that\'s not an issue at all.\u003c\\/p\u003e\\n\\n\u003cp\u003eRob, I want to make sure we are all on the same page as to what we want to achieve in this issue (helps scope it):\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eAdd SamplingFacetsCollector which takes \u003ctt\u003esampleRatio\u003c\\/tt\u003e and optional \u003ctt\u003eseed\u003c\\/tt\u003e and random-samples the matching docs so that facets are counted on fewer hits\u003c\\/li\u003e\\n\\t\u003cli\u003eWe should note that as a result the weights computed for facets are approximation only, and the application needs to correct them if it wants (e.g. multiplying by the inverse of \u003ctt\u003esampleRatio\u003c\\/tt\u003e or exact count etc.). At any rate, this is something that we don\'t plan to tackle in this issue, right?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eMaybe we should call it RandomSamplingFacetsCollector to denote it\'s a random sample (vs e.g the approaches mentioned by Gilad above)? Then the parameter \u003ctt\u003eseed\u003c\\/tt\u003e is clear as to what it means.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13918164_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13918164_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Mar\\/14 15:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-03T15:36:34+0000\'\u003e03\\/Mar\\/14 15:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    +1 for removing SamplingParams. \\n\\n I\'m OK if the original collected hits is lost, let\'s just make sure we document this on the collector. Perhaps in the future (separate issue) we can add another collector (or enhance this one) to allow you to get both the original docs and the sampled docs. \\n\\n I wonder what are the performance implications of sampling during collection or post collection. In the past, Mike and I saw that not interfering with collection improves performance, though what we measured was accessing the ordinals-DV during collection. Just wondering if in-collection performs better than post-collection. Especially if sampleRatio is low, it means we set far fewer hits on the FBS, just to clean most of them afterwards. On the other hand we add calls to random.nextInt\\/Double, so that\'s a tradeoff which would be good to measure. We don\'t even need random.nextDouble(), we can do what you\\/mike suggested above &#8211; work in \\\"bins\\\", for each bin draw a random index and discard all hits given to addDoc unless it is the binIndex. \\n\\n I also think that if we keep the original FBS (whether we clone-and-clear, create-new-sampled-one or whatever), we should iterate on the matching docs and not all the bits. I don\'t see the logic of why that\'s good at all, unless the bitset.cardinality() is very big (like maybe 75% of the bitset size)? Of course, if we move to sample in-collection, that\'s not an issue at all. \\n\\n Rob, I want to make sure we are all on the same page as to what we want to achieve in this issue (helps scope it): \\n\\n \\n\\t Add SamplingFacetsCollector which takes  sampleRatio  and optional  seed  and random-samples the matching docs so that facets are counted on fewer hits \\n\\t We should note that as a result the weights computed for facets are approximation only, and the application needs to correct them if it wants (e.g. multiplying by the inverse of  sampleRatio  or exact count etc.). At any rate, this is something that we don\'t plan to tackle in this issue, right? \\n \\n\\n\\n Maybe we should call it RandomSamplingFacetsCollector to denote it\'s a random sample (vs e.g the approaches mentioned by Gilad above)? Then the parameter  seed  is clear as to what it means.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13919138\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13919138&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13919138\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13919138_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919138_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 08:39\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T08:39:29+0000\'\u003e04\\/Mar\\/14 08:39\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eNew patch. \u003c\\/p\u003e\\n\\n\u003cp\u003eMy little benchmark results:\u003c\\/p\u003e\\n\\n\u003cp\u003eExact  :176 ms\u003cbr\\/\u003e\\nSampled:36 ms\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eI removed the \u003ctt\u003eSamplingParams\u003c\\/tt\u003e.\u003c\\/li\u003e\\n\\t\u003cli\u003eI use random sampling in bins in the \u003ctt\u003eaddDoc\u003c\\/tt\u003e. This has almost no performance impact over fix-internal samling when running with a sampleRatio of 0.001.\u003c\\/li\u003e\\n\\t\u003cli\u003eRenamed the class to \u003ctt\u003eRandomSamplingFacetsCollector\u003c\\/tt\u003e\u003c\\/li\u003e\\n\\t\u003cli\u003eI decided to always add the first document of a segment. This counters the fact that randomindex in the last bin is larger than the segment-size. Gives slightly better results.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\\n\u003cp\u003eI do have some questions:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eCode style-wise: I see \u003ctt\u003ethis.\u003c\\/tt\u003e is sometimes used, and sometimes not. What do you prefer?\u003c\\/li\u003e\\n\\t\u003cli\u003eIt seems \u003ctt\u003eFixedBitSet\u003c\\/tt\u003e contains a lot of empty space, as only 1 in 1000 hits are preserved. I\'m not that familiar with all the DocIdSet implementations, but maybe there are more suitable subclasses?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13919138_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919138_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 08:39\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T08:39:29+0000\'\u003e04\\/Mar\\/14 08:39\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    New patch.  \\n\\n My little benchmark results: \\n\\n Exact  :176 ms \\nSampled:36 ms \\n\\n \\n\\t I removed the  SamplingParams . \\n\\t I use random sampling in bins in the  addDoc . This has almost no performance impact over fix-internal samling when running with a sampleRatio of 0.001. \\n\\t Renamed the class to  RandomSamplingFacetsCollector  \\n\\t I decided to always add the first document of a segment. This counters the fact that randomindex in the last bin is larger than the segment-size. Gives slightly better results. \\n \\n\\n\\n\\n I do have some questions: \\n\\n \\n\\t Code style-wise: I see  this.  is sometimes used, and sometimes not. What do you prefer? \\n\\t It seems  FixedBitSet  contains a lot of empty space, as only 1 in 1000 hits are preserved. I\'m not that familiar with all the DocIdSet implementations, but maybe there are more suitable subclasses? \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13919160\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13919160&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13919160\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13919160_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919160_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 09:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T09:02:56+0000\'\u003e04\\/Mar\\/14 09:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ebtw: \u003c\\/p\u003e\\n\\n\u003cp\u003eMy use case is that I would like to present a \'overview\' of the search results using facets. Because the index might well be over 10M documents, I need the speed-up that comes from sampling the facets.  The results do not need to be exact; as the user will be informed that the results are estimated. \u003c\\/p\u003e\\n\\n\u003cp\u003eI do want to provide a \'order of magnitude\' comparison, that is why I need the \u003ctt\u003ecorrectCountFacetResults\u003c\\/tt\u003e. It is easier for the user to see that it is about 10.000 than just provide a percentage.  \u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13919160_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919160_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 09:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T09:02:56+0000\'\u003e04\\/Mar\\/14 09:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    btw:  \\n\\n My use case is that I would like to present a \'overview\' of the search results using facets. Because the index might well be over 10M documents, I need the speed-up that comes from sampling the facets.  The results do not need to be exact; as the user will be informed that the results are estimated.  \\n\\n I do want to provide a \'order of magnitude\' comparison, that is why I need the  correctCountFacetResults . It is easier for the user to see that it is about 10.000 than just provide a percentage.   \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13919207\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13919207&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13919207\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13919207_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919207_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 10:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T10:02:01+0000\'\u003e04\\/Mar\\/14 10:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks Rob. Few comments:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eTypo in jdoc: \\\"to low\\\" &#8211; \\\"too low\\\"?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eAbout constructors: can we have two ctors, one taking samplingRatio and another taking all the parameters?\\n\\t\u003cul\u003e\\n\\t\\t\u003cli\u003eAnd then I think that seed=0 could be used as \\\"generate a seed for me\\\", so you don\'t need to take a Long (can take primitive)\u003c\\/li\u003e\\n\\t\u003c\\/ul\u003e\\n\\t\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eI\'d make the first ctor call \u003ctt\u003ethis(false, ratio, 0)\u003c\\/tt\u003e and fold in init() inside the all-params ctor.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eIt\'s a matter of personal preference, but I like that static classes are either at the top of the class (above all class members) or at the end .. but not in the middle \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003e\u003ctt\u003ecorrectCountFacetResults\u003c\\/tt\u003e\\n\\t\u003cul\u003e\\n\\t\\t\u003cli\u003eI think this is redundant in the jdoc \\\"Corrects FacetCounts if sampling is used.\\\" &#8211; you obviously call this method if you used sampling?\u003c\\/li\u003e\\n\\t\u003c\\/ul\u003e\\n\\t\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eXORShift64Random: maybe we should move it under o.a.l.util (and lucene\\/core)? I think it\'s a useful utility class in general?\\n\\t\u003cul\u003e\\n\\t\\t\u003cli\u003eAt any rate, it should be static class and let\'s not nest it inside SampledDocs\u003c\\/li\u003e\\n\\t\u003c\\/ul\u003e\\n\\t\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eNow that the collector sub-samples during collection and does not record the original docs, I think SampledDocs can be declared private (static) class as I don\'t see any use for someone to care if it\'s SampledDocs or just Docs?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cblockquote\u003e\u003cp\u003eCode style-wise: I see this. is sometimes used, and sometimes not. What do you prefer?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThis is a personal preference. I use \u003ctt\u003ethis.\u003c\\/tt\u003e only when the method has a parameter which conflicts w\\/ class members and I often use it explicitly in the ctor.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eIt seems FixedBitSet contains a lot of empty space\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eYou can use WAH8DocIdSet which offers better compression, but it means that the collector would need to declare it doesn\'t support out-of-order collection. If \u003ctt\u003ekeepScores=true\u003c\\/tt\u003e it doesn\'t support that anyway, but I think you can explore with it? Can you benchmark with it and report back? If the results are good, maybe we can turn off out-of-order collection for sampling by default and let the app override this behavior if it cares about out-of-order?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13919207_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919207_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 10:02\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T10:02:01+0000\'\u003e04\\/Mar\\/14 10:02\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks Rob. Few comments: \\n\\n \\n\\t Typo in jdoc: \\\"to low\\\" &#8211; \\\"too low\\\"? \\n \\n\\n\\n \\n\\t About constructors: can we have two ctors, one taking samplingRatio and another taking all the parameters?\\n\\t \\n\\t\\t And then I think that seed=0 could be used as \\\"generate a seed for me\\\", so you don\'t need to take a Long (can take primitive) \\n\\t \\n\\t \\n \\n\\n\\n \\n\\t I\'d make the first ctor call  this(false, ratio, 0)  and fold in init() inside the all-params ctor. \\n \\n\\n\\n \\n\\t It\'s a matter of personal preference, but I like that static classes are either at the top of the class (above all class members) or at the end .. but not in the middle   \\n \\n\\n\\n \\n\\t  correctCountFacetResults \\n\\t \\n\\t\\t I think this is redundant in the jdoc \\\"Corrects FacetCounts if sampling is used.\\\" &#8211; you obviously call this method if you used sampling? \\n\\t \\n\\t \\n \\n\\n\\n \\n\\t XORShift64Random: maybe we should move it under o.a.l.util (and lucene\\/core)? I think it\'s a useful utility class in general?\\n\\t \\n\\t\\t At any rate, it should be static class and let\'s not nest it inside SampledDocs \\n\\t \\n\\t \\n \\n\\n\\n \\n\\t Now that the collector sub-samples during collection and does not record the original docs, I think SampledDocs can be declared private (static) class as I don\'t see any use for someone to care if it\'s SampledDocs or just Docs? \\n \\n\\n\\n  Code style-wise: I see this. is sometimes used, and sometimes not. What do you prefer?  \\n\\n This is a personal preference. I use  this.  only when the method has a parameter which conflicts w\\/ class members and I often use it explicitly in the ctor. \\n\\n  It seems FixedBitSet contains a lot of empty space  \\n\\n You can use WAH8DocIdSet which offers better compression, but it means that the collector would need to declare it doesn\'t support out-of-order collection. If  keepScores=true  it doesn\'t support that anyway, but I think you can explore with it? Can you benchmark with it and report back? If the results are good, maybe we can turn off out-of-order collection for sampling by default and let the app override this behavior if it cares about out-of-order?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13919227\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13919227&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13919227\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13919227_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919227_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 10:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T10:34:25+0000\'\u003e04\\/Mar\\/14 10:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Rob Audenaerde - 04\\/Mar\\/14 10:35\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI have taken these points into account in the new patch.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eSeparated \u003ctt\u003eXORShift64Random\u003c\\/tt\u003e to o.a.l.util\u003c\\/li\u003e\\n\\t\u003cli\u003eMoved SampledDocs and declared private\u003c\\/li\u003e\\n\\t\u003cli\u003eFixed some typos \\/ redundancy in the javadocs.\u003c\\/li\u003e\\n\\t\u003cli\u003eRefactored the c\'tors, removed the init.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13919227_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919227_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 10:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T10:34:25+0000\'\u003e04\\/Mar\\/14 10:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Rob Audenaerde - 04\\/Mar\\/14 10:35\\\"\u003eedited\u003c\\/span\u003e                   I have taken these points into account in the new patch. \\n\\n \\n\\t Separated  XORShift64Random  to o.a.l.util \\n\\t Moved SampledDocs and declared private \\n\\t Fixed some typos \\/ redundancy in the javadocs. \\n\\t Refactored the c\'tors, removed the init. \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13919240\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13919240&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13919240\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13919240_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919240_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 10:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T10:56:37+0000\'\u003e04\\/Mar\\/14 10:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Shai Erera - 04\\/Mar\\/14 10:57\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eLooks good Rob. I apologize for not mentioning this, but now that XORShift64Random is a public class, it has to have jdocs on all methods and ctors, otherwise documentation linting will fail. Can you please add some in your next patch?\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso, are you planning to write some unit tests? You can either start with one of the existing tests or look at old tests. I think maybe start new will be easier. The key point is that in order to test sampling, we need to index many documents to make the samples \u003cem\u003ecount\u003c\\/em\u003e. So e.g. we want to make sure that if we give 10% sample ratio, then a category\'s count is ~10% of the expected count.\u003c\\/p\u003e\\n\\n\u003cp\u003eIn the old tests we had issues w\\/ false positives - tests that failed on these asserts just because the nature of sampling isn\'t deterministic. Would be good if we can craft the test such that on one hand it does test sampling, but on the other hand doesn\'t cause unwanted noise.\u003c\\/p\u003e\\n\\n\u003cp\u003eI do think we can optimize SampledDocs to not use FixedBitSet even in the case of out-of-order collection (no scores) by keeping an int[] or some other compressed array, especially when the sample ratio is so small. We can do that later though - we need tests first.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13919240_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919240_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 10:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T10:56:37+0000\'\u003e04\\/Mar\\/14 10:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Shai Erera - 04\\/Mar\\/14 10:57\\\"\u003eedited\u003c\\/span\u003e                   Looks good Rob. I apologize for not mentioning this, but now that XORShift64Random is a public class, it has to have jdocs on all methods and ctors, otherwise documentation linting will fail. Can you please add some in your next patch? \\n\\n Also, are you planning to write some unit tests? You can either start with one of the existing tests or look at old tests. I think maybe start new will be easier. The key point is that in order to test sampling, we need to index many documents to make the samples  count . So e.g. we want to make sure that if we give 10% sample ratio, then a category\'s count is ~10% of the expected count. \\n\\n In the old tests we had issues w\\/ false positives - tests that failed on these asserts just because the nature of sampling isn\'t deterministic. Would be good if we can craft the test such that on one hand it does test sampling, but on the other hand doesn\'t cause unwanted noise. \\n\\n I do think we can optimize SampledDocs to not use FixedBitSet even in the case of out-of-order collection (no scores) by keeping an int[] or some other compressed array, especially when the sample ratio is so small. We can do that later though - we need tests first.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13919311\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13919311&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13919311\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13919311_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919311_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 11:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T11:51:43+0000\'\u003e04\\/Mar\\/14 11:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI will add the documentation to the XORShift64Random. \u003c\\/p\u003e\\n\\n\u003cp\u003eAnd of course, the tests. I have already some code that does testing in my mini benchmark. I will reduce the document count, for the unit tests need to be as fast as possible. Probably about 100 docs will do fine. Providing a seed will make sure we can test exact; but I will try to also add a test that uses a random seed and tests if the result fits in a given range. Should be doable, will take the other tests as example. \u003c\\/p\u003e\\n\\n\u003cp\u003eBtw. I also tried the \u003ctt\u003eWAH8DocIdSet\u003c\\/tt\u003e with \u003ctt\u003esetInterval(8)\u003c\\/tt\u003e. It is slightly slower (36 ms for FSB, 42 ms for WAH8) but it is a too small margin to draw real conclusions I think. I agree it is better to have some tests first.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13919311_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919311_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 11:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T11:51:43+0000\'\u003e04\\/Mar\\/14 11:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I will add the documentation to the XORShift64Random.  \\n\\n And of course, the tests. I have already some code that does testing in my mini benchmark. I will reduce the document count, for the unit tests need to be as fast as possible. Probably about 100 docs will do fine. Providing a seed will make sure we can test exact; but I will try to also add a test that uses a random seed and tests if the result fits in a given range. Should be doable, will take the other tests as example.  \\n\\n Btw. I also tried the  WAH8DocIdSet  with  setInterval(8) . It is slightly slower (36 ms for FSB, 42 ms for WAH8) but it is a too small margin to draw real conclusions I think. I agree it is better to have some tests first.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13919348\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13919348&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13919348\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rcmuir\\\" id=\\\"commentauthor_13919348_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rcmuir\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rcmuir\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Robert Muir\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919348_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 12:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T12:58:43+0000\'\u003e04\\/Mar\\/14 12:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e-1 to adding this XOrShiftRandom to lucene\\/core. There is absolutely no need for it to be here. We are an IR library, not a JDK. Just because its \\\"useful\\\" is \u003cem\u003enot\u003c\\/em\u003e good enough to expose something as a public API. \u003c\\/p\u003e\\n\\n\u003cp\u003eMoreover, this class does not extend java.util.Random, has no statistical tests, etc. Doesn\'t belong as a public api in lucene core. please keep it package private in facets.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rcmuir\\\" id=\\\"commentauthor_13919348_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rcmuir\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rcmuir\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Robert Muir\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919348_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 12:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T12:58:43+0000\'\u003e04\\/Mar\\/14 12:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    -1 to adding this XOrShiftRandom to lucene\\/core. There is absolutely no need for it to be here. We are an IR library, not a JDK. Just because its \\\"useful\\\" is  not  good enough to expose something as a public API.  \\n\\n Moreover, this class does not extend java.util.Random, has no statistical tests, etc. Doesn\'t belong as a public api in lucene core. please keep it package private in facets.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13919380\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13919380&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13919380\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"gilad\\\" id=\\\"commentauthor_13919380_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=gilad\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"gilad\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Gilad Barkai\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919380_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 13:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T13:24:01+0000\'\u003e04\\/Mar\\/14 13:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eSorry if this was mentioned before and I missed it - how can sampling work correctly (correctness of the end result) if it\'s done \'on the fly\' ? \u003cbr\\/\u003e\\nBeforehand, one cannot know the number of documents that would match the query, as such, the sampling ratio is unknown, given that we can afford faceted search over N documents only.\u003cbr\\/\u003e\\nIf the query yields 10K results and the sampling ration is 0.001 - would 10 documents make a good sample?\u003cbr\\/\u003e\\nSame if the query yields 100M results - is 10K sample good enough? Is it perhaps to much?\u003cbr\\/\u003e\\nI find it hard to figure a pre-defined sampling ratio which would fit different cases.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"gilad\\\" id=\\\"commentauthor_13919380_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=gilad\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"gilad\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Gilad Barkai\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919380_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 13:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T13:24:01+0000\'\u003e04\\/Mar\\/14 13:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Sorry if this was mentioned before and I missed it - how can sampling work correctly (correctness of the end result) if it\'s done \'on the fly\' ?  \\nBeforehand, one cannot know the number of documents that would match the query, as such, the sampling ratio is unknown, given that we can afford faceted search over N documents only. \\nIf the query yields 10K results and the sampling ration is 0.001 - would 10 documents make a good sample? \\nSame if the query yields 100M results - is 10K sample good enough? Is it perhaps to much? \\nI find it hard to figure a pre-defined sampling ratio which would fit different cases.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13919559\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13919559&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13919559\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13919559_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919559_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 16:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T16:10:33+0000\'\u003e04\\/Mar\\/14 16:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThat\'s good point Gilad. I think once this gets into Lucene it means other people will use it and we should offer a good sampling collector that works in more than one extreme case (always tons of results) even if it\'s well documented. One of the problems is that when you have a query Q, you don\'t know in advance how many documents it\'s going to match.\u003c\\/p\u003e\\n\\n\u003cp\u003eThat\'s where the min\\/maxDocsToEvaluate came in handy in the previous solution &#8211; it made SamplingFC smart and adaptive. If the query matched very few documents, not only it didn\'t bother to sample and save CPU, it also didn\'t come up w\\/ a crappy sample (as Gilad says, 10 docs). The previous sampling worked on the entire query, the new collector can be used to use these threshold per-segment.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut I feel that this has to give a qualitative solution &#8211; the sample has be meaningful in order to be considered as representative at all, and we should let the app specify what \\\"meaningful\\\" is to it, in the form of minDocsToEvaluate(PerSegment).\u003c\\/p\u003e\\n\\n\u003cp\u003eAnd since sampling is about improving speed, we should also let the app specify a maxDocsToEvaluate(PerSegment), so a 1% sample still doesn\'t end up evaluating millions of documents.\u003c\\/p\u003e\\n\\n\u003cp\u003eRobert, I agree w\\/ your comment on XORShiftRandom - it was a mistake to suggest moving it under core.\u003c\\/p\u003e\\n\\n\u003cp\u003eRob, I feel like I\'ve thrown you back and forth with the patch. If you want, I can take a stab at making the changes to SFC.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13919559_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13919559_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Mar\\/14 16:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-04T16:10:33+0000\'\u003e04\\/Mar\\/14 16:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    That\'s good point Gilad. I think once this gets into Lucene it means other people will use it and we should offer a good sampling collector that works in more than one extreme case (always tons of results) even if it\'s well documented. One of the problems is that when you have a query Q, you don\'t know in advance how many documents it\'s going to match. \\n\\n That\'s where the min\\/maxDocsToEvaluate came in handy in the previous solution &#8211; it made SamplingFC smart and adaptive. If the query matched very few documents, not only it didn\'t bother to sample and save CPU, it also didn\'t come up w\\/ a crappy sample (as Gilad says, 10 docs). The previous sampling worked on the entire query, the new collector can be used to use these threshold per-segment. \\n\\n But I feel that this has to give a qualitative solution &#8211; the sample has be meaningful in order to be considered as representative at all, and we should let the app specify what \\\"meaningful\\\" is to it, in the form of minDocsToEvaluate(PerSegment). \\n\\n And since sampling is about improving speed, we should also let the app specify a maxDocsToEvaluate(PerSegment), so a 1% sample still doesn\'t end up evaluating millions of documents. \\n\\n Robert, I agree w\\/ your comment on XORShiftRandom - it was a mistake to suggest moving it under core. \\n\\n Rob, I feel like I\'ve thrown you back and forth with the patch. If you want, I can take a stab at making the changes to SFC.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13920642\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13920642&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13920642\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13920642_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13920642_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Mar\\/14 08:17\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-05T08:17:58+0000\'\u003e05\\/Mar\\/14 08:17\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Rob Audenaerde - 05\\/Mar\\/14 08:18\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi all, good points.\u003c\\/p\u003e\\n\\n\u003cp\u003eActually, in my application, I always do a count before any other search\\/facetting. This means I can set a sampling ratio to be appropriate for the number of results (or even decide not to do sampling at all). So for me, I have enough functionality as-is in this issue.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut of course if would be nice if it could be implemented in one pass, because there are more people using Lucene \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eI think it would not be that hard to implement a lower-bound; if for example 15.000 would be the minimum number of documents before sampling kicks in, the \u003ctt\u003eRandomSamplingFacetCollector\u003c\\/tt\u003e could also collect docs in a int\u003cspan class=\\\"error\\\"\u003e&#91;15000&#93;\u003c\\/span\u003e to make sure that if there are less hits, the int[] is used, else the sampled set. The exact-part collector can stop collecting after these 15k docs.\u003c\\/p\u003e\\n\\n\u003cp\u003eA bit harder is the upper-bound, as you only know how many hits there are after collecting them all. To prevent collecting all the documents, you need a sampling rate to start skipping documents. If the result then contains too much document; the sampled result can be re-sampled to the desired size. I think this is more like the previous implementation of the SamplingCollector.\u003c\\/p\u003e\\n\\n\u003cp\u003eI have already implemented a small test (and fixed an off-by-one using it) ; I will create a patch today that contains this test and the \u003ctt\u003exorshift\u003c\\/tt\u003e merged back into the collector.  \u003c\\/p\u003e\\n\\n\u003cp\u003eIs it a good idea to explore this upper-bound\\/lower-bound approach? Maybe you already thought of alternative approaches as well?\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13920642_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13920642_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Mar\\/14 08:17\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-05T08:17:58+0000\'\u003e05\\/Mar\\/14 08:17\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Rob Audenaerde - 05\\/Mar\\/14 08:18\\\"\u003eedited\u003c\\/span\u003e                   Hi all, good points. \\n\\n Actually, in my application, I always do a count before any other search\\/facetting. This means I can set a sampling ratio to be appropriate for the number of results (or even decide not to do sampling at all). So for me, I have enough functionality as-is in this issue. \\n\\n But of course if would be nice if it could be implemented in one pass, because there are more people using Lucene   \\n\\n I think it would not be that hard to implement a lower-bound; if for example 15.000 would be the minimum number of documents before sampling kicks in, the  RandomSamplingFacetCollector  could also collect docs in a int &#91;15000&#93;  to make sure that if there are less hits, the int[] is used, else the sampled set. The exact-part collector can stop collecting after these 15k docs. \\n\\n A bit harder is the upper-bound, as you only know how many hits there are after collecting them all. To prevent collecting all the documents, you need a sampling rate to start skipping documents. If the result then contains too much document; the sampled result can be re-sampled to the desired size. I think this is more like the previous implementation of the SamplingCollector. \\n\\n I have already implemented a small test (and fixed an off-by-one using it) ; I will create a patch today that contains this test and the  xorshift  merged back into the collector.   \\n\\n Is it a good idea to explore this upper-bound\\/lower-bound approach? Maybe you already thought of alternative approaches as well? \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13920688\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13920688&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13920688\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13920688_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13920688_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Mar\\/14 09:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-05T09:22:33+0000\'\u003e05\\/Mar\\/14 09:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cul\u003e\\n\\t\u003cli\u003eReverted move of XorShift64Random\u003c\\/li\u003e\\n\\t\u003cli\u003eAdded basic test for random sampling. Uses sampling ratios of 1.0d and 0.1d. 1.0d should behave like no sampling at all.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13920688_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13920688_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Mar\\/14 09:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-05T09:22:33+0000\'\u003e05\\/Mar\\/14 09:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n\\t Reverted move of XorShift64Random \\n\\t Added basic test for random sampling. Uses sampling ratios of 1.0d and 0.1d. 1.0d should behave like no sampling at all. \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13920771\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13920771&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13920771\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13920771_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13920771_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Mar\\/14 11:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-05T11:50:47+0000\'\u003e05\\/Mar\\/14 11:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eActually, in my application, I always do a count before any other search\\/facetting\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eHmm, what do you mean? How do you count the number of hits before you execute the search?\u003c\\/p\u003e\\n\\n\u003cp\u003eThe reason why the previous sampling solution did not do sampling per-segment is that in order to get to a good sample size and representative set, you need to know first how many documents the query matches and only then you can do a good sampling, taking min\\/maxSampleSize into account. Asking the app to define these boundaries per-segment is odd because app may not know how many segments an index has, or even the distribution of the segment sizes. For instance, if an index contains 10 segments and the app is willing to fully evaluate 200K docs in order to get a good sampled set, it would be wrong to specify that each segment needs to sample 20K docs, because the last two segments may be tiny and so in practice you\'ll end up w\\/ a sampled set of ~160K docs. On the other hand, if the search is evaluated entirely, such that you know the List&lt;MatchingDocs&gt; before sampling, you can now take a global decision about which documents to sample, given the min\\/maxSampleSize constraints.\u003c\\/p\u003e\\n\\n\u003cp\u003eAt the beginning of this issue I thought that sampling could work like that:\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003eFacetsCollector fc = \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e FacetsCollector(...);\\nsearcher.search(q, fc);\\nSampler sampler = \u003cspan class=\\\"code-keyword\\\"\u003enew\u003c\\/span\u003e RandomSampler(...);\\nList&lt;MatchingDocs&gt; sampledDocs = sampler.sample(fc.getMachingDoc());\\nfacets.count(sampledDocs);\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003eBut the Facets impls all take FacetsCollector, so perhaps what we need is to implement RandomSamplingFacetsCollector and only override getMatchingDocs() to return the sampled set (and of course cache it). If we\'ll later want to return the original set, it\'s trivial to cache it aside (I don\'t think we should do it in this issue).\u003c\\/p\u003e\\n\\n\u003cp\u003eI realize it means we allocate bitsets unnecessarily, but that a correct way to create a meaningful sample. Unless we can do it per-segment, but I think it\'s tricky since we never know how many hits a segment will match a priori. Perhaps we should focus here to get a correct and meaningful sample, and improve performance only if it becomes a bottleneck? After all, setting a bit in a bitset if far faster than scoring the document.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13920771_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13920771_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Mar\\/14 11:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-05T11:50:47+0000\'\u003e05\\/Mar\\/14 11:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Actually, in my application, I always do a count before any other search\\/facetting  \\n\\n Hmm, what do you mean? How do you count the number of hits before you execute the search? \\n\\n The reason why the previous sampling solution did not do sampling per-segment is that in order to get to a good sample size and representative set, you need to know first how many documents the query matches and only then you can do a good sampling, taking min\\/maxSampleSize into account. Asking the app to define these boundaries per-segment is odd because app may not know how many segments an index has, or even the distribution of the segment sizes. For instance, if an index contains 10 segments and the app is willing to fully evaluate 200K docs in order to get a good sampled set, it would be wrong to specify that each segment needs to sample 20K docs, because the last two segments may be tiny and so in practice you\'ll end up w\\/ a sampled set of ~160K docs. On the other hand, if the search is evaluated entirely, such that you know the List&lt;MatchingDocs&gt; before sampling, you can now take a global decision about which documents to sample, given the min\\/maxSampleSize constraints. \\n\\n At the beginning of this issue I thought that sampling could work like that: \\n\\n  \\n FacetsCollector fc =  new  FacetsCollector(...);\\nsearcher.search(q, fc);\\nSampler sampler =  new  RandomSampler(...);\\nList&lt;MatchingDocs&gt; sampledDocs = sampler.sample(fc.getMachingDoc());\\nfacets.count(sampledDocs);\\n \\n  \\n\\n But the Facets impls all take FacetsCollector, so perhaps what we need is to implement RandomSamplingFacetsCollector and only override getMatchingDocs() to return the sampled set (and of course cache it). If we\'ll later want to return the original set, it\'s trivial to cache it aside (I don\'t think we should do it in this issue). \\n\\n I realize it means we allocate bitsets unnecessarily, but that a correct way to create a meaningful sample. Unless we can do it per-segment, but I think it\'s tricky since we never know how many hits a segment will match a priori. Perhaps we should focus here to get a correct and meaningful sample, and improve performance only if it becomes a bottleneck? After all, setting a bit in a bitset if far faster than scoring the document.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13920822\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13920822&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13920822\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13920822_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13920822_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Mar\\/14 13:18\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-05T13:18:09+0000\'\u003e05\\/Mar\\/14 13:18\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eHow do you count the number of hits before you execute the search?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eWell, I do a search of course, but collect the hits using a \u003ctt\u003eTotalHitCountCollector\u003c\\/tt\u003e and not retrieve any stored values. I did not find any other way to determine for sure if I needed to do sampling or not. I know this takes time. When I first implemented it however, it was faster to do a count and determine whether provide exact facets or needed to sample. Not optimal, but it worked. And because I could use sampling in the facets, the total time (1 pass counting, 1 pass sampling facets) was still much less than the time it would take to do a exact facet and count in one pass.   \u003c\\/p\u003e\\n\\n\u003cp\u003eWhen only considering the \u003ctt\u003esamplingThreshold\u003c\\/tt\u003e, facetting should still be doable without counting first. It can be done by storing the first \u003ctt\u003esamplingThreshold\u003c\\/tt\u003e documents (in the addDoc) in a separate array (in the collector) without sampling. This way the count is not needed to decide on whether to sample or not as there will always be sampled. Only the sampled result is discarded if the total number of hits &lt;= minSampleSize. I agree that this is not the nicest way to get a sample. (but can reduce the time to retrieve estimated facet results by 5 when using a sampling rate of 1 in 1000).\u003c\\/p\u003e\\n\\n\u003cp\u003eThe alternative is to do it more like in your snippet (and more like the first approach); collect all documents and sample afterwards. This way you know the number of hits and adjusting the sample rate based on parameters is more straightforward. \u003c\\/p\u003e\\n\\n\u003cp\u003eEither way is faster than using exact facets, so both ways are a win. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13920822_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13920822_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Mar\\/14 13:18\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-05T13:18:09+0000\'\u003e05\\/Mar\\/14 13:18\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n How do you count the number of hits before you execute the search?  \\n Well, I do a search of course, but collect the hits using a  TotalHitCountCollector  and not retrieve any stored values. I did not find any other way to determine for sure if I needed to do sampling or not. I know this takes time. When I first implemented it however, it was faster to do a count and determine whether provide exact facets or needed to sample. Not optimal, but it worked. And because I could use sampling in the facets, the total time (1 pass counting, 1 pass sampling facets) was still much less than the time it would take to do a exact facet and count in one pass.    \\n\\n When only considering the  samplingThreshold , facetting should still be doable without counting first. It can be done by storing the first  samplingThreshold  documents (in the addDoc) in a separate array (in the collector) without sampling. This way the count is not needed to decide on whether to sample or not as there will always be sampled. Only the sampled result is discarded if the total number of hits &lt;= minSampleSize. I agree that this is not the nicest way to get a sample. (but can reduce the time to retrieve estimated facet results by 5 when using a sampling rate of 1 in 1000). \\n\\n The alternative is to do it more like in your snippet (and more like the first approach); collect all documents and sample afterwards. This way you know the number of hits and adjusting the sample rate based on parameters is more straightforward.  \\n\\n Either way is faster than using exact facets, so both ways are a win.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13920897\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13920897&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13920897\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13920897_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13920897_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Mar\\/14 14:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-05T14:41:35+0000\'\u003e05\\/Mar\\/14 14:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eWell, I do a search of course, but collect the hits using a TotalHitCountCollector and not retrieve any stored values\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThat means that you evaluate the query twice, which is expensive ... but also, this doesn\'t guarantee to provide a \\\"correct\\\" sample. So say you found out the query matches 10M documents and you decide that 100K docs are a good sample, you\'ll set the sampling ratio to 0.01 but then you apply this ratio per-segment (as in this patch), and could easily end up with less than 100K docs (e.g. if randomness didn\'t really pick 0.01 of documents in a certain segment).\u003c\\/p\u003e\\n\\n\u003cp\u003eI don\'t think we should store the minSampleSize in an int[] and move to a bitset if we collected more docs. First, the collector works per-segment and I think sampling should work on the entire result set. So the int[] wouldn\'t be part of MatchingDocs, it\'d need to be held inside the collector and then you\'ll need to know where to \\\"cut\\\" it for each MatchingDocs instance (per-segment).\u003c\\/p\u003e\\n\\n\u003cp\u003eI really think a simple solution is what we should start with. RandomSamplingFC only overrides \u003ctt\u003e.getMatchingDocs()\u003c\\/tt\u003e and it can determine if sampling is needed or not, given \u003ctt\u003eminSampleSize\u003c\\/tt\u003e and the sum of totalHits from all MatchingDocs. Then you do sampling per-segment, but with the \\\"global picture\\\" in mind, and you\'re able to correct the sample ratio so that we come as close to \u003ctt\u003eminSampleSize\u003c\\/tt\u003e as possible.\u003c\\/p\u003e\\n\\n\u003cp\u003eTo me, if we can factor in a \u003ctt\u003emaxSampleSize\u003c\\/tt\u003e in this issue is a bonus, but I can definitely see that happening in a separate issue, as that\'s a performance thing. We should focus on giving our users a collector which produces a good sample, otherwise it\'s not valuable sampling.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13920897_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13920897_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Mar\\/14 14:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-05T14:41:35+0000\'\u003e05\\/Mar\\/14 14:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Well, I do a search of course, but collect the hits using a TotalHitCountCollector and not retrieve any stored values  \\n\\n That means that you evaluate the query twice, which is expensive ... but also, this doesn\'t guarantee to provide a \\\"correct\\\" sample. So say you found out the query matches 10M documents and you decide that 100K docs are a good sample, you\'ll set the sampling ratio to 0.01 but then you apply this ratio per-segment (as in this patch), and could easily end up with less than 100K docs (e.g. if randomness didn\'t really pick 0.01 of documents in a certain segment). \\n\\n I don\'t think we should store the minSampleSize in an int[] and move to a bitset if we collected more docs. First, the collector works per-segment and I think sampling should work on the entire result set. So the int[] wouldn\'t be part of MatchingDocs, it\'d need to be held inside the collector and then you\'ll need to know where to \\\"cut\\\" it for each MatchingDocs instance (per-segment). \\n\\n I really think a simple solution is what we should start with. RandomSamplingFC only overrides  .getMatchingDocs()  and it can determine if sampling is needed or not, given  minSampleSize  and the sum of totalHits from all MatchingDocs. Then you do sampling per-segment, but with the \\\"global picture\\\" in mind, and you\'re able to correct the sample ratio so that we come as close to  minSampleSize  as possible. \\n\\n To me, if we can factor in a  maxSampleSize  in this issue is a bonus, but I can definitely see that happening in a separate issue, as that\'s a performance thing. We should focus on giving our users a collector which produces a good sample, otherwise it\'s not valuable sampling.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13922172\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13922172&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13922172\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13922172_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13922172_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Mar\\/14 08:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-06T08:46:07+0000\'\u003e06\\/Mar\\/14 08:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI have a patch ready that implements the random sampling usign override on \u003ctt\u003e.getMatchingDocs()\u003c\\/tt\u003e. It passes the test, so it should be ok \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e. \u003c\\/p\u003e\\n\\n\u003cp\u003eIt is slower however (only 3x speedup),  but maybe there is room for optimization?\u003c\\/p\u003e\\n\\n\u003cp\u003eExact  :168 ms\u003cbr\\/\u003e\\nSampled:55 ms\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13922172_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13922172_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Mar\\/14 08:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-06T08:46:07+0000\'\u003e06\\/Mar\\/14 08:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I have a patch ready that implements the random sampling usign override on  .getMatchingDocs() . It passes the test, so it should be ok  .  \\n\\n It is slower however (only 3x speedup),  but maybe there is room for optimization? \\n\\n Exact  :168 ms \\nSampled:55 ms              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13922234\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13922234&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13922234\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13922234_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13922234_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Mar\\/14 09:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-06T09:55:18+0000\'\u003e06\\/Mar\\/14 09:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks Rob. Few comments:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eI don\'t think that we need both totalHits and segmentHits. I know it may look not so expensive, but if you think about these ++ for millions of hits, they add up. Instead, I think we should stick w\\/ the original totalHits per-segment and in RandomSamplingFC do a first pass to sum up the global totalHits.\\n\\t\u003cul\u003e\\n\\t\\t\u003cli\u003eWith that I think no changes are needed to FacetsCollector?\u003c\\/li\u003e\\n\\t\u003c\\/ul\u003e\\n\\t\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eAbout RandomSamplingFacetsCollector:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eI think we should fix the class jdoc\'s last \\\"Note\\\" as follows: \\\"Note: if you use a counting \\n{\\\\@link Facets}\\n\u003cp\u003e implementation, you can fix the sampled counts by calling...\\\".\u003c\\/p\u003e\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eAlso, I think instead of correctFacetCounts we should call it amortizeFacetCounts or something like that. We do not implement here the exact facet counting method that was before.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eI see that you remove sampleRatio, and now the ratio is computed as threshold\\/totalDocs but I think that\'s ... wrong? I.e. if threshold=10 and totalHits = 1000, I\'ll still get only 10 documents. But this is not what threshold means.\\n\\t\u003cul\u003e\\n\\t\\t\u003cli\u003eI think we should have minSampleSize, below which we don\'t sample at all (that\'s the \u003cem\u003ethreshold\u003c\\/em\u003e)\u003c\\/li\u003e\\n\\t\\t\u003cli\u003esampleRatio (e.g. 1%) is used only if totalHits &gt; minSampleSize, and even then, we make sure that we sample at least minSampleSize\u003c\\/li\u003e\\n\\t\\t\u003cli\u003eIf we will have maxSampleSize as well, we can take that into account too, but it\'s OK if we don\'t do this in this issue\u003c\\/li\u003e\\n\\t\u003c\\/ul\u003e\\n\\t\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003ecreateSample seems to be memory-less &#8211; i.e. it doesn\'t carry over the bin residue to the next segment. Not sure if it\'s critical though, but it might affect the total sample size. If you feel like getting closer to the optimum, want to fix it? Otherwise, can you please drop a TODO?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eAlso, do you want to test using WAH8DocIdSet instead of FixedBitSet for the sampled docs? If not, could you please drop a TODO that we could use a more efficient bitset impl since it\'s a sparse vector?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eAbout the test:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eCould you remove the \'s\' from collectors in the test name?\u003c\\/li\u003e\\n\\t\u003cli\u003eCould you move to numDocs being a random number &#8211; something like atLeast(8000)?\u003c\\/li\u003e\\n\\t\u003cli\u003eI don\'t mean to nitpick but if you obtain an NRT reader, no need to commit() \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/li\u003e\\n\\t\u003cli\u003eMake the two collector instances take 100\\/10% of the numDocs when you fix it\u003c\\/li\u003e\\n\\t\u003cli\u003eMaybe use random.nextInt(10) for the facets instead of alternating sequentially?\u003c\\/li\u003e\\n\\t\u003cli\u003eI don\'t understand how you know that numChildren=5 when you ask for the 10 top children. Isn\'t it possible that w\\/ some random seed the number of children will be different?\\n\\t\u003cul\u003e\\n\\t\\t\u003cli\u003eIn fact, I think that the random collectors should be initialized w\\/ a random seed that depends on the test? Currently they aren\'t and so always use 0xdeadbeef?\u003c\\/li\u003e\\n\\t\u003c\\/ul\u003e\\n\\t\u003c\\/li\u003e\\n\\t\u003cli\u003eYou have some sops left at the end of the test\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13922234_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13922234_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Mar\\/14 09:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-06T09:55:18+0000\'\u003e06\\/Mar\\/14 09:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks Rob. Few comments: \\n\\n \\n\\t I don\'t think that we need both totalHits and segmentHits. I know it may look not so expensive, but if you think about these ++ for millions of hits, they add up. Instead, I think we should stick w\\/ the original totalHits per-segment and in RandomSamplingFC do a first pass to sum up the global totalHits.\\n\\t \\n\\t\\t With that I think no changes are needed to FacetsCollector? \\n\\t \\n\\t \\n \\n\\n\\n About RandomSamplingFacetsCollector: \\n\\n \\n\\t I think we should fix the class jdoc\'s last \\\"Note\\\" as follows: \\\"Note: if you use a counting \\n{\\\\@link Facets}\\n  implementation, you can fix the sampled counts by calling...\\\".  \\n \\n\\n\\n \\n\\t Also, I think instead of correctFacetCounts we should call it amortizeFacetCounts or something like that. We do not implement here the exact facet counting method that was before. \\n \\n\\n\\n \\n\\t I see that you remove sampleRatio, and now the ratio is computed as threshold\\/totalDocs but I think that\'s ... wrong? I.e. if threshold=10 and totalHits = 1000, I\'ll still get only 10 documents. But this is not what threshold means.\\n\\t \\n\\t\\t I think we should have minSampleSize, below which we don\'t sample at all (that\'s the  threshold ) \\n\\t\\t sampleRatio (e.g. 1%) is used only if totalHits &gt; minSampleSize, and even then, we make sure that we sample at least minSampleSize \\n\\t\\t If we will have maxSampleSize as well, we can take that into account too, but it\'s OK if we don\'t do this in this issue \\n\\t \\n\\t \\n \\n\\n\\n \\n\\t createSample seems to be memory-less &#8211; i.e. it doesn\'t carry over the bin residue to the next segment. Not sure if it\'s critical though, but it might affect the total sample size. If you feel like getting closer to the optimum, want to fix it? Otherwise, can you please drop a TODO? \\n \\n\\n\\n \\n\\t Also, do you want to test using WAH8DocIdSet instead of FixedBitSet for the sampled docs? If not, could you please drop a TODO that we could use a more efficient bitset impl since it\'s a sparse vector? \\n \\n\\n\\n About the test: \\n\\n \\n\\t Could you remove the \'s\' from collectors in the test name? \\n\\t Could you move to numDocs being a random number &#8211; something like atLeast(8000)? \\n\\t I don\'t mean to nitpick but if you obtain an NRT reader, no need to commit()   \\n\\t Make the two collector instances take 100\\/10% of the numDocs when you fix it \\n\\t Maybe use random.nextInt(10) for the facets instead of alternating sequentially? \\n\\t I don\'t understand how you know that numChildren=5 when you ask for the 10 top children. Isn\'t it possible that w\\/ some random seed the number of children will be different?\\n\\t \\n\\t\\t In fact, I think that the random collectors should be initialized w\\/ a random seed that depends on the test? Currently they aren\'t and so always use 0xdeadbeef? \\n\\t \\n\\t \\n\\t You have some sops left at the end of the test \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13922293\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13922293&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13922293\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13922293_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13922293_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Mar\\/14 10:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-06T10:47:43+0000\'\u003e06\\/Mar\\/14 10:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks Shai,\u003c\\/p\u003e\\n\\n\u003cp\u003eI have fixed the points you noted about the collector. I renamed the sampleThreshold to sampleSize. It currently picks a samplingRatio that will reduce the number of hits to the sampleSize, if the number of hits is greater. \u003c\\/p\u003e\\n\\n\u003cp\u003eI have a  general question about your remarks about the test, besides fixing the obvious (names, commit, sops). Is there a reason to add more randomness to one test? I normally try to test one aspect in a unit test. And if I also want to test some other aspect, like random document counts (to test the sampleratio for example), I add more tests. \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003e   Make the two collector instances take 100\\/10% of the numDocs when you fix it\u003c\\/p\u003e\\n\u003c\\/blockquote\u003e\\n\u003cp\u003eSorry, I don\'t get what you mean by this.\u003c\\/p\u003e\\n\u003cblockquote\u003e\\n\u003cp\u003e    I don\'t understand how you know that numChildren=5 when you ask for the 10 top children. Isn\'t it possible that w\\/ some random seed the number of children will be different?\u003cbr\\/\u003e\\n        In fact, I think that the random collectors should be initialized w\\/ a random seed that depends on the test? Currently they aren\'t and so always use 0xdeadbeef?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eThere will be 5 facet values (0, 2, 4, 6 and 8), as only the even documents (i % 10) are hits. There is a REAL small chance that one of the five values will be entirely missed when sampling. But is that \u003ctt\u003e0.8 (chance not to take a value) ^ 2000 * 5 (any can be missing) ~ 10^-193\u003c\\/tt\u003e, so that is probable not going to happen \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13922293_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13922293_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Mar\\/14 10:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-06T10:47:43+0000\'\u003e06\\/Mar\\/14 10:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks Shai, \\n\\n I have fixed the points you noted about the collector. I renamed the sampleThreshold to sampleSize. It currently picks a samplingRatio that will reduce the number of hits to the sampleSize, if the number of hits is greater.  \\n\\n I have a  general question about your remarks about the test, besides fixing the obvious (names, commit, sops). Is there a reason to add more randomness to one test? I normally try to test one aspect in a unit test. And if I also want to test some other aspect, like random document counts (to test the sampleratio for example), I add more tests.  \\n\\n \\n    Make the two collector instances take 100\\/10% of the numDocs when you fix it \\n \\n Sorry, I don\'t get what you mean by this. \\n \\n     I don\'t understand how you know that numChildren=5 when you ask for the 10 top children. Isn\'t it possible that w\\/ some random seed the number of children will be different? \\n        In fact, I think that the random collectors should be initialized w\\/ a random seed that depends on the test? Currently they aren\'t and so always use 0xdeadbeef?  \\n There will be 5 facet values (0, 2, 4, 6 and 8), as only the even documents (i % 10) are hits. There is a REAL small chance that one of the five values will be entirely missed when sampling. But is that  0.8 (chance not to take a value) ^ 2000 * 5 (any can be missing) ~ 10^-193 , so that is probable not going to happen  . \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13922374\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13922374&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13922374\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"gilad\\\" id=\\\"commentauthor_13922374_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=gilad\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"gilad\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Gilad Barkai\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13922374_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Mar\\/14 11:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-06T11:59:43+0000\'\u003e06\\/Mar\\/14 11:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi Rob, patch looks great.\u003c\\/p\u003e\\n\\n\u003cp\u003eA few comments:\u003c\\/p\u003e\\n\u003cul\u003e\\n\\t\u003cli\u003eSome imports are not used (o.a.l.u.Bits, o.a.l.s.Collector &amp; o.a.l.s.DocIdSet)\u003c\\/li\u003e\\n\\t\u003cli\u003ePerhaps the parameters initialized in the RandomSamplingFacetsCollector c\'tor could be made \u003ctt\u003efinal\u003c\\/tt\u003e\u003c\\/li\u003e\\n\\t\u003cli\u003eXORShift64Random.XORShift64Random() (default c\'tor) is never used. Perhaps it was needed for usability when this was thought to be a core utility and was left by mistake? Should it be called somewhere?\u003c\\/li\u003e\\n\\t\u003cli\u003e\u003ctt\u003egetMatchingDocs()\u003c\\/tt\u003e\\n\\t\u003cul\u003e\\n\\t\\t\u003cli\u003ewhen \u003ctt\u003e!sampleNeeded()\u003c\\/tt\u003e there\'s a call to \u003ctt\u003esuper.getMatchingDocs()\u003c\\/tt\u003e, this may be redundant method call as 5 lines above we call it, and the code always compute the \u003ctt\u003etotalHits\u003c\\/tt\u003e first. Perhaps the original matching docs could be stored as a member? This would also help for some implementations of correcting the sampled facet results.\u003c\\/li\u003e\\n\\t\\t\u003cli\u003e\u003ctt\u003etotalHits\u003c\\/tt\u003e is redundantly computed again in line 147-152\u003c\\/li\u003e\\n\\t\u003c\\/ul\u003e\\n\\t\u003c\\/li\u003e\\n\\t\u003cli\u003e\u003ctt\u003eneedsSampling()\u003c\\/tt\u003e could perhaps be protected, allowing other criteria for sampling to be added\u003c\\/li\u003e\\n\\t\u003cli\u003e\u003ctt\u003ecreateSample()\u003c\\/tt\u003e\\n\\t\u003cul\u003e\\n\\t\\t\u003cli\u003e\u003ctt\u003erandomIndex\u003c\\/tt\u003e is initialized to \u003ctt\u003e0\u003c\\/tt\u003e, effectively making the first document of every segment\'s bin to be selected as the representative of that bin, neglecting the rest of the bin (regardless of the seed). So if a bin is the size of a 1000 documents, than there are 999 documents that regardless of the seed would always be neglected. It may be better so initialize as \u003ctt\u003erandomIndex = random.nextInt(binsize)\u003c\\/tt\u003e as it happens for the 2nd and on bins.\u003c\\/li\u003e\\n\\t\\t\u003cli\u003eWhile creating a new \u003ctt\u003eMatchingDocs\u003c\\/tt\u003e with the sampled set, the original \u003ctt\u003etotalHits\u003c\\/tt\u003e and original \u003ctt\u003escores\u003c\\/tt\u003e are used. I\'m not 100% sure the first is an issue, but any facet accumulation which would rely on document scores would be hit by the second as the \u003ctt\u003escores\u003c\\/tt\u003e (at least by javadocs) are defined as non-sparse.\u003c\\/li\u003e\\n\\t\u003c\\/ul\u003e\\n\\t\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"gilad\\\" id=\\\"commentauthor_13922374_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=gilad\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"gilad\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Gilad Barkai\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13922374_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Mar\\/14 11:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-06T11:59:43+0000\'\u003e06\\/Mar\\/14 11:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hi Rob, patch looks great. \\n\\n A few comments: \\n \\n\\t Some imports are not used (o.a.l.u.Bits, o.a.l.s.Collector &amp; o.a.l.s.DocIdSet) \\n\\t Perhaps the parameters initialized in the RandomSamplingFacetsCollector c\'tor could be made  final  \\n\\t XORShift64Random.XORShift64Random() (default c\'tor) is never used. Perhaps it was needed for usability when this was thought to be a core utility and was left by mistake? Should it be called somewhere? \\n\\t  getMatchingDocs() \\n\\t \\n\\t\\t when  !sampleNeeded()  there\'s a call to  super.getMatchingDocs() , this may be redundant method call as 5 lines above we call it, and the code always compute the  totalHits  first. Perhaps the original matching docs could be stored as a member? This would also help for some implementations of correcting the sampled facet results. \\n\\t\\t  totalHits  is redundantly computed again in line 147-152 \\n\\t \\n\\t \\n\\t  needsSampling()  could perhaps be protected, allowing other criteria for sampling to be added \\n\\t  createSample() \\n\\t \\n\\t\\t  randomIndex  is initialized to  0 , effectively making the first document of every segment\'s bin to be selected as the representative of that bin, neglecting the rest of the bin (regardless of the seed). So if a bin is the size of a 1000 documents, than there are 999 documents that regardless of the seed would always be neglected. It may be better so initialize as  randomIndex = random.nextInt(binsize)  as it happens for the 2nd and on bins. \\n\\t\\t While creating a new  MatchingDocs  with the sampled set, the original  totalHits  and original  scores  are used. I\'m not 100% sure the first is an issue, but any facet accumulation which would rely on document scores would be hit by the second as the  scores  (at least by javadocs) are defined as non-sparse. \\n\\t \\n\\t \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13922411\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13922411&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13922411\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13922411_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13922411_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Mar\\/14 12:18\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-06T12:18:57+0000\'\u003e06\\/Mar\\/14 12:18\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks,\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003ewhen !sampleNeeded() there\'s a call to super.getMatchingDocs(), this may be redundant method call as 5 lines above we call it, and the code always compute the totalHits first. Perhaps the original matching docs could be stored as a member? This would also help for some implementations of correcting the sampled facet results.\u003cbr\\/\u003e\\ntotalHits is redundantly computed again in line 147-152\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eHow could I have missed this... Must take a break I think. \u003c\\/p\u003e\\n\\n\u003cp\u003e\u003ctt\u003ecreateSample\u003c\\/tt\u003e\u003cbr\\/\u003e\\nI always take the first document, as I did not implement carrying-over of the segments. If I would pick a random index and this index would be greater than the number of document in the segment, the segment would not be sampled. This results is \'too few\' sampled documents. Taking the first always might result in \'too many\' but that gave a better overall distribution and average. \u003cbr\\/\u003e\\nI think your argument about not-so-random documents and the fact that carry-over should not be that hard, I should implement carry over anyway. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13922411_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13922411_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Mar\\/14 12:18\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-06T12:18:57+0000\'\u003e06\\/Mar\\/14 12:18\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks, \\n\\n \\n when !sampleNeeded() there\'s a call to super.getMatchingDocs(), this may be redundant method call as 5 lines above we call it, and the code always compute the totalHits first. Perhaps the original matching docs could be stored as a member? This would also help for some implementations of correcting the sampled facet results. \\ntotalHits is redundantly computed again in line 147-152  \\n How could I have missed this... Must take a break I think.  \\n\\n  createSample  \\nI always take the first document, as I did not implement carrying-over of the segments. If I would pick a random index and this index would be greater than the number of document in the segment, the segment would not be sampled. This results is \'too few\' sampled documents. Taking the first always might result in \'too many\' but that gave a better overall distribution and average.  \\nI think your argument about not-so-random documents and the fact that carry-over should not be that hard, I should implement carry over anyway.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13922884\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13922884&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13922884\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13922884_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13922884_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Mar\\/14 18:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-06T18:54:32+0000\'\u003e06\\/Mar\\/14 18:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Shai Erera - 06\\/Mar\\/14 18:56\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003ebut any facet accumulation which would rely on document scores would be hit by the second as the scores\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThat\'s a great point Gilad. We need a test which covers that with random sampling collector.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eIs there a reason to add more randomness to one test?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIt depends. I have a problem with numDocs=10,000 and percents being 10% .. it creates too perfect numbers if you know what I mean. I prefer a random number of documents to add some spice to the test. Since we\'re testing a random sampler, I don\'t think it makes sense to test it with a fixed seed (0xdeadbeef) ... this collector is all about randomness, so we should stress the randomness done there. Given our test framework, randomness is not a big deal at all, since once we get a test failure, we can deterministically reproduce the failure (when there is no multi-threading). So I say YES, in this test I think we should have randomness.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut e.g. when you add a test which ensures the collector works well w\\/ sampled docs and scores, I don\'t think you should add randomness &#8211; it\'s ok to test it once.\u003c\\/p\u003e\\n\\n\u003cp\u003eAlso, in terms of test coverage, there are other cases which I think would be good if they were tested:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eDocs + Scores (discussed above)\u003c\\/li\u003e\\n\\t\u003cli\u003eMulti-segment indexes (ensuring we work well there)\u003c\\/li\u003e\\n\\t\u003cli\u003eDifferent number of hits per-segment (to make sure our sampling on tiny segments works well too)\u003c\\/li\u003e\\n\\t\u003cli\u003e...\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eI wouldn\'t for example use RandomIndexWriter because we\'re only testing search (and so it just adds noise in this test). If we want many segments, we should commit\\/nrt-open every few docs, disable merge policy etc. These can be separate, real \\\"unit-\\\", tests.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eSorry, I don\'t get what you mean by this.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI meant that if you set \u003ctt\u003enumDocs = atLeast(8000)\u003c\\/tt\u003e, then the 10% sampler should not be hardcoded to 1,000, but \u003ctt\u003enumDocs * 0.1\u003c\\/tt\u003e.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003ethe original totalHits .. is used\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI think that\'s OK. In fact, if we don\'t record that, it would be hard to fix the counts no?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eThere will be 5 facet values (0, 2, 4, 6 and 8), as only the even documents (i % 10) are hits. There is a REAL small chance that one of the five values will be entirely missed when sampling. But is that 0.8 (chance not to take a value) ^ 2000 * 5 (any can be missing) ~ 10^-193, so that is probable not going to happen\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eAhh thanks, I missed that. I agree it\'s very improbable that one of the values is missing, but if we can avoid that at all it\'s better. First, it\'s not one of the values, we could be missing even 2 right &#8211; really depends on randomness. I find this assert just redundant &#8211; if we always expect 5, we shouldn\'t assert that we received 5. If we say that very infrequently we might get &lt;5 and we\'re OK with it .. what\'s the point of asserting that at all?\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\u003cp\u003eI renamed the sampleThreshold to sampleSize. It currently picks a samplingRatio that will reduce the number of hits to the sampleSize, if the number of hits is greater.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eIt looks like it hasn\'t changed? I mean besides the rename. So if I set sampleSize=100K, it\'s 100K whether there are 101K docs or 100M docs, right? Is that your intention?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13922884_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13922884_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Mar\\/14 18:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-06T18:54:32+0000\'\u003e06\\/Mar\\/14 18:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Shai Erera - 06\\/Mar\\/14 18:56\\\"\u003eedited\u003c\\/span\u003e                    but any facet accumulation which would rely on document scores would be hit by the second as the scores  \\n\\n That\'s a great point Gilad. We need a test which covers that with random sampling collector. \\n\\n  Is there a reason to add more randomness to one test?  \\n\\n It depends. I have a problem with numDocs=10,000 and percents being 10% .. it creates too perfect numbers if you know what I mean. I prefer a random number of documents to add some spice to the test. Since we\'re testing a random sampler, I don\'t think it makes sense to test it with a fixed seed (0xdeadbeef) ... this collector is all about randomness, so we should stress the randomness done there. Given our test framework, randomness is not a big deal at all, since once we get a test failure, we can deterministically reproduce the failure (when there is no multi-threading). So I say YES, in this test I think we should have randomness. \\n\\n But e.g. when you add a test which ensures the collector works well w\\/ sampled docs and scores, I don\'t think you should add randomness &#8211; it\'s ok to test it once. \\n\\n Also, in terms of test coverage, there are other cases which I think would be good if they were tested: \\n\\n \\n\\t Docs + Scores (discussed above) \\n\\t Multi-segment indexes (ensuring we work well there) \\n\\t Different number of hits per-segment (to make sure our sampling on tiny segments works well too) \\n\\t ... \\n \\n\\n\\n I wouldn\'t for example use RandomIndexWriter because we\'re only testing search (and so it just adds noise in this test). If we want many segments, we should commit\\/nrt-open every few docs, disable merge policy etc. These can be separate, real \\\"unit-\\\", tests. \\n\\n  Sorry, I don\'t get what you mean by this.  \\n\\n I meant that if you set  numDocs = atLeast(8000) , then the 10% sampler should not be hardcoded to 1,000, but  numDocs * 0.1 . \\n\\n  the original totalHits .. is used  \\n\\n I think that\'s OK. In fact, if we don\'t record that, it would be hard to fix the counts no? \\n\\n \\n There will be 5 facet values (0, 2, 4, 6 and 8), as only the even documents (i % 10) are hits. There is a REAL small chance that one of the five values will be entirely missed when sampling. But is that 0.8 (chance not to take a value) ^ 2000 * 5 (any can be missing) ~ 10^-193, so that is probable not going to happen  \\n\\n Ahh thanks, I missed that. I agree it\'s very improbable that one of the values is missing, but if we can avoid that at all it\'s better. First, it\'s not one of the values, we could be missing even 2 right &#8211; really depends on randomness. I find this assert just redundant &#8211; if we always expect 5, we shouldn\'t assert that we received 5. If we say that very infrequently we might get &lt;5 and we\'re OK with it .. what\'s the point of asserting that at all? \\n\\n  I renamed the sampleThreshold to sampleSize. It currently picks a samplingRatio that will reduce the number of hits to the sampleSize, if the number of hits is greater.  \\n\\n It looks like it hasn\'t changed? I mean besides the rename. So if I set sampleSize=100K, it\'s 100K whether there are 101K docs or 100M docs, right? Is that your intention?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13924037\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13924037&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13924037\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13924037_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13924037_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/Mar\\/14 16:39\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-07T16:39:36+0000\'\u003e07\\/Mar\\/14 16:39\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003e...Given our test framework, randomness is not a big deal at all, since once we get a test failure, we can deterministically reproduce the failure (when there is no multi-threading)...\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eOk, this makes sense to me. \u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eIt looks like it hasn\'t changed? I mean besides the rename. So if I set sampleSize=100K, it\'s 100K whether there are 101K docs or 100M docs, right? Is that your intention?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eCorrect, it is my intention. I actually prefer not to increase the \u003ctt\u003esampleSize\u003c\\/tt\u003e with more hits, as bigger samples are slower and 100K is a nice sample size anyway and more hits means more time. I adjust the sampleRatio so that the resulting set of documents is (close to) the \u003ctt\u003esampleSize\u003c\\/tt\u003e.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eI find this assert just redundant \\u2013 if we always expect 5, we shouldn\'t assert that we received 5. If we say that very infrequently we might get &lt;5 and we\'re OK with it .. what\'s the point of asserting that at all?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\u003cp\u003eAgreed with the &lt;5. Asserting seems redundant, but is that not the point in unit-tests? The trick is that the assertion should still hold if you change the implementation.. \u003c\\/p\u003e\\n\\n\u003cp\u003eI will add more next week. \u003c\\/p\u003e\\n\\n\u003cp\u003eBtw. Is there an easy way to retrieve the total facet counts for a ordinal? When correcting facet counts it would a quick win to limit the number of estimated documents to the actual number of documents in the index that match that facet. (And maybe use the distribution as well, to make better estimates)\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13924037_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13924037_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/Mar\\/14 16:39\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-07T16:39:36+0000\'\u003e07\\/Mar\\/14 16:39\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n ...Given our test framework, randomness is not a big deal at all, since once we get a test failure, we can deterministically reproduce the failure (when there is no multi-threading)...  \\n Ok, this makes sense to me.  \\n\\n \\n It looks like it hasn\'t changed? I mean besides the rename. So if I set sampleSize=100K, it\'s 100K whether there are 101K docs or 100M docs, right? Is that your intention?  \\n Correct, it is my intention. I actually prefer not to increase the  sampleSize  with more hits, as bigger samples are slower and 100K is a nice sample size anyway and more hits means more time. I adjust the sampleRatio so that the resulting set of documents is (close to) the  sampleSize . \\n\\n \\n I find this assert just redundant \\u2013 if we always expect 5, we shouldn\'t assert that we received 5. If we say that very infrequently we might get &lt;5 and we\'re OK with it .. what\'s the point of asserting that at all?  \\n Agreed with the &lt;5. Asserting seems redundant, but is that not the point in unit-tests? The trick is that the assertion should still hold if you change the implementation..  \\n\\n I will add more next week.  \\n\\n Btw. Is there an easy way to retrieve the total facet counts for a ordinal? When correcting facet counts it would a quick win to limit the number of estimated documents to the actual number of documents in the index that match that facet. (And maybe use the distribution as well, to make better estimates)              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13924348\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13924348&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13924348\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"gilad\\\" id=\\\"commentauthor_13924348_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=gilad\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"gilad\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Gilad Barkai\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13924348_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/Mar\\/14 21:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-07T21:05:19+0000\'\u003e07\\/Mar\\/14 21:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eBtw. Is there an easy way to retrieve the total facet counts for a ordinal? When correcting facet counts it would a quick win to limit the number of estimated documents to the actual number of documents in the index that match that facet. (And maybe use the distribution as well, to make better estimates)\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThat\'s a great idea!\u003c\\/p\u003e\\n\\n\u003cp\u003eThe \u003ctt\u003edocFreq\u003c\\/tt\u003e of the category drill-down term is an upper bound - and could be used as a limit.\u003cbr\\/\u003e\\nIt\'s cheap, but might not be the exact number as it also take under account deleted documents.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe limit should also take under account the total number of hits for the query, otherwise the estimate and the multiplication with the sampling factor may yield a larger number than the actual results.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"gilad\\\" id=\\\"commentauthor_13924348_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=gilad\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"gilad\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Gilad Barkai\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13924348_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/Mar\\/14 21:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-07T21:05:19+0000\'\u003e07\\/Mar\\/14 21:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n Btw. Is there an easy way to retrieve the total facet counts for a ordinal? When correcting facet counts it would a quick win to limit the number of estimated documents to the actual number of documents in the index that match that facet. (And maybe use the distribution as well, to make better estimates)  \\n\\n That\'s a great idea! \\n\\n The  docFreq  of the category drill-down term is an upper bound - and could be used as a limit. \\nIt\'s cheap, but might not be the exact number as it also take under account deleted documents. \\n\\n The limit should also take under account the total number of hits for the query, otherwise the estimate and the multiplication with the sampling factor may yield a larger number than the actual results.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13925158\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13925158&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13925158\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"gilad\\\" id=\\\"commentauthor_13925158_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=gilad\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"gilad\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Gilad Barkai\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13925158_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Mar\\/14 09:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-09T09:29:48+0000\'\u003e09\\/Mar\\/14 09:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eThe limit should also take under account the total number of hits for the query, otherwise the estimate and the multiplication with the sampling factor may yield a larger number than the actual results.\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI understand this statement is confusing, I\'ll try to elaborate.\u003cbr\\/\u003e\\nIf the sample was \u003cb\u003eexactly\u003c\\/b\u003e at the sampling ratio, this would not be a problem, but since the sample - being random as it is - may be a bit larger, adjusting according to the original sampling ratio (rather than the actual one) may yield larger counts than the actual results. \u003cbr\\/\u003e\\nThis could be solved by either limiting to the number of results, or adjusting the \u003ctt\u003esamplingRate\u003c\\/tt\u003e to be the exact, post-sampling, ratio.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"gilad\\\" id=\\\"commentauthor_13925158_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=gilad\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"gilad\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Gilad Barkai\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13925158_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Mar\\/14 09:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-09T09:29:48+0000\'\u003e09\\/Mar\\/14 09:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n The limit should also take under account the total number of hits for the query, otherwise the estimate and the multiplication with the sampling factor may yield a larger number than the actual results.  \\n\\n I understand this statement is confusing, I\'ll try to elaborate. \\nIf the sample was  exactly  at the sampling ratio, this would not be a problem, but since the sample - being random as it is - may be a bit larger, adjusting according to the original sampling ratio (rather than the actual one) may yield larger counts than the actual results.  \\nThis could be solved by either limiting to the number of results, or adjusting the  samplingRate  to be the exact, post-sampling, ratio.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13925160\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13925160&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13925160\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13925160_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13925160_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Mar\\/14 09:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-09T09:38:42+0000\'\u003e09\\/Mar\\/14 09:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eAsserting seems redundant, but is that not the point in unit-tests?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThe problem is when those false alarms cause noise. The previous sampling tests had a mechanism to reduce the noise as much as possible, but they didn\'t eliminate it. For example, the test was run few times, each time w\\/ increasing sample until it gave up and failed. At which point someone had to inspect the log and determine that this is a false positive. Since you expect at most 5 categories, and any number between 1-5 is fair game, I prefer not to assert on #categories at all. If you really want to assert something, then make sure \u003ctt\u003e0 &lt; #categories &lt;= 5\u003c\\/tt\u003e?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13925160_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13925160_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Mar\\/14 09:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-09T09:38:42+0000\'\u003e09\\/Mar\\/14 09:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Asserting seems redundant, but is that not the point in unit-tests?  \\n\\n The problem is when those false alarms cause noise. The previous sampling tests had a mechanism to reduce the noise as much as possible, but they didn\'t eliminate it. For example, the test was run few times, each time w\\/ increasing sample until it gave up and failed. At which point someone had to inspect the log and determine that this is a false positive. Since you expect at most 5 categories, and any number between 1-5 is fair game, I prefer not to assert on #categories at all. If you really want to assert something, then make sure  0 &lt; #categories &lt;= 5 ?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13930078\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13930078&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13930078\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13930078_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13930078_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Mar\\/14 08:03\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-11T08:03:56+0000\'\u003e11\\/Mar\\/14 08:03\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Rob Audenaerde - 11\\/Mar\\/14 08:10\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks again for the good points. \u003c\\/p\u003e\\n\\n\u003cp\u003eI currently have an \u003ctt\u003eamortizeFacetCounts\u003c\\/tt\u003e that uses the \u003ctt\u003eIndexSearcher\u003c\\/tt\u003e to retrieve a reader an a \u003ctt\u003eFacetsConfig\u003c\\/tt\u003e to determine the \u003ctt\u003eTerm\u003c\\/tt\u003e for the \u003ctt\u003edocFreq\u003c\\/tt\u003e. I\'m not really sure how this will work for hierarchies though. \u003c\\/p\u003e\\n\\n\u003cp\u003eUsing \u003ctt\u003etotalHits\u003c\\/tt\u003e as upper bound is not really necessary I think; as the sampling rate is determined by the total number of hits and the sample size; so reversing this can never yield numbers greater that \u003ctt\u003etotalHits\u003c\\/tt\u003e. \u003c\\/p\u003e\\n\\n\u003cp\u003eI alse removed the exact assert and switch to an \u003ctt\u003eatLeast\u003c\\/tt\u003e. Will add a patch soon.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13930078_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13930078_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Mar\\/14 08:03\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-11T08:03:56+0000\'\u003e11\\/Mar\\/14 08:03\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Rob Audenaerde - 11\\/Mar\\/14 08:10\\\"\u003eedited\u003c\\/span\u003e                   Thanks again for the good points.  \\n\\n I currently have an  amortizeFacetCounts  that uses the  IndexSearcher  to retrieve a reader an a  FacetsConfig  to determine the  Term  for the  docFreq . I\'m not really sure how this will work for hierarchies though.  \\n\\n Using  totalHits  as upper bound is not really necessary I think; as the sampling rate is determined by the total number of hits and the sample size; so reversing this can never yield numbers greater that  totalHits .  \\n\\n I alse removed the exact assert and switch to an  atLeast . Will add a patch soon. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13930111\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13930111&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13930111\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13930111_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13930111_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Mar\\/14 09:21\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-11T09:21:50+0000\'\u003e11\\/Mar\\/14 09:21\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cul\u003e\\n\\t\u003cli\u003eJavadocs:\\n\\t\u003cul\u003e\\n\\t\\t\u003cli\u003eFrom the class javadocs: \u003cem\u003eNote: the original set of hits will be available as documents...\u003c\\/em\u003e\u003cbr\\/\u003e\\nI think we should just write \\\"the original set of hits can be retrieved from getOriginal..\\\" - I don\'t want anyone to be confused with the wording \\\"will be available as documents\\\".\u003c\\/li\u003e\\n\\t\\t\u003cli\u003eCan you make NOT_CALCULATED static?\u003c\\/li\u003e\\n\\t\\t\u003cli\u003eTypo: samplingRato\u003c\\/li\u003e\\n\\t\\t\u003cli\u003erandomSeed: I think it should say \\\"if 0...\\\" not \\\"if null\\\".\u003c\\/li\u003e\\n\\t\u003c\\/ul\u003e\\n\\t\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003egetMatchingDocs &#8211; can you move the totalHits calculation to \u003ctt\u003egetTotalHits()\u003c\\/tt\u003e? And then call it only \u003ctt\u003eif (sampledDocs==null)\u003c\\/tt\u003e?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eneedsSampling &#8211; I know it was suggested to make it protected for inheritance purposes, but as it looks now, all members are private so I don\'t see how can one extend the class only to override this method (e.g. he won\'t have access to sampleSize even). Maybe we should keep it private and when someone asks to extend, we know better what needs to be protected? For instance, I think it\'s also important that we allow overriding createSampledDocList, but for now let\'s keep it simple.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eI think that we need to document somewhere (maybe in class javadocs) that the returned sampled docs may include empty MatchingDocs instances (i.e. when no docs were \\\"sampled\\\" from a segment). Just so that we don\'t surprise anyone with empty instances. If people work w\\/ MatchingDocs as they should, by obtaining an iterator, it shouldn\'t be a problem, but better document it explicitly.\\n\\t\u003cul\u003e\\n\\t\\t\u003cli\u003ePerhaps we should also say something about the returned MatchingDocs.totalHits, which are the original totalHits and not the sampled set size?\u003c\\/li\u003e\\n\\t\u003c\\/ul\u003e\\n\\t\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eAbout carryOver:\\n\\t\u003cul\u003e\\n\\t\\t\u003cli\u003eDoesn\'t it handle the TODO at the beginning of createSample?\u003c\\/li\u003e\\n\\t\\t\u003cli\u003eWhy does it need to always include the first document of the first segment? Rather you could initialize it to -1 and if \u003ctt\u003ecarryOver == -1\u003c\\/tt\u003e set it to a random index within that bin? Seems more \\\"random\\\" to me.\u003c\\/li\u003e\\n\\t\u003c\\/ul\u003e\\n\\t\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eamortizedFacetCounts:\\n\\t\u003cul\u003e\\n\\t\\t\u003cli\u003eIt\'s a matter of style so I don\'t mind if you keep this like you wrote, but I would write it as \u003ctt\u003eif (!needsSampling() || res == null)\u003c\\/tt\u003e and then the rest of the method isn\'t indented. Your call.\u003c\\/li\u003e\\n\\t\\t\u003cli\u003eI think it\'s better to allocate \u003ctt\u003echildPath\u003c\\/tt\u003e so that the first element is already the dimension. See what FacetsConfig.pathToString currently does. Currently it results in re-allocating the String[] for every label. Then you can call the pathToString variant which takes the array and the length.\\n\\t\\t\u003cul\u003e\\n\\t\\t\\t\u003cli\u003eSeparately, would be good if FacetsConfig had an appendElement(Appendable, int idx) to append a specific element to the appendable. Then you could use a StringBuilder once, and skip the encoding done for the entire path except the last element.\u003c\\/li\u003e\\n\\t\\t\u003c\\/ul\u003e\\n\\t\\t\u003c\\/li\u003e\\n\\t\\t\u003cli\u003ePerhaps we should cap this \u003ctt\u003e(int) (res.value.doubleValue() \\/ this.samplingRate)\u003c\\/tt\u003e by e.g. the number of non-deleted documents?\u003c\\/li\u003e\\n\\t\u003c\\/ul\u003e\\n\\t\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eAbout test:\\n\\t\u003cul\u003e\\n\\t\\t\u003cli\u003eThis comment is wrong: \u003cem\u003e\\/\\/there will be 5000 hits.\u003c\\/em\u003e\u003c\\/li\u003e\\n\\t\\t\u003cli\u003eWhy do you initialize your own Random? It\'s impossible to debug the test like that. You should use \u003ctt\u003erandom()\u003c\\/tt\u003e instead.\u003c\\/li\u003e\\n\\t\\t\u003cli\u003eThis comment is wrong? \u003cem\u003e\\/\\/because a randomindexer is used, the results will vary each time.\u003c\\/em\u003e &#8211; it\'s not because the random indexer, but because of random sampling no?\u003c\\/li\u003e\\n\\t\\t\u003cli\u003eWould you mind formatting the test code? I see empty lines, curly braces that are sometimes open in the next line etc. I can do it too before I commit it.\u003c\\/li\u003e\\n\\t\u003c\\/ul\u003e\\n\\t\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eI see that createSample still has the scores array bug &#8211; it returns the original scores array, irrespective of the sampled docs. Before you fix it, can you please add a testcase which covers scores and fails?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eI think we\'re very close!\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13930111_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13930111_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Mar\\/14 09:21\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-11T09:21:50+0000\'\u003e11\\/Mar\\/14 09:21\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n\\t Javadocs:\\n\\t \\n\\t\\t From the class javadocs:  Note: the original set of hits will be available as documents...  \\nI think we should just write \\\"the original set of hits can be retrieved from getOriginal..\\\" - I don\'t want anyone to be confused with the wording \\\"will be available as documents\\\". \\n\\t\\t Can you make NOT_CALCULATED static? \\n\\t\\t Typo: samplingRato \\n\\t\\t randomSeed: I think it should say \\\"if 0...\\\" not \\\"if null\\\". \\n\\t \\n\\t \\n \\n\\n\\n \\n\\t getMatchingDocs &#8211; can you move the totalHits calculation to  getTotalHits() ? And then call it only  if (sampledDocs==null) ? \\n \\n\\n\\n \\n\\t needsSampling &#8211; I know it was suggested to make it protected for inheritance purposes, but as it looks now, all members are private so I don\'t see how can one extend the class only to override this method (e.g. he won\'t have access to sampleSize even). Maybe we should keep it private and when someone asks to extend, we know better what needs to be protected? For instance, I think it\'s also important that we allow overriding createSampledDocList, but for now let\'s keep it simple. \\n \\n\\n\\n \\n\\t I think that we need to document somewhere (maybe in class javadocs) that the returned sampled docs may include empty MatchingDocs instances (i.e. when no docs were \\\"sampled\\\" from a segment). Just so that we don\'t surprise anyone with empty instances. If people work w\\/ MatchingDocs as they should, by obtaining an iterator, it shouldn\'t be a problem, but better document it explicitly.\\n\\t \\n\\t\\t Perhaps we should also say something about the returned MatchingDocs.totalHits, which are the original totalHits and not the sampled set size? \\n\\t \\n\\t \\n \\n\\n\\n \\n\\t About carryOver:\\n\\t \\n\\t\\t Doesn\'t it handle the TODO at the beginning of createSample? \\n\\t\\t Why does it need to always include the first document of the first segment? Rather you could initialize it to -1 and if  carryOver == -1  set it to a random index within that bin? Seems more \\\"random\\\" to me. \\n\\t \\n\\t \\n \\n\\n\\n \\n\\t amortizedFacetCounts:\\n\\t \\n\\t\\t It\'s a matter of style so I don\'t mind if you keep this like you wrote, but I would write it as  if (!needsSampling() || res == null)  and then the rest of the method isn\'t indented. Your call. \\n\\t\\t I think it\'s better to allocate  childPath  so that the first element is already the dimension. See what FacetsConfig.pathToString currently does. Currently it results in re-allocating the String[] for every label. Then you can call the pathToString variant which takes the array and the length.\\n\\t\\t \\n\\t\\t\\t Separately, would be good if FacetsConfig had an appendElement(Appendable, int idx) to append a specific element to the appendable. Then you could use a StringBuilder once, and skip the encoding done for the entire path except the last element. \\n\\t\\t \\n\\t\\t \\n\\t\\t Perhaps we should cap this  (int) (res.value.doubleValue() \\/ this.samplingRate)  by e.g. the number of non-deleted documents? \\n\\t \\n\\t \\n \\n\\n\\n \\n\\t About test:\\n\\t \\n\\t\\t This comment is wrong:  \\/\\/there will be 5000 hits.  \\n\\t\\t Why do you initialize your own Random? It\'s impossible to debug the test like that. You should use  random()  instead. \\n\\t\\t This comment is wrong?  \\/\\/because a randomindexer is used, the results will vary each time.  &#8211; it\'s not because the random indexer, but because of random sampling no? \\n\\t\\t Would you mind formatting the test code? I see empty lines, curly braces that are sometimes open in the next line etc. I can do it too before I commit it. \\n\\t \\n\\t \\n \\n\\n\\n \\n\\t I see that createSample still has the scores array bug &#8211; it returns the original scores array, irrespective of the sampled docs. Before you fix it, can you please add a testcase which covers scores and fails? \\n \\n\\n\\n I think we\'re very close!              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13930118\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13930118&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13930118\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13930118_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13930118_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Mar\\/14 09:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-11T09:34:20+0000\'\u003e11\\/Mar\\/14 09:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Rob Audenaerde - 11\\/Mar\\/14 09:39\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks Shai, I really appreciate all the feedback from you guys on this issue. \u003c\\/p\u003e\\n\\n\u003cp\u003eI will try to fix the loose ends soon.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13930118_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13930118_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Mar\\/14 09:34\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-11T09:34:20+0000\'\u003e11\\/Mar\\/14 09:34\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Rob Audenaerde - 11\\/Mar\\/14 09:39\\\"\u003eedited\u003c\\/span\u003e                   Thanks Shai, I really appreciate all the feedback from you guys on this issue.  \\n\\n I will try to fix the loose ends soon.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13930121\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13930121&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13930121\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13930121_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13930121_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Mar\\/14 09:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-11T09:38:32+0000\'\u003e11\\/Mar\\/14 09:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\u003cp\u003eThanks Shai, I really appreciate all the feedback for you guys on this issue. \u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eNo worries, it should be me thanking you for doing all this work!\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13930121_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13930121_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'11\\/Mar\\/14 09:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-11T09:38:32+0000\'\u003e11\\/Mar\\/14 09:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                     Thanks Shai, I really appreciate all the feedback for you guys on this issue.   \\n\\n No worries, it should be me thanking you for doing all this work!              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13931510\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13931510&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13931510\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13931510_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13931510_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Mar\\/14 08:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-12T08:12:33+0000\'\u003e12\\/Mar\\/14 08:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi all,\u003c\\/p\u003e\\n\\n\u003cp\u003eMaking good progress, only I\'m not really sure what to do with the \u003ctt\u003escores\u003c\\/tt\u003e. I could only keep the scores of the sampled documents (creating a new \u003ctt\u003escores[]\u003c\\/tt\u003e in the \u003ctt\u003ecreateSample\u003c\\/tt\u003e. Or just leave scoring out completely for the sampler? (Passing keepscores = false, removing the c\'tor param, setting {[scores}} to \u003ctt\u003enull\u003c\\/tt\u003e?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13931510_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13931510_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Mar\\/14 08:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-12T08:12:33+0000\'\u003e12\\/Mar\\/14 08:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hi all, \\n\\n Making good progress, only I\'m not really sure what to do with the  scores . I could only keep the scores of the sampled documents (creating a new  scores[]  in the  createSample . Or just leave scoring out completely for the sampler? (Passing keepscores = false, removing the c\'tor param, setting {[scores}} to  null ?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13931543\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13931543&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13931543\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13931543_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13931543_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Mar\\/14 08:42\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-12T08:42:57+0000\'\u003e12\\/Mar\\/14 08:42\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIf it\'s not too much work for you, I think you should just create a new float[]? You can separate the code such that you don\'t check if needs to keep scores for every sampled document, at the cost of duplicating code. But otherwise I think it would be good if we kept that functionality for sampled docs too.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13931543_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13931543_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Mar\\/14 08:42\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-12T08:42:57+0000\'\u003e12\\/Mar\\/14 08:42\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    If it\'s not too much work for you, I think you should just create a new float[]? You can separate the code such that you don\'t check if needs to keep scores for every sampled document, at the cost of duplicating code. But otherwise I think it would be good if we kept that functionality for sampled docs too.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13937529\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13937529&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13937529\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13937529_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13937529_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Mar\\/14 07:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-17T07:55:01+0000\'\u003e17\\/Mar\\/14 07:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eNew patch. I\'m still not really sure about the scorings, but please take a look at it.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13937529_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13937529_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Mar\\/14 07:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-17T07:55:01+0000\'\u003e17\\/Mar\\/14 07:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    New patch. I\'m still not really sure about the scorings, but please take a look at it.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13937580\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13937580&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13937580\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"gilad\\\" id=\\\"commentauthor_13937580_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=gilad\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"gilad\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Gilad Barkai\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13937580_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Mar\\/14 09:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-17T09:16:14+0000\'\u003e17\\/Mar\\/14 09:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAbout the scores (the only part I got to review thus far), the scores should be a non-sparse float array.\u003cbr\\/\u003e\\nE,g, if there are 1M documents and the original set contains 1000 documents the score[] array would be of length 1000, If the sampled set will only have 10 documents, the score[] array should be only 10.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe relevant part:\u003c\\/p\u003e\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e\u003cspan class=\\\"code-keyword\\\"\u003eif\u003c\\/span\u003e (getKeepScores()) {\\n  scores[doc] = docs.scores[doc];\\n}\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\u003cp\u003eshould be changed as the scores[] size and index should be relative to the sampled set and not the original results.\u003cbr\\/\u003e\\nAlso the size of the score[] array could be the amount of bins?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"gilad\\\" id=\\\"commentauthor_13937580_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=gilad\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"gilad\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Gilad Barkai\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13937580_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Mar\\/14 09:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-17T09:16:14+0000\'\u003e17\\/Mar\\/14 09:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    About the scores (the only part I got to review thus far), the scores should be a non-sparse float array. \\nE,g, if there are 1M documents and the original set contains 1000 documents the score[] array would be of length 1000, If the sampled set will only have 10 documents, the score[] array should be only 10. \\n\\n The relevant part: \\n  \\n  if  (getKeepScores()) {\\n  scores[doc] = docs.scores[doc];\\n}\\n \\n  \\n should be changed as the scores[] size and index should be relative to the sampled set and not the original results. \\nAlso the size of the score[] array could be the amount of bins?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13937681\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13937681&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13937681\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13937681_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13937681_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Mar\\/14 11:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-17T11:10:52+0000\'\u003e17\\/Mar\\/14 11:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eRob, I reviewed the patch and I agree with Gilad - the way you handle the scores array is wrong. It\'s not random access by doc. I believe if you added a test it would show up quickly. But perhaps we can keep scores out of this collector ... we can always add it later. So I don\'t mind if you want to wrap up w\\/o scores for now. Can you then fix the patch to always set keepScores=false? Also, I noticed few sops left in test.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13937681_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13937681_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Mar\\/14 11:10\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-17T11:10:52+0000\'\u003e17\\/Mar\\/14 11:10\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Rob, I reviewed the patch and I agree with Gilad - the way you handle the scores array is wrong. It\'s not random access by doc. I believe if you added a test it would show up quickly. But perhaps we can keep scores out of this collector ... we can always add it later. So I don\'t mind if you want to wrap up w\\/o scores for now. Can you then fix the patch to always set keepScores=false? Also, I noticed few sops left in test.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13937755\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13937755&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13937755\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13937755_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13937755_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Mar\\/14 12:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-17T12:46:22+0000\'\u003e17\\/Mar\\/14 12:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eRemoved scores. Added javadoc explaining what happens to scores. Removed System.out.println\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"robau\\\" id=\\\"commentauthor_13937755_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=robau\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"robau\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rob Audenaerde\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13937755_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'17\\/Mar\\/14 12:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-17T12:46:22+0000\'\u003e17\\/Mar\\/14 12:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Removed scores. Added javadoc explaining what happens to scores. Removed System.out.println              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13940616\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13940616&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13940616\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13940616_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13940616_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Mar\\/14 16:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-19T16:07:28+0000\'\u003e19\\/Mar\\/14 16:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI reviewed the patch more closely before I commit:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eModified few javadocs\u003c\\/li\u003e\\n\\t\u003cli\u003eRemoved needsSampling() since we don\'t offer an extension any access to e.g. totalHits. We can add it when there\'s demand.\u003c\\/li\u003e\\n\\t\u003cli\u003eFixed a bug in how carryOver was implemented &#8211; replaced by two members \u003ctt\u003eleftoverBin\u003c\\/tt\u003e and \u003ctt\u003eleftoverIndex\u003c\\/tt\u003e. So now if \u003ctt\u003eleftoverBin != -1\u003c\\/tt\u003e we know to skip the first such documents in the next segment and depending on \u003ctt\u003eleftoverIndex\u003c\\/tt\u003e, whether we need to sample any of them. Before that, we didn\'t really skip over the leftover docs in the bin, but started to count a new bin.\u003c\\/li\u003e\\n\\t\u003cli\u003eAdded a CHANGES entry.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eI reviewed the test - would be good if we can write a unit test which specifically matches only few documents in one segment compared to the rest. I will look into it perhaps later.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think it\'s ready, but if anyone wants to give createSample() another look, to make sure this time leftover works well, I won\'t commit it by tomorrow anyway.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13940616_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13940616_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Mar\\/14 16:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-19T16:07:28+0000\'\u003e19\\/Mar\\/14 16:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I reviewed the patch more closely before I commit: \\n\\n \\n\\t Modified few javadocs \\n\\t Removed needsSampling() since we don\'t offer an extension any access to e.g. totalHits. We can add it when there\'s demand. \\n\\t Fixed a bug in how carryOver was implemented &#8211; replaced by two members  leftoverBin  and  leftoverIndex . So now if  leftoverBin != -1  we know to skip the first such documents in the next segment and depending on  leftoverIndex , whether we need to sample any of them. Before that, we didn\'t really skip over the leftover docs in the bin, but started to count a new bin. \\n\\t Added a CHANGES entry. \\n \\n\\n\\n I reviewed the test - would be good if we can write a unit test which specifically matches only few documents in one segment compared to the rest. I will look into it perhaps later. \\n\\n I think it\'s ready, but if anyone wants to give createSample() another look, to make sure this time leftover works well, I won\'t commit it by tomorrow anyway.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13941637\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13941637&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13941637\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jira-bot\\\" id=\\\"commentauthor_13941637_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jira-bot\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jira-bot\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e ASF subversion and git services\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13941637_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Mar\\/14 11:30\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-20T11:30:33+0000\'\u003e20\\/Mar\\/14 11:30\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eCommit 1579594 from \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\" class=\\\"user-hover\\\" rel=\\\"shaie\\\"\u003eShai Erera\u003c\\/a\u003e in branch \'dev\\/trunk\'\u003cbr\\/\u003e\\n[ \u003ca href=\\\"https:\\/\\/svn.apache.org\\/r1579594\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttps:\\/\\/svn.apache.org\\/r1579594\u003c\\/a\u003e ]\u003c\\/p\u003e\\n\\n\u003cp\u003e\u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-5476\\\" title=\\\"Facet sampling\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-5476\\\"\u003e\u003cdel\u003eLUCENE-5476\u003c\\/del\u003e\u003c\\/a\u003e: add RandomSamplingFacetsCollector\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jira-bot\\\" id=\\\"commentauthor_13941637_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jira-bot\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jira-bot\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e ASF subversion and git services\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13941637_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Mar\\/14 11:30\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-20T11:30:33+0000\'\u003e20\\/Mar\\/14 11:30\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Commit 1579594 from  Shai Erera  in branch \'dev\\/trunk\' \\n[  https:\\/\\/svn.apache.org\\/r1579594  ] \\n\\n   LUCENE-5476  : add RandomSamplingFacetsCollector              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13941638\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13941638&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13941638\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jira-bot\\\" id=\\\"commentauthor_13941638_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jira-bot\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jira-bot\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e ASF subversion and git services\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13941638_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Mar\\/14 11:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-20T11:33:39+0000\'\u003e20\\/Mar\\/14 11:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eCommit 1579596 from \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\" class=\\\"user-hover\\\" rel=\\\"shaie\\\"\u003eShai Erera\u003c\\/a\u003e in branch \'dev\\/trunk\'\u003cbr\\/\u003e\\n[ \u003ca href=\\\"https:\\/\\/svn.apache.org\\/r1579596\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttps:\\/\\/svn.apache.org\\/r1579596\u003c\\/a\u003e ]\u003c\\/p\u003e\\n\\n\u003cp\u003e\u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-5476\\\" title=\\\"Facet sampling\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-5476\\\"\u003e\u003cdel\u003eLUCENE-5476\u003c\\/del\u003e\u003c\\/a\u003e: use empty diamond\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jira-bot\\\" id=\\\"commentauthor_13941638_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jira-bot\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jira-bot\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e ASF subversion and git services\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13941638_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Mar\\/14 11:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-20T11:33:39+0000\'\u003e20\\/Mar\\/14 11:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Commit 1579596 from  Shai Erera  in branch \'dev\\/trunk\' \\n[  https:\\/\\/svn.apache.org\\/r1579596  ] \\n\\n   LUCENE-5476  : use empty diamond              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13941640\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13941640&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13941640\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jira-bot\\\" id=\\\"commentauthor_13941640_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jira-bot\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jira-bot\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e ASF subversion and git services\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13941640_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Mar\\/14 11:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-20T11:35:39+0000\'\u003e20\\/Mar\\/14 11:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eCommit 1579598 from \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\" class=\\\"user-hover\\\" rel=\\\"shaie\\\"\u003eShai Erera\u003c\\/a\u003e in branch \'dev\\/branches\\/branch_4x\'\u003cbr\\/\u003e\\n[ \u003ca href=\\\"https:\\/\\/svn.apache.org\\/r1579598\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttps:\\/\\/svn.apache.org\\/r1579598\u003c\\/a\u003e ]\u003c\\/p\u003e\\n\\n\u003cp\u003e\u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/LUCENE-5476\\\" title=\\\"Facet sampling\\\" class=\\\"issue-link\\\" data-issue-key=\\\"LUCENE-5476\\\"\u003e\u003cdel\u003eLUCENE-5476\u003c\\/del\u003e\u003c\\/a\u003e: add RandomSamplingFacetsCollector\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jira-bot\\\" id=\\\"commentauthor_13941640_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jira-bot\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jira-bot\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e ASF subversion and git services\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13941640_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Mar\\/14 11:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-20T11:35:39+0000\'\u003e20\\/Mar\\/14 11:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Commit 1579598 from  Shai Erera  in branch \'dev\\/branches\\/branch_4x\' \\n[  https:\\/\\/svn.apache.org\\/r1579598  ] \\n\\n   LUCENE-5476  : add RandomSamplingFacetsCollector              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13941641\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13941641&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13941641\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13941641_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13941641_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Mar\\/14 11:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-20T11:36:04+0000\'\u003e20\\/Mar\\/14 11:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eCommitted to trunk and 4x. Thanks Rob and Gilad for your contributions!\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"shaie\\\" id=\\\"commentauthor_13941641_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=shaie\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"shaie\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Shai Erera\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13941641_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Mar\\/14 11:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-03-20T11:36:04+0000\'\u003e20\\/Mar\\/14 11:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Committed to trunk and 4x. Thanks Rob and Gilad for your contributions!              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13982588\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/LUCENE-5476?focusedCommentId=13982588&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13982588\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"thetaphi\\\" id=\\\"commentauthor_13982588_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=thetaphi\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"thetaphi\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Uwe Schindler\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13982588_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Apr\\/14 23:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-27T23:25:50+0000\'\u003e27\\/Apr\\/14 23:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eClose issue after release of 4.8.0\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"thetaphi\\\" id=\\\"commentauthor_13982588_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=thetaphi\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"thetaphi\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Uwe Schindler\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13982588_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Apr\\/14 23:25\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-27T23:25:50+0000\'\u003e27\\/Apr\\/14 23:25\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Close issue after release of 4.8.0              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\"";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["scope-filter-data"]="{\"createScopeActions\":[],\"scopes\":[]}";
WRM._unparsedData["sidebar-collapsed-by-default"]="true";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:can-manage"]="false";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:with-icons"]="false";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:shortcuts"]="[]";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:project-id"]="12310110";
WRM._unparsedData["sidebar-id"]="\"\u003cdiv class=\\\"aui-sidebar  projects-sidebar sidebar-pending\\\" \u003e\u003cdiv class=\\\"aui-sidebar-wrapper\\\"\u003e\u003cdiv class=\\\"aui-sidebar-body\\\"\u003e\u003cheader class=\\\"aui-page-header\\\"\u003e\u003cdiv class=\\\"aui-page-header-inner\\\"\u003e\u003cdiv class=\\\"aui-page-header-image\\\"\u003e\u003ca href=\\\"\\/jira\\/projects\\/LUCENE\\/summary\\\" title=\\\"Lucene - Core\\\" class=\\\"jira-project-avatar\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-large aui-avatar-project\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"\\/jira\\/secure\\/projectavatar?pid=12310110&amp;avatarId=10061\\\" alt=\\\"Lucene - Core\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e\u003cimg src=\\\"data:image\\/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI\\/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE4LjEuMSwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCINCgkgdmlld0JveD0iMCAwIDMwMCAzMDAiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDMwMCAzMDA7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxnIGlkPSJMYXllcl8yIj4NCgk8cGF0aCBzdHlsZT0iZmlsbDojRjc5MjMyOyIgZD0iTTE1MCwwQzY2LjY2NywwLDAsNjYuNjY3LDAsMTUwczY2LjY2NywxNTAsMTUwLDE1MHMxNTAtNjYuNjY3LDE1MC0xNTBTMjMzLjMzMywwLDE1MCwweg0KCQkgTTEzNi42NjcsMTc4LjMzM0wxMjUsMTkwbC00MS42NjctNDBMOTUsMTM4LjMzM2wzMC0zMEwxMzYuNjY3LDEyMGwtMzAsMzBMMTM2LjY2NywxNzguMzMzeiBNMjA1LDE2MS42NjdsLTMwLDMwTDE2My4zMzMsMTgwDQoJCWwzMC0zMGwtMzAtMzBMMTc1LDEwOC4zMzNMMjE2LjY2NywxNTBMMjA1LDE2MS42Njd6Ii8+DQo8L2c+DQo8Zz4NCgk8cG9seWdvbiBzdHlsZT0iZmlsbDojRkZGRkZGOyIgcG9pbnRzPSIxNzUsMTkxLjY2NyAyMDUsMTYxLjY2NyAyMTYuNjY3LDE1MCAxNzUsMTA4LjMzMyAxNjMuMzMzLDEyMCAxOTMuMzMzLDE1MCAxNjMuMzMzLDE4MCAJIi8+DQoJPHBvbHlnb24gc3R5bGU9ImZpbGw6I0ZGRkZGRjsiIHBvaW50cz0iMTI1LDEwOC4zMzMgOTUsMTM4LjMzMyA4My4zMzMsMTUwIDEyNSwxOTAgMTM2LjY2NywxNzguMzMzIDEwNi42NjcsMTUwIDEzNi42NjcsMTIwIAkiLz4NCjwvZz4NCjwvc3ZnPg0K\\\" alt=\\\"Icon indicating the project type\\\" class=\\\"jira-project-avatar-icon\\\" \\/\u003e\u003c\\/a\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-image --\u003e\u003cdiv class=\\\"aui-page-header-main\\\"\u003e\u003ch1\u003e\u003cdiv class=\\\"aui-group aui-group-split\\\"\u003e\u003cdiv class=\\\"aui-item project-title\\\"\u003e\u003ca href=\\\"\\/jira\\/projects\\/LUCENE\\/summary\\\" title=\\\"Lucene - Core\\\"\u003eLucene - Core\u003c\\/a\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/h1\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-main --\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-inner --\u003e\u003c\\/header\u003e\u003c!-- .aui-page-header --\u003e\u003cnav class=\\\"aui-navgroup aui-navgroup-vertical\\\"\u003e\u003cdiv class=\\\"aui-navgroup-inner sidebar-content-container\\\"\u003e\u003cdiv class=\\\"aui-sidebar-group aui-sidebar-group-tier-one\\\" data-id=\\\"sidebar-navigation-panel\\\"\u003e\u003cul class=\\\"aui-nav\\\"\u003e\u003cli class=\\\"aui-nav-selected\\\" \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/LUCENE\\/issues\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-issue-navigator:sidebar-issue-navigator\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large icon-sidebar-issues\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Issues\\\"\u003eIssues\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003cli  \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/LUCENE?selectedItem=com.atlassian.jira.jira-projects-plugin:report-page\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-plugin:report-page\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large agile-icon-report\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Reports\\\"\u003eReports\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003cli  \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/LUCENE?selectedItem=com.atlassian.jira.jira-projects-plugin:components-page\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-plugin:components-page\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large icon-sidebar-components\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Components\\\"\u003eComponents\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003c\\/ul\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/nav\u003e\u003c\\/div\u003e\u003cdiv class=\\\"aui-sidebar-footer\\\"\u003e\u003ca class=\\\"aui-button aui-button-subtle aui-sidebar-toggle aui-sidebar-footer-tipsy\\\" data-tooltip=\\\"Expand sidebar ( [ )\\\" href=\\\"#\\\"\u003e\u003cspan class=\\\"aui-icon aui-icon-small\\\"\u003e\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/div\u003e\"";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/-juyfor/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:bigpipe-init/jira.webresources:bigpipe-init.js" data-wrm-key="jira.webresources:bigpipe-init" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <form id="jira_request_timing_info" class="dont-default-focus"> 
   <fieldset class="parameters hidden"> 
    <input type="hidden" title="jira.request.start.millis" value="1516204982728"> 
    <input type="hidden" title="jira.request.server.time" value="682"> 
    <input type="hidden" title="jira.request.id" value="963x7780215x8"> 
    <input type="hidden" title="jira.session.expiry.time" value="-"> 
    <input type="hidden" title="jira.session.expiry.in.mins" value="-"> 
    <input id="jiraConcurrentRequests" type="hidden" name="jira.request.concurrent.requests" value="12"> 
    <input type="hidden" title="db.reads.time.in.ms" value="38"> 
    <input type="hidden" title="db.conns.time.in.ms" value="46"> 
   </fieldset> 
  </form> 
  <!--
	                 REQUEST ID : 963x7780215x8
	          REQUEST TIMESTAMP : [17/Jan/2018:16:03:02 +0000]
	               REQUEST TIME : 0.6820
	                 ASESSIONID : -
	        CONCURRENT REQUESTS : 12

	                      db.reads : OpSnapshot{name='db.reads', invocationCount=18, elapsedTotal=38416938, elapsedMin=721882, elapsedMax=15765520, resultSetSize=0, cpuTotal=0, cpuMin=0, cpuMax=0}
	                      db.conns : OpSnapshot{name='db.conns', invocationCount=22, elapsedTotal=46039770, elapsedMin=754909, elapsedMax=15824634, resultSetSize=0, cpuTotal=0, cpuMin=0, cpuMax=0}
-->   
 </body>
</html>