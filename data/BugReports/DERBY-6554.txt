<!doctype html>
<html lang="en">
 <head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=Edge"> 
  <meta name="application-name" content="JIRA" data-name="jira" data-version="7.6.3">
  <meta name="ajs-viewissue-use-history-api" content="false"> 
  <meta name="ajs-jira-base-url" content="https://issues.apache.org/jira"> 
  <meta name="ajs-serverRenderedViewIssue" content="true"> 
  <meta name="ajs-dev-mode" content="false"> 
  <meta name="ajs-context-path" content="/jira"> 
  <meta name="ajs-version-number" content="7.6.3"> 
  <meta name="ajs-build-number" content="76005"> 
  <meta name="ajs-is-beta" content="false"> 
  <meta name="ajs-is-rc" content="false"> 
  <meta name="ajs-is-snapshot" content="false"> 
  <meta name="ajs-is-milestone" content="false"> 
  <meta name="ajs-remote-user" content=""> 
  <meta name="ajs-remote-user-fullname" content=""> 
  <meta name="ajs-user-locale" content="en_UK"> 
  <meta name="ajs-user-locale-group-separator" content=","> 
  <meta name="ajs-app-title" content="ASF JIRA"> 
  <meta name="ajs-keyboard-shortcuts-enabled" content="true"> 
  <meta name="ajs-keyboard-accesskey-modifier" content="Ctrl+Alt"> 
  <meta name="ajs-enabled-dark-features" content="[&quot;com.atlassian.jira.agile.darkfeature.editable.detailsview&quot;,&quot;nps.survey.inline.dialog&quot;,&quot;com.atlassian.jira.agile.darkfeature.edit.closed.sprint.enabled&quot;,&quot;jira.plugin.devstatus.phasetwo&quot;,&quot;jira.frother.reporter.field&quot;,&quot;atlassian.rest.xsrf.legacy.enabled&quot;,&quot;jira.issue.status.lozenge&quot;,&quot;com.atlassian.jira.config.BIG_PIPE&quot;,&quot;com.atlassian.jira.projects.issuenavigator&quot;,&quot;com.atlassian.jira.config.PDL&quot;,&quot;jira.plugin.devstatus.phasetwo.enabled&quot;,&quot;atlassian.aui.raphael.disabled&quot;,&quot;app-switcher.new&quot;,&quot;frother.assignee.field&quot;,&quot;com.atlassian.jira.projects.ProjectCentricNavigation.Switch&quot;,&quot;sd.internal.base.off.thread.on.completion.events.enabled&quot;,&quot;jira.onboarding.cyoa&quot;,&quot;com.atlassian.jira.agile.darkfeature.kanplan.enabled&quot;,&quot;sd.slavalue.record.updated.date.enabled&quot;,&quot;com.atlassian.jira.config.ProjectConfig.MENU&quot;,&quot;com.atlassian.jira.projects.sidebar.DEFER_RESOURCES&quot;,&quot;com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions.enabled&quot;,&quot;com.atlassian.jira.agile.darkfeature.sprint.goal.enabled&quot;,&quot;jira.zdu.admin-updates-ui&quot;,&quot;jira.zdu.jmx-monitoring&quot;,&quot;sd.sla.improved.rendering.enabled&quot;,&quot;sd.canned.responses.enabled&quot;,&quot;sd.new.settings.sidebar.location.disabled&quot;,&quot;jira.zdu.cluster-upgrade-state&quot;,&quot;com.atlassian.jira.agile.darkfeature.splitissue&quot;,&quot;com.atlassian.jira.config.CoreFeatures.LICENSE_ROLES_ENABLED&quot;,&quot;com.atlassian.feedback.feedback-button-move-to-header-enable&quot;,&quot;jira.export.csv.enabled&quot;]"> 
  <meta name="ajs-in-admin-mode" content="false"> 
  <meta name="ajs-is-sysadmin" content="false"> 
  <meta name="ajs-is-admin" content="false"> 
  <meta name="ajs-outgoing-mail-enabled" content="true"> 
  <meta name="ajs-date-relativize" content="true"> 
  <meta name="ajs-date-time" content="HH:mm"> 
  <meta name="ajs-date-day" content="EEEE HH:mm"> 
  <meta name="ajs-date-dmy" content="dd/MMM/yy"> 
  <meta name="ajs-date-complete" content="dd/MMM/yy HH:mm"> 
  <script type="text/javascript">var AJS=AJS||{};AJS.debug=true;</script> 
  <meta id="atlassian-token" name="atlassian-token" content="A5KQ-2QAV-T4JA-FDED|e5cf56e2c9cac8ae12e4560bc017376f390de382|lout"> 
  <link rel="shortcut icon" href="/jira/s/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/_/favicon.ico"> 
  <!--[if IE]><![endif]--> 
  <script type="text/javascript">
    (function() {
        var contextPath = '/jira';
        var eventBuffer = [];

        function printDeprecatedMsg() {
            if (console && console.warn) {
                console.warn('DEPRECATED JS - contextPath global variable has been deprecated since 7.4.0. Use `wrm/context-path` module instead.');
            }
        }

        function sendEvent(analytics, postfix) {
            analytics.send({
                name: 'js.globals.contextPath.' + postfix
            });
        }

        function sendDeprecatedEvent(postfix) {
            try {
                var analytics = require('jira/analytics');
                if (eventBuffer.length) {
                    eventBuffer.forEach(function(value) {
                        sendEvent(analytics, value);
                    });
                    eventBuffer = [];
                }

                if (postfix) {
                    sendEvent(analytics, postfix);
                }
            } catch(ex) {
                eventBuffer.push(postfix);
                setTimeout(sendDeprecatedEvent, 1000);
            }
        }

        Object.defineProperty(window, 'contextPath', {
            get: function() {
                printDeprecatedMsg();
                sendDeprecatedEvent('get');
                return contextPath;
            },
            set: function(value) {
                printDeprecatedMsg();
                sendDeprecatedEvent('set');
                contextPath = value;
            }
        });
    })();

</script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"/jira\"";
WRM._unparsedData["jira.webresources:feature-flags.feature-flag-data"]="{\"enabled-feature-keys\":[\"com.atlassian.jira.agile.darkfeature.editable.detailsview\",\"nps.survey.inline.dialog\",\"com.atlassian.jira.agile.darkfeature.edit.closed.sprint.enabled\",\"jira.plugin.devstatus.phasetwo\",\"jira.frother.reporter.field\",\"atlassian.rest.xsrf.legacy.enabled\",\"jira.issue.status.lozenge\",\"com.atlassian.jira.config.BIG_PIPE\",\"com.atlassian.jira.projects.issuenavigator\",\"com.atlassian.jira.config.PDL\",\"jira.plugin.devstatus.phasetwo.enabled\",\"atlassian.aui.raphael.disabled\",\"app-switcher.new\",\"frother.assignee.field\",\"com.atlassian.jira.projects.ProjectCentricNavigation.Switch\",\"sd.internal.base.off.thread.on.completion.events.enabled\",\"jira.onboarding.cyoa\",\"com.atlassian.jira.agile.darkfeature.kanplan.enabled\",\"sd.slavalue.record.updated.date.enabled\",\"com.atlassian.jira.config.ProjectConfig.MENU\",\"com.atlassian.jira.projects.sidebar.DEFER_RESOURCES\",\"com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions.enabled\",\"com.atlassian.jira.agile.darkfeature.sprint.goal.enabled\",\"jira.zdu.admin-updates-ui\",\"jira.zdu.jmx-monitoring\",\"sd.sla.improved.rendering.enabled\",\"sd.canned.responses.enabled\",\"sd.new.settings.sidebar.location.disabled\",\"jira.zdu.cluster-upgrade-state\",\"com.atlassian.jira.agile.darkfeature.splitissue\",\"com.atlassian.jira.config.CoreFeatures.LICENSE_ROLES_ENABLED\",\"com.atlassian.feedback.feedback-button-move-to-header-enable\",\"jira.export.csv.enabled\"],\"feature-flag-states\":{\"com.atlassian.jira.agile.darkfeature.kanplan\":false,\"sd.internal.base.off.thread.on.completion.events\":false,\"jira.instrumentation.laas\":false,\"com.atlassian.jira.agile.darkfeature.edit.closed.sprint\":false,\"com.atlassian.jira.issuetable.draggable\":true,\"jira.create.linked.issue\":true,\"com.atlassian.jira.agile.darkfeature.sprint.goal\":false,\"jira.sal.host.connect.accessor.existing.transaction.will.create.transactions\":true,\"jira.jql.suggestrecentfields\":false,\"com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions\":false,\"jira.jql.smartautoselectfirst\":false,\"com.atlassian.jira.agile.darkfeature.optimistic.transitions\":true,\"com.atlassian.jira.issuetable.move.links.hidden\":true,\"jira.priorities.per.project\":true,\"com.atlassian.jira.upgrade.startup.fix.index\":true,\"jira.renderer.consider.variable.format\":true}}";
WRM._unparsedData["jira.webresources:default-comment-security-level.DefaultCommentSecurityLevelHelpLink"]="{\"extraClasses\":\"default-comment-level-help\",\"title\":\"Commenting on an Issue\",\"url\":\"https://docs.atlassian.com/jira/jcore-docs-076/Editing+and+collaborating+on+issues#Editingandcollaboratingonissues-restrictacomment\",\"isLocal\":false}";
WRM._unparsedData["jira.webresources:dateFormatProvider.allFormats"]="{\"dateFormats\":{\"meridiem\":[\"AM\",\"PM\"],\"eras\":[\"BC\",\"AD\"],\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"monthsShort\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"weekdaysShort\":[\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\",\"Sat\"],\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]},\"lookAndFeelFormats\":{\"relativize\":\"true\",\"time\":\"HH:mm\",\"day\":\"EEEE HH:mm\",\"dmy\":\"dd/MMM/yy\",\"complete\":\"dd/MMM/yy HH:mm\"}}";
WRM._unparsedData["com.atlassian.jira.jira-issue-nav-components:issueviewer.features"]="{\"rteEnabled\":true}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-dnd-attachment-plugin:dnd-issue-drop-zone.thumbnail-mime-types"]="\"image/vnd.wap.wbmp,image/png,image/x-png,image/jpeg,image/bmp,image/gif\"";
WRM._unparsedData["com.atlassian.jira.plugins.jira-dnd-attachment-plugin:dnd-issue-drop-zone.upload-limit"]="\"62914560\"";
WRM._unparsedData["com.atlassian.plugins.helptips.jira-help-tips:help-tip-manager.JiraHelpTipData"]="{\"anonymous\":true}";
WRM._unparsedData["com.atlassian.jira.jira-view-issue-plugin:controller-subtasks.controller.subtasks.parameters"]="{\"url\":\"/rest/api/2/issue/{issueId}/subtask/move\"}";
WRM._unparsedData["com.atlassian.analytics.analytics-client:policy-update-init.policy-update-data-provider"]="false";
WRM._unparsedData["com.atlassian.analytics.analytics-client:programmatic-analytics-init.programmatic-analytics-data-provider"]="false";
WRM._unparsedData["jira.webresources:avatar-picker.data"]="{}";
WRM._unparsedData["com.atlassian.feedback.jira-feedback-plugin:button-resources-init.data"]="{\"jira.feedback.plugin.issue.collector.core\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"jira.feedback.plugin.issue.collector.default\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"jira.feedback.plugin.issue.collector.service.desk\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?locale=en-UK&collectorId=a698db21\",\"jira.feedback.plugin.issue.collector.software\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"isHeaderFeedbackButtonEnabled\":true}";
WRM._unparsedData["com.atlassian.jira.jira-header-plugin:dismissedFlags.flags"]="{\"dismissed\":[]}";
WRM._unparsedData["com.atlassian.jira.jira-header-plugin:newsletter-signup-tip-init.newsletterSignup"]="{\"signupDescription\":\"Get updates, inspiration and best practices from the team behind JIRA.\",\"formUrl\":\"https://www.atlassian.com/apis/exact-target/{0}/subscribe?mailingListId=1401671\",\"signupTitle\":\"Sign up!\",\"signupId\":\"newsletter-signup-tip\",\"showNewsletterTip\":false}";
WRM._unparsedData["com.atlassian.jira.project-templates-plugin:project-templates-plugin-resources.ptAnalyticsData"]="{\"instanceCreatedDate\":\"2011-01-31\"}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-wiki-editor:wiki-editor-resources.help-data"]="{\"showHelp\":true,\"editorDocumentationUrl\":[\"https://docs.atlassian.com/jira/jcore-docs-076/Visual+editing\"],\"editorDocumentationTitle\":[\"Show me documentation for the visual editor\"]}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-wiki-editor:wiki-editor-resources.thumbnails-allowed"]="false";
WRM._unparsedData["jira.webresources:user-message-flags.adminLockout"]="{}";
WRM._unparsedData["jira.request.correlation-id"]="\"8aa4be206ec727\"";
WRM._unparsedData["project-id"]="10594";
WRM._unparsedData["project-key"]="\"DERBY\"";
WRM._unparsedData["project-name"]="\"Derby\"";
WRM._unparsedData["project-type"]="\"software\"";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:generic-filters"]="[{\"id\":\"allissues\",\"jql\":\"project = \\\"{0}\\\" ORDER BY {1}\",\"defaultOrderby\":\"created DESC\",\"label\":\"All issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[]},{\"id\":\"allopenissues\",\"jql\":\"project = \\\"{0}\\\" AND resolution = Unresolved ORDER BY {1}\",\"defaultOrderby\":\"priority DESC, updated DESC\",\"label\":\"Open issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"resolution\"]},{\"id\":\"doneissues\",\"jql\":\"project = \\\"{0}\\\" AND statusCategory = Done ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Done issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":false,\"fields\":[\"status\"]},{\"id\":\"recentlyviewed\",\"jql\":\"project = \\\"{0}\\\" AND issuekey in issueHistory() ORDER BY {1}\",\"defaultOrderby\":\"lastViewed DESC\",\"label\":\"Viewed recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"issuekey\"]},{\"id\":\"addedrecently\",\"jql\":\"project = \\\"{0}\\\" AND created \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"created DESC\",\"label\":\"Created recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"created\"]},{\"id\":\"resolvedrecently\",\"jql\":\"project = \\\"{0}\\\" AND resolutiondate \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Resolved recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":false,\"fields\":[\"resolutiondate\"]},{\"id\":\"updatedrecently\",\"jql\":\"project = \\\"{0}\\\" AND updated \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Updated recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"updated\"]}]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:default-filter-priority"]="[\"allopenissues\",\"allissues\"]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:can-manage-filters"]="false";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:project-filters"]="[]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:can-create-issues"]="false";
WRM._unparsedData["projectId"]="10594";
WRM._unparsedData["projectKey"]="\"DERBY\"";
WRM._unparsedData["projectType"]="\"software\"";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:server-rendered"]="true";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/a8a4711bc3f2eb261d8c8fd9fbcbba8b-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1fca1750044f2777c977e8d8cc023344/_/download/contextbatch/css/_super/batch.css" data-wrm-key="_super" data-wrm-batch-type="context" media="all"> 
  <link type="text/css" rel="stylesheet" href="/jira/s/74ac580603ca910fff0cfdf319e54add-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/fbf45109b31165e5b7740a9d72318cea/_/download/contextbatch/css/project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super/batch.css?agile_global_admin_condition=true&amp;hc-enabled=true&amp;is-server-instance=true&amp;jag=true&amp;jira.create.linked.issue=true&amp;nps-acknowledged=true&amp;richediton=true" data-wrm-key="project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super" data-wrm-batch-type="context" media="all"> 
  <link type="text/css" rel="stylesheet" href="/jira/s/611672383f6cab00ab202241ba6f9d68-T/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/7.6.3/_/download/batch/com.atlassian.feedback.jira-feedback-plugin:button-resources-init/com.atlassian.feedback.jira-feedback-plugin:button-resources-init.css" data-wrm-key="com.atlassian.feedback.jira-feedback-plugin:button-resources-init" data-wrm-batch-type="resource" media="all"> 
  <script type="text/javascript" src="/jira/s/98ceb006e504d7924d5ffc411626c6bc-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1fca1750044f2777c977e8d8cc023344/_/download/contextbatch/js/_super/batch.js?locale=en-UK" data-wrm-key="_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/c1e4d26ea276469807c3dc0918df482c-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/fbf45109b31165e5b7740a9d72318cea/_/download/contextbatch/js/project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super/batch.js?agile_global_admin_condition=true&amp;hc-enabled=true&amp;is-server-instance=true&amp;jag=true&amp;jira.create.linked.issue=true&amp;locale=en-UK&amp;nps-acknowledged=true&amp;richediton=true" data-wrm-key="project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/6bf9253c8d533109c3b02e26794be24e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/871d45c9f322a22cb3aa9b7948a69803/_/download/contextbatch/js/atl.global,-_super/batch.js?locale=en-UK" data-wrm-key="atl.global,-_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:calendar-en/jira.webresources:calendar-en.js" data-wrm-key="jira.webresources:calendar-en" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:calendar-localisation-moment/jira.webresources:calendar-localisation-moment.js" data-wrm-key="jira.webresources:calendar-localisation-moment" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/7.6.3/_/download/batch/com.atlassian.feedback.jira-feedback-plugin:button-resources/com.atlassian.feedback.jira-feedback-plugin:button-resources.js" data-wrm-key="com.atlassian.feedback.jira-feedback-plugin:button-resources" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/ccd2e67b523185973473e8bd5735c8f9-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/e0de73613a1027de08f3da6a45e1d1a2/_/download/contextbatch/css/jira.global.look-and-feel,-_super/batch.css" data-wrm-key="jira.global.look-and-feel,-_super" data-wrm-batch-type="context" media="all"> 
  <script type="text/javascript" src="/jira/rest/api/1.0/shortcuts/76005/33e5e0166867c8c9228d44506f60b2e8/shortcuts.js?context=issuenavigation&amp;context=issueaction"></script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.jira.jira-issue-nav-components:inline-edit-enabled"]="true";
WRM._unparsedData["should-display-chaperone"]="false";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/15712b600e9aecf72ffd9fd3704a0c78-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/6b22a15c7b83f87a47b1757076f43542/_/download/contextbatch/css/com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue/batch.css?jira.create.linked.issue=true&amp;richediton=true" data-wrm-key="com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue" data-wrm-batch-type="context" media="all"> 
  <script type="text/javascript" src="/jira/s/6579b6b8ba67abaa496e39b9242a18a4-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/6b22a15c7b83f87a47b1757076f43542/_/download/contextbatch/js/com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue/batch.js?jira.create.linked.issue=true&amp;locale=en-UK&amp;richediton=true" data-wrm-key="com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue" data-wrm-batch-type="context" data-initially-rendered></script> 
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
  <meta name="ajs-can-search-users" content="false"> 
  <meta name="ajs-can-edit-watchers" content="false"> 
  <meta name="ajs-default-avatar-url" content="https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10453"> 
  <meta name="ajs-issue-project-type" content="software"> 
  <meta name="ajs-issue-key" content="DERBY-6554"> 
  <meta name="ajs-server-view-issue-is-editable" content="false"> 
  <title>[DERBY-6554] Too much contention followed by assert failure when accessing sequence in transaction that created it - ASF JIRA</title> 
  <link rel="search" type="application/opensearchdescription+xml" href="/jira/osd.jsp" title="[DERBY-6554] Too much contention followed by assert failure when accessing sequence in transaction that created it - ASF JIRA"> 
 </head> 
 <body id="jira" class="aui-layout aui-theme-default " data-version="7.6.3"> 
  <div id="page"> 
   <header id="header" role="banner"> 
    <script>
require(["jquery", "jira/license-banner"], function ($, licenseBanner) {
    $(function () {
        licenseBanner.showLicenseBanner("");
        licenseBanner.showLicenseFlag("");
    });
});
</script> 
    <nav class="aui-header aui-dropdown2-trigger-group" role="navigation">
     <div class="aui-header-inner">
      <div class="aui-header-before">
       <a class=" aui-dropdown2-trigger app-switcher-trigger" aria-controls="app-switcher" aria-haspopup="true" role="button" tabindex="0" data-aui-trigger href="#app-switcher"><span class="aui-icon aui-icon-small aui-iconfont-appswitcher">Linked Applications</span></a>
       <div id="app-switcher" class="aui-dropdown2 aui-style-default" role="menu" aria-hidden="true" data-is-switcher="true" data-environment="{&quot;isUserAdmin&quot;:false,&quot;isAppSuggestionAvailable&quot;:false,&quot;isSiteAdminUser&quot;:false}">
        <div role="application">
         <div class="app-switcher-loading">
          Loading…
         </div>
        </div>
       </div>
      </div>
      <div class="aui-header-primary">
       <h1 id="logo" class="aui-header-logo aui-header-logo-custom"><a href="https://issues.apache.org/jira/secure/MyJiraHome.jspa"><img src="/jira/s/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/_/jira-logo-scaled.png" alt="ASF JIRA"></a></h1>
       <ul class="aui-nav">
        <li><a href="/jira/secure/Dashboard.jspa" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="home_link" aria-haspopup="true" aria-controls="home_link-content" title="View and manage your dashboards" accesskey="d">Dashboards</a>
         <div class="aui-dropdown2 aui-style-default" id="home_link-content" data-aui-dropdown2-ajax-key="home_link"></div></li>
        <li><a href="/jira/browse/DERBY" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="browse_link" aria-haspopup="true" aria-controls="browse_link-content" title="View recent projects and browse a list of projects" accesskey="p">Projects</a>
         <div class="aui-dropdown2 aui-style-default" id="browse_link-content" data-aui-dropdown2-ajax-key="browse_link"></div></li>
        <li><a href="/jira/issues/" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="find_link" aria-haspopup="true" aria-controls="find_link-content" title="Search for issues and view recent issues" accesskey="i">Issues</a>
         <div class="aui-dropdown2 aui-style-default" id="find_link-content" data-aui-dropdown2-ajax-key="find_link"></div></li> 
       </ul>
      </div>
      <div class="aui-header-secondary">
       <ul class="aui-nav">
        <li id="quicksearch-menu"> 
         <form action="/jira/secure/QuickSearch.jspa" method="get" id="quicksearch" class="aui-quicksearch dont-default-focus ajs-dirty-warning-exempt"> 
          <input id="quickSearchInput" class="search" type="text" title="Search" placeholder="Search" name="searchString" accessKey="q"> 
          <input type="submit" class="hidden" value="Search"> 
         </form> </li> 
        <li><a class="jira-feedback-plugin" role="button" aria-haspopup="true" id="jira-header-feedback-link" href="#"><span class="aui-icon aui-icon-small jira-feedback-plugin-icon">Give feedback to Atlassian</span></a></li> 
        <li id="system-help-menu"> <a class="aui-nav-link aui-dropdown2-trigger" id="help_menu" aria-haspopup="true" aria-owns="system-help-menu-content" href="https://docs.atlassian.com/jira/jcore-docs-076/" target="$textUtils.htmlEncode($rootHelpMenuItem.params.target)" title="Help"><span class="aui-icon aui-icon-small aui-iconfont-help">Help</span></a> 
         <div id="system-help-menu-content" class="aui-dropdown2 aui-style-default"> 
          <div class="aui-dropdown2-section"> 
           <ul id="jira-help" class="aui-list-truncate"> 
            <li> <a id="view_core_help" class="aui-nav-link " title="Go to the online documentation for JIRA Core" href="https://docs.atlassian.com/jira/jcore-docs-076/" target="_blank">JIRA Core help</a> </li> 
            <li> <a id="keyshortscuthelp" class="aui-nav-link " title="Get more information about JIRA's Keyboard Shortcuts" href="/jira/secure/ViewKeyboardShortcuts!default.jspa" target="_blank">Keyboard Shortcuts</a> </li> 
            <li> <a id="view_about" class="aui-nav-link " title="Get more information about JIRA" href="/jira/secure/AboutPage.jspa">About JIRA</a> </li> 
            <li> <a id="view_credits" class="aui-nav-link " title="See who did what" href="/jira/secure/JiraCreditsPage!default.jspa" target="_blank">JIRA Credits</a> </li> 
           </ul> 
          </div> 
         </div> </li> 
        <li id="user-options"> <a class="aui-nav-link login-link" href="/jira/login.jsp?os_destination=%2Fbrowse%2FDERBY-6554">Log In</a> 
         <div id="user-options-content" class="aui-dropdown2 aui-style-default"> 
          <div class="aui-dropdown2-section"> 
          </div> 
         </div> </li> 
       </ul>
      </div>
     </div>
     <!-- .aui-header-inner-->
    </nav>
    <!-- .aui-header --> 
   </header> 
   <section id="content" role="main"> 
    <big-pipe data-id="sidebar-id" unresolved></big-pipe>
    <div class="aui-sidebar  sidebar-placeholder">
     <div class="aui-sidebar-wrapper">
      <div class="aui-sidebar-body"></div>
      <div class="aui-sidebar-footer">
       <a class="aui-button aui-button-subtle aui-sidebar-toggle aui-sidebar-footer-tipsy" data-tooltip="Expand sidebar ( [ )" href="#"><span class="aui-icon aui-icon-small"></span></a>
      </div>
     </div>
    </div>
    <script id="projects-sidebar-init">
    require(['jira/projects/sidebar/expansion-manager'], function(expansionManager) {
        var scriptTag = document.getElementById('projects-sidebar-init');
        var sidebar = AJS.sidebar('.aui-sidebar');
        expansionManager(sidebar);
        scriptTag.parentElement.removeChild(scriptTag);
    });
    </script>
    <div class="aui-page-panel">
     <div class="aui-page-panel-inner">
      <div class="issue-navigator">
       <div class="content">
        <div class="issue-view">
         <div class="navigation-tools">
          <div class="pager-container"></div>
         </div>
         <div class="issue-container">
          <div id="issue-content" class="issue-edit-form">
           <header id="stalker" class="issue-header js-stalker">
            <div class="issue-header-content">
             <header class="aui-page-header">
              <div class="aui-page-header-inner">
               <div class="aui-page-header-image">
                <span id="10594" class="aui-avatar aui-avatar-large aui-avatar-project"><span class="aui-avatar-inner"><img id="project-avatar" alt="Uploaded image for project: 'Derby'" src="https://issues.apache.org/jira/secure/projectavatar?pid=10594&amp;avatarId=10122"></span></span>
               </div>
               <!-- .aui-page-header-image -->
               <div class="aui-page-header-main">
                <ol class="aui-nav aui-nav-breadcrumbs">
                 <li><a id="project-name-val" href="/jira/browse/DERBY">Derby</a></li>
                 <li><a class="issue-link" data-issue-key="DERBY-6554" href="/jira/browse/DERBY-6554" id="key-val" rel="12710537">DERBY-6554</a></li>
                </ol>
                <h1 id="summary-val">Too much contention followed by assert failure when accessing sequence in transaction that created it</h1>
               </div>
               <!-- .aui-page-header-main -->
               <div class="aui-page-header-actions">
                <div id="issue-header-pager"></div>
               </div>
               <!-- .aui-page-header-actions -->
              </div>
              <!-- .aui-page-header-inner -->
             </header>
             <!-- .aui-page-header -->
             <div class="command-bar">
              <div class="ops-cont">
               <div class="ops-menus aui-toolbar">
                <div class="toolbar-split toolbar-split-left">
                 <ul id="opsbar-ops-login-lnk_container" class="toolbar-group pluggable-ops">
                  <li class="toolbar-item"><a id="ops-login-lnk" title="Log In" class="toolbar-trigger" href="/jira/login.jsp?os_destination=%2Fbrowse%2FDERBY-6554"><span class="trigger-label">Log In</span></a></li>
                 </ul>
                 <ul id="opsbar-opsbar-operations" class="toolbar-group pluggable-ops"></ul>
                 <ul id="opsbar-opsbar-transitions" class="toolbar-group pluggable-ops"></ul>
                 <ul id="opsbar-opsbar-admin" class="toolbar-group pluggable-ops"></ul>
                </div>
                <div class="toolbar-split toolbar-split-right">
                 <ul id="opsbar-jira.issue.tools" class="toolbar-group pluggable-ops">
                  <li class="toolbar-item">
                   <div>
                    <a href="#" id="viewissue-export" aria-owns="viewissue-export_drop" aria-haspopup="true" title="Export this issue in another format" class="toolbar-trigger aui-button aui-style-default aui-dropdown2-trigger"><span class="icon icon-default aui-icon aui-icon-small aui-iconfont-export"></span> <span class="dropdown-text">Export</span></a>
                    <div id="viewissue-export_drop" class="aui-style-default aui-dropdown2">
                     <ul>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-xml/DERBY-6554/DERBY-6554.xml" id="jira.issueviews:issue-xml"><span class="trigger-label">XML</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-word/DERBY-6554/DERBY-6554.doc" id="jira.issueviews:issue-word"><span class="trigger-label">Word</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-html/DERBY-6554/DERBY-6554.html" id="jira.issueviews:issue-html"><span class="trigger-label">Printable</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/com.atlassian.jira.plugins.jira-importers-plugin:issue-json/DERBY-6554/DERBY-6554.json" id="com.atlassian.jira.plugins.jira-importers-plugin:issue-json"><span class="trigger-label">JSON</span></a></li>
                     </ul>
                    </div>
                   </div></li>
                 </ul>
                </div>
               </div>
              </div>
             </div>
            </div>
           </header>
           <div class="issue-body-content">
            <div class="aui-group issue-body">
             <div class="aui-item issue-main-column">
              <div id="details-module" class="module toggle-wrap">
               <div id="details-module_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Details</h2>
               </div>
               <div class="mod-content"> 
                <ul id="issuedetails" class="property-list two-cols"> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Type:</strong> 
                   <span id="type-val" class="value"> <img alt="" height="16" src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype" title="Bug - A problem which impairs or prevents the functions of the product." width="16"> Bug </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Status:</strong> 
                   <span id="status-val" class="value"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done jira-issue-status-lozenge-max-width-medium" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </span> 
                  </div> </li> 
                 <li class="item new"> 
                  <div class="wrap"> 
                   <strong class="name">Priority:</strong> 
                   <span id="priority-val" class="value"> <img alt="" height="16" src="/jira/images/icons/priorities/major.svg" title="Major - Major loss of function." width="16"> Major </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Resolution:</strong> 
                   <span id="resolution-val" class="value resolved"> Fixed </span> 
                  </div> </li> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Affects Version/s:</strong> 
                   <span id="versions-val" class="value"> <span class="shorten" id="versions-field"> <span title="10.9.1.0 First release on the 10.9 branch">10.9.1.0</span>, <span title="10.10.2.0 candidate for Second release for 10.10 branch">10.10.2.0</span>, <span title="10.11.1.1 First release on the 10.11 branch">10.11.1.1</span> </span> </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Fix Version/s:</strong> 
                   <span id="fixfor-val" class="value"> <span class="shorten" id="fixVersions-field"> <a href="/jira/issues/?jql=project+%3D+DERBY+AND+fixVersion+%3D+10.11.1.1" title="10.11.1.1 First release on the 10.11 branch">10.11.1.1</a> </span> </span> 
                  </div> </li> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Component/s:</strong> 
                   <span id="components-val" class="value"> <span class="shorten" id="components-field"> <a href="/jira/issues/?jql=project+%3D+DERBY+AND+component+%3D+SQL" title="SQL ">SQL</a> </span> </span> 
                  </div> </li> 
                 <li class="item full-width"> 
                  <div class="wrap" id="wrap-labels"> 
                   <strong class="name">Labels:</strong> 
                   <div class="labels-wrap value"> 
                    <ul class="labels" id="labels-12710537-value"> 
                     <li><a class="lozenge" href="/jira/issues/?jql=labels+%3D+derby_backport_reject_10_10" title="derby_backport_reject_10_10"><span>derby_backport_reject_10_10</span></a></li> 
                    </ul> 
                   </div> 
                  </div> </li> 
                </ul> 
                <div id="customfieldmodule"> 
                 <div class="aui-tabs horizontal-tabs" id="customfield-tabs"> 
                  <div id="customfield-panel-1" class="tabs-pane active-pane"> 
                   <ul class="property-list"> 
                    <li id="rowForcustomfield_12310050" class="item"> 
                     <div class="wrap"> 
                      <strong title="Urgency" class="name">Urgency:</strong> 
                      <div id="customfield_12310050-val" class="value type-select" data-fieldtype="select" data-fieldtypecompletekey="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        Blocker 
                      </div> 
                     </div> </li> 
                    <li id="rowForcustomfield_12310090" class="item"> 
                     <div class="wrap"> 
                      <strong title="Issue &amp; fix info" class="name">Issue &amp; fix info:</strong> 
                      <div id="customfield_12310090-val" class="value type-multicheckboxes" data-fieldtype="multicheckboxes" data-fieldtypecompletekey="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes"> 
                       <div class="shorten" id="customfield_12310090-field"> 
                        <span>Repro attached</span> 
                       </div> 
                      </div> 
                     </div> </li> 
                   </ul> 
                  </div> 
                 </div>
                </div> 
               </div>
              </div>
              <div id="descriptionmodule" class="module toggle-wrap">
               <div id="descriptionmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Description</h2>
               </div>
               <div class="mod-content">
                <div id="description-val" class="field-ignore-highlight"> 
                 <div class="user-content-block"> 
                  <div class="preformatted panel" style="border-width: 1px;">
                   <div class="preformattedContent panelContent"> 
                    <pre>ij version 10.11
ij&gt; connect 'jdbc:derby:memory:db;create=true' as c1;
ij&gt; autocommit off;
ij&gt; create sequence seq;
0 rows inserted/updated/deleted
ij&gt; values next value for seq;
1          
-----------
ERROR X0Y84: Too much contention on sequence SEQ. This is probably caused by an uncommitted scan of the SYS.SYSSEQUENCES catalog. Do not query this catalog directly. Instead, use the SYSCS_UTIL.SYSCS_PEEK_AT_SEQUENCE function to view the current value of a query generator.
ij&gt; rollback;
ERROR 08003: No current connection.
ij&gt; connect 'jdbc:derby:memory:db' as c2;
ij(C2)&gt; autocommit off;
ij(C2)&gt; create sequence seq;
0 rows inserted/updated/deleted
ij(C2)&gt; values next value for seq;
1          
-----------
ERROR 38000: The exception 'org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED Identity being changed on a live cacheable. Old uuidString = 0ddd00a9-0145-98ba-79df-000007d88b08' was thrown while evaluating an expression.
ERROR XJ001: Java exception: 'ASSERT FAILED Identity being changed on a live cacheable. Old uuidString = 0ddd00a9-0145-98ba-79df-000007d88b08: org.apache.derby.shared.common.sanity.AssertFailure'.
</pre> 
                   </div>
                  </div> 
                 </div> 
                </div> 
               </div>
              </div>
              <div id="dnd-metadata" class="module toggle-wrap">
               <div id="dnd-metadata_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Attachments</h2>
               </div>
               <div class="mod-content">
                <div id="dnd-metadata-webpanel" data-can-attach="false" data-project-type="software" data-upload-limit="62914560" data-thumbnails-allowed="false"></div>
               </div>
              </div>
              <div id="attachmentmodule" class="module toggle-wrap">
               <div id="attachmentmodule_heading" class="mod-header">
                <ul class="ops">
                 <li class="drop">
                  <div class="aui-dd-parent">
                   <a href="#" class="icon drop-menu js-default-dropdown" title="Options"><span>Options</span></a>
                   <div class="aui-dropdown-content aui-list">
                    <ul id="attachment-sorting-options" class="aui-list-section aui-first">
                     <li class="aui-list-item"><a id="attachment-sort-key-name" href="/jira/browse/DERBY-6554?attachmentSortBy=fileName#attachmentmodule" class="aui-list-checked aui-checked aui-list-item-link" title="viewissue.subtasks.tab.show.all.name"><span>Sort By Name</span></a></li>
                     <li class="aui-list-item"><a id="attachment-sort-key-date" href="/jira/browse/DERBY-6554?attachmentSortBy=dateTime#attachmentmodule" class="aui-list-checked aui-list-item-link" title="Sort By Date"><span>Sort By Date</span></a></li>
                    </ul>
                    <ul id="attachment-sorting-order-options" class="aui-list-section aui-last">
                     <li class="aui-list-item"><a id="attachment-sort-direction-asc" href="/jira/browse/DERBY-6554?attachmentOrder=asc#attachmentmodule" class="aui-list-checked aui-checked aui-list-item-link" title="Ascending"><span>Ascending</span></a></li>
                     <li class="aui-list-item"><a id="attachment-sort-direction-desc" href="/jira/browse/DERBY-6554?attachmentOrder=desc#attachmentmodule" class="aui-list-checked aui-list-item-link" title="Descending"><span>Descending</span></a></li>
                    </ul>
                   </div>
                  </div></li>
                </ul>
                <h2 class="toggle-title">Attachments</h2>
               </div>
               <div class="mod-content">
                <ol id="file_attachments" class="item-attachments" data-sort-key="fileName" data-sort-order="asc">
                 <li class="attachment-content js-file-attachment" data-attachment-id="12643414" data-issue-id="12710537" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12643414/D6554_2.java" draggable="true" data-downloadurl="text/x-java-source:D6554_2.java:https://issues.apache.org/jira/secure/attachment/12643414/D6554_2.java"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-code" title="Java Source File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12643414/D6554_2.java" title="Latest  05/May/14 19:52 - Rick Hillegas" draggable="true" data-downloadurl="text/x-java-source:D6554_2.java:https://issues.apache.org/jira/secure/attachment/12643414/D6554_2.java">D6554_2.java</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-05-05T19:52:34.765Z">05/May/14 19:52</time>
                   </dd>
                   <dd class="attachment-size">
                    6 kB
                   </dd>
                   <dd class="attachment-author">
                    Rick Hillegas
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12642470" data-issue-id="12710537" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12642470/D6554.java" draggable="true" data-downloadurl="text/x-java:D6554.java:https://issues.apache.org/jira/secure/attachment/12642470/D6554.java"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-code" title="Java Source File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12642470/D6554.java" title="Latest  29/Apr/14 15:12 - Knut Anders Hatlen" draggable="true" data-downloadurl="text/x-java:D6554.java:https://issues.apache.org/jira/secure/attachment/12642470/D6554.java">D6554.java</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-04-29T15:12:47.102Z">29/Apr/14 15:12</time>
                   </dd>
                   <dd class="attachment-size">
                    0.9 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12642457" data-issue-id="12710537" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12642457/derby-6554-01-aa-useCreationTransaction.diff" draggable="true" data-downloadurl="application/octet-stream:derby-6554-01-aa-useCreationTransaction.diff:https://issues.apache.org/jira/secure/attachment/12642457/derby-6554-01-aa-useCreationTransaction.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12642457/derby-6554-01-aa-useCreationTransaction.diff" title="Latest  29/Apr/14 13:59 - Rick Hillegas" draggable="true" data-downloadurl="application/octet-stream:derby-6554-01-aa-useCreationTransaction.diff:https://issues.apache.org/jira/secure/attachment/12642457/derby-6554-01-aa-useCreationTransaction.diff">derby-6554-01-aa-useCreationTransaction.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-04-29T13:59:50.436Z">29/Apr/14 13:59</time>
                   </dd>
                   <dd class="attachment-size">
                    10 kB
                   </dd>
                   <dd class="attachment-author">
                    Rick Hillegas
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12642501" data-issue-id="12710537" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12642501/derby-6554-01-ab-useCreationTransaction.diff" draggable="true" data-downloadurl="application/octet-stream:derby-6554-01-ab-useCreationTransaction.diff:https://issues.apache.org/jira/secure/attachment/12642501/derby-6554-01-ab-useCreationTransaction.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12642501/derby-6554-01-ab-useCreationTransaction.diff" title="Latest  29/Apr/14 17:49 - Rick Hillegas" draggable="true" data-downloadurl="application/octet-stream:derby-6554-01-ab-useCreationTransaction.diff:https://issues.apache.org/jira/secure/attachment/12642501/derby-6554-01-ab-useCreationTransaction.diff">derby-6554-01-ab-useCreationTransaction.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-04-29T17:49:59.906Z">29/Apr/14 17:49</time>
                   </dd>
                   <dd class="attachment-size">
                    11 kB
                   </dd>
                   <dd class="attachment-author">
                    Rick Hillegas
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12642704" data-issue-id="12710537" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12642704/derby-6554-01-ac-useCreationTransaction.diff" draggable="true" data-downloadurl="application/octet-stream:derby-6554-01-ac-useCreationTransaction.diff:https://issues.apache.org/jira/secure/attachment/12642704/derby-6554-01-ac-useCreationTransaction.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12642704/derby-6554-01-ac-useCreationTransaction.diff" title="Latest  30/Apr/14 19:14 - Rick Hillegas" draggable="true" data-downloadurl="application/octet-stream:derby-6554-01-ac-useCreationTransaction.diff:https://issues.apache.org/jira/secure/attachment/12642704/derby-6554-01-ac-useCreationTransaction.diff">derby-6554-01-ac-useCreationTransaction.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-04-30T19:14:07.477Z">30/Apr/14 19:14</time>
                   </dd>
                   <dd class="attachment-size">
                    21 kB
                   </dd>
                   <dd class="attachment-author">
                    Rick Hillegas
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12642849" data-issue-id="12710537" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12642849/derby-6554-01-ad-bugfixes.diff" draggable="true" data-downloadurl="application/octet-stream:derby-6554-01-ad-bugfixes.diff:https://issues.apache.org/jira/secure/attachment/12642849/derby-6554-01-ad-bugfixes.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12642849/derby-6554-01-ad-bugfixes.diff" title="Latest  01/May/14 14:12 - Rick Hillegas" draggable="true" data-downloadurl="application/octet-stream:derby-6554-01-ad-bugfixes.diff:https://issues.apache.org/jira/secure/attachment/12642849/derby-6554-01-ad-bugfixes.diff">derby-6554-01-ad-bugfixes.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-05-01T14:12:51.232Z">01/May/14 14:12</time>
                   </dd>
                   <dd class="attachment-size">
                    10 kB
                   </dd>
                   <dd class="attachment-author">
                    Rick Hillegas
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12643098" data-issue-id="12710537" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12643098/derby-6554-02-aa-selfDeadlock.diff" draggable="true" data-downloadurl="application/octet-stream:derby-6554-02-aa-selfDeadlock.diff:https://issues.apache.org/jira/secure/attachment/12643098/derby-6554-02-aa-selfDeadlock.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12643098/derby-6554-02-aa-selfDeadlock.diff" title="Latest  02/May/14 19:33 - Rick Hillegas" draggable="true" data-downloadurl="application/octet-stream:derby-6554-02-aa-selfDeadlock.diff:https://issues.apache.org/jira/secure/attachment/12643098/derby-6554-02-aa-selfDeadlock.diff">derby-6554-02-aa-selfDeadlock.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-05-02T19:33:47.487Z">02/May/14 19:33</time>
                   </dd>
                   <dd class="attachment-size">
                    21 kB
                   </dd>
                   <dd class="attachment-author">
                    Rick Hillegas
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12643354" data-issue-id="12710537" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12643354/derby-6554-02-ab-selfDeadlock.diff" draggable="true" data-downloadurl="application/octet-stream:derby-6554-02-ab-selfDeadlock.diff:https://issues.apache.org/jira/secure/attachment/12643354/derby-6554-02-ab-selfDeadlock.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12643354/derby-6554-02-ab-selfDeadlock.diff" title="Latest  05/May/14 12:20 - Rick Hillegas" draggable="true" data-downloadurl="application/octet-stream:derby-6554-02-ab-selfDeadlock.diff:https://issues.apache.org/jira/secure/attachment/12643354/derby-6554-02-ab-selfDeadlock.diff">derby-6554-02-ab-selfDeadlock.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-05-05T12:20:04.621Z">05/May/14 12:20</time>
                   </dd>
                   <dd class="attachment-size">
                    21 kB
                   </dd>
                   <dd class="attachment-author">
                    Rick Hillegas
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12643578" data-issue-id="12710537" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12643578/derby-6554-02-ac-selfDeadlock.diff" draggable="true" data-downloadurl="application/octet-stream:derby-6554-02-ac-selfDeadlock.diff:https://issues.apache.org/jira/secure/attachment/12643578/derby-6554-02-ac-selfDeadlock.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12643578/derby-6554-02-ac-selfDeadlock.diff" title="Latest  06/May/14 14:22 - Rick Hillegas" draggable="true" data-downloadurl="application/octet-stream:derby-6554-02-ac-selfDeadlock.diff:https://issues.apache.org/jira/secure/attachment/12643578/derby-6554-02-ac-selfDeadlock.diff">derby-6554-02-ac-selfDeadlock.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-05-06T14:22:50.382Z">06/May/14 14:22</time>
                   </dd>
                   <dd class="attachment-size">
                    22 kB
                   </dd>
                   <dd class="attachment-author">
                    Rick Hillegas
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12643803" data-issue-id="12710537" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12643803/derby-6554-02-ae-selfDeadlock_sps_compress.diff" draggable="true" data-downloadurl="application/octet-stream:derby-6554-02-ae-selfDeadlock_sps_compress.diff:https://issues.apache.org/jira/secure/attachment/12643803/derby-6554-02-ae-selfDeadlock_sps_compress.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12643803/derby-6554-02-ae-selfDeadlock_sps_compress.diff" title="Latest  07/May/14 17:15 - Rick Hillegas" draggable="true" data-downloadurl="application/octet-stream:derby-6554-02-ae-selfDeadlock_sps_compress.diff:https://issues.apache.org/jira/secure/attachment/12643803/derby-6554-02-ae-selfDeadlock_sps_compress.diff">derby-6554-02-ae-selfDeadlock_sps_compress.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-05-07T17:15:27.489Z">07/May/14 17:15</time>
                   </dd>
                   <dd class="attachment-size">
                    25 kB
                   </dd>
                   <dd class="attachment-author">
                    Rick Hillegas
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12644112" data-issue-id="12710537" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12644112/derby-6554-02-af-askToRaiseSelfDeadlock.diff" draggable="true" data-downloadurl="application/octet-stream:derby-6554-02-af-askToRaiseSelfDeadlock.diff:https://issues.apache.org/jira/secure/attachment/12644112/derby-6554-02-af-askToRaiseSelfDeadlock.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12644112/derby-6554-02-af-askToRaiseSelfDeadlock.diff" title="Latest  09/May/14 14:20 - Rick Hillegas" draggable="true" data-downloadurl="application/octet-stream:derby-6554-02-af-askToRaiseSelfDeadlock.diff:https://issues.apache.org/jira/secure/attachment/12644112/derby-6554-02-af-askToRaiseSelfDeadlock.diff">derby-6554-02-af-askToRaiseSelfDeadlock.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-05-09T14:20:05.410Z">09/May/14 14:20</time>
                   </dd>
                   <dd class="attachment-size">
                    56 kB
                   </dd>
                   <dd class="attachment-author">
                    Rick Hillegas
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12644173" data-issue-id="12710537" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12644173/derby-6554-02-ag-raiseSelfDeadlockAlways.diff" draggable="true" data-downloadurl="application/octet-stream:derby-6554-02-ag-raiseSelfDeadlockAlways.diff:https://issues.apache.org/jira/secure/attachment/12644173/derby-6554-02-ag-raiseSelfDeadlockAlways.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12644173/derby-6554-02-ag-raiseSelfDeadlockAlways.diff" title="Latest  09/May/14 19:45 - Rick Hillegas" draggable="true" data-downloadurl="application/octet-stream:derby-6554-02-ag-raiseSelfDeadlockAlways.diff:https://issues.apache.org/jira/secure/attachment/12644173/derby-6554-02-ag-raiseSelfDeadlockAlways.diff">derby-6554-02-ag-raiseSelfDeadlockAlways.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2014-05-09T19:45:59.184Z">09/May/14 19:45</time>
                   </dd>
                   <dd class="attachment-size">
                    25 kB
                   </dd>
                   <dd class="attachment-author">
                    Rick Hillegas
                   </dd>
                  </dl></li>
                </ol>
               </div>
              </div>
              <div id="linkingmodule" class="module toggle-wrap">
               <div id="linkingmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Issue Links</h2>
               </div>
               <div class="mod-content"> 
                <div class="links-container" data-default-link-icon="/jira/images/icons/generic_link_16.png"> 
                 <dl class="links-list "> 
                  <dt title="blocks">
                   blocks
                  </dt> 
                  <dd id="internal-12708269_10032"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21140&amp;avatarType=issuetype" width="16" height="16" title="Improvement - An improvement or enhancement to an existing feature or task." alt="Improvement - An improvement or enhancement to an existing feature or task."> <span title="DERBY-6542: Improve the concurrency of identity columns by using SYS.SYSSEQUENCES"> <a href="/jira/browse/DERBY-6542" data-issue-key="DERBY-6542" class="issue-link link-title resolution">DERBY-6542</a> <span class="link-summary">Improve the concurrency of identity columns by using SYS.SYSSEQUENCES</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                 </dl> 
                 <dl class="links-list "> 
                  <dt title="is related to">
                   is related to
                  </dt> 
                  <dd id="internal-12732287_10030"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype" width="16" height="16" title="Bug - A problem which impairs or prevents the functions of the product." alt="Bug - A problem which impairs or prevents the functions of the product."> <span title="DERBY-6692: Self-deadlock when inserting row with identity column in soft-upgraded database"> <a href="/jira/browse/DERBY-6692" data-issue-key="DERBY-6692" class="issue-link link-title resolution">DERBY-6692</a> <span class="link-summary">Self-deadlock when inserting row with identity column in soft-upgraded database</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                  <dd id="internal-12713457_10030"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21140&amp;avatarType=issuetype" width="16" height="16" title="Improvement - An improvement or enhancement to an existing feature or task." alt="Improvement - An improvement or enhancement to an existing feature or task."> <span title="DERBY-6572: Raise SelfDeadlock exception when a nested sub transaction has to wait for a lock held by its parent transaction."> <a href="/jira/browse/DERBY-6572" data-issue-key="DERBY-6572" class="issue-link link-title">DERBY-6572</a> <span class="link-summary">Raise SelfDeadlock exception when a nested sub transaction has to wait for a lock held by its parent transaction.</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-blue-gray jira-issue-status-lozenge-new aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Open</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is open and ready for the assignee to start work on it.</span>">Open</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                  <dd id="internal-12713458_10030"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21140&amp;avatarType=issuetype" width="16" height="16" title="Improvement - An improvement or enhancement to an existing feature or task." alt="Improvement - An improvement or enhancement to an existing feature or task."> <span title="DERBY-6573: Don't throw an exception if a nested sub transaction can't immediately get a blocking lock held by its parent transaction."> <a href="/jira/browse/DERBY-6573" data-issue-key="DERBY-6573" class="issue-link link-title">DERBY-6573</a> <span class="link-summary">Don't throw an exception if a nested sub transaction can't immediately get a blocking lock held by its parent transaction.</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-blue-gray jira-issue-status-lozenge-new aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Open</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is open and ready for the assignee to start work on it.</span>">Open</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                 </dl> 
                </div> 
               </div>
              </div>
              <div id="activitymodule" class="module toggle-wrap">
               <div id="activitymodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Activity</h2>
               </div>
               <div class="mod-content"> 
                <big-pipe data-id="activity-panel-pipe-id" style="height: 70px"> 
                 <div></div> 
                </big-pipe> 
               </div>
              </div>
             </div>
             <div id="viewissuesidebar" class="aui-item issue-side-column">
              <div id="peoplemodule" class="module toggle-wrap">
               <div id="peoplemodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">People</h2>
               </div>
               <div class="mod-content"> 
                <ul class="item-details" id="peopledetails"> 
                 <li class="people-details"> 
                  <dl> 
                   <dt>
                    Assignee:
                   </dt> 
                   <dd> 
                    <span id="assignee-val" class="view-issue-field"> <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img src="https://issues.apache.org/jira/secure/useravatar?size=small&amp;avatarId=10453"></span></span> Unassigned </span> 
                   </dd> 
                  </dl> 
                  <dl> 
                   <dt>
                    Reporter:
                   </dt> 
                   <dd> 
                    <span id="reporter-val" class="view-issue-field"> <span class="user-hover" id="issue_summary_reporter_knutanders" rel="knutanders" data-user="{&quot;avatarUrl&quot;:&quot;https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10452&quot;,&quot;displayName&quot;:&quot;Knut Anders Hatlen&quot;,&quot;emailAddress&quot;:&quot;knut.hatlen@oracle.com&quot;,&quot;username&quot;:&quot;knutanders&quot;}"> <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img src="https://issues.apache.org/jira/secure/useravatar?size=small&amp;avatarId=10452" alt="knutanders"></span></span> Knut Anders Hatlen </span> </span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
                <ul class="item-details"> 
                 <li> 
                  <dl> 
                   <dt>
                    Votes:
                   </dt> 
                   <dd> 
                    <span id="vote-data" class="aui-badge vote-state-off">0</span> 
                    <span id="vote-label" title="You have to be logged in to vote for an issue.">Vote for this issue</span> 
                   </dd> 
                  </dl> 
                  <dl> 
                   <dt>
                    Watchers:
                   </dt> 
                   <dd> 
                    <span id="watcher-data" class="aui-badge watch-state-off">5</span> 
                    <span id="watch-label" title="You have to be logged in to watch an issue.">Start watching this issue</span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
               </div>
              </div>
              <div id="datesmodule" class="module toggle-wrap">
               <div id="datesmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Dates</h2>
               </div>
               <div class="mod-content"> 
                <ul class="item-details"> 
                 <li> 
                  <dl class="dates"> 
                   <dt>
                    Created:
                   </dt> 
                   <dd class="date user-tz" title="25/Apr/14 11:53"> 
                    <span data-name="Created" id="created-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2014-04-25T11:53:41+0000">25/Apr/14 11:53</time> </span> 
                   </dd> 
                  </dl> 
                  <dl class="dates"> 
                   <dt>
                    Updated:
                   </dt> 
                   <dd class="date user-tz" title="09/Sep/16 09:51"> 
                    <span data-name="Updated" id="updated-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2016-09-09T09:51:56+0000">09/Sep/16 09:51</time> </span> 
                   </dd> 
                  </dl> 
                  <dl class="dates"> 
                   <dt>
                    Resolved:
                   </dt> 
                   <dd class="date user-tz" title="19/May/14 17:32"> 
                    <span data-name="Resolved" id="resolutiondate-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2014-05-19T17:32:05+0000">19/May/14 17:32</time> </span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
               </div>
              </div>
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
     <!-- .aui-page-panel-inner -->
    </div>
    <!-- .aui-page-panel -->
    <div class="issue-navigator-init"></div> 
   </section> 
   <footer id="footer" role="contentinfo"> 
    <section class="footer-body"> 
     <ul class="atlassian-footer"> 
      <li> Atlassian JIRA <a class="seo-link" rel="nofollow" href="https://www.atlassian.com/software/jira">Project Management Software</a> <span id="footer-build-information">(v7.6.3#76005-<span title="8a4e38d34af948780dbf52044e7aafb13a7cae58" data-commit-id="8a4e38d34af948780dbf52044e7aafb13a7cae58}">sha1:8a4e38d</span>)</span> </li> 
      <li> <a id="about-link" rel="nofollow" href="/jira/secure/AboutPage.jspa/secure/AboutPage.jspa">About JIRA</a> </li> 
      <li> <a id="footer-report-problem-link" rel="nofollow" href="/jira/secure/CreateIssue!default.jspa">Report a problem</a> </li> 
     </ul> 
     <ul class="atlassian-footer"> 
      <li class="licensemessage"> Powered by a free Atlassian <a rel="nofollow" href="http://www.atlassian.com/software/jira">JIRA</a> open source license for Apache Software Foundation. Try JIRA - <a rel="nofollow" href="http://www.atlassian.com/software/jira">bug tracking software</a> for <i>your</i> team. </li> 
     </ul> 
     <div id="footer-logo">
      <a rel="nofollow" href="http://www.atlassian.com/">Atlassian</a>
     </div> 
    </section> 
    <fieldset class="hidden parameters"> 
     <input type="hidden" title="loggedInUser" value=""> 
     <input type="hidden" title="ajaxTimeout" value="The call to the JIRA server did not complete within the timeout period.  We are unsure of the result of this operation."> 
     <input type="hidden" title="JiraVersion" value="7.6.3"> 
     <input type="hidden" title="ajaxUnauthorised" value="You are not authorised to perform this operation. Please log in."> 
     <input type="hidden" title="baseURL" value="https://issues.apache.org/jira"> 
     <input type="hidden" title="ajaxCommsError" value="The JIRA server could not be contacted. This may be a temporary glitch or the server may be down. "> 
     <input type="hidden" title="ajaxServerError" value="The JIRA server was contacted but has returned an error response. We are unsure of the result of this operation."> 
     <input type="hidden" title="ajaxErrorCloseDialog" value="Close this dialog and press refresh in your browser"> 
     <input type="hidden" title="ajaxErrorDialogHeading" value="Communications Breakdown"> 
     <input type="hidden" title="dirtyMessage" value="You have entered new data on this page. If you navigate away from this page without first saving your data, the changes will be lost."> 
     <input type="hidden" title="dirtyDialogMessage" value="You have entered new data in this dialog. If you navigate away from this dialog without first saving your data, the changes will be lost. Click cancel to return to the dialog."> 
     <input type="hidden" title="keyType" value="Type"> 
     <input type="hidden" title="keyThen" value="then"> 
     <input type="hidden" title="dblClickToExpand" value="Double click to expand"> 
     <input type="hidden" title="actions" value="Actions"> 
     <input type="hidden" title="removeItem" value="Remove"> 
     <input type="hidden" title="workflow" value="Workflow"> 
     <input type="hidden" title="labelNew" value="New Label"> 
     <input type="hidden" title="issueActionsHint" value="Begin typing for available operations or press down to see all"> 
     <input type="hidden" title="closelink" value="Close"> 
     <input type="hidden" title="dotOperations" value="Operations"> 
     <input type="hidden" title="dotLoading" value="Loading..."> 
     <input type="hidden" title="frotherSuggestions" value="Suggestions"> 
     <input type="hidden" title="frotherNomatches" value="No Matches"> 
     <input type="hidden" title="multiselectVersionsError" value="{0} is not a valid version."> 
     <input type="hidden" title="multiselectComponentsError" value="{0} is not a valid component."> 
     <input type="hidden" title="multiselectGenericError" value="The value {0} is invalid."> 
    </fieldset> 
   </footer> 
  </div> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:bigpipe-js/jira.webresources:bigpipe-js.js" data-wrm-key="jira.webresources:bigpipe-js" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["activity-panel-pipe-id"]="\"\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n    \u003cdiv class=\\\"tabwrap tabs2\\\"\u003e\\n\\n        \u003cul id=\\\"issue-tabs\\\" class=\\\"tabs horizontal\\\"\u003e\\n                                \\n            \u003cli  data-id=\\\"all-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\" data-label=\\\"All\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-6554?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"all-tabpanel\\\" href=\\\"\\/jira\\/browse\\/DERBY-6554?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\"\u003e\u003cstrong\u003eAll\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  class=\\\"active\\\" id=\\\"comment-tabpanel\\\"  data-id=\\\"comment-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel\\\" data-label=\\\"Comments\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-6554?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel\\\"\u003e\\n                            \u003cstrong tabindex=\\\"0\\\"\u003eComments\u003c\\/strong\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"worklog-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\" data-label=\\\"Work Log\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-6554?page=com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"worklog-tabpanel\\\" href=\\\"\\/jira\\/browse\\/DERBY-6554?page=com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\"\u003e\u003cstrong\u003eWork Log\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"changehistory-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\" data-label=\\\"History\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-6554?page=com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"changehistory-tabpanel\\\" href=\\\"\\/jira\\/browse\\/DERBY-6554?page=com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\"\u003e\u003cstrong\u003eHistory\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"activity-stream-issue-tab\\\" data-key=\\\"com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\" data-label=\\\"Activity\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-6554?page=com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"activity-stream-issue-tab\\\" href=\\\"\\/jira\\/browse\\/DERBY-6554?page=com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\"\u003e\u003cstrong\u003eActivity\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"transitions-summary-tabpanel\\\" data-key=\\\"com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\" data-label=\\\"Transitions\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-6554?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"transitions-summary-tabpanel\\\" href=\\\"\\/jira\\/browse\\/DERBY-6554?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\"\u003e\u003cstrong\u003eTransitions\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                \u003c\\/ul\u003e\\n\\n                    \u003cdiv class=\\\"sortwrap\\\"\u003e\\n                                    \u003ca class=\\\"issue-activity-sort-link ajax-activity-content\\\" rel=\\\"nofollow\\\" data-tab-sort data-order=\\\"desc\\\" href=\\\"\\/jira\\/browse\\/DERBY-6554?actionOrder=desc\\\" title=\\\"Ascending order - Click to sort in descending order\\\"\u003e\\n                        \u003cspan class=\\\"aui-icon aui-icon-small aui-iconfont-up\\\"\u003eAscending order - Click to sort in descending order\u003c\\/span\u003e\\n                    \u003c\\/a\u003e\\n                            \u003c\\/div\u003e\\n            \u003c\\/div\u003e\\n    \u003cdiv class=\\\"issuePanelWrapper\\\"\u003e\\n        \u003cdiv class=\\\"issuePanelProgress\\\"\u003e\u003c\\/div\u003e\\n        \u003cdiv class=\\\"issuePanelContainer\\\" id=\\\"issue_actions_container\\\"\u003e\\n                                    \\n\\n\\n\u003cdiv id=\\\"comment-13980956\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13980956&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13980956\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13980956_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13980956_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Apr\\/14 12:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-25T12:46:55+0000\'\u003e25\\/Apr\\/14 12:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks for logging this one. I\'ve seen that assert a couple times and never known how to trip it. This code path may be a red herring. But it may help us bag a bug on the main code path.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13980956_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13980956_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Apr\\/14 12:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-25T12:46:55+0000\'\u003e25\\/Apr\\/14 12:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks for logging this one. I\'ve seen that assert a couple times and never known how to trip it. This code path may be a red herring. But it may help us bag a bug on the main code path.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13981052\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13981052&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13981052\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13981052_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13981052_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Apr\\/14 14:21\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-25T14:21:20+0000\'\u003e25\\/Apr\\/14 14:21\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'m actually seeing this with 10.10.2.0 too. But it is only seen with the debug version, since it\'s an assert failure.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13981052_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13981052_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Apr\\/14 14:21\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-25T14:21:20+0000\'\u003e25\\/Apr\\/14 14:21\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'m actually seeing this with 10.10.2.0 too. But it is only seen with the debug version, since it\'s an assert failure.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13981053\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13981053&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13981053\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13981053_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13981053_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Apr\\/14 14:23\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-25T14:23:47+0000\'\u003e25\\/Apr\\/14 14:23\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIt reproduces with the debug version of 10.9.1.0 too.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13981053_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13981053_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Apr\\/14 14:23\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-25T14:23:47+0000\'\u003e25\\/Apr\\/14 14:23\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    It reproduces with the debug version of 10.9.1.0 too.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13981135\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13981135&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13981135\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13981135_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13981135_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Apr\\/14 15:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-25T15:24:47+0000\'\u003e25\\/Apr\\/14 15:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWhen I said it only reproduced with the debug version, that\'s not quite correct. The assert failure only reproduces with the debug version. The \\\"too much contention\\\" error happens with the non-debug version too. I don\'t think it\'s reasonable to see that error in this scenario, so I think that\'s a bug too.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13981135_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13981135_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Apr\\/14 15:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-25T15:24:47+0000\'\u003e25\\/Apr\\/14 15:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    When I said it only reproduced with the debug version, that\'s not quite correct. The assert failure only reproduces with the debug version. The \\\"too much contention\\\" error happens with the non-debug version too. I don\'t think it\'s reasonable to see that error in this scenario, so I think that\'s a bug too.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13983099\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13983099&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13983099\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13983099_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13983099_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Apr\\/14 15:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-28T15:24:57+0000\'\u003e28\\/Apr\\/14 15:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Rick Hillegas - 28\\/Apr\\/14 15:26\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThis regression actually kills the connection, perhaps because of an assert failure:\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"preformatted panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"preformattedContent panelContent\\\"\u003e\\n\u003cpre\u003eij version 10.11\\nij&gt; connect \'jdbc:derby:memory:db;create=true\';\\nij&gt; autocommit off;\\nij&gt; create sequence seq;\\n0 rows inserted\\/updated\\/deleted\\nij&gt; values next value for seq;\\n1          \\n-----------\\nERROR X0Y84: Too much contention on sequence SEQ. This is probably caused by an uncommitted scan of the SYS.SYSSEQUENCES catalog. Do not query this catalog directly. Instead, use the SYSCS_UTIL.SYSCS_PEEK_AT_SEQUENCE function to view the current value of a sequence generator.\\nij&gt; select count(*) from sys.systables;\\nERROR 08003: No current connection.\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13983099_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13983099_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Apr\\/14 15:24\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-28T15:24:57+0000\'\u003e28\\/Apr\\/14 15:24\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Rick Hillegas - 28\\/Apr\\/14 15:26\\\"\u003eedited\u003c\\/span\u003e                   This regression actually kills the connection, perhaps because of an assert failure: \\n\\n  \\n ij version 10.11\\nij&gt; connect \'jdbc:derby:memory:db;create=true\';\\nij&gt; autocommit off;\\nij&gt; create sequence seq;\\n0 rows inserted\\/updated\\/deleted\\nij&gt; values next value for seq;\\n1          \\n-----------\\nERROR X0Y84: Too much contention on sequence SEQ. This is probably caused by an uncommitted scan of the SYS.SYSSEQUENCES catalog. Do not query this catalog directly. Instead, use the SYSCS_UTIL.SYSCS_PEEK_AT_SEQUENCE function to view the current value of a sequence generator.\\nij&gt; select count(*) from sys.systables;\\nERROR 08003: No current connection.\\n \\n               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13983364\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13983364&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13983364\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13983364_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13983364_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Apr\\/14 18:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-28T18:29:16+0000\'\u003e28\\/Apr\\/14 18:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThis is my analysis of what is going on:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) The CREATE SEQUENCE statement puts a row into SYS.SYSSEQUENCES and slaps an exclusive lock on it using the connection\'s execution transaction controller.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) The subsequent NEXT VALUE FOR statement is the first attempt to use the sequence generator. In trying to allocate the first range of values, it has to update that row in SYS.SYSSEQUENCES. It tries to do this in a nested subtransaction of the connection\'s execution transaction controller. But it can\'t get a lock on the row. It is blocked by the parent transaction.\u003c\\/p\u003e\\n\\n\u003cp\u003e3) A \\\"too much contention\\\" exception is raised. That is a transaction severity error. While cleaning up the transaction, the DataDictionary trips over an assertion failure which makes the connection unusable:\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"preformatted panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"preformattedContent panelContent\\\"\u003e\\n\u003cpre\u003eNew exception raised during cleanup ASSERT FAILED Number of DDL Users is &lt;= 0 when finishing a transaction\\norg.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED Number of DDL Users is &lt;= 0 when finishing a transaction\\n\\tat org.apache.derby.shared.common.sanity.SanityManager.ASSERT(SanityManager.java:120)\\n\\tat org.apache.derby.impl.sql.catalog.DataDictionaryImpl.transactionFinished(DataDictionaryImpl.java:1325)\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003eHere is the script output showing the lock table just before the NEXT VALUE FOR statement. I also instrumented SequenceUpdater to print out the transaction id of the execution transaction. As you can see, it is the same transaction which holds the lock on the row in SYS.SYSSEQUENCES.\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"preformatted panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"preformattedContent panelContent\\\"\u003e\\n\u003cpre\u003eij version 10.11\\nij&gt; connect \'jdbc:derby:memory:db;create=true\';\\nij&gt; autocommit off;\\nij&gt; create sequence seq;\\n0 rows inserted\\/updated\\/deleted\\nij&gt; select * from syscs_diag.lock_table;\\nXID            |TYPE |MODE|TABLENAME                                                                                                                       |LOCKNAME            |STATE|TABLETYPE|LOCK&amp;|INDEXNAME                                                                                                                       \\n---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\\n167            |ROW  |S   |SYSSCHEMAS                                                                                                                      |(1,17)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |TABLE|IS  |SYSSEQUENCES                                                                                                                    |Tablelock           |GRANT|S        |2    |NULL                                                                                                                            \\n167            |TABLE|IX  |SYSSEQUENCES                                                                                                                    |Tablelock           |GRANT|S        |3    |NULL                                                                                                                            \\n167            |TABLE|IS  |SYSCONGLOMERATES                                                                                                                |Tablelock           |GRANT|S        |2    |NULL                                                                                                                            \\n167            |TABLE|IS  |SYSSCHEMAS                                                                                                                      |Tablelock           |GRANT|S        |2    |NULL                                                                                                                            \\n167            |TABLE|IS  |SYSTABLES                                                                                                                       |Tablelock           |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,21)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |X   |SYSSEQUENCES                                                                                                                    |(1,7)               |GRANT|S        |3    |NULL                                                                                                                            \\n167            |TABLE|IS  |SYSCOLUMNS                                                                                                                      |Tablelock           |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,30)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,25)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCONGLOMERATES                                                                                                                |(6,10)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,24)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCONGLOMERATES                                                                                                                |(6,9)               |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,23)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCONGLOMERATES                                                                                                                |(6,8)               |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,22)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,29)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSTABLES                                                                                                                       |(1,27)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,28)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,27)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,26)              |GRANT|S        |2    |NULL                                                                                                                            \\n\\n22 rows selected\\nij&gt; values next value for seq;\\n1          \\n-----------\\nXXX SequenceUpdater transaction id = 167\\nXXX SequenceUpdater transaction id = 167\\nERROR X0Y84: Too much contention on sequence SEQ. This is probably caused by an uncommitted scan of the SYS.SYSSEQUENCES catalog. Do not query this catalog directly. Instead, use the SYSCS_UTIL.SYSCS_PEEK_AT_SEQUENCE function to view the current value of a sequence generator.\\nij&gt; select count(*) from sys.systables;\\nERROR 08003: No current connection.\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003eI\'m unclear on the behavior of Derby nested subtransactions and I have a question about step 2). Is it expected that the subtransaction should be blocked by its parent transaction?\u003c\\/p\u003e\\n\\n\u003cp\u003eThanks,\u003cbr\\/\u003e\\n-Rick\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13983364_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13983364_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Apr\\/14 18:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-28T18:29:16+0000\'\u003e28\\/Apr\\/14 18:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    This is my analysis of what is going on: \\n\\n 1) The CREATE SEQUENCE statement puts a row into SYS.SYSSEQUENCES and slaps an exclusive lock on it using the connection\'s execution transaction controller. \\n\\n 2) The subsequent NEXT VALUE FOR statement is the first attempt to use the sequence generator. In trying to allocate the first range of values, it has to update that row in SYS.SYSSEQUENCES. It tries to do this in a nested subtransaction of the connection\'s execution transaction controller. But it can\'t get a lock on the row. It is blocked by the parent transaction. \\n\\n 3) A \\\"too much contention\\\" exception is raised. That is a transaction severity error. While cleaning up the transaction, the DataDictionary trips over an assertion failure which makes the connection unusable: \\n\\n  \\n New exception raised during cleanup ASSERT FAILED Number of DDL Users is &lt;= 0 when finishing a transaction\\norg.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED Number of DDL Users is &lt;= 0 when finishing a transaction\\n\\tat org.apache.derby.shared.common.sanity.SanityManager.ASSERT(SanityManager.java:120)\\n\\tat org.apache.derby.impl.sql.catalog.DataDictionaryImpl.transactionFinished(DataDictionaryImpl.java:1325)\\n \\n  \\n\\n Here is the script output showing the lock table just before the NEXT VALUE FOR statement. I also instrumented SequenceUpdater to print out the transaction id of the execution transaction. As you can see, it is the same transaction which holds the lock on the row in SYS.SYSSEQUENCES. \\n\\n  \\n ij version 10.11\\nij&gt; connect \'jdbc:derby:memory:db;create=true\';\\nij&gt; autocommit off;\\nij&gt; create sequence seq;\\n0 rows inserted\\/updated\\/deleted\\nij&gt; select * from syscs_diag.lock_table;\\nXID            |TYPE |MODE|TABLENAME                                                                                                                       |LOCKNAME            |STATE|TABLETYPE|LOCK&amp;|INDEXNAME                                                                                                                       \\n---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\\n167            |ROW  |S   |SYSSCHEMAS                                                                                                                      |(1,17)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |TABLE|IS  |SYSSEQUENCES                                                                                                                    |Tablelock           |GRANT|S        |2    |NULL                                                                                                                            \\n167            |TABLE|IX  |SYSSEQUENCES                                                                                                                    |Tablelock           |GRANT|S        |3    |NULL                                                                                                                            \\n167            |TABLE|IS  |SYSCONGLOMERATES                                                                                                                |Tablelock           |GRANT|S        |2    |NULL                                                                                                                            \\n167            |TABLE|IS  |SYSSCHEMAS                                                                                                                      |Tablelock           |GRANT|S        |2    |NULL                                                                                                                            \\n167            |TABLE|IS  |SYSTABLES                                                                                                                       |Tablelock           |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,21)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |X   |SYSSEQUENCES                                                                                                                    |(1,7)               |GRANT|S        |3    |NULL                                                                                                                            \\n167            |TABLE|IS  |SYSCOLUMNS                                                                                                                      |Tablelock           |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,30)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,25)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCONGLOMERATES                                                                                                                |(6,10)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,24)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCONGLOMERATES                                                                                                                |(6,9)               |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,23)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCONGLOMERATES                                                                                                                |(6,8)               |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,22)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,29)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSTABLES                                                                                                                       |(1,27)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,28)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,27)              |GRANT|S        |2    |NULL                                                                                                                            \\n167            |ROW  |S   |SYSCOLUMNS                                                                                                                      |(4,26)              |GRANT|S        |2    |NULL                                                                                                                            \\n\\n22 rows selected\\nij&gt; values next value for seq;\\n1          \\n-----------\\nXXX SequenceUpdater transaction id = 167\\nXXX SequenceUpdater transaction id = 167\\nERROR X0Y84: Too much contention on sequence SEQ. This is probably caused by an uncommitted scan of the SYS.SYSSEQUENCES catalog. Do not query this catalog directly. Instead, use the SYSCS_UTIL.SYSCS_PEEK_AT_SEQUENCE function to view the current value of a sequence generator.\\nij&gt; select count(*) from sys.systables;\\nERROR 08003: No current connection.\\n \\n  \\n\\n I\'m unclear on the behavior of Derby nested subtransactions and I have a question about step 2). Is it expected that the subtransaction should be blocked by its parent transaction? \\n\\n Thanks, \\n-Rick              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13983423\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13983423&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13983423\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_13983423_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13983423_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Apr\\/14 19:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-28T19:14:32+0000\'\u003e28\\/Apr\\/14 19:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Dag H. Wanvik - 28\\/Apr\\/14 19:18\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI think we have seen that before, yes. I seem to remember we have code that, when failing to lock a resource in the sub-transaction, falls back to trying to use the parent transaction instead, in case it is a self-lock scenario (like the one you are seeing). But should one wait for lock time-out in this case before doing the fall-back? Probably not..\u003cbr\\/\u003e\\nI think Knut has done some work with this mechanism..\u003cbr\\/\u003e\\nSee also \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-3693\\\" title=\\\"Deadlocks accessing DB metadata\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-3693\\\"\u003e\u003cdel\u003eDERBY-3693\u003c\\/del\u003e\u003c\\/a\u003e, and the method RAMTRansaction#setNoLockWait and its usage.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_13983423_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13983423_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Apr\\/14 19:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-28T19:14:32+0000\'\u003e28\\/Apr\\/14 19:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Dag H. Wanvik - 28\\/Apr\\/14 19:18\\\"\u003eedited\u003c\\/span\u003e                   I think we have seen that before, yes. I seem to remember we have code that, when failing to lock a resource in the sub-transaction, falls back to trying to use the parent transaction instead, in case it is a self-lock scenario (like the one you are seeing). But should one wait for lock time-out in this case before doing the fall-back? Probably not.. \\nI think Knut has done some work with this mechanism.. \\nSee also   DERBY-3693  , and the method RAMTRansaction#setNoLockWait and its usage.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13983481\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13983481&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13983481\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13983481_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13983481_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Apr\\/14 20:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-28T20:09:27+0000\'\u003e28\\/Apr\\/14 20:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eOK. But we want to NEVER escalate into the parent transaction because those are the long-running locks which kill concurrency. We may need to build some complexity to handle the edge case of using a sequence generator in the transaction which created it. The discussion on \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-5493\\\" title=\\\"Same value returned by successive calls to a sequence generator.\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-5493\\\"\u003e\u003cdel\u003eDERBY-5493\u003c\\/del\u003e\u003c\\/a\u003e suggests that we once thought that this limitation was fine. I\'ll give this some thought. Thanks.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13983481_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13983481_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Apr\\/14 20:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-28T20:09:27+0000\'\u003e28\\/Apr\\/14 20:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    OK. But we want to NEVER escalate into the parent transaction because those are the long-running locks which kill concurrency. We may need to build some complexity to handle the edge case of using a sequence generator in the transaction which created it. The discussion on   DERBY-5493   suggests that we once thought that this limitation was fine. I\'ll give this some thought. Thanks.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13983563\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13983563&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13983563\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13983563_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13983563_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Apr\\/14 21:19\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-28T21:19:51+0000\'\u003e28\\/Apr\\/14 21:19\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eCould we perhaps try to lock it in the parent transaction no-wait before we give up with too much contention? Then we would use the parent transaction if the parent transaction already holds locks that would block others from using the sequence anyway, but not wait if there\'s some other transaction that\'s locking the sequence.\u003c\\/p\u003e\\n\\n\u003cp\u003eSuch a solution would open a small window for unwanted lock escalations, though. If another transaction holds a lock that prevents the subtransaction from doing its work, and releases the lock before it is retried in the main transaction, it would end up being locked in the main transaction even though it wasn\'t the main transaction that held the lock in the first place.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13983563_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13983563_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Apr\\/14 21:19\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-28T21:19:51+0000\'\u003e28\\/Apr\\/14 21:19\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Could we perhaps try to lock it in the parent transaction no-wait before we give up with too much contention? Then we would use the parent transaction if the parent transaction already holds locks that would block others from using the sequence anyway, but not wait if there\'s some other transaction that\'s locking the sequence. \\n\\n Such a solution would open a small window for unwanted lock escalations, though. If another transaction holds a lock that prevents the subtransaction from doing its work, and releases the lock before it is retried in the main transaction, it would end up being locked in the main transaction even though it wasn\'t the main transaction that held the lock in the first place.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13983600\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13983600&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13983600\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_13983600_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13983600_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Apr\\/14 21:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-28T21:36:41+0000\'\u003e28\\/Apr\\/14 21:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWhy isn\'t the sub-transaction exclusive lock compatible with that of the parent transaction? I.e. why can\'t it be granted?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_13983600_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13983600_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Apr\\/14 21:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-28T21:36:41+0000\'\u003e28\\/Apr\\/14 21:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Why isn\'t the sub-transaction exclusive lock compatible with that of the parent transaction? I.e. why can\'t it be granted?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13983833\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13983833&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13983833\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13983833_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13983833_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Apr\\/14 01:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-29T01:06:57+0000\'\u003e29\\/Apr\\/14 01:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'m going to try the following approach unless people think that this won\'t work. The idea is to add a special code path for the situation when we are trying to use the sequence generator in the transaction which created it:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) When the CreateSequenceConstantAction creates a sequence, it will mark the associated SequenceUpdater with its execution TransactionController\'s transaction id (what comes back from getTransactionIdString()) plus an as yet not implemented commit\\/rollback counter obtained from the TransactionController. If someone can think of a better identifier for the execution transaction, I\'m happy to use that.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) When trying to update the sequence number on disk, the SequenceUpdater will check to see whether the current execution transaction is the one it was marked with. If so, we will use the execution transaction rather than a nested subtransaction to do the work.\u003c\\/p\u003e\\n\\n\u003cp\u003e3) When TransactionController.commit() or abort() is called, we will bump the commit\\/rollback counter.\u003c\\/p\u003e\\n\\n\u003cp\u003eThere may be an edge-case on an edge-case to consider: creating and using a sequence inside the nested transaction context of a stored procedure.\u003c\\/p\u003e\\n\\n\u003cp\u003eYour feedback is welcome.\u003c\\/p\u003e\\n\\n\u003cp\u003eThanks,\u003cbr\\/\u003e\\n-Rick\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13983833_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13983833_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Apr\\/14 01:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-29T01:06:57+0000\'\u003e29\\/Apr\\/14 01:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'m going to try the following approach unless people think that this won\'t work. The idea is to add a special code path for the situation when we are trying to use the sequence generator in the transaction which created it: \\n\\n 1) When the CreateSequenceConstantAction creates a sequence, it will mark the associated SequenceUpdater with its execution TransactionController\'s transaction id (what comes back from getTransactionIdString()) plus an as yet not implemented commit\\/rollback counter obtained from the TransactionController. If someone can think of a better identifier for the execution transaction, I\'m happy to use that. \\n\\n 2) When trying to update the sequence number on disk, the SequenceUpdater will check to see whether the current execution transaction is the one it was marked with. If so, we will use the execution transaction rather than a nested subtransaction to do the work. \\n\\n 3) When TransactionController.commit() or abort() is called, we will bump the commit\\/rollback counter. \\n\\n There may be an edge-case on an edge-case to consider: creating and using a sequence inside the nested transaction context of a stored procedure. \\n\\n Your feedback is welcome. \\n\\n Thanks, \\n-Rick              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13984099\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13984099&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13984099\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13984099_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13984099_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Apr\\/14 07:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-29T07:41:52+0000\'\u003e29\\/Apr\\/14 07:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eSounds like a promising approach that would only use the main transaction in cases where we know we already have exclusive access to the sequence.\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eWhy isn\'t the sub-transaction exclusive lock compatible with that of the parent transaction? I.e. why can\'t it be granted?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThe lock manager doesn\'t currently check the relationship between the owing transactions when determining if two locks are compatible. It would be helpful if it did.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13984099_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13984099_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Apr\\/14 07:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-29T07:41:52+0000\'\u003e29\\/Apr\\/14 07:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Sounds like a promising approach that would only use the main transaction in cases where we know we already have exclusive access to the sequence. \\n\\n \\n Why isn\'t the sub-transaction exclusive lock compatible with that of the parent transaction? I.e. why can\'t it be granted?  \\n\\n The lock manager doesn\'t currently check the relationship between the owing transactions when determining if two locks are compatible. It would be helpful if it did.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13984311\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13984311&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13984311\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13984311_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13984311_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Apr\\/14 13:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-29T13:59:50+0000\'\u003e29\\/Apr\\/14 13:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching derby-6554-01-aa-useCreationTransaction.diff. I am running tests now.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis implements the approach proposed above. It turns out that the transaction id returned by TransactionController.getTransactionIdString() is good enough and no additional counter is need.\u003c\\/p\u003e\\n\\n\u003cp\u003eI also added a test case for the situation of a CREATE SEQUENCE statement inside a database procedure.\u003c\\/p\u003e\\n\\n\\n\u003cp\u003eTouches the following files:\u003c\\/p\u003e\\n\\n\u003cp\u003e--------------\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/sql\\/catalog\\/SequenceUpdater.java\u003c\\/p\u003e\\n\\n\u003cp\u003eSpecial code path when the execution transaction is the one which created the sequence.\u003c\\/p\u003e\\n\\n\u003cp\u003e--------------\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/storeless\\/org\\/apache\\/derby\\/impl\\/storeless\\/EmptyDictionary.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/sql\\/dictionary\\/DataDictionary.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/sql\\/catalog\\/DataDictionaryImpl.java\u003c\\/p\u003e\\n\\n\u003cp\u003eNew method for stuffing the transaction id into the SequenceUpdater at CREATE SEQUENCE time.\u003c\\/p\u003e\\n\\n\u003cp\u003e--------------\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/sql\\/execute\\/CreateSequenceConstantAction.java\u003c\\/p\u003e\\n\\n\u003cp\u003eStuff the transaction id in the SequenceUpdater right after creating the sequence.\u003c\\/p\u003e\\n\\n\u003cp\u003e--------------\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/testing\\/org\\/apache\\/derbyTesting\\/functionTests\\/tests\\/lang\\/SequenceTest.java\u003c\\/p\u003e\\n\\n\u003cp\u003eTests.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13984311_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13984311_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Apr\\/14 13:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-29T13:59:50+0000\'\u003e29\\/Apr\\/14 13:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attaching derby-6554-01-aa-useCreationTransaction.diff. I am running tests now. \\n\\n This implements the approach proposed above. It turns out that the transaction id returned by TransactionController.getTransactionIdString() is good enough and no additional counter is need. \\n\\n I also added a test case for the situation of a CREATE SEQUENCE statement inside a database procedure. \\n\\n\\n Touches the following files: \\n\\n -------------- \\n\\n M       java\\/engine\\/org\\/apache\\/derby\\/impl\\/sql\\/catalog\\/SequenceUpdater.java \\n\\n Special code path when the execution transaction is the one which created the sequence. \\n\\n -------------- \\n\\n M       java\\/storeless\\/org\\/apache\\/derby\\/impl\\/storeless\\/EmptyDictionary.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/sql\\/dictionary\\/DataDictionary.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/sql\\/catalog\\/DataDictionaryImpl.java \\n\\n New method for stuffing the transaction id into the SequenceUpdater at CREATE SEQUENCE time. \\n\\n -------------- \\n\\n M       java\\/engine\\/org\\/apache\\/derby\\/impl\\/sql\\/execute\\/CreateSequenceConstantAction.java \\n\\n Stuff the transaction id in the SequenceUpdater right after creating the sequence. \\n\\n -------------- \\n\\n M       java\\/testing\\/org\\/apache\\/derbyTesting\\/functionTests\\/tests\\/lang\\/SequenceTest.java \\n\\n Tests.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13984378\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13984378&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13984378\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13984378_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13984378_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Apr\\/14 15:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-29T15:12:47+0000\'\u003e29\\/Apr\\/14 15:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks, Rick. The patch made the repro pass. I also tested it together with the 02-ab patch for \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-6542\\\" title=\\\"Improve the concurrency of identity columns by using SYS.SYSSEQUENCES\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-6542\\\"\u003e\u003cdel\u003eDERBY-6542\u003c\\/del\u003e\u003c\\/a\u003e and verified that it fixed the corresponding problem for identity columns based on sequences.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe problem seems to persist, though, if I increase the number of sequences (because sequence updaters get evicted from the cache and lose information about the creating transaction, perhaps?). See the attached D6554.java class, which produces the following output:\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"preformatted panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"preformattedContent panelContent\\\"\u003e\\n\u003cpre\u003ejava.sql.SQLException: Too much contention on sequence S25. This is probably caused by an uncommitted scan of the SYS.SYSSEQUENCES catalog. Do not query this catalog directly. Instead, use the SYSCS_UTIL.SYSCS_PEEK_AT_SEQUENCE function to view the current value of a sequence generator.\\njava.sql.SQLException: Java exception: \'ASSERT FAILED base row not found: org.apache.derby.shared.common.sanity.AssertFailure\'.\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13984378_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13984378_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Apr\\/14 15:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-29T15:12:47+0000\'\u003e29\\/Apr\\/14 15:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks, Rick. The patch made the repro pass. I also tested it together with the 02-ab patch for   DERBY-6542   and verified that it fixed the corresponding problem for identity columns based on sequences. \\n\\n The problem seems to persist, though, if I increase the number of sequences (because sequence updaters get evicted from the cache and lose information about the creating transaction, perhaps?). See the attached D6554.java class, which produces the following output: \\n\\n  \\n java.sql.SQLException: Too much contention on sequence S25. This is probably caused by an uncommitted scan of the SYS.SYSSEQUENCES catalog. Do not query this catalog directly. Instead, use the SYSCS_UTIL.SYSCS_PEEK_AT_SEQUENCE function to view the current value of a sequence generator.\\njava.sql.SQLException: Java exception: \'ASSERT FAILED base row not found: org.apache.derby.shared.common.sanity.AssertFailure\'.\\n \\n               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13984576\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13984576&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13984576\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13984576_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13984576_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Apr\\/14 17:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-29T17:49:59+0000\'\u003e29\\/Apr\\/14 17:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching a new rev of the patch, derby-6554-01-ab-useCreationTransaction.diff. This fixes a howler in the previous version. This version also adjusts SequenceGeneratorTest to account for the fact that the SequenceUpdater is now instantiated when the sequence is created.\u003c\\/p\u003e\\n\\n\u003cp\u003eI will give some thought to the new test case which Knut scripted.\u003c\\/p\u003e\\n\\n\u003cp\u003eTouches the following additional file:\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/testing\\/org\\/apache\\/derbyTesting\\/functionTests\\/tests\\/lang\\/SequenceGeneratorTest.java\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13984576_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13984576_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'29\\/Apr\\/14 17:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-29T17:49:59+0000\'\u003e29\\/Apr\\/14 17:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attaching a new rev of the patch, derby-6554-01-ab-useCreationTransaction.diff. This fixes a howler in the previous version. This version also adjusts SequenceGeneratorTest to account for the fact that the SequenceUpdater is now instantiated when the sequence is created. \\n\\n I will give some thought to the new test case which Knut scripted. \\n\\n Touches the following additional file: \\n\\n M       java\\/testing\\/org\\/apache\\/derbyTesting\\/functionTests\\/tests\\/lang\\/SequenceGeneratorTest.java              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13985721\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13985721&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13985721\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13985721_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13985721_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Apr\\/14 16:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-30T16:45:37+0000\'\u003e30\\/Apr\\/14 16:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; Why isn\'t the sub-transaction exclusive lock compatible with that of the parent transaction? I.e. why can\'t it be granted?\u003cbr\\/\u003e\\nThe Derby recovery algorithms do not currently support compatible locking of parent transaction and child read\\/write transactions.  \u003cbr\\/\u003e\\nI believe there are a number of problems and those problems are avoided by making sure the read\\/write sub transaction does not\u003cbr\\/\u003e\\nchange the same row that may have been changed by the parent transaction.  This was acceptable when the first specific use of\u003cbr\\/\u003e\\nthe read\\/write transaction was created, but we have added more use cases since then.\u003c\\/p\u003e\\n\\n\u003cp\u003eHere is an example off the top of my head that would cause problems in the system if a read\\/write sub transaction locking was compatible\u003cbr\\/\u003e\\nwith parent.  The issue is that the subtransaction can commit separate from the parent and subsequently the parent xact may abort.\u003c\\/p\u003e\\n\\n\u003cp\u003e1) parent transaction gets X lock on row A and changes it.\u003cbr\\/\u003e\\n2) (if it were allowed) read\\/write substransaction gets lock on row A and changes it in an arbitrary different way.\u003cbr\\/\u003e\\n3) subtransaction commits changes and releases locks\u003cbr\\/\u003e\\n4) parent transaction aborts, and expects changes to row A to be backed out.  I believe this will crash the system currently if the\u003cbr\\/\u003e\\n    above scenario was played through as it would try to apply undo log records in reverse, but would only look at log records associated\u003cbr\\/\u003e\\n    with the parent transaction but will see a page version from the other transaction and not know what to do.\u003c\\/p\u003e\\n\\n\u003cp\u003enote that read only substransactions do have compatible locking with parent as they present no recovery issues.  This is what the compiler\u003cbr\\/\u003e\\nuses to get consistent plans but not conflict with user locking.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13985721_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13985721_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Apr\\/14 16:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-30T16:45:37+0000\'\u003e30\\/Apr\\/14 16:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; Why isn\'t the sub-transaction exclusive lock compatible with that of the parent transaction? I.e. why can\'t it be granted? \\nThe Derby recovery algorithms do not currently support compatible locking of parent transaction and child read\\/write transactions.   \\nI believe there are a number of problems and those problems are avoided by making sure the read\\/write sub transaction does not \\nchange the same row that may have been changed by the parent transaction.  This was acceptable when the first specific use of \\nthe read\\/write transaction was created, but we have added more use cases since then. \\n\\n Here is an example off the top of my head that would cause problems in the system if a read\\/write sub transaction locking was compatible \\nwith parent.  The issue is that the subtransaction can commit separate from the parent and subsequently the parent xact may abort. \\n\\n 1) parent transaction gets X lock on row A and changes it. \\n2) (if it were allowed) read\\/write substransaction gets lock on row A and changes it in an arbitrary different way. \\n3) subtransaction commits changes and releases locks \\n4) parent transaction aborts, and expects changes to row A to be backed out.  I believe this will crash the system currently if the \\n    above scenario was played through as it would try to apply undo log records in reverse, but would only look at log records associated \\n    with the parent transaction but will see a page version from the other transaction and not know what to do. \\n\\n note that read only substransactions do have compatible locking with parent as they present no recovery issues.  This is what the compiler \\nuses to get consistent plans but not conflict with user locking.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13985725\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13985725&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13985725\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13985725_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13985725_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Apr\\/14 16:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-30T16:48:28+0000\'\u003e30\\/Apr\\/14 16:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIt might be interesting to think about if we could special case something about concurrency and recovery for something so special as\u003cbr\\/\u003e\\nsequence values.  Currently all the sub transaction stuff and locking is very general purpose and fits sql standards.  But locking and recovery\u003cbr\\/\u003e\\nof an internal column\\/row for sequences likely can break some of these rules. \u003c\\/p\u003e\\n\\n\u003cp\u003eJust needed to make sure that someone interested in this knows that there is more to do than just allowing the lock to be granted.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13985725_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13985725_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Apr\\/14 16:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-30T16:48:28+0000\'\u003e30\\/Apr\\/14 16:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    It might be interesting to think about if we could special case something about concurrency and recovery for something so special as \\nsequence values.  Currently all the sub transaction stuff and locking is very general purpose and fits sql standards.  But locking and recovery \\nof an internal column\\/row for sequences likely can break some of these rules.  \\n\\n Just needed to make sure that someone interested in this knows that there is more to do than just allowing the lock to be granted.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13985941\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13985941&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13985941\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13985941_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13985941_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Apr\\/14 19:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-30T19:14:07+0000\'\u003e30\\/Apr\\/14 19:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks, Mike. We may need to ask for your help in pushing this problem into the Store if people think that the following solution is too complex.\u003c\\/p\u003e\\n\\n\u003cp\u003eAttaching derby-6554-01-ac-useCreationTransaction.diff. This patch attempts to address the D6554 problem case. This patch also addresses some other problems discovered while investigating D6554. I am running tests now.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe solution, including the fix for D6554, now is:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) Remember the transaction id which created the sequence. This is saved in the SequenceUpdater which corresponds to the new sequence.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) A map of (sequenceID, creatingTransactionID) pairs is maintained so that we can restore the SequenceUpdater\'s creatingTransactionID after cache eviction. The map is not persistent. Rebooting the database clears it out.\u003c\\/p\u003e\\n\\n\u003cp\u003e3) A good faith effort is made to garbage collect a (sequenceID, creatingTransactionID) pair and keep the map from growing indefinitely. However, there are cases when we won\'t know that it\'s ok to garbage collect a pair. I considered putting a hard limit on the size of the map. But I think that is brittle, particularly since I can\'t guarantee that the pair will eventually be garbage collected. This means that there is a resource-leak\\/denial-of-service defect with this solution. I think it is unlikely that any well behaved application will see this problem. And it is not clear to me that this is really a new vulnerability: in setting up such a situation, it is possible that you will hit some other resource limit first. But if people think this is a serious defect, then we will have to consider something fancier or abandon this approach.\u003c\\/p\u003e\\n\\n\u003cp\u003eIn developing this fix for D6554, I tripped across a bug in cache eviction: If there was an uncommitted CREATE SEQUENCE holding a lock on a SYS.SYSSEQUENCES row at cache eviction time, and the cache evicting transaction was not the transaction which created the sequence, then the Cacheable.clean() method would raise an exception when trying to flush the unused sequence values to disk. This, in turn, would short-circuit the clearing of the Cacheable identity. And that would raise an assertion when the Cacheable was re-used: \\\"Identity being changed on a live cacheable\\\". To fix this, I have moved the identity-resetting logic into a finally block.\u003c\\/p\u003e\\n\\n\u003cp\u003eDeveloping the fix for D6554 also concentrated my attention on this behavior of sequence generators: If a sequence generator is evicted from the cache and the evicting transaction can\'t write to SYS.SYSSEQUENCES, then gaps in the sequence will appear. I\'m aware of only two situations which give rise to this problem:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) An uncommitted CREATE SEQUENCE statement.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) Users who ignore our advice and scan SYS.SYSSEQUENCES.\u003c\\/p\u003e\\n\\n\u003cp\u003eFinally, in order to reduce the likelihood that we will trip across cache eviction problems, I have increased the size of the sequence generator cache to 1000. Applications will need to adjust derby.language.sequenceGeneratorCacheSize if they need to create and use a lot of sequences in a single transaction.\u003c\\/p\u003e\\n\\n\\n\u003cp\u003eTouches the following additional file:\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/reference\\/Property.java\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13985941_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13985941_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Apr\\/14 19:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-30T19:14:07+0000\'\u003e30\\/Apr\\/14 19:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks, Mike. We may need to ask for your help in pushing this problem into the Store if people think that the following solution is too complex. \\n\\n Attaching derby-6554-01-ac-useCreationTransaction.diff. This patch attempts to address the D6554 problem case. This patch also addresses some other problems discovered while investigating D6554. I am running tests now. \\n\\n The solution, including the fix for D6554, now is: \\n\\n 1) Remember the transaction id which created the sequence. This is saved in the SequenceUpdater which corresponds to the new sequence. \\n\\n 2) A map of (sequenceID, creatingTransactionID) pairs is maintained so that we can restore the SequenceUpdater\'s creatingTransactionID after cache eviction. The map is not persistent. Rebooting the database clears it out. \\n\\n 3) A good faith effort is made to garbage collect a (sequenceID, creatingTransactionID) pair and keep the map from growing indefinitely. However, there are cases when we won\'t know that it\'s ok to garbage collect a pair. I considered putting a hard limit on the size of the map. But I think that is brittle, particularly since I can\'t guarantee that the pair will eventually be garbage collected. This means that there is a resource-leak\\/denial-of-service defect with this solution. I think it is unlikely that any well behaved application will see this problem. And it is not clear to me that this is really a new vulnerability: in setting up such a situation, it is possible that you will hit some other resource limit first. But if people think this is a serious defect, then we will have to consider something fancier or abandon this approach. \\n\\n In developing this fix for D6554, I tripped across a bug in cache eviction: If there was an uncommitted CREATE SEQUENCE holding a lock on a SYS.SYSSEQUENCES row at cache eviction time, and the cache evicting transaction was not the transaction which created the sequence, then the Cacheable.clean() method would raise an exception when trying to flush the unused sequence values to disk. This, in turn, would short-circuit the clearing of the Cacheable identity. And that would raise an assertion when the Cacheable was re-used: \\\"Identity being changed on a live cacheable\\\". To fix this, I have moved the identity-resetting logic into a finally block. \\n\\n Developing the fix for D6554 also concentrated my attention on this behavior of sequence generators: If a sequence generator is evicted from the cache and the evicting transaction can\'t write to SYS.SYSSEQUENCES, then gaps in the sequence will appear. I\'m aware of only two situations which give rise to this problem: \\n\\n 1) An uncommitted CREATE SEQUENCE statement. \\n\\n 2) Users who ignore our advice and scan SYS.SYSSEQUENCES. \\n\\n Finally, in order to reduce the likelihood that we will trip across cache eviction problems, I have increased the size of the sequence generator cache to 1000. Applications will need to adjust derby.language.sequenceGeneratorCacheSize if they need to create and use a lot of sequences in a single transaction. \\n\\n\\n Touches the following additional file: \\n\\n M       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/reference\\/Property.java              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13986086\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13986086&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13986086\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13986086_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986086_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Apr\\/14 21:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-30T21:09:49+0000\'\u003e30\\/Apr\\/14 21:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eTests passed cleanly for me on derby-6554-01-ac-useCreationTransaction.diff except for the failure in OnlineCompressTest tracked by \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-6502\\\" title=\\\"Failure in OnlineCompressTest\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-6502\\\"\u003e\u003cdel\u003eDERBY-6502\u003c\\/del\u003e\u003c\\/a\u003e.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13986086_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986086_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Apr\\/14 21:09\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-30T21:09:49+0000\'\u003e30\\/Apr\\/14 21:09\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Tests passed cleanly for me on derby-6554-01-ac-useCreationTransaction.diff except for the failure in OnlineCompressTest tracked by   DERBY-6502  .              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13986113\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13986113&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13986113\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13986113_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986113_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Apr\\/14 21:28\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-30T21:28:42+0000\'\u003e30\\/Apr\\/14 21:28\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ei have not followed the most recent discussion on this, just happened to notice the lock question.  I\'ll think\u003cbr\\/\u003e\\nmore but here are initial thoughts based on your description in the latest posting.  \u003c\\/p\u003e\\n\\n\u003cp\u003eI think we had long discussions about this when you were first doing sequences and that is what led to \u003cbr\\/\u003e\\nthe too much contention error in the sequence implementation.  The proposed solution seems overly complex to me.  A lot\u003cbr\\/\u003e\\nof mechanism to solve what should just be a locking issue with ddl in transaction.  I would lean toward what\u003cbr\\/\u003e\\nknut suggests and just catch the error and retry in main transaction, to handle the creating transaction case.\u003cbr\\/\u003e\\nAnd maybe tune how long you wait for lock in sub transaction to get fewer false escalations.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think the right next project to fix the issue with incorrectly escalating to parent is to fix the lock manager to throw deadlock\u003cbr\\/\u003e\\nrather than lock wait when it can\'t get a lock because parent transaction holds it.  Not sure how hard that \u003cbr\\/\u003e\\nproject would be, but if necessary we could even special case the lock and lock path to make it easier if no one\u003cbr\\/\u003e\\nwas up to a general change to the lock manager.\u003c\\/p\u003e\\n\\n\u003cp\u003eFor sequences do you have some feel for the need to create and use sequences in the same transaction.  For\u003cbr\\/\u003e\\nidentity I have always been comfortable telling people to create the table and then use it in a different transaction\u003cbr\\/\u003e\\nif they see poor performance\\/contention with in transaction work.  Basically is it reasonable to require a commit\u003cbr\\/\u003e\\nafter create sequence to get best performance.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13986113_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986113_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Apr\\/14 21:28\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-30T21:28:42+0000\'\u003e30\\/Apr\\/14 21:28\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    i have not followed the most recent discussion on this, just happened to notice the lock question.  I\'ll think \\nmore but here are initial thoughts based on your description in the latest posting.   \\n\\n I think we had long discussions about this when you were first doing sequences and that is what led to  \\nthe too much contention error in the sequence implementation.  The proposed solution seems overly complex to me.  A lot \\nof mechanism to solve what should just be a locking issue with ddl in transaction.  I would lean toward what \\nknut suggests and just catch the error and retry in main transaction, to handle the creating transaction case. \\nAnd maybe tune how long you wait for lock in sub transaction to get fewer false escalations. \\n\\n I think the right next project to fix the issue with incorrectly escalating to parent is to fix the lock manager to throw deadlock \\nrather than lock wait when it can\'t get a lock because parent transaction holds it.  Not sure how hard that  \\nproject would be, but if necessary we could even special case the lock and lock path to make it easier if no one \\nwas up to a general change to the lock manager. \\n\\n For sequences do you have some feel for the need to create and use sequences in the same transaction.  For \\nidentity I have always been comfortable telling people to create the table and then use it in a different transaction \\nif they see poor performance\\/contention with in transaction work.  Basically is it reasonable to require a commit \\nafter create sequence to get best performance.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13986153\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13986153&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13986153\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13986153_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986153_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Apr\\/14 22:08\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-30T22:08:09+0000\'\u003e30\\/Apr\\/14 22:08\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eRick I have copied below from \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-5443\\\" title=\\\"reduce number of times sequence updater does it work on user thread rather than nested user thread.\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-5443\\\"\u003e\u003cdel\u003eDERBY-5443\u003c\\/del\u003e\u003c\\/a\u003e, I think we are back to discussing the same problem that was marked fixed.  Could you update this description if necessary to reflect what sequencers do in trunk now, I have lost track.\u003cbr\\/\u003e\\nI like option 1 the best but not sure if anyone with skills in the lock manager would be interested, I don\' like option 2 anymore and think option 3 may be the easiest solution, but need to understand what current implementation of sequencers do now.  \u003c\\/p\u003e\\n\\n\u003cp\u003eDescription of problem from around 03\\/Oct\\/11 14:47 in \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-5443\\\" title=\\\"reduce number of times sequence updater does it work on user thread rather than nested user thread.\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-5443\\\"\u003e\u003cdel\u003eDERBY-5443\u003c\\/del\u003e\u003c\\/a\u003e:\u003c\\/p\u003e\\n\\n\u003cp\u003eCurrently the Sequence updater tries to do the system catalog update as part of the user thread, but in a nested user transaction. When this works\u003cbr\\/\u003e\\nall is well as the nested user transaction is immediately committed and thus the throughput of all threads depending on allocating sequences is\u003cbr\\/\u003e\\noptimized.\u003c\\/p\u003e\\n\\n\u003cp\u003eIn order to be able to commit the nested writable transaction independently the lock manager must treat the parent and nested transactions as two\u003cbr\\/\u003e\\nindependent transactions and locks held by the parent will thus block the child. And in effect any lock that is blocked by the parent is a deadlock,\u003cbr\\/\u003e\\nbut the lock manager does not understand this relationship and thus only will timeout and not recognize the implicit deadlock.\u003c\\/p\u003e\\n\\n\u003cp\u003eOnly 2 cases come to mind of the parent blocking the child in this manner for sequences:\u003cbr\\/\u003e\\n1) ddl like create done in transaction followed by inserts into the table requiring sequence update.\u003cbr\\/\u003e\\n2) users doing jdbc data dictionary lookups in a multistatment transaction resulting in holding locks on the system catalog rows and subsequently\u003cbr\\/\u003e\\ndoing inserts into the table requiring sequence updates.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe sequence updater currently never waits for a lock in the nested transaction and assumes any blocked lock is this parent deadlock case. It\u003cbr\\/\u003e\\nthen falls back on doing the update in tranaction and then the system catalog lock remains until the user transaction commits which could then\u003cbr\\/\u003e\\nhold hostage all other inserts into the table. This is ok in the above 2 cases as there is not any other choice since the user transaction is already\u003cbr\\/\u003e\\nholding the system hostage.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe problem is the case where it was not a deadlock but just another thread trying to do the sequence update. In this case the thread should\u003cbr\\/\u003e\\nnot be getting locks on the user thread.\u003c\\/p\u003e\\n\\n\u003cp\u003eI am not sure best way to address this project but here are some ideas:\u003cbr\\/\u003e\\n1) enhance lock manager to recognize the deadlock and then change to code to somehow do an immediately deadlock check for internal\u003cbr\\/\u003e\\nnested transactions, no matter what the system default is. Then the code should go ahead and use the system wait timeout on this lock\u003cbr\\/\u003e\\nand only fall over to using user transaction for deadlock (or maybe even throw a new \\\"self deadlock\\\" error that would only be possible for\u003cbr\\/\u003e\\ninternal transactions).\u003c\\/p\u003e\\n\\n\u003cp\u003e2) somehow execute the internal system catalog update as part of a whole different transaction in the system. Would need a separate context.\u003cbr\\/\u003e\\nSort of like the background daemon threads. Then no self deadlock is possible and it could just go ahead and wait. The downside is that then\u003cbr\\/\u003e\\nthe code to \\\"wait\\\" for a new sequence becomes more complicated as it has to wait for an event from another thread. But seems like it could\u003cbr\\/\u003e\\ndesigned with locks\\/synchonization blocks somehow.\u003c\\/p\u003e\\n\\n\u003cp\u003e3) maybe add another lock synchronization that would only involve threads updating the sequences. So first an updater would request the\u003cbr\\/\u003e\\nsequence updater lock (with a key specific to the table and a new type) and it could just wait on it. It should never be held by parent\u003cbr\\/\u003e\\ntransaction. Then it would still need the catalog row lock to do the update. I think with proper ordering this would insure that blocking on\u003cbr\\/\u003e\\nthe catalog row lock would only happen in the self deadlock case.\u003c\\/p\u003e\\n\\n\u003cp\u003eOverall this problem is less important as the size of the chunk of sequence is tuned properly for the application, and ultimately best if derby\u003cbr\\/\u003e\\nautotuned the chunk. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13986153_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986153_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'30\\/Apr\\/14 22:08\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-04-30T22:08:09+0000\'\u003e30\\/Apr\\/14 22:08\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Rick I have copied below from   DERBY-5443  , I think we are back to discussing the same problem that was marked fixed.  Could you update this description if necessary to reflect what sequencers do in trunk now, I have lost track. \\nI like option 1 the best but not sure if anyone with skills in the lock manager would be interested, I don\' like option 2 anymore and think option 3 may be the easiest solution, but need to understand what current implementation of sequencers do now.   \\n\\n Description of problem from around 03\\/Oct\\/11 14:47 in   DERBY-5443  : \\n\\n Currently the Sequence updater tries to do the system catalog update as part of the user thread, but in a nested user transaction. When this works \\nall is well as the nested user transaction is immediately committed and thus the throughput of all threads depending on allocating sequences is \\noptimized. \\n\\n In order to be able to commit the nested writable transaction independently the lock manager must treat the parent and nested transactions as two \\nindependent transactions and locks held by the parent will thus block the child. And in effect any lock that is blocked by the parent is a deadlock, \\nbut the lock manager does not understand this relationship and thus only will timeout and not recognize the implicit deadlock. \\n\\n Only 2 cases come to mind of the parent blocking the child in this manner for sequences: \\n1) ddl like create done in transaction followed by inserts into the table requiring sequence update. \\n2) users doing jdbc data dictionary lookups in a multistatment transaction resulting in holding locks on the system catalog rows and subsequently \\ndoing inserts into the table requiring sequence updates. \\n\\n The sequence updater currently never waits for a lock in the nested transaction and assumes any blocked lock is this parent deadlock case. It \\nthen falls back on doing the update in tranaction and then the system catalog lock remains until the user transaction commits which could then \\nhold hostage all other inserts into the table. This is ok in the above 2 cases as there is not any other choice since the user transaction is already \\nholding the system hostage. \\n\\n The problem is the case where it was not a deadlock but just another thread trying to do the sequence update. In this case the thread should \\nnot be getting locks on the user thread. \\n\\n I am not sure best way to address this project but here are some ideas: \\n1) enhance lock manager to recognize the deadlock and then change to code to somehow do an immediately deadlock check for internal \\nnested transactions, no matter what the system default is. Then the code should go ahead and use the system wait timeout on this lock \\nand only fall over to using user transaction for deadlock (or maybe even throw a new \\\"self deadlock\\\" error that would only be possible for \\ninternal transactions). \\n\\n 2) somehow execute the internal system catalog update as part of a whole different transaction in the system. Would need a separate context. \\nSort of like the background daemon threads. Then no self deadlock is possible and it could just go ahead and wait. The downside is that then \\nthe code to \\\"wait\\\" for a new sequence becomes more complicated as it has to wait for an event from another thread. But seems like it could \\ndesigned with locks\\/synchonization blocks somehow. \\n\\n 3) maybe add another lock synchronization that would only involve threads updating the sequences. So first an updater would request the \\nsequence updater lock (with a key specific to the table and a new type) and it could just wait on it. It should never be held by parent \\ntransaction. Then it would still need the catalog row lock to do the update. I think with proper ordering this would insure that blocking on \\nthe catalog row lock would only happen in the self deadlock case. \\n\\n Overall this problem is less important as the size of the chunk of sequence is tuned properly for the application, and ultimately best if derby \\nautotuned the chunk.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13986571\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13986571&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13986571\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13986571_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986571_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 13:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T13:36:08+0000\'\u003e01\\/May\\/14 13:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi Mike,\u003c\\/p\u003e\\n\\n\u003cp\u003eHere are some responses to your previous two comments. I hope I am addressing your questions. Ask me again if I have inadvertently missed something.\u003c\\/p\u003e\\n\\n\u003cp\u003e----------------------\u003c\\/p\u003e\\n\\n\u003cp\u003eHow likely\\/real is it that someone will use a sequence generator in the transaction which created it?\u003c\\/p\u003e\\n\\n\u003cp\u003eVery unlikely. That is why this bug was discovered in the laboratory and not discovered in production. I think that most applications do their DDL first as part of application-installation. However, I suppose you could imagine an application which scales itself by cloning its schema on the fly. The cloning transaction might have to exercise the sequence generator during initialization. New connections would back up behind the cloning transaction, waiting for it to commit and signal that initialization had completed.\u003c\\/p\u003e\\n\\n\u003cp\u003e---------------------------------\u003c\\/p\u003e\\n\\n\u003cp\u003eWhat is SequenceUpdater doing today?\u003c\\/p\u003e\\n\\n\u003cp\u003eThere are 3 kinds of writes to SYS.SYSSEQUENCES:\u003c\\/p\u003e\\n\\n\u003cp\u003eA) The initial row insertion by CREATE SEQUENCE.\u003c\\/p\u003e\\n\\n\u003cp\u003eB) Periodic allocations of new ranges of sequence values.\u003c\\/p\u003e\\n\\n\u003cp\u003eC) Flushing unused sequence values.\u003c\\/p\u003e\\n\\n\u003cp\u003ei) This happens if the cache of sequence generators fills up and an active sequence generator has to be evicted from the cache. That is, merely using another, unrelated sequence generator can cause this to happen.\u003c\\/p\u003e\\n\\n\u003cp\u003eii) This also happens during DDL, which causes the DataDictionary to flush all of its caches.\u003c\\/p\u003e\\n\\n\u003cp\u003eiii) This also happens during orderly database shutdown.\u003c\\/p\u003e\\n\\n\u003cp\u003eRight now (not including the derby-6554-01-ac-useCreationTransaction.diff patch):\u003c\\/p\u003e\\n\\n\u003cp\u003eA always happens in the user\'s execution transaction\u003c\\/p\u003e\\n\\n\u003cp\u003eB and C only try to write to SYS.SYSSEQUENCES in a nested sub-transaction of the user\'s execution transaction. B and C never wait for a lock. Instead, if they can\'t get the lock, they timeout immediately and raise a \\\"too much contention\\\" exception.\u003c\\/p\u003e\\n\\n\u003cp\u003e---------------------------------\u003c\\/p\u003e\\n\\n\u003cp\u003eWhat if we changed this behavior so that B and C waited for the X lock and\\/or escalated into the parent transaction?\u003c\\/p\u003e\\n\\n\u003cp\u003eThis might be ok for B, although throughput might suffer.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think this would cause system freeze-ups for C.\u003c\\/p\u003e\\n\\n\u003cp\u003e--------------------------------\u003c\\/p\u003e\\n\\n\u003cp\u003eWhat if the LockManager raised a SelfDeadlock exception when a nested sub-transaction requested an X lock held by its parent transaction?\u003c\\/p\u003e\\n\\n\u003cp\u003eI think this eliminates the troubling complexity of derby-6554-01-ac-useCreationTransaction.diff. SelfDeadlock would be the only case which caused us to escalate from the nested sub-transaction into the parent transaction. I think that this situation will only occur under the conditions of this bug: exercising a sequence generator in the transaction which created it. If anyone can think of another case which gives rise to this situation, then we\'ll need to think some more.\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'m happy to try my hand at this, provided that the experts are willing to coach me.\u003c\\/p\u003e\\n\\n\u003cp\u003eWith this extra explanation, does this still seem like the best approach to you?\u003c\\/p\u003e\\n\\n\u003cp\u003eThanks,\u003cbr\\/\u003e\\n-Rick\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13986571_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986571_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 13:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T13:36:08+0000\'\u003e01\\/May\\/14 13:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hi Mike, \\n\\n Here are some responses to your previous two comments. I hope I am addressing your questions. Ask me again if I have inadvertently missed something. \\n\\n ---------------------- \\n\\n How likely\\/real is it that someone will use a sequence generator in the transaction which created it? \\n\\n Very unlikely. That is why this bug was discovered in the laboratory and not discovered in production. I think that most applications do their DDL first as part of application-installation. However, I suppose you could imagine an application which scales itself by cloning its schema on the fly. The cloning transaction might have to exercise the sequence generator during initialization. New connections would back up behind the cloning transaction, waiting for it to commit and signal that initialization had completed. \\n\\n --------------------------------- \\n\\n What is SequenceUpdater doing today? \\n\\n There are 3 kinds of writes to SYS.SYSSEQUENCES: \\n\\n A) The initial row insertion by CREATE SEQUENCE. \\n\\n B) Periodic allocations of new ranges of sequence values. \\n\\n C) Flushing unused sequence values. \\n\\n i) This happens if the cache of sequence generators fills up and an active sequence generator has to be evicted from the cache. That is, merely using another, unrelated sequence generator can cause this to happen. \\n\\n ii) This also happens during DDL, which causes the DataDictionary to flush all of its caches. \\n\\n iii) This also happens during orderly database shutdown. \\n\\n Right now (not including the derby-6554-01-ac-useCreationTransaction.diff patch): \\n\\n A always happens in the user\'s execution transaction \\n\\n B and C only try to write to SYS.SYSSEQUENCES in a nested sub-transaction of the user\'s execution transaction. B and C never wait for a lock. Instead, if they can\'t get the lock, they timeout immediately and raise a \\\"too much contention\\\" exception. \\n\\n --------------------------------- \\n\\n What if we changed this behavior so that B and C waited for the X lock and\\/or escalated into the parent transaction? \\n\\n This might be ok for B, although throughput might suffer. \\n\\n I think this would cause system freeze-ups for C. \\n\\n -------------------------------- \\n\\n What if the LockManager raised a SelfDeadlock exception when a nested sub-transaction requested an X lock held by its parent transaction? \\n\\n I think this eliminates the troubling complexity of derby-6554-01-ac-useCreationTransaction.diff. SelfDeadlock would be the only case which caused us to escalate from the nested sub-transaction into the parent transaction. I think that this situation will only occur under the conditions of this bug: exercising a sequence generator in the transaction which created it. If anyone can think of another case which gives rise to this situation, then we\'ll need to think some more. \\n\\n I\'m happy to try my hand at this, provided that the experts are willing to coach me. \\n\\n With this extra explanation, does this still seem like the best approach to you? \\n\\n Thanks, \\n-Rick              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13986617\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13986617&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13986617\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13986617_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986617_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 14:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T14:12:51+0000\'\u003e01\\/May\\/14 14:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Rick Hillegas - 01\\/May\\/14 14:16\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching derby-6554-01-ad-bugfixes.diff.  This is the previous patch after removing the complex solution to this bug. This patch just contains the other bug fixes discovered while investigating this JIRA. I am running tests now.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis patch does the following:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) Fixes a bug in re-use of the SequenceUpdater Cacheable after a\u003cbr\\/\u003e\\nsequence generator is evicted from the cache.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) Removes an assertion which killed the connection while evicting a SequenceUpdater from the cache.\u003c\\/p\u003e\\n\\n\u003cp\u003e3) Increases the size of the sequence generator cache to 1000.\u003c\\/p\u003e\\n\\n\\n\u003cp\u003eTouches the following files:\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/reference\\/Property.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/sql\\/catalog\\/DataDictionaryImpl.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/sql\\/catalog\\/SequenceUpdater.java\u003cbr\\/\u003e\\nM       java\\/testing\\/org\\/apache\\/derbyTesting\\/functionTests\\/tests\\/lang\\/SequenceTest.java\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13986617_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986617_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 14:12\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T14:12:51+0000\'\u003e01\\/May\\/14 14:12\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Rick Hillegas - 01\\/May\\/14 14:16\\\"\u003eedited\u003c\\/span\u003e                   Attaching derby-6554-01-ad-bugfixes.diff.  This is the previous patch after removing the complex solution to this bug. This patch just contains the other bug fixes discovered while investigating this JIRA. I am running tests now. \\n\\n This patch does the following: \\n\\n 1) Fixes a bug in re-use of the SequenceUpdater Cacheable after a \\nsequence generator is evicted from the cache. \\n\\n 2) Removes an assertion which killed the connection while evicting a SequenceUpdater from the cache. \\n\\n 3) Increases the size of the sequence generator cache to 1000. \\n\\n\\n Touches the following files: \\n\\n M       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/reference\\/Property.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/sql\\/catalog\\/DataDictionaryImpl.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/sql\\/catalog\\/SequenceUpdater.java \\nM       java\\/testing\\/org\\/apache\\/derbyTesting\\/functionTests\\/tests\\/lang\\/SequenceTest.java              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13986725\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13986725&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13986725\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13986725_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986725_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 16:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T16:20:37+0000\'\u003e01\\/May\\/14 16:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eTests passed cleanly for me on derby-6554-01-ad-bugfixes.diff.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13986725_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986725_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 16:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T16:20:37+0000\'\u003e01\\/May\\/14 16:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Tests passed cleanly for me on derby-6554-01-ad-bugfixes.diff.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13986736\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13986736&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13986736\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jira-bot\\\" id=\\\"commentauthor_13986736_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jira-bot\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jira-bot\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e ASF subversion and git services\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986736_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 16:30\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T16:30:45+0000\'\u003e01\\/May\\/14 16:30\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eCommit 1591703 from \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\" class=\\\"user-hover\\\" rel=\\\"rhillegas\\\"\u003eRick Hillegas\u003c\\/a\u003e in branch \'code\\/trunk\'\u003cbr\\/\u003e\\n[ \u003ca href=\\\"https:\\/\\/svn.apache.org\\/r1591703\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttps:\\/\\/svn.apache.org\\/r1591703\u003c\\/a\u003e ]\u003c\\/p\u003e\\n\\n\u003cp\u003e\u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-6554\\\" title=\\\"Too much contention followed by assert failure when accessing sequence in transaction that created it\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-6554\\\"\u003e\u003cdel\u003eDERBY-6554\u003c\\/del\u003e\u003c\\/a\u003e: Fix some bugs in cache management for sequence generators; commit derby-6554-01-ad-bugfixes.diff.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jira-bot\\\" id=\\\"commentauthor_13986736_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jira-bot\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jira-bot\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e ASF subversion and git services\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986736_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 16:30\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T16:30:45+0000\'\u003e01\\/May\\/14 16:30\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Commit 1591703 from  Rick Hillegas  in branch \'code\\/trunk\' \\n[  https:\\/\\/svn.apache.org\\/r1591703  ] \\n\\n   DERBY-6554  : Fix some bugs in cache management for sequence generators; commit derby-6554-01-ad-bugfixes.diff.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13986766\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13986766&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13986766\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13986766_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986766_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 17:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T17:00:24+0000\'\u003e01\\/May\\/14 17:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ethanks for the explanation, i think it answers most.  May need more explanation on why \u003cbr\\/\u003e\\nescalation causes:\u003cbr\\/\u003e\\n\\\"I think this would cause system freeze-ups for C.\\\"\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13986766_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986766_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 17:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T17:00:24+0000\'\u003e01\\/May\\/14 17:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    thanks for the explanation, i think it answers most.  May need more explanation on why  \\nescalation causes: \\n\\\"I think this would cause system freeze-ups for C.\\\" \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13986791\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13986791&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13986791\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13986791_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986791_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 17:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T17:20:50+0000\'\u003e01\\/May\\/14 17:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI still lean toward some approach that defaults the work to a subtransaction, and then escalates \u003cbr\\/\u003e\\nthe work to the parent transaction based on some condition. \u003c\\/p\u003e\\n\\n\u003cp\u003eDiscounting the work involved I do believe the lock manager recognizing the self deadlock is the\u003cbr\\/\u003e\\nbest solution, if it could be implemented with negatively impacting the throughput of all locks through\u003cbr\\/\u003e\\nthe system.  A solution that updated the current deadlock algorithm to be executed after system set\u003cbr\\/\u003e\\ndeadlock wait time would be fine.  I am not sure if a solution that checked on every wait would be\u003cbr\\/\u003e\\ngood -but might be if you could do a simple check that only looked at the data of the lock in question\u003cbr\\/\u003e\\nafter it was noticed it had to wait.  I am not sure if the current lock manager data has the necessary child\\/parent relationships\u003cbr\\/\u003e\\nnecessary.   I have not looked at the lock manager since it was partially rewritten multiple years ago\u003cbr\\/\u003e\\nso not sure how much I could help with this.\u003c\\/p\u003e\\n\\n\\n\u003cp\u003eI think the following will achieve the same result but no lock manager change, I do understand\u003cbr\\/\u003e\\nhow to do the locking part and would be happy to help if you would prefer this approach to the\u003cbr\\/\u003e\\nlock manager change.  There is a cost of an extra lock request per sequencer update for this\u003cbr\\/\u003e\\napproach.\u003cbr\\/\u003e\\n1) change code to wait for the lock and on timeout retry in parent transaction, and if that fails I guess\u003cbr\\/\u003e\\n     continue to throw too much contention.  Is there an argument to just not allow timeout in this case?\u003c\\/p\u003e\\n\\n\u003cp\u003e2) implement the following that would require no lock manager code change:\u003cbr\\/\u003e\\n    add new lock that will cause sub transaction to wait on other subtransactions but not on \u003cbr\\/\u003e\\n    parent transactions, and then change subtracation to wait first on the new lock, and then to \u003cbr\\/\u003e\\n    continue to nowait on the existing sequencer lock, with escalation code from 1 if it can\'t get\u003cbr\\/\u003e\\n    lock.\u003c\\/p\u003e\\n\\n\u003cp\u003eIf this does not work for C) Flushing unused sequence values. - maybe there is some special case we\u003cbr\\/\u003e\\ncan use for that?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13986791_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986791_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 17:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T17:20:50+0000\'\u003e01\\/May\\/14 17:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I still lean toward some approach that defaults the work to a subtransaction, and then escalates  \\nthe work to the parent transaction based on some condition.  \\n\\n Discounting the work involved I do believe the lock manager recognizing the self deadlock is the \\nbest solution, if it could be implemented with negatively impacting the throughput of all locks through \\nthe system.  A solution that updated the current deadlock algorithm to be executed after system set \\ndeadlock wait time would be fine.  I am not sure if a solution that checked on every wait would be \\ngood -but might be if you could do a simple check that only looked at the data of the lock in question \\nafter it was noticed it had to wait.  I am not sure if the current lock manager data has the necessary child\\/parent relationships \\nnecessary.   I have not looked at the lock manager since it was partially rewritten multiple years ago \\nso not sure how much I could help with this. \\n\\n\\n I think the following will achieve the same result but no lock manager change, I do understand \\nhow to do the locking part and would be happy to help if you would prefer this approach to the \\nlock manager change.  There is a cost of an extra lock request per sequencer update for this \\napproach. \\n1) change code to wait for the lock and on timeout retry in parent transaction, and if that fails I guess \\n     continue to throw too much contention.  Is there an argument to just not allow timeout in this case? \\n\\n 2) implement the following that would require no lock manager code change: \\n    add new lock that will cause sub transaction to wait on other subtransactions but not on  \\n    parent transactions, and then change subtracation to wait first on the new lock, and then to  \\n    continue to nowait on the existing sequencer lock, with escalation code from 1 if it can\'t get \\n    lock. \\n\\n If this does not work for C) Flushing unused sequence values. - maybe there is some special case we \\ncan use for that?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13986795\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13986795&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13986795\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13986795_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986795_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 17:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T17:29:31+0000\'\u003e01\\/May\\/14 17:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Mike Matrigali - 01\\/May\\/14 17:56\\\"\u003eedited\u003c\\/span\u003e \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI think it would be a major compatibility issue for inserts into hard upgraded tables with identity columns  \u003cbr\\/\u003e\\nto see \\\"too much contention\\\" errors on insert in the new release.    Hopefully we can come up with a \u003cbr\\/\u003e\\ngeneric solution for both sequences and identity columns based on sequences.\u003c\\/p\u003e\\n\\n\u003cp\u003eI assume that identity columns likely fail with timeouts and maybe deadlocks today, and likely much \u003cbr\\/\u003e\\nless so when changed to use underlying sequences.  If we can\'t eliminate new \\\"too much contention\\\" \u003cbr\\/\u003e\\nerror we may want to consider mapping it to a lock timeout for identity columns for backward application\u003cbr\\/\u003e\\ncompatibility.  That way upgraded applications will both see the much improved performance of\u003cbr\\/\u003e\\nidentity columns without having to change properly coded applications that already handled\u003cbr\\/\u003e\\nlock timeouts and deadlocks.  Not to mention they will possibly see way less of these errors\u003cbr\\/\u003e\\nin the new release.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n                                            \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13986795_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986795_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 17:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T17:29:31+0000\'\u003e01\\/May\\/14 17:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e   - \u003cspan class=\\\"redText subText\\\" title=\\\"Mike Matrigali - 01\\/May\\/14 17:56\\\"\u003eedited\u003c\\/span\u003e                   I think it would be a major compatibility issue for inserts into hard upgraded tables with identity columns   \\nto see \\\"too much contention\\\" errors on insert in the new release.    Hopefully we can come up with a  \\ngeneric solution for both sequences and identity columns based on sequences. \\n\\n I assume that identity columns likely fail with timeouts and maybe deadlocks today, and likely much  \\nless so when changed to use underlying sequences.  If we can\'t eliminate new \\\"too much contention\\\"  \\nerror we may want to consider mapping it to a lock timeout for identity columns for backward application \\ncompatibility.  That way upgraded applications will both see the much improved performance of \\nidentity columns without having to change properly coded applications that already handled \\nlock timeouts and deadlocks.  Not to mention they will possibly see way less of these errors \\nin the new release.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13986842\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13986842&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13986842\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13986842_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986842_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 18:27\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T18:27:50+0000\'\u003e01\\/May\\/14 18:27\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi Mike,\u003c\\/p\u003e\\n\\n\u003cp\u003e\\\"I think this would cause system freeze-ups for C.\\\" This is what would happen when the cache is cleared, or a cache entry is evicted, or the system shuts down in an orderly way: An attempt is made to stuff the SYSSEQUENCES row with the next sequence number which would be doled out. Suppose that one user scanned SYSSEQUENCES or the lock escalated into his execution transaction. Then someone else tries to use another sequence which evicts the first sequence from the cache. Or someone else tries to do some cache-flushing DDL. Or someone else tries to bring down the database. That subsequent operation will block, perhaps twice, for the lock timeout period and will get an error message referring to the first sequence. Potentially lots of threads will back up behind these operations.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13986842_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986842_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 18:27\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T18:27:50+0000\'\u003e01\\/May\\/14 18:27\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hi Mike, \\n\\n \\\"I think this would cause system freeze-ups for C.\\\" This is what would happen when the cache is cleared, or a cache entry is evicted, or the system shuts down in an orderly way: An attempt is made to stuff the SYSSEQUENCES row with the next sequence number which would be doled out. Suppose that one user scanned SYSSEQUENCES or the lock escalated into his execution transaction. Then someone else tries to use another sequence which evicts the first sequence from the cache. Or someone else tries to do some cache-flushing DDL. Or someone else tries to bring down the database. That subsequent operation will block, perhaps twice, for the lock timeout period and will get an error message referring to the first sequence. Potentially lots of threads will back up behind these operations.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13986844\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13986844&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13986844\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13986844_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986844_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 18:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T18:33:01+0000\'\u003e01\\/May\\/14 18:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi Mike,\u003c\\/p\u003e\\n\\n\u003cp\u003eI think that it would be trivial to raise a \\\"lock timeout\\\" for identity columns in the situations where we are currently raising \\\"too much contention\\\". Thanks.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13986844_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13986844_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/May\\/14 18:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-01T18:33:01+0000\'\u003e01\\/May\\/14 18:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hi Mike, \\n\\n I think that it would be trivial to raise a \\\"lock timeout\\\" for identity columns in the situations where we are currently raising \\\"too much contention\\\". Thanks.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13988130\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13988130&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13988130\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13988130_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13988130_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/May\\/14 19:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-02T19:33:47+0000\'\u003e02\\/May\\/14 19:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching derby-6554-02-aa-selfDeadlock.diff. This is a first pass at fixing this bug by adding a new SelfDeadlock condition which is raised by the lock manager.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe lock manager code has been changed as follows:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) Xact now has a field holding the TransactionId of its parent transaction. Usually, this field is null. However, it is non-null if the transaction was created by TransactionController.startNestedUserTransaction().\u003c\\/p\u003e\\n\\n\u003cp\u003e2) LockControl uses this new information to determine if a parent transaction has been granted a lock which conflicts with a nested transaction\'s lock request.\u003c\\/p\u003e\\n\\n\u003cp\u003e3) ConcurrentLockSet.lockObject() raises a SelfDeadlock exception if this is the case.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis is my first attempt to touch this part of Derby so it is likely that I have misunderstood something important and put this code in the wrong place. I would appreciate review by the experts.\u003c\\/p\u003e\\n\\n\u003cp\u003eI don\'t know if I\'ve allocated the SelfDeadlock exception out of the correct block of SQLStates. Technically, it is an internal error which should never escape to the user and is only used to communicate this edge-case condition to higher levels of the engine.\u003c\\/p\u003e\\n\\n\\n\u003cp\u003eTouches the following files:\u003c\\/p\u003e\\n\\n\u003cp\u003e----------------\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/engine\\/org\\/apache\\/derby\\/loc\\/messages.xml\u003cbr\\/\u003e\\nM       java\\/shared\\/org\\/apache\\/derby\\/shared\\/common\\/reference\\/SQLState.java\u003c\\/p\u003e\\n\\n\u003cp\u003eThe new SelfDeadlock exception state.\u003c\\/p\u003e\\n\\n\u003cp\u003e----------------\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/store\\/raw\\/xact\\/TransactionFactory.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/store\\/raw\\/RawStoreFactory.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/services\\/locks\\/LockOwner.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/Xact.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/access\\/RAMTransaction.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/XactFactory.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/InternalXact.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/RawStore.java\u003c\\/p\u003e\\n\\n\u003cp\u003eAdded a parent transaction id to transactions.\u003c\\/p\u003e\\n\\n\u003cp\u003e----------------\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/services\\/locks\\/LockControl.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/services\\/reflect\\/UpdateLoader.java\u003c\\/p\u003e\\n\\n\u003cp\u003eAdded a method to check whether any of the conflicting locks is owned by the parent transaction of the transaction which wants a lock.\u003c\\/p\u003e\\n\\n\u003cp\u003e----------------\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/services\\/locks\\/ConcurrentLockSet.java\u003c\\/p\u003e\\n\\n\u003cp\u003eThe lockObject() now raises a SelfDeadlock error if the parent of the requesting transaction has been granted a conflicting lock on the object.\u003c\\/p\u003e\\n\\n\u003cp\u003e----------------\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/sql\\/catalog\\/SequenceUpdater.java\u003c\\/p\u003e\\n\\n\u003cp\u003eEscalates to the parent (execution) transaction if a SelfDeadlock error is caught while trying to update SYS.SYSSEQUENCES in the nested transaction.\u003c\\/p\u003e\\n\\n\u003cp\u003e----------------\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/testing\\/org\\/apache\\/derbyTesting\\/functionTests\\/tests\\/lang\\/SequenceTest.java\u003c\\/p\u003e\\n\\n\u003cp\u003eTest to verify that this bug is fixed.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13988130_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13988130_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'02\\/May\\/14 19:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-02T19:33:47+0000\'\u003e02\\/May\\/14 19:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attaching derby-6554-02-aa-selfDeadlock.diff. This is a first pass at fixing this bug by adding a new SelfDeadlock condition which is raised by the lock manager. \\n\\n The lock manager code has been changed as follows: \\n\\n 1) Xact now has a field holding the TransactionId of its parent transaction. Usually, this field is null. However, it is non-null if the transaction was created by TransactionController.startNestedUserTransaction(). \\n\\n 2) LockControl uses this new information to determine if a parent transaction has been granted a lock which conflicts with a nested transaction\'s lock request. \\n\\n 3) ConcurrentLockSet.lockObject() raises a SelfDeadlock exception if this is the case. \\n\\n This is my first attempt to touch this part of Derby so it is likely that I have misunderstood something important and put this code in the wrong place. I would appreciate review by the experts. \\n\\n I don\'t know if I\'ve allocated the SelfDeadlock exception out of the correct block of SQLStates. Technically, it is an internal error which should never escape to the user and is only used to communicate this edge-case condition to higher levels of the engine. \\n\\n\\n Touches the following files: \\n\\n ---------------- \\n\\n M       java\\/engine\\/org\\/apache\\/derby\\/loc\\/messages.xml \\nM       java\\/shared\\/org\\/apache\\/derby\\/shared\\/common\\/reference\\/SQLState.java \\n\\n The new SelfDeadlock exception state. \\n\\n ---------------- \\n\\n M       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/store\\/raw\\/xact\\/TransactionFactory.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/store\\/raw\\/RawStoreFactory.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/services\\/locks\\/LockOwner.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/Xact.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/access\\/RAMTransaction.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/XactFactory.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/InternalXact.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/RawStore.java \\n\\n Added a parent transaction id to transactions. \\n\\n ---------------- \\n\\n M       java\\/engine\\/org\\/apache\\/derby\\/impl\\/services\\/locks\\/LockControl.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/services\\/reflect\\/UpdateLoader.java \\n\\n Added a method to check whether any of the conflicting locks is owned by the parent transaction of the transaction which wants a lock. \\n\\n ---------------- \\n\\n M       java\\/engine\\/org\\/apache\\/derby\\/impl\\/services\\/locks\\/ConcurrentLockSet.java \\n\\n The lockObject() now raises a SelfDeadlock error if the parent of the requesting transaction has been granted a conflicting lock on the object. \\n\\n ---------------- \\n\\n M       java\\/engine\\/org\\/apache\\/derby\\/impl\\/sql\\/catalog\\/SequenceUpdater.java \\n\\n Escalates to the parent (execution) transaction if a SelfDeadlock error is caught while trying to update SYS.SYSSEQUENCES in the nested transaction. \\n\\n ---------------- \\n\\n M       java\\/testing\\/org\\/apache\\/derbyTesting\\/functionTests\\/tests\\/lang\\/SequenceTest.java \\n\\n Test to verify that this bug is fixed.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13989378\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13989378&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13989378\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13989378_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13989378_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/May\\/14 09:30\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-05T09:30:16+0000\'\u003e05\\/May\\/14 09:30\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eLooks like a fine approach to me. If I read the patch correctly, a nested transaction now will raise a self-deadlock if it is immediately blocked by its parent. In the more general case, where the parent is part of the lock cycle, but other transactions are involved in it too, it won\'t raise a self-deadlock. This sounds fine, since the case where multiple transactions are involved is where the too much contention error should be raised by design.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think I\'d prefer the SQLState to be something more similar to the ones for lock timeout and deadlock, so that it\'s more likely that existing application logic will be able to handle them sensibly if they ever leak out. With the current prefix (42), they will be reported as SQLSyntaxErrorException, which doesn\'t sound quite right. If the SQLState is changed to something that begins with 40, they will be reported as SQLTransactionRollbackException, same as lock timeout and deadlock.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13989378_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13989378_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/May\\/14 09:30\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-05T09:30:16+0000\'\u003e05\\/May\\/14 09:30\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Looks like a fine approach to me. If I read the patch correctly, a nested transaction now will raise a self-deadlock if it is immediately blocked by its parent. In the more general case, where the parent is part of the lock cycle, but other transactions are involved in it too, it won\'t raise a self-deadlock. This sounds fine, since the case where multiple transactions are involved is where the too much contention error should be raised by design. \\n\\n I think I\'d prefer the SQLState to be something more similar to the ones for lock timeout and deadlock, so that it\'s more likely that existing application logic will be able to handle them sensibly if they ever leak out. With the current prefix (42), they will be reported as SQLSyntaxErrorException, which doesn\'t sound quite right. If the SQLState is changed to something that begins with 40, they will be reported as SQLTransactionRollbackException, same as lock timeout and deadlock.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13989455\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13989455&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13989455\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13989455_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13989455_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/May\\/14 12:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-05T12:20:04+0000\'\u003e05\\/May\\/14 12:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks, Knut. Attaching derby-6554-02-ab-selfDeadlock.diff. This patch moves the SelfDeadlock error into the 40* range. I am running tests now.\u003c\\/p\u003e\\n\\n\u003cp\u003eTouches the same files as the previous rev of the patch.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13989455_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13989455_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/May\\/14 12:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-05T12:20:04+0000\'\u003e05\\/May\\/14 12:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks, Knut. Attaching derby-6554-02-ab-selfDeadlock.diff. This patch moves the SelfDeadlock error into the 40* range. I am running tests now. \\n\\n Touches the same files as the previous rev of the patch.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13989902\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13989902&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13989902\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13989902_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13989902_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/May\\/14 19:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-05T19:52:34+0000\'\u003e05\\/May\\/14 19:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching D6554_2.java. This test fails with a SelfDeadlock error using the derby-6554-02-ab-selfDeadlock.diff patch. The test does the following:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) Creates and populates a table.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) Adds an index to the table.\u003c\\/p\u003e\\n\\n\u003cp\u003e3) Then, in a single transaction, drops all the rows in the table and compresses the table.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe table compression wants to do its work in a nested sub-transaction. This is a nested sub-transaction which we  haven\'t discussed yet. Does this case ring any bells?\u003c\\/p\u003e\\n\\n\u003cp\u003eThanks,\u003cbr\\/\u003e\\n-Rick\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13989902_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13989902_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/May\\/14 19:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-05T19:52:34+0000\'\u003e05\\/May\\/14 19:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attaching D6554_2.java. This test fails with a SelfDeadlock error using the derby-6554-02-ab-selfDeadlock.diff patch. The test does the following: \\n\\n 1) Creates and populates a table. \\n\\n 2) Adds an index to the table. \\n\\n 3) Then, in a single transaction, drops all the rows in the table and compresses the table. \\n\\n The table compression wants to do its work in a nested sub-transaction. This is a nested sub-transaction which we  haven\'t discussed yet. Does this case ring any bells? \\n\\n Thanks, \\n-Rick              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13989910\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13989910&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13989910\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13989910_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13989910_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/May\\/14 19:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-05T19:59:22+0000\'\u003e05\\/May\\/14 19:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHere is a simple script which raises the same error:\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"preformatted panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"preformattedContent panelContent\\\"\u003e\\n\u003cpre\u003econnect \'jdbc:derby:memory:db;create=true\';\\n\\ncreate table t(keycol int);\\n\\ncreate index t_idx_keycol on t(keycol);\\n\\nautocommit off;\\n\\ndelete from t;\\n\\ncall SYSCS_UTIL.SYSCS_INPLACE_COMPRESS_TABLE(\'APP\', \'T\', 1, 1, 1);\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13989910_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13989910_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/May\\/14 19:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-05T19:59:22+0000\'\u003e05\\/May\\/14 19:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Here is a simple script which raises the same error: \\n\\n  \\n connect \'jdbc:derby:memory:db;create=true\';\\n\\ncreate table t(keycol int);\\n\\ncreate index t_idx_keycol on t(keycol);\\n\\nautocommit off;\\n\\ndelete from t;\\n\\ncall SYSCS_UTIL.SYSCS_INPLACE_COMPRESS_TABLE(\'APP\', \'T\', 1, 1, 1);\\n \\n               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13990670\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13990670&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13990670\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13990670_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13990670_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/May\\/14 14:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-06T14:15:03+0000\'\u003e06\\/May\\/14 14:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThat use-case comes from the lang\\/compressTable.sql test. What is going on is this: The DELETE statement grabs an IX lock on the table. The SYSCS_INPLACE_COMPRESS_TABLE tries to grab an X lock on the table. The locks are incompatible. Without the patch, the test case fails on a lock timeout.\u003c\\/p\u003e\\n\\n\u003cp\u003eI can get the test case to pass by adding another restriction: Raise SelfDeadlock only if the lock timeout is 0, that is, if we are supposed to abort the transaction when we can\'t immediately get the lock. This will result in a behavior change for the SYSCS_INPLACE_COMPRESS_TABLE case. We will raise a SelfDeadlock exception rather than a lock timeout exception. Is this behavior change ok? Other suggestions?\u003c\\/p\u003e\\n\\n\u003cp\u003eThanks,\u003cbr\\/\u003e\\n-Rick\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13990670_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13990670_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/May\\/14 14:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-06T14:15:03+0000\'\u003e06\\/May\\/14 14:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    That use-case comes from the lang\\/compressTable.sql test. What is going on is this: The DELETE statement grabs an IX lock on the table. The SYSCS_INPLACE_COMPRESS_TABLE tries to grab an X lock on the table. The locks are incompatible. Without the patch, the test case fails on a lock timeout. \\n\\n I can get the test case to pass by adding another restriction: Raise SelfDeadlock only if the lock timeout is 0, that is, if we are supposed to abort the transaction when we can\'t immediately get the lock. This will result in a behavior change for the SYSCS_INPLACE_COMPRESS_TABLE case. We will raise a SelfDeadlock exception rather than a lock timeout exception. Is this behavior change ok? Other suggestions? \\n\\n Thanks, \\n-Rick              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13990680\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13990680&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13990680\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13990680_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13990680_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/May\\/14 14:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-06T14:22:50+0000\'\u003e06\\/May\\/14 14:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching derby-6554-02-ac-selfDeadlock.diff. This patch adds an extra restriction on when we raise SelfDeadlock: the requestor (that is, the nested sub-transaction) must be requesting an immediate, no-wait lock. I will run tests now.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe conditions for SelfDeadlock now are:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) Must be a nested sub-transaction which is requesting the lock.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) The lock must be blocked by some other lock held by the parent transaction.\u003c\\/p\u003e\\n\\n\u003cp\u003e3) The nested sub-transaction must have specified a lock timeout of 0.\u003c\\/p\u003e\\n\\n\u003cp\u003eTouches the same files as the previous rev of the patch.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13990680_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13990680_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/May\\/14 14:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-06T14:22:50+0000\'\u003e06\\/May\\/14 14:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attaching derby-6554-02-ac-selfDeadlock.diff. This patch adds an extra restriction on when we raise SelfDeadlock: the requestor (that is, the nested sub-transaction) must be requesting an immediate, no-wait lock. I will run tests now. \\n\\n The conditions for SelfDeadlock now are: \\n\\n 1) Must be a nested sub-transaction which is requesting the lock. \\n\\n 2) The lock must be blocked by some other lock held by the parent transaction. \\n\\n 3) The nested sub-transaction must have specified a lock timeout of 0. \\n\\n Touches the same files as the previous rev of the patch.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13991646\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13991646&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13991646\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13991646_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13991646_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/May\\/14 07:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-07T07:54:04+0000\'\u003e07\\/May\\/14 07:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cblockquote\u003e\\n\u003cp\u003eI can get the test case to pass by adding another restriction: Raise SelfDeadlock only if the lock timeout is 0, that is, if we are supposed to abort the transaction when we can\'t immediately get the lock. This will result in a behavior change for the SYSCS_INPLACE_COMPRESS_TABLE case. We will raise a SelfDeadlock exception rather than a lock timeout exception. Is this behavior change ok?\u003c\\/p\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eI\'m not sure I fully understand this question. First it sounded as if adding the extra restriction would prevent SYSCS_INPLACE_COMPRESS_TABLE from raising SelfDeadlock. But the question seems to imply that adding the extra restriction will make it start raising SelfDeadlock rather than lock timeout in some cases. Exactly what does adding the extra restriction fix, and what behaviour change does it introduce?\u003c\\/p\u003e\\n\\n\u003cp\u003eI think it is ok that SYSCS_INPLACE_COMPRESS_TABLE raises a lock timeout in this case (which it currently does?), since the reference manual says \\\"Tip: We recommend that you issue the SYSCS_UTIL.SYSCS_INPLACE_COMPRESS_TABLE system procedure in auto-commit mode.\\\" Presumably that tip was added because of this issue.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13991646_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13991646_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/May\\/14 07:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-07T07:54:04+0000\'\u003e07\\/May\\/14 07:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    \\n I can get the test case to pass by adding another restriction: Raise SelfDeadlock only if the lock timeout is 0, that is, if we are supposed to abort the transaction when we can\'t immediately get the lock. This will result in a behavior change for the SYSCS_INPLACE_COMPRESS_TABLE case. We will raise a SelfDeadlock exception rather than a lock timeout exception. Is this behavior change ok?  \\n\\n I\'m not sure I fully understand this question. First it sounded as if adding the extra restriction would prevent SYSCS_INPLACE_COMPRESS_TABLE from raising SelfDeadlock. But the question seems to imply that adding the extra restriction will make it start raising SelfDeadlock rather than lock timeout in some cases. Exactly what does adding the extra restriction fix, and what behaviour change does it introduce? \\n\\n I think it is ok that SYSCS_INPLACE_COMPRESS_TABLE raises a lock timeout in this case (which it currently does?), since the reference manual says \\\"Tip: We recommend that you issue the SYSCS_UTIL.SYSCS_INPLACE_COMPRESS_TABLE system procedure in auto-commit mode.\\\" Presumably that tip was added because of this issue.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13992014\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13992014&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13992014\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13992014_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13992014_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/May\\/14 17:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-07T17:15:27+0000\'\u003e07\\/May\\/14 17:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks for helping me think through these issues, Knut. Attaching derby-6554-02-ae-selfDeadlock_sps_compress.diff. This patch adds some more logic to catch SelfDeadlock in more nested transaction contexts and treat it like a LOCK_TIMEOUT.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe only situation where SelfDeadlock should not be treated like LOCK_TIMEOUT is the sequence generator case.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis patch makes the compilation of stored prepared statements (triggers) treat SelfDeadlock like LOCK_TIMEOUT. This patch also makes table compression treat SelfDeadlock like LOCK_TIMEOUT.\u003c\\/p\u003e\\n\\n\u003cp\u003eAt this point, we are back to the situation where table compression raises LOCK_TIMEOUT again so the user experience should be backward compatible.\u003c\\/p\u003e\\n\\n\u003cp\u003eThanks,\u003cbr\\/\u003e\\n-Rick\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13992014_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13992014_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/May\\/14 17:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-07T17:15:27+0000\'\u003e07\\/May\\/14 17:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks for helping me think through these issues, Knut. Attaching derby-6554-02-ae-selfDeadlock_sps_compress.diff. This patch adds some more logic to catch SelfDeadlock in more nested transaction contexts and treat it like a LOCK_TIMEOUT. \\n\\n The only situation where SelfDeadlock should not be treated like LOCK_TIMEOUT is the sequence generator case. \\n\\n This patch makes the compilation of stored prepared statements (triggers) treat SelfDeadlock like LOCK_TIMEOUT. This patch also makes table compression treat SelfDeadlock like LOCK_TIMEOUT. \\n\\n At this point, we are back to the situation where table compression raises LOCK_TIMEOUT again so the user experience should be backward compatible. \\n\\n Thanks, \\n-Rick              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13992138\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13992138&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13992138\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13992138_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13992138_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/May\\/14 19:23\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-07T19:23:37+0000\'\u003e07\\/May\\/14 19:23\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eTests passed cleanly for me on derby-6554-02-ae-selfDeadlock_sps_compress.diff. I would like to describe this patch in greater detail so that we can reason about whether this solution is adequate or needs more work.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe bulk of the patch consists of a change to the lock manager to detect SelfDeadlock situations. The SelfDeadlock situation is as described above:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) Must be a nested sub-transaction which is requesting the lock.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) The lock must be blocked by some other lock held by the parent transaction.\u003c\\/p\u003e\\n\\n\u003cp\u003e3) The nested sub-transaction must have specified a lock timeout of 0.\u003c\\/p\u003e\\n\\n\u003cp\u003eSequenceUpdater has been changed so that it escalates locks into the parent transaction when it catches a SelfDeadlock.\u003c\\/p\u003e\\n\\n\u003cp\u003eInsertResultSet and SPSDescriptor have been changed so that they treat SelfDeadlock the same way that they treat LockTimeout.\u003c\\/p\u003e\\n\\n\u003cp\u003eHeapController.lockRowAtSlotNoWaitExclusive() has also been changed so that it treats SelfDeadlock just like LockTimeout. However, I would like the experts to evaluate whether that code is ok. It involves catching an exception in a situation which didn\'t previously involve exceptions. Exception processing is expensive. That may be ok if we can convince ourselves that SelfDeadlock will only be thrown in edge case situations. But if it is an ordinary situation on the main execution path, then we need a better solution. For the record, this situation arises when you run OnlineCompressTest. Here is the code:\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"preformatted panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"preformattedContent panelContent\\\"\u003e\\n\u003cpre\u003e    protected boolean lockRowAtSlotNoWaitExclusive(RecordHandle rh)\\n        throws StandardException\\n    {\\n        try {\\n            return(\\n                   open_conglom.getContainer().getLockingPolicy().\\n                   lockRecordForWrite\\n                   ( open_conglom.getRawTran(), rh, false, false) );\\n        }\\n        catch (StandardException se)\\n        {\\n            if ( se.isSelfDeadlock() ) { return false; }\\n            else { throw se; }\\n        }\\n    }\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003eI don\'t feel I\'m competent to evaluate whether this situation will arise on the main execution path. I would like advice from the experts.\u003c\\/p\u003e\\n\\n\u003cp\u003eThanks,\u003cbr\\/\u003e\\n-Rick\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13992138_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13992138_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/May\\/14 19:23\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-07T19:23:37+0000\'\u003e07\\/May\\/14 19:23\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Tests passed cleanly for me on derby-6554-02-ae-selfDeadlock_sps_compress.diff. I would like to describe this patch in greater detail so that we can reason about whether this solution is adequate or needs more work. \\n\\n The bulk of the patch consists of a change to the lock manager to detect SelfDeadlock situations. The SelfDeadlock situation is as described above: \\n\\n 1) Must be a nested sub-transaction which is requesting the lock. \\n\\n 2) The lock must be blocked by some other lock held by the parent transaction. \\n\\n 3) The nested sub-transaction must have specified a lock timeout of 0. \\n\\n SequenceUpdater has been changed so that it escalates locks into the parent transaction when it catches a SelfDeadlock. \\n\\n InsertResultSet and SPSDescriptor have been changed so that they treat SelfDeadlock the same way that they treat LockTimeout. \\n\\n HeapController.lockRowAtSlotNoWaitExclusive() has also been changed so that it treats SelfDeadlock just like LockTimeout. However, I would like the experts to evaluate whether that code is ok. It involves catching an exception in a situation which didn\'t previously involve exceptions. Exception processing is expensive. That may be ok if we can convince ourselves that SelfDeadlock will only be thrown in edge case situations. But if it is an ordinary situation on the main execution path, then we need a better solution. For the record, this situation arises when you run OnlineCompressTest. Here is the code: \\n\\n  \\n     protected boolean lockRowAtSlotNoWaitExclusive(RecordHandle rh)\\n        throws StandardException\\n    {\\n        try {\\n            return(\\n                   open_conglom.getContainer().getLockingPolicy().\\n                   lockRecordForWrite\\n                   ( open_conglom.getRawTran(), rh, false, false) );\\n        }\\n        catch (StandardException se)\\n        {\\n            if ( se.isSelfDeadlock() ) { return false; }\\n            else { throw se; }\\n        }\\n    }\\n \\n  \\n\\n I don\'t feel I\'m competent to evaluate whether this situation will arise on the main execution path. I would like advice from the experts. \\n\\n Thanks, \\n-Rick              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13992206\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13992206&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13992206\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13992206_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13992206_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/May\\/14 20:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-07T20:45:08+0000\'\u003e07\\/May\\/14 20:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ecan you comment on why you decided to throw a new exception on self deadlock rather than just throw \u003cbr\\/\u003e\\ndeadlock?  Just throwing deadlock would solve the problem if it ever leaks out, and seems the right choice.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut, maybe you need the distinct error for a logic path.\u003c\\/p\u003e\\n\\n\u003cp\u003eIt is hard with java to guarantee that these exceptions which are meant to always be caught internally\u003cbr\\/\u003e\\nnever leak.  I think the only completely safe way is to create something different than a StandardException\u003cbr\\/\u003e\\nand then explicitly declare it - but my guess is that is going to be painful with such a low level routine\u003cbr\\/\u003e\\nthat is likely used by a lot of paths.\u003c\\/p\u003e\\n\\n\\n\\n\u003cp\u003e\\/mikem\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13992206_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13992206_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/May\\/14 20:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-07T20:45:08+0000\'\u003e07\\/May\\/14 20:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    can you comment on why you decided to throw a new exception on self deadlock rather than just throw  \\ndeadlock?  Just throwing deadlock would solve the problem if it ever leaks out, and seems the right choice. \\n\\n But, maybe you need the distinct error for a logic path. \\n\\n It is hard with java to guarantee that these exceptions which are meant to always be caught internally \\nnever leak.  I think the only completely safe way is to create something different than a StandardException \\nand then explicitly declare it - but my guess is that is going to be painful with such a low level routine \\nthat is likely used by a lot of paths. \\n\\n\\n\\n \\/mikem              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13992236\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13992236&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13992236\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13992236_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13992236_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/May\\/14 21:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-07T21:20:10+0000\'\u003e07\\/May\\/14 21:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eTrying to think about the compress self deadlock issue.  \u003c\\/p\u003e\\n\\n\u003cp\u003eo Before your change is a lock timeout ever raised in the case of 0 wait lock request?\u003c\\/p\u003e\\n\\n\u003cp\u003eo Do any of your changes require a self deadlock exception to be raised in the case of 0 wait lock request?\u003cbr\\/\u003e\\n   I with this new lock functionality that sequences will wait for some time for the lock now that self deadlock\u003cbr\\/\u003e\\n   will return immediately so won\'t be following the 0 wait lock request code path.\u003c\\/p\u003e\\n\\n\u003cp\u003eIf possible it would seem better not to raise an exception at all in this case where the request to lock\u003cbr\\/\u003e\\n manager asked not to wait at all. \u003c\\/p\u003e\\n\\n\u003cp\u003eThe lock manager javadoc does not seem difinitive in what to expect for 0 wait locks, but as you\u003cbr\\/\u003e\\nare seeing code seemed not to expect exceptions when specifying 0 wait locks.  Whatever we decide\u003cbr\\/\u003e\\nit would be good to beef up the javadoc to say what should be expected.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13992236_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13992236_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/May\\/14 21:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-07T21:20:10+0000\'\u003e07\\/May\\/14 21:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Trying to think about the compress self deadlock issue.   \\n\\n o Before your change is a lock timeout ever raised in the case of 0 wait lock request? \\n\\n o Do any of your changes require a self deadlock exception to be raised in the case of 0 wait lock request? \\n   I with this new lock functionality that sequences will wait for some time for the lock now that self deadlock \\n   will return immediately so won\'t be following the 0 wait lock request code path. \\n\\n If possible it would seem better not to raise an exception at all in this case where the request to lock \\n manager asked not to wait at all.  \\n\\n The lock manager javadoc does not seem difinitive in what to expect for 0 wait locks, but as you \\nare seeing code seemed not to expect exceptions when specifying 0 wait locks.  Whatever we decide \\nit would be good to beef up the javadoc to say what should be expected.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13992297\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13992297&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13992297\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13992297_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13992297_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/May\\/14 22:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-07T22:16:28+0000\'\u003e07\\/May\\/14 22:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eDoes the following work\\/make sense:\u003c\\/p\u003e\\n\\n\u003cp\u003eChange lock manger to continue to return no exception if lock can not be granted if lock is 0 wait.  Hopefully\u003cbr\\/\u003e\\nthis would then limit impact on other parts of the code until they can be changed to take advantage of the\u003cbr\\/\u003e\\nnew functionality.\u003c\\/p\u003e\\n\\n\u003cp\u003eChange lock manger to always check for self deadlock (if it has the available fields to check), if a \u003cbr\\/\u003e\\nnon-0 wait lock can not be granted, and throw exception if it is a self deadlock.  \u003c\\/p\u003e\\n\\n\u003cp\u003eChange DataDictionaryImpl.java!updateCurrentSequenceValue to always wait for the lock, knowing that\u003cbr\\/\u003e\\nit will be a 0 wait if it is a self deadlock, and then change caller to catch and retry on appropriate exception\u003cbr\\/\u003e\\nthrown.  Not many comments in this routine, but I think all the wait inputs and complication was to take\u003cbr\\/\u003e\\ncare of the problem being solved by doing self deadlock detection.  So maybe both caller and this code\u003cbr\\/\u003e\\ncan be simplified by always waiting.  Not sure how much to wait - either user set wait, or internal hard\u003cbr\\/\u003e\\ncoded, or some combination of both - for instance may want to wait some in internal transaction even if\u003cbr\\/\u003e\\nuser has specified 0 wait for user locks.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13992297_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13992297_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/May\\/14 22:16\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-07T22:16:28+0000\'\u003e07\\/May\\/14 22:16\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Does the following work\\/make sense: \\n\\n Change lock manger to continue to return no exception if lock can not be granted if lock is 0 wait.  Hopefully \\nthis would then limit impact on other parts of the code until they can be changed to take advantage of the \\nnew functionality. \\n\\n Change lock manger to always check for self deadlock (if it has the available fields to check), if a  \\nnon-0 wait lock can not be granted, and throw exception if it is a self deadlock.   \\n\\n Change DataDictionaryImpl.java!updateCurrentSequenceValue to always wait for the lock, knowing that \\nit will be a 0 wait if it is a self deadlock, and then change caller to catch and retry on appropriate exception \\nthrown.  Not many comments in this routine, but I think all the wait inputs and complication was to take \\ncare of the problem being solved by doing self deadlock detection.  So maybe both caller and this code \\ncan be simplified by always waiting.  Not sure how much to wait - either user set wait, or internal hard \\ncoded, or some combination of both - for instance may want to wait some in internal transaction even if \\nuser has specified 0 wait for user locks. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13992840\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13992840&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13992840\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13992840_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13992840_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/May\\/14 15:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-08T15:22:03+0000\'\u003e08\\/May\\/14 15:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi Mike,\u003c\\/p\u003e\\n\\n\u003cp\u003eSome responses to your comments:\u003c\\/p\u003e\\n\\n\u003cp\u003eMM&gt; can you comment on why you decided to throw a new exception on self deadlock rather than just throw \u003cbr\\/\u003e\\nMM&gt; deadlock? Just throwing deadlock would solve the problem if it ever leaks out, and seems the right choice.\u003cbr\\/\u003e\\nMM&gt; \u003cbr\\/\u003e\\nMM&gt; But, maybe you need the distinct error for a logic path.\u003c\\/p\u003e\\n\\n\u003cp\u003eYes, that is the problem. SequenceUpdater needs to distinguish a SelfDeadlock from an ordinary Deadlock.\u003c\\/p\u003e\\n\\n\u003cp\u003eMM&gt; \u003cbr\\/\u003e\\nMM&gt; It is hard with java to guarantee that these exceptions which are meant to always be caught internally\u003cbr\\/\u003e\\nMM&gt; never leak. I think the only completely safe way is to create something different than a StandardException\u003cbr\\/\u003e\\nMM&gt; and then explicitly declare it - but my guess is that is going to be painful with such a low level routine\u003cbr\\/\u003e\\nMM&gt; that is likely used by a lot of paths.\u003c\\/p\u003e\\n\\n\u003cp\u003eI can create a SelfDeadlock subtype of StandardException. StandardException already has a few subtypes. But that won\'t address the performance question.\u003c\\/p\u003e\\n\\n\u003cp\u003eMM&gt; Trying to think about the compress self deadlock issue.\u003cbr\\/\u003e\\nMM&gt; \u003cbr\\/\u003e\\nMM&gt; o Before your change is a lock timeout ever raised in the case of 0 wait lock request?\u003cbr\\/\u003e\\nMM&gt; \u003c\\/p\u003e\\n\\n\u003cp\u003eI don\'t think so. It appears to me that ConcurrentLockSet.lockObject() returns null if you can\'t get a lock immediately and (AbstractPool.noLockWait(timeout, compatibilitySpace) == true). But I don\'t understand what condition sets up the special \\\"else\\\" case in AbstractPool.noLockWait():\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"preformatted panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"preformattedContent panelContent\\\"\u003e\\n\u003cpre\u003e    static boolean noLockWait(int timeout, CompatibilitySpace compat) {\\n        if (timeout == C_LockFactory.NO_WAIT) {\\n            return true;\\n        } else {\\n            LockOwner owner = compat.getOwner();\\n            return owner != null &amp;&amp; owner.noWait();\\n        }\\n    }\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003eMM&gt; o Do any of your changes require a self deadlock exception to be raised in the case of 0 wait lock request?\u003cbr\\/\u003e\\nMM&gt; \u003c\\/p\u003e\\n\\n\u003cp\u003eThe requirement is that SequenceUpdater have a way to figure out that SelfDeadlock happened. That is, that it was blocked by its own (parent transaction) lock rather than by a lock held by another Connection. There are a lot of code layers between SequenceUpdater and ConcurrentLockSet. There may be some way to signal SelfDeadlock without raising an exception. This would involve changes to the ConglomerateController interface and maybe some other interfaces.\u003c\\/p\u003e\\n\\n\u003cp\u003eMM&gt; I with this new lock functionality that sequences will wait for some time for the lock now that self deadlock\u003cbr\\/\u003e\\nMM&gt; will return immediately so won\'t be following the 0 wait lock request code path.\u003cbr\\/\u003e\\nMM&gt; \u003cbr\\/\u003e\\nMM&gt; If possible it would seem better not to raise an exception at all in this case where the request to lock\u003cbr\\/\u003e\\nMM&gt; manager asked not to wait at all.\u003c\\/p\u003e\\n\\n\u003cp\u003eAgreed.\u003c\\/p\u003e\\n\\n\u003cp\u003eMM&gt; Does the following work\\/make sense:\u003cbr\\/\u003e\\nMM&gt; \u003cbr\\/\u003e\\nMM&gt; Change lock manger to continue to return no exception if lock can not be granted if lock is 0 wait. Hopefully\u003cbr\\/\u003e\\nMM&gt; this would then limit impact on other parts of the code until they can be changed to take advantage of the\u003cbr\\/\u003e\\nMM&gt; new functionality.\u003cbr\\/\u003e\\nMM&gt; \u003cbr\\/\u003e\\nMM&gt; Change lock manger to always check for self deadlock (if it has the available fields to check), if a \u003cbr\\/\u003e\\nMM&gt; non-0 wait lock can not be granted, and throw exception if it is a self deadlock.\u003cbr\\/\u003e\\nMM&gt; \u003cbr\\/\u003e\\nMM&gt; Change DataDictionaryImpl.java!updateCurrentSequenceValue to always wait for the lock, knowing that\u003cbr\\/\u003e\\nMM&gt; it will be a 0 wait if it is a self deadlock, and then change caller to catch and retry on appropriate exception\u003cbr\\/\u003e\\nMM&gt; thrown. Not many comments in this routine, but I think all the wait inputs and complication was to take\u003cbr\\/\u003e\\nMM&gt; care of the problem being solved by doing self deadlock detection. So maybe both caller and this code\u003cbr\\/\u003e\\nMM&gt; can be simplified by always waiting. Not sure how much to wait - either user set wait, or internal hard\u003cbr\\/\u003e\\nMM&gt; coded, or some combination of both - for instance may want to wait some in internal transaction even if\u003cbr\\/\u003e\\nMM&gt; user has specified 0 wait for user locks\u003c\\/p\u003e\\n\\n\u003cp\u003eNot sure I follow. I think what you are suggesting is the following:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) Have SequenceUpdater wait for the smallest non-zero timeout, 1 millisecond. The smaller the timeout the better. We want to prevent threads from piling up like a train wreck behind a request to allocate a new range of sequence values.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) Only raise SelfDeadlock if the timeout is non-zero.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think I would like to try another solution first:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) Currently, all negative values of derby.locks.waitTimeout are collapsed into a single meaning: WaitForever. We can give Integer.MIN_VALUE a special meaning: DontWaitButRaiseSelfDeadlockOnFailure\u003c\\/p\u003e\\n\\n\u003cp\u003e2) The lock manager will raise SelfDeadlock only if the timeout value is DontWaitButRaiseSelfDeadlockOnFailure.\u003c\\/p\u003e\\n\\n\u003cp\u003e3) At least initially, SequenceUpdater will be the only caller who requests a lock with a timeout of DontWaitButRaiseSelfDeadlockOnFailure.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13992840_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13992840_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/May\\/14 15:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-08T15:22:03+0000\'\u003e08\\/May\\/14 15:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hi Mike, \\n\\n Some responses to your comments: \\n\\n MM&gt; can you comment on why you decided to throw a new exception on self deadlock rather than just throw  \\nMM&gt; deadlock? Just throwing deadlock would solve the problem if it ever leaks out, and seems the right choice. \\nMM&gt;  \\nMM&gt; But, maybe you need the distinct error for a logic path. \\n\\n Yes, that is the problem. SequenceUpdater needs to distinguish a SelfDeadlock from an ordinary Deadlock. \\n\\n MM&gt;  \\nMM&gt; It is hard with java to guarantee that these exceptions which are meant to always be caught internally \\nMM&gt; never leak. I think the only completely safe way is to create something different than a StandardException \\nMM&gt; and then explicitly declare it - but my guess is that is going to be painful with such a low level routine \\nMM&gt; that is likely used by a lot of paths. \\n\\n I can create a SelfDeadlock subtype of StandardException. StandardException already has a few subtypes. But that won\'t address the performance question. \\n\\n MM&gt; Trying to think about the compress self deadlock issue. \\nMM&gt;  \\nMM&gt; o Before your change is a lock timeout ever raised in the case of 0 wait lock request? \\nMM&gt;  \\n\\n I don\'t think so. It appears to me that ConcurrentLockSet.lockObject() returns null if you can\'t get a lock immediately and (AbstractPool.noLockWait(timeout, compatibilitySpace) == true). But I don\'t understand what condition sets up the special \\\"else\\\" case in AbstractPool.noLockWait(): \\n\\n  \\n     static boolean noLockWait(int timeout, CompatibilitySpace compat) {\\n        if (timeout == C_LockFactory.NO_WAIT) {\\n            return true;\\n        } else {\\n            LockOwner owner = compat.getOwner();\\n            return owner != null &amp;&amp; owner.noWait();\\n        }\\n    }\\n \\n  \\n\\n MM&gt; o Do any of your changes require a self deadlock exception to be raised in the case of 0 wait lock request? \\nMM&gt;  \\n\\n The requirement is that SequenceUpdater have a way to figure out that SelfDeadlock happened. That is, that it was blocked by its own (parent transaction) lock rather than by a lock held by another Connection. There are a lot of code layers between SequenceUpdater and ConcurrentLockSet. There may be some way to signal SelfDeadlock without raising an exception. This would involve changes to the ConglomerateController interface and maybe some other interfaces. \\n\\n MM&gt; I with this new lock functionality that sequences will wait for some time for the lock now that self deadlock \\nMM&gt; will return immediately so won\'t be following the 0 wait lock request code path. \\nMM&gt;  \\nMM&gt; If possible it would seem better not to raise an exception at all in this case where the request to lock \\nMM&gt; manager asked not to wait at all. \\n\\n Agreed. \\n\\n MM&gt; Does the following work\\/make sense: \\nMM&gt;  \\nMM&gt; Change lock manger to continue to return no exception if lock can not be granted if lock is 0 wait. Hopefully \\nMM&gt; this would then limit impact on other parts of the code until they can be changed to take advantage of the \\nMM&gt; new functionality. \\nMM&gt;  \\nMM&gt; Change lock manger to always check for self deadlock (if it has the available fields to check), if a  \\nMM&gt; non-0 wait lock can not be granted, and throw exception if it is a self deadlock. \\nMM&gt;  \\nMM&gt; Change DataDictionaryImpl.java!updateCurrentSequenceValue to always wait for the lock, knowing that \\nMM&gt; it will be a 0 wait if it is a self deadlock, and then change caller to catch and retry on appropriate exception \\nMM&gt; thrown. Not many comments in this routine, but I think all the wait inputs and complication was to take \\nMM&gt; care of the problem being solved by doing self deadlock detection. So maybe both caller and this code \\nMM&gt; can be simplified by always waiting. Not sure how much to wait - either user set wait, or internal hard \\nMM&gt; coded, or some combination of both - for instance may want to wait some in internal transaction even if \\nMM&gt; user has specified 0 wait for user locks \\n\\n Not sure I follow. I think what you are suggesting is the following: \\n\\n 1) Have SequenceUpdater wait for the smallest non-zero timeout, 1 millisecond. The smaller the timeout the better. We want to prevent threads from piling up like a train wreck behind a request to allocate a new range of sequence values. \\n\\n 2) Only raise SelfDeadlock if the timeout is non-zero. \\n\\n I think I would like to try another solution first: \\n\\n 1) Currently, all negative values of derby.locks.waitTimeout are collapsed into a single meaning: WaitForever. We can give Integer.MIN_VALUE a special meaning: DontWaitButRaiseSelfDeadlockOnFailure \\n\\n 2) The lock manager will raise SelfDeadlock only if the timeout value is DontWaitButRaiseSelfDeadlockOnFailure. \\n\\n 3) At least initially, SequenceUpdater will be the only caller who requests a lock with a timeout of DontWaitButRaiseSelfDeadlockOnFailure.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13992897\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13992897&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13992897\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13992897_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13992897_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/May\\/14 16:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-08T16:29:04+0000\'\u003e08\\/May\\/14 16:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI am not seeing email from apache right now, will continue talking here.\u003c\\/p\u003e\\n\\n\u003cp\u003eI have no problem with raising the exception, and am not seeing why we need to have special cases\u003cbr\\/\u003e\\nwhen we raise self deadlock.  I am not understanding why it is good to not wait in the subtransaction\u003cbr\\/\u003e\\nif we know we are waiting for another thread to allocated the sequence.\u003c\\/p\u003e\\n\\n\u003cp\u003eI am just not understanding the \\\"backing\\\" up problem.  I assumed that we would want to eliminate the\u003cbr\\/\u003e\\ntoo much contention error by now waiting some reasonable amount of time (not minimum) in the nested\u003cbr\\/\u003e\\ntransaction if we knew for sure it was not a self deadlock.  I assume if nested transaction can\'t get lock,\u003cbr\\/\u003e\\nand we know it is not self deadlock there is no work that thread can do at that point.  So the options are:\u003cbr\\/\u003e\\n1) throw an error and fail the insert immediately\u003cbr\\/\u003e\\n2) wait for whatever thread is doing the update to finish and then proceed\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13992897_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13992897_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/May\\/14 16:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-08T16:29:04+0000\'\u003e08\\/May\\/14 16:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I am not seeing email from apache right now, will continue talking here. \\n\\n I have no problem with raising the exception, and am not seeing why we need to have special cases \\nwhen we raise self deadlock.  I am not understanding why it is good to not wait in the subtransaction \\nif we know we are waiting for another thread to allocated the sequence. \\n\\n I am just not understanding the \\\"backing\\\" up problem.  I assumed that we would want to eliminate the \\ntoo much contention error by now waiting some reasonable amount of time (not minimum) in the nested \\ntransaction if we knew for sure it was not a self deadlock.  I assume if nested transaction can\'t get lock, \\nand we know it is not self deadlock there is no work that thread can do at that point.  So the options are: \\n1) throw an error and fail the insert immediately \\n2) wait for whatever thread is doing the update to finish and then proceed              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13992909\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13992909&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13992909\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13992909_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13992909_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/May\\/14 16:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-08T16:44:08+0000\'\u003e08\\/May\\/14 16:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eif you feel strongly it is important to not wait at all in the subtransaction for sequences, i don\'t think it is worth the effort to special case as you are suggesting.  In that case I see why you need the exception, and I will just revisit\u003cbr\\/\u003e\\nthoughts on what to do for self deadlock on 0 wait scenario.    Would rather not see more complication\u003cbr\\/\u003e\\nin the lock manager for this as you are suggesting.  Better to just teach the rest of the code to expect an\u003cbr\\/\u003e\\nexception on self deadlock.  \u003c\\/p\u003e\\n\\n\u003cp\u003eI still think we should throw self deadlock in the wait case no matter what.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13992909_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13992909_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/May\\/14 16:44\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-08T16:44:08+0000\'\u003e08\\/May\\/14 16:44\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    if you feel strongly it is important to not wait at all in the subtransaction for sequences, i don\'t think it is worth the effort to special case as you are suggesting.  In that case I see why you need the exception, and I will just revisit \\nthoughts on what to do for self deadlock on 0 wait scenario.    Would rather not see more complication \\nin the lock manager for this as you are suggesting.  Better to just teach the rest of the code to expect an \\nexception on self deadlock.   \\n\\n I still think we should throw self deadlock in the wait case no matter what.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13993593\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13993593&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13993593\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13993593_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13993593_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/May\\/14 14:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-09T14:20:05+0000\'\u003e09\\/May\\/14 14:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eNone of us are getting Apache email right now, so I missed your latest comments, too. I am attaching a new rev of the patch. You can evaluate whether you think this version is better or worse than the previous rev.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe new rev adds an extra argument to lockObject() so that callers can request how they want SelfDeadlock to be handled:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) Callers can ask that a SelfDeadlock exception be thrown. This option is useful when callers need to distinguish the SelfDeadlock situation from other situations in which a nested subtransaction can\'t get a lock immediately.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) Callers can ask for the existing behavior prior to the work on this issue. That is, lockObject() returns null if a lock can\'t be grabbed immediately and does not distinguish between SelfDeadlock and being blocked by another Connection\'s work.\u003c\\/p\u003e\\n\\n\u003cp\u003eAttaching derby-6554-02-af-askToRaiseSelfDeadlock.diff. I am running tests.\u003c\\/p\u003e\\n\\n\u003cp\u003eIt became clear from the previous revs of this patch that there are many places where Derby attempts to do work in a nested sub-transa tion, hoping to get a lock immediately. The new code affected too many old code paths. And by the time we got to lockObject(), there was not enough context in the call arguments to let us isolate the SequenceUpdater case. \u003c\\/p\u003e\\n\\n\u003cp\u003eSo I am experimenting with a solution in which the caller has to explicitly request a SelfDeadlock exception when a nested subtransaction is blocked by its parent and it can\'t grab a lock immediately.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis new patch adds a new argument to LockFactory.lockObject(): raiseSelfDeadlock. When this argument is set to true, lockObject() raises a SelfDeadlock exception. Otherwise, lockObject() behaves the way it did before this patch. The only code path which sets raiseSelfDeadlock is the code path starting with SequenceUpdater.\u003c\\/p\u003e\\n\\n\u003cp\u003eThere are 3 parts to this patch:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) Adding more state to transactions so that we can detect the self-deadlock between a nested subtransaction and its parent. This logic was in the previous revs of the patch.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) Adding the new raiseSelfDeadlock argument to LockFactory.lockObject(). These changes are new to this patch.\u003c\\/p\u003e\\n\\n\u003cp\u003e3) Adjusting SequenceUpdater so that it escalates locks into the parent transaction when it detects a SelfDeadlock.\u003c\\/p\u003e\\n\\n\u003cp\u003eTouches the following files:\u003c\\/p\u003e\\n\\n\u003cp\u003e---------------------\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/services\\/locks\\/LockOwner.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/error\\/StandardException.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/store\\/raw\\/xact\\/TransactionFactory.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/store\\/raw\\/RawStoreFactory.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/services\\/reflect\\/UpdateLoader.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/services\\/locks\\/ConcurrentLockSet.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/services\\/locks\\/LockControl.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/access\\/RAMTransaction.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/Xact.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/XactFactory.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/InternalXact.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/RawStore.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/loc\\/messages.xml\u003cbr\\/\u003e\\nM       java\\/shared\\/org\\/apache\\/derby\\/shared\\/common\\/reference\\/SQLState.java\u003c\\/p\u003e\\n\\n\u003cp\u003eChanges for 1). Machinery to detect a self-deadlock between a subtransaction and its parent transaction. These changes were in the previous rev of the patch.\u003c\\/p\u003e\\n\\n\u003cp\u003e---------------------\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/services\\/locks\\/LockFactory.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/services\\/locks\\/LockTable.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/services\\/locks\\/AbstractPool.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/access\\/PropertyConglomerate.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/store\\/raw\\/LockingPolicy.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/RowLocking2.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/RowLocking3.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/ContainerLocking2.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/ContainerLocking3.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/NoLocking.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/store\\/access\\/ConglomerateController.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/access\\/conglomerate\\/GenericConglomerateController.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/access\\/conglomerate\\/OpenConglomerate.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/access\\/conglomerate\\/GenericScanController.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/access\\/btree\\/BTreeController.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/access\\/heap\\/HeapController.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/data\\/BasePage.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/data\\/BaseContainer.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/data\\/ReclaimSpaceHelper.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/data\\/LogicalPageOperation.java\u003cbr\\/\u003e\\nM       java\\/testing\\/org\\/apache\\/derbyTesting\\/unitTests\\/services\\/T_User.java\u003cbr\\/\u003e\\nM       java\\/testing\\/org\\/apache\\/derbyTesting\\/unitTests\\/services\\/T_LockFactory.java\u003cbr\\/\u003e\\nM       java\\/testing\\/org\\/apache\\/derbyTesting\\/unitTests\\/store\\/T_AccessFactory.java\u003cbr\\/\u003e\\nM       java\\/testing\\/org\\/apache\\/derbyTesting\\/unitTests\\/store\\/T_RawStoreFactory.java\u003c\\/p\u003e\\n\\n\u003cp\u003eChanges for 2). New raiseSelfDeadlock argument for lockObject(). This includes changes to the conglomerate interfaces so that raiseSelfDeadlock behavior can be requested when opening conglomerates and fetching rows. These changes are new to this patch.\u003c\\/p\u003e\\n\\n\u003cp\u003e---------------------\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/sql\\/catalog\\/DataDictionaryImpl.java\u003cbr\\/\u003e\\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/sql\\/catalog\\/SequenceUpdater.java\u003c\\/p\u003e\\n\\n\u003cp\u003eRequest raiseSelfDeadlock behavior when updating rows in SYS.SYSSEQUENCES. The DataDictionaryImpl change is what\'s new to this patch.\u003c\\/p\u003e\\n\\n\u003cp\u003e---------------------\u003c\\/p\u003e\\n\\n\u003cp\u003eM       java\\/testing\\/org\\/apache\\/derbyTesting\\/functionTests\\/tests\\/lang\\/SequenceTest.java\u003c\\/p\u003e\\n\\n\u003cp\u003eTest the fix to this bug. This test case was in the previous rev of the patch.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13993593_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13993593_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/May\\/14 14:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-09T14:20:05+0000\'\u003e09\\/May\\/14 14:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    None of us are getting Apache email right now, so I missed your latest comments, too. I am attaching a new rev of the patch. You can evaluate whether you think this version is better or worse than the previous rev. \\n\\n The new rev adds an extra argument to lockObject() so that callers can request how they want SelfDeadlock to be handled: \\n\\n 1) Callers can ask that a SelfDeadlock exception be thrown. This option is useful when callers need to distinguish the SelfDeadlock situation from other situations in which a nested subtransaction can\'t get a lock immediately. \\n\\n 2) Callers can ask for the existing behavior prior to the work on this issue. That is, lockObject() returns null if a lock can\'t be grabbed immediately and does not distinguish between SelfDeadlock and being blocked by another Connection\'s work. \\n\\n Attaching derby-6554-02-af-askToRaiseSelfDeadlock.diff. I am running tests. \\n\\n It became clear from the previous revs of this patch that there are many places where Derby attempts to do work in a nested sub-transa tion, hoping to get a lock immediately. The new code affected too many old code paths. And by the time we got to lockObject(), there was not enough context in the call arguments to let us isolate the SequenceUpdater case.  \\n\\n So I am experimenting with a solution in which the caller has to explicitly request a SelfDeadlock exception when a nested subtransaction is blocked by its parent and it can\'t grab a lock immediately. \\n\\n This new patch adds a new argument to LockFactory.lockObject(): raiseSelfDeadlock. When this argument is set to true, lockObject() raises a SelfDeadlock exception. Otherwise, lockObject() behaves the way it did before this patch. The only code path which sets raiseSelfDeadlock is the code path starting with SequenceUpdater. \\n\\n There are 3 parts to this patch: \\n\\n 1) Adding more state to transactions so that we can detect the self-deadlock between a nested subtransaction and its parent. This logic was in the previous revs of the patch. \\n\\n 2) Adding the new raiseSelfDeadlock argument to LockFactory.lockObject(). These changes are new to this patch. \\n\\n 3) Adjusting SequenceUpdater so that it escalates locks into the parent transaction when it detects a SelfDeadlock. \\n\\n Touches the following files: \\n\\n --------------------- \\n\\n M       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/services\\/locks\\/LockOwner.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/error\\/StandardException.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/store\\/raw\\/xact\\/TransactionFactory.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/store\\/raw\\/RawStoreFactory.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/services\\/reflect\\/UpdateLoader.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/services\\/locks\\/ConcurrentLockSet.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/services\\/locks\\/LockControl.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/access\\/RAMTransaction.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/Xact.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/XactFactory.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/InternalXact.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/RawStore.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/loc\\/messages.xml \\nM       java\\/shared\\/org\\/apache\\/derby\\/shared\\/common\\/reference\\/SQLState.java \\n\\n Changes for 1). Machinery to detect a self-deadlock between a subtransaction and its parent transaction. These changes were in the previous rev of the patch. \\n\\n --------------------- \\n\\n M       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/services\\/locks\\/LockFactory.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/services\\/locks\\/LockTable.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/services\\/locks\\/AbstractPool.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/access\\/PropertyConglomerate.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/store\\/raw\\/LockingPolicy.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/RowLocking2.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/RowLocking3.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/ContainerLocking2.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/ContainerLocking3.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/xact\\/NoLocking.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/iapi\\/store\\/access\\/ConglomerateController.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/access\\/conglomerate\\/GenericConglomerateController.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/access\\/conglomerate\\/OpenConglomerate.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/access\\/conglomerate\\/GenericScanController.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/access\\/btree\\/BTreeController.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/access\\/heap\\/HeapController.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/data\\/BasePage.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/data\\/BaseContainer.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/data\\/ReclaimSpaceHelper.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/store\\/raw\\/data\\/LogicalPageOperation.java \\nM       java\\/testing\\/org\\/apache\\/derbyTesting\\/unitTests\\/services\\/T_User.java \\nM       java\\/testing\\/org\\/apache\\/derbyTesting\\/unitTests\\/services\\/T_LockFactory.java \\nM       java\\/testing\\/org\\/apache\\/derbyTesting\\/unitTests\\/store\\/T_AccessFactory.java \\nM       java\\/testing\\/org\\/apache\\/derbyTesting\\/unitTests\\/store\\/T_RawStoreFactory.java \\n\\n Changes for 2). New raiseSelfDeadlock argument for lockObject(). This includes changes to the conglomerate interfaces so that raiseSelfDeadlock behavior can be requested when opening conglomerates and fetching rows. These changes are new to this patch. \\n\\n --------------------- \\n\\n M       java\\/engine\\/org\\/apache\\/derby\\/impl\\/sql\\/catalog\\/DataDictionaryImpl.java \\nM       java\\/engine\\/org\\/apache\\/derby\\/impl\\/sql\\/catalog\\/SequenceUpdater.java \\n\\n Request raiseSelfDeadlock behavior when updating rows in SYS.SYSSEQUENCES. The DataDictionaryImpl change is what\'s new to this patch. \\n\\n --------------------- \\n\\n M       java\\/testing\\/org\\/apache\\/derbyTesting\\/functionTests\\/tests\\/lang\\/SequenceTest.java \\n\\n Test the fix to this bug. This test case was in the previous rev of the patch.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13993604\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13993604&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13993604\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13993604_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13993604_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/May\\/14 14:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-09T14:41:29+0000\'\u003e09\\/May\\/14 14:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIf tests pass cleanly on that last rev of the patch, we can choose which behavior is better:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) derby-6554-02-ae-selfDeadlock_sps_compress.diff - This rev of the patch raises a SelfDeadlock exception whenever a parent transaction is blocking a nested subtransaction and the subtransaction can\'t get a lock immediately.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) derby-6554-02-af-askToRaiseSelfDeadlock.diff - This rev of the patch lets the caller choose whether a SelfDeadlock exception should be thrown or whether lockObject() should just return null if it can\'t grab a lock immediately. The null return value does not distinguish SelfDeadlock from BlockedByAnotherConnection.\u003c\\/p\u003e\\n\\n\u003cp\u003eI think I understand your preference for the first solution. I can run an experiment with that patch to see what breaks if SelfDeadlock is raised when the caller is willing to wait. Having gotten to this point and seen how many parts of the code use nested subtransactions, I just want to raise a warning flag that this may break a lot of tests and create backward compatibility problems because SelfDeadlock will be thrown in cases where the user application is expecting LockTimeout. It may be better to pursue this improvement in a separate issue.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13993604_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13993604_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/May\\/14 14:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-09T14:41:29+0000\'\u003e09\\/May\\/14 14:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    If tests pass cleanly on that last rev of the patch, we can choose which behavior is better: \\n\\n 1) derby-6554-02-ae-selfDeadlock_sps_compress.diff - This rev of the patch raises a SelfDeadlock exception whenever a parent transaction is blocking a nested subtransaction and the subtransaction can\'t get a lock immediately. \\n\\n 2) derby-6554-02-af-askToRaiseSelfDeadlock.diff - This rev of the patch lets the caller choose whether a SelfDeadlock exception should be thrown or whether lockObject() should just return null if it can\'t grab a lock immediately. The null return value does not distinguish SelfDeadlock from BlockedByAnotherConnection. \\n\\n I think I understand your preference for the first solution. I can run an experiment with that patch to see what breaks if SelfDeadlock is raised when the caller is willing to wait. Having gotten to this point and seen how many parts of the code use nested subtransactions, I just want to raise a warning flag that this may break a lot of tests and create backward compatibility problems because SelfDeadlock will be thrown in cases where the user application is expecting LockTimeout. It may be better to pursue this improvement in a separate issue.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13993605\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13993605&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13993605\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13993605_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13993605_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/May\\/14 14:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-09T14:45:52+0000\'\u003e09\\/May\\/14 14:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eTests passed cleanly on derby-6554-02-af-askToRaiseSelfDeadlock.diff.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13993605_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13993605_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/May\\/14 14:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-09T14:45:52+0000\'\u003e09\\/May\\/14 14:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Tests passed cleanly on derby-6554-02-af-askToRaiseSelfDeadlock.diff.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13993655\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13993655&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13993655\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13993655_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13993655_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/May\\/14 15:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-09T15:57:34+0000\'\u003e09\\/May\\/14 15:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI do prefer an option where the lockmanger just picks the behavior and the calling code deals with it.  Would\u003cbr\\/\u003e\\nrather not add another knob to the lockmanager if we can help it.\u003c\\/p\u003e\\n\\n\u003cp\u003eMy preferred behavior would be:\u003cbr\\/\u003e\\no on 0 wait locks, continue to not throw exceptions even for self deadlocks.  This would mean changing\u003cbr\\/\u003e\\n   sequence subtransaction to wait for lock rather than 0 wait so that it can \\\"know\\\" that a self deadlock \u003cbr\\/\u003e\\n   has happened.\u003c\\/p\u003e\\n\\n\u003cp\u003eo on non-0 wait locks, always check for self deadlock when lock can\'t be granted immediately and we\u003cbr\\/\u003e\\n   have the info to check (which I believe will only be checked for subtransactions), and throw self \u003cbr\\/\u003e\\n   deadlock exception if appropriate.\u003c\\/p\u003e\\n\\n\u003cp\u003eHaving said that I would welcome a sequence checkin that got us partway, with a separate JIRA \u003cbr\\/\u003e\\nissue\\/work  to deal with possible fallout from always throwing self deadlock on wait.   Is there something \u003cbr\\/\u003e\\nyou can check in that passes tests (or maybe just  a few break that we can temp disable) without adding the lock interface change?  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13993655_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13993655_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/May\\/14 15:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-09T15:57:34+0000\'\u003e09\\/May\\/14 15:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I do prefer an option where the lockmanger just picks the behavior and the calling code deals with it.  Would \\nrather not add another knob to the lockmanager if we can help it. \\n\\n My preferred behavior would be: \\no on 0 wait locks, continue to not throw exceptions even for self deadlocks.  This would mean changing \\n   sequence subtransaction to wait for lock rather than 0 wait so that it can \\\"know\\\" that a self deadlock  \\n   has happened. \\n\\n o on non-0 wait locks, always check for self deadlock when lock can\'t be granted immediately and we \\n   have the info to check (which I believe will only be checked for subtransactions), and throw self  \\n   deadlock exception if appropriate. \\n\\n Having said that I would welcome a sequence checkin that got us partway, with a separate JIRA  \\nissue\\/work  to deal with possible fallout from always throwing self deadlock on wait.   Is there something  \\nyou can check in that passes tests (or maybe just  a few break that we can temp disable) without adding the lock interface change?                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13993663\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13993663&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13993663\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13993663_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13993663_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/May\\/14 16:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-09T16:15:59+0000\'\u003e09\\/May\\/14 16:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI still am worried I don\'t understand the problem with waiting on locks in the sequence sub transaction.   Can you describe your preferred behavior for the system when we run out of allocated range, transaction A\u003cbr\\/\u003e\\nget lock to allocate the range, and transaction B also needs one and I assume also tries to allocate the\u003cbr\\/\u003e\\nrange and will lock conflict with transaction A.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13993663_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13993663_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/May\\/14 16:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-09T16:15:59+0000\'\u003e09\\/May\\/14 16:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I still am worried I don\'t understand the problem with waiting on locks in the sequence sub transaction.   Can you describe your preferred behavior for the system when we run out of allocated range, transaction A \\nget lock to allocate the range, and transaction B also needs one and I assume also tries to allocate the \\nrange and will lock conflict with transaction A.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13993866\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13993866&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13993866\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13993866_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13993866_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/May\\/14 19:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-09T19:45:59+0000\'\u003e09\\/May\\/14 19:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching derby-6554-02-ag-raiseSelfDeadlockAlways.diff. This is a variation on derby-6554-02-ae-selfDeadlock_sps_compress.diff. This patch always raises a SelfDeadlock when one is detected, regardless of whether we\'re asked to wait. So this patch has the extra logic in HeapController.lockRowAtSlotNoWaitExclusive() which catches a SelfDeadlock and returns a null lock.\u003c\\/p\u003e\\n\\n\u003cp\u003eTests passed cleanly except for two errors:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) testDerby48SelfLockingRecoveryDeadlockDetectionOn() (in LazyDefaultSchemaCreationTest) now fails because an expected timeout isn\'t raised. The following script shows the problem. Without the patch, this script fails on a LOCK_TIMEOUT. With the patch, the script succeeds.\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"preformatted panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"preformattedContent panelContent\\\"\u003e\\n\u003cpre\u003econnect \'jdbc:derby:memory:db;create=true\';\\n\\ncall syscs_util.syscs_set_database_property( \'derby.locks.deadlockTrace\', \'true\' );\\ncall syscs_util.syscs_set_database_property( \'derby.locks.waitTimeout\', \'1\' );\\ncall syscs_util.syscs_set_database_property( \'derby.locks.deadlockTimeout\', \'2\' );\\n\\nconnect \'jdbc:derby:memory:db;user=foo\';\\n\\nautocommit off;\\n\\nset isolation serializable;\\n\\nselect count(*) from sys.sysschemas;\\n\\ncreate table t1(i int);\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003e2) The store unit tests had a failure in T_LockFactory. Not a lot of information in the failure report:\u003c\\/p\u003e\\n\\n\u003cdiv class=\\\"preformatted panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"preformattedContent panelContent\\\"\u003e\\n\u003cpre\u003e********* Diff file derbyall\\/storeall\\/storeunit\\/TLockFactory.diff\\n*** Start: TLockFactory jdk1.8.0 storeall:storeunit 2014-05-09 08:28:09 ***\\n2 del\\n&lt; -- Unit Test T_LockFactory finished\\n2 add\\n&gt; Shutting down due to unit test failure.\\nTest Failed.\\n*** End:   TLockFactory jdk1.8.0 storeall:storeunit 2014-05-09 08:28:10 ***\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\\n\\n\u003cp\u003eMike, at this point I don\'t exactly remember what breaks if we wait for locks in SequenceUpdater. That logic was arrived at painfully a couple years back. We can certainly try putting waits back in. Maybe everything will be fine. Or maybe we will painfully rediscover why we did it this way. One reason you don\'t want to wait is because this logic is called during cache eviction\\/flushing and during orderly database shutdown. If there are locks on SYSSEQUENCES, then cache eviction will stall, ddl will stall, and orderly shutdown will block. If the lock timeout is infinite, this would be very bad. We could try waiting for the minimum time, a millisecond. I suspect that will cause pile-ups, but I\'m not sure. It also involves a change to the existing apis which is as big as the change in patch derby-6554-02-af-askToRaiseSelfDeadlock.diff. That is because the current store interfaces don\'t let you pass a lock timeout override down the call stack when you open a conglomerate or fetch a row.\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'ll be away for a week. Someone else is welcome to play around with this while I\'m gone and check in one of the solutions if they feel confident. Here\'s a summary of the candidate patches:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) derby-6554-02-ae-selfDeadlock_sps_compress.diff\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003epasses the tests\u003c\\/li\u003e\\n\\t\u003cli\u003eraises a SelfDeadlock only if requested not to wait\u003c\\/li\u003e\\n\\t\u003cli\u003eforces HeapController.lockRowAtSlotNoWaitExclusive() to catch an exception\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e2) derby-6554-02-af-askToRaiseSelfDeadlock.diff\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003epasses the tests\u003c\\/li\u003e\\n\\t\u003cli\u003eSelfDeadlock is raised only if the caller asks for it\u003c\\/li\u003e\\n\\t\u003cli\u003eno change to HeapController.lockRowAtSlotNoWaitExclusive()\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e3) derby-6554-02-ag-raiseSelfDeadlockAlways.diff\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003efails 2 tests (see above)\u003c\\/li\u003e\\n\\t\u003cli\u003ealways raises SelfDeadlock, regardless of whether waiting was requested\u003c\\/li\u003e\\n\\t\u003cli\u003eforces HeapController.lockRowAtSlotNoWaitExclusive() to catch an exception\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eAll of these patches fix \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-6554\\\" title=\\\"Too much contention followed by assert failure when accessing sequence in transaction that created it\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-6554\\\"\u003e\u003cdel\u003eDERBY-6554\u003c\\/del\u003e\u003c\\/a\u003e. But I don\'t think that any of these patches fits your preferences. The first two at least pass the tests.\u003c\\/p\u003e\\n\\n\u003cp\u003eThanks for helping me think through these issues.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13993866_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13993866_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/May\\/14 19:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-09T19:45:59+0000\'\u003e09\\/May\\/14 19:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attaching derby-6554-02-ag-raiseSelfDeadlockAlways.diff. This is a variation on derby-6554-02-ae-selfDeadlock_sps_compress.diff. This patch always raises a SelfDeadlock when one is detected, regardless of whether we\'re asked to wait. So this patch has the extra logic in HeapController.lockRowAtSlotNoWaitExclusive() which catches a SelfDeadlock and returns a null lock. \\n\\n Tests passed cleanly except for two errors: \\n\\n 1) testDerby48SelfLockingRecoveryDeadlockDetectionOn() (in LazyDefaultSchemaCreationTest) now fails because an expected timeout isn\'t raised. The following script shows the problem. Without the patch, this script fails on a LOCK_TIMEOUT. With the patch, the script succeeds. \\n\\n  \\n connect \'jdbc:derby:memory:db;create=true\';\\n\\ncall syscs_util.syscs_set_database_property( \'derby.locks.deadlockTrace\', \'true\' );\\ncall syscs_util.syscs_set_database_property( \'derby.locks.waitTimeout\', \'1\' );\\ncall syscs_util.syscs_set_database_property( \'derby.locks.deadlockTimeout\', \'2\' );\\n\\nconnect \'jdbc:derby:memory:db;user=foo\';\\n\\nautocommit off;\\n\\nset isolation serializable;\\n\\nselect count(*) from sys.sysschemas;\\n\\ncreate table t1(i int);\\n \\n  \\n\\n 2) The store unit tests had a failure in T_LockFactory. Not a lot of information in the failure report: \\n\\n  \\n ********* Diff file derbyall\\/storeall\\/storeunit\\/TLockFactory.diff\\n*** Start: TLockFactory jdk1.8.0 storeall:storeunit 2014-05-09 08:28:09 ***\\n2 del\\n&lt; -- Unit Test T_LockFactory finished\\n2 add\\n&gt; Shutting down due to unit test failure.\\nTest Failed.\\n*** End:   TLockFactory jdk1.8.0 storeall:storeunit 2014-05-09 08:28:10 ***\\n \\n  \\n\\n Mike, at this point I don\'t exactly remember what breaks if we wait for locks in SequenceUpdater. That logic was arrived at painfully a couple years back. We can certainly try putting waits back in. Maybe everything will be fine. Or maybe we will painfully rediscover why we did it this way. One reason you don\'t want to wait is because this logic is called during cache eviction\\/flushing and during orderly database shutdown. If there are locks on SYSSEQUENCES, then cache eviction will stall, ddl will stall, and orderly shutdown will block. If the lock timeout is infinite, this would be very bad. We could try waiting for the minimum time, a millisecond. I suspect that will cause pile-ups, but I\'m not sure. It also involves a change to the existing apis which is as big as the change in patch derby-6554-02-af-askToRaiseSelfDeadlock.diff. That is because the current store interfaces don\'t let you pass a lock timeout override down the call stack when you open a conglomerate or fetch a row. \\n\\n I\'ll be away for a week. Someone else is welcome to play around with this while I\'m gone and check in one of the solutions if they feel confident. Here\'s a summary of the candidate patches: \\n\\n 1) derby-6554-02-ae-selfDeadlock_sps_compress.diff \\n\\n \\n\\t passes the tests \\n\\t raises a SelfDeadlock only if requested not to wait \\n\\t forces HeapController.lockRowAtSlotNoWaitExclusive() to catch an exception \\n \\n\\n\\n 2) derby-6554-02-af-askToRaiseSelfDeadlock.diff \\n\\n \\n\\t passes the tests \\n\\t SelfDeadlock is raised only if the caller asks for it \\n\\t no change to HeapController.lockRowAtSlotNoWaitExclusive() \\n \\n\\n\\n 3) derby-6554-02-ag-raiseSelfDeadlockAlways.diff \\n\\n \\n\\t fails 2 tests (see above) \\n\\t always raises SelfDeadlock, regardless of whether waiting was requested \\n\\t forces HeapController.lockRowAtSlotNoWaitExclusive() to catch an exception \\n \\n\\n\\n All of these patches fix   DERBY-6554  . But I don\'t think that any of these patches fits your preferences. The first two at least pass the tests. \\n\\n Thanks for helping me think through these issues.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13993922\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13993922&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13993922\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13993922_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13993922_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/May\\/14 21:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-09T21:20:37+0000\'\u003e09\\/May\\/14 21:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ethanks rick for the explanation, i keep forgetting about the shutdown and cache eviction case.  I\'ll think about\u003cbr\\/\u003e\\nit some more while you are out.  But early thoughts would be to take incremental steps so as to not hold\u003cbr\\/\u003e\\nup your sequence work any more:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) go with your patch #1 above as it seems to do what you need and passes tests.  I think it only slows\u003cbr\\/\u003e\\n    down delete row reclamation with extra exceptions vs returns, so probably ok.  I am ok with the one\u003cbr\\/\u003e\\n    store change for now as an incremental step.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) file a separate JIRA to put in self deadlock detection in for waiting locks.  With your patches the\u003cbr\\/\u003e\\n    code is available and work just needs to be done on problems with rest of code.\u003c\\/p\u003e\\n\\n\u003cp\u003e3) file a separate JIRA to change 0 wait locks to not throw an exception in self deadlock.  This will need\u003cbr\\/\u003e\\n    a solution that works for sequences.  Not sure of solution at this point, would be easy if we can have\u003cbr\\/\u003e\\n    sequences wait.   \u003c\\/p\u003e\\n\\n\u003cp\u003e4) test and see if we think sequences would benefit from waiting.   If so figure out how to wait.  Current\u003cbr\\/\u003e\\n    lock interfaces don\'t make it easy to set timeout\'s other than 0 and default.  \u003cbr\\/\u003e\\n    I think we want sequences to wait at least as long as we expect another transaction\u003cbr\\/\u003e\\n    to take to update the sequence and commit the transaction on a system that does a real I\\/O at commit\u003cbr\\/\u003e\\n    time.   If waiting does not work out, may still want to try sleep retry now that we know we are not\u003cbr\\/\u003e\\n    in self deadlock vs. sending an error to user.  All depends on doing this without negatively affecting\u003cbr\\/\u003e\\n    the shutdown and cache clean cases.\u003c\\/p\u003e\\n\\n\u003cp\u003eI would be interested in working on #2, as it ties in with work I would like to do to improve automatic\u003cbr\\/\u003e\\nspace reclamation.  I think some of the problems in this area are with self deadlock and waiting may\u003cbr\\/\u003e\\nhelp.  It would be easier to work on this if we separated the dependencies.  Along with #2 I would look\u003cbr\\/\u003e\\nat all the store nested transactions and make sure they are ready and do the right thing with self\u003cbr\\/\u003e\\ndeadlock.  I may need help with the language layer uses, but I don\'t think there are many other than\u003cbr\\/\u003e\\nsequences and identity.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_13993922_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13993922_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/May\\/14 21:20\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-09T21:20:37+0000\'\u003e09\\/May\\/14 21:20\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    thanks rick for the explanation, i keep forgetting about the shutdown and cache eviction case.  I\'ll think about \\nit some more while you are out.  But early thoughts would be to take incremental steps so as to not hold \\nup your sequence work any more: \\n\\n 1) go with your patch #1 above as it seems to do what you need and passes tests.  I think it only slows \\n    down delete row reclamation with extra exceptions vs returns, so probably ok.  I am ok with the one \\n    store change for now as an incremental step. \\n\\n 2) file a separate JIRA to put in self deadlock detection in for waiting locks.  With your patches the \\n    code is available and work just needs to be done on problems with rest of code. \\n\\n 3) file a separate JIRA to change 0 wait locks to not throw an exception in self deadlock.  This will need \\n    a solution that works for sequences.  Not sure of solution at this point, would be easy if we can have \\n    sequences wait.    \\n\\n 4) test and see if we think sequences would benefit from waiting.   If so figure out how to wait.  Current \\n    lock interfaces don\'t make it easy to set timeout\'s other than 0 and default.   \\n    I think we want sequences to wait at least as long as we expect another transaction \\n    to take to update the sequence and commit the transaction on a system that does a real I\\/O at commit \\n    time.   If waiting does not work out, may still want to try sleep retry now that we know we are not \\n    in self deadlock vs. sending an error to user.  All depends on doing this without negatively affecting \\n    the shutdown and cache clean cases. \\n\\n I would be interested in working on #2, as it ties in with work I would like to do to improve automatic \\nspace reclamation.  I think some of the problems in this area are with self deadlock and waiting may \\nhelp.  It would be easier to work on this if we separated the dependencies.  Along with #2 I would look \\nat all the store nested transactions and make sure they are ready and do the right thing with self \\ndeadlock.  I may need help with the language layer uses, but I don\'t think there are many other than \\nsequences and identity.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13994242\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13994242&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13994242\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jira-bot\\\" id=\\\"commentauthor_13994242_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jira-bot\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jira-bot\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e ASF subversion and git services\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13994242_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/May\\/14 13:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-10T13:55:50+0000\'\u003e10\\/May\\/14 13:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eCommit 1593702 from \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\" class=\\\"user-hover\\\" rel=\\\"rhillegas\\\"\u003eRick Hillegas\u003c\\/a\u003e in branch \'code\\/trunk\'\u003cbr\\/\u003e\\n[ \u003ca href=\\\"https:\\/\\/svn.apache.org\\/r1593702\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttps:\\/\\/svn.apache.org\\/r1593702\u003c\\/a\u003e ]\u003c\\/p\u003e\\n\\n\u003cp\u003e\u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-6554\\\" title=\\\"Too much contention followed by assert failure when accessing sequence in transaction that created it\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-6554\\\"\u003e\u003cdel\u003eDERBY-6554\u003c\\/del\u003e\u003c\\/a\u003e: Raise SelfDeadlock when a nested subtransaction can\'t immediately get a lock because it is blocked by its parent transaction; commit derby-6554-02-ae-selfDeadlock_sps_compress.diff.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"jira-bot\\\" id=\\\"commentauthor_13994242_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=jira-bot\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"jira-bot\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e ASF subversion and git services\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13994242_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/May\\/14 13:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-10T13:55:50+0000\'\u003e10\\/May\\/14 13:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Commit 1593702 from  Rick Hillegas  in branch \'code\\/trunk\' \\n[  https:\\/\\/svn.apache.org\\/r1593702  ] \\n\\n   DERBY-6554  : Raise SelfDeadlock when a nested subtransaction can\'t immediately get a lock because it is blocked by its parent transaction; commit derby-6554-02-ae-selfDeadlock_sps_compress.diff.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13994243\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13994243&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13994243\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13994243_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13994243_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/May\\/14 14:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-10T14:07:46+0000\'\u003e10\\/May\\/14 14:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi Mike,\u003c\\/p\u003e\\n\\n\u003cp\u003eI have checked in derby-6554-02-ae-selfDeadlock_sps_compress.diff, the patch you prefer. I have also logged new, follow-on issues:\u003c\\/p\u003e\\n\\n\u003cp\u003eo \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-6572\\\" title=\\\"Raise SelfDeadlock exception when a nested sub transaction has to wait for a lock held by its parent transaction.\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-6572\\\"\u003eDERBY-6572\u003c\\/a\u003e - This is item 2 in your previous comment.\u003c\\/p\u003e\\n\\n\u003cp\u003eo \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-6573\\\" title=\\\"Don&#39;t throw an exception if a nested sub transaction can&#39;t immediately get a blocking lock held by its parent transaction.\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-6573\\\"\u003eDERBY-6573\u003c\\/a\u003e - This is item 3 in your previous comment.\u003c\\/p\u003e\\n\\n\u003cp\u003eHopefully, this is enough to get you going on item 2. Note that besides sequence\\/identity, the language layer uses nested sub transactions during trigger compilation (technically, during the compilation of any stored prepared statement).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_13994243_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13994243_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/May\\/14 14:07\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-10T14:07:46+0000\'\u003e10\\/May\\/14 14:07\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hi Mike, \\n\\n I have checked in derby-6554-02-ae-selfDeadlock_sps_compress.diff, the patch you prefer. I have also logged new, follow-on issues: \\n\\n o  DERBY-6572  - This is item 2 in your previous comment. \\n\\n o  DERBY-6573  - This is item 3 in your previous comment. \\n\\n Hopefully, this is enough to get you going on item 2. Note that besides sequence\\/identity, the language layer uses nested sub transactions during trigger compilation (technically, during the compilation of any stored prepared statement).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-13994926\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=13994926&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13994926\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13994926_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13994926_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/May\\/14 08:21\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-12T08:21:49+0000\'\u003e12\\/May\\/14 08:21\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eSorry for the late response. I missed most of this discussion while the Apache mail server was down.\u003c\\/p\u003e\\n\\n\u003cp\u003eRick said:\u003c\\/p\u003e\\n\\n\u003cblockquote\u003e\\n\u003cp\u003eI don\'t think so. It appears to me that ConcurrentLockSet.lockObject() returns null if you can\'t get a lock immediately and (AbstractPool.noLockWait(timeout, compatibilitySpace) == true). But I don\'t understand what condition sets up the special \\\"else\\\" case in AbstractPool.noLockWait():\u003c\\/p\u003e\\n\u003cdiv class=\\\"code panel\\\" style=\\\"border-width: 1px;\\\"\u003e\u003cdiv class=\\\"codeContent panelContent\\\"\u003e\\n\u003cpre class=\\\"code-java\\\"\u003e    \u003cspan class=\\\"code-keyword\\\"\u003estatic\u003c\\/span\u003e \u003cspan class=\\\"code-object\\\"\u003eboolean\u003c\\/span\u003e noLockWait(\u003cspan class=\\\"code-object\\\"\u003eint\u003c\\/span\u003e timeout, CompatibilitySpace compat) {\\n        \u003cspan class=\\\"code-keyword\\\"\u003eif\u003c\\/span\u003e (timeout == C_LockFactory.NO_WAIT) {\\n            \u003cspan class=\\\"code-keyword\\\"\u003ereturn\u003c\\/span\u003e \u003cspan class=\\\"code-keyword\\\"\u003etrue\u003c\\/span\u003e;\\n        } \u003cspan class=\\\"code-keyword\\\"\u003eelse\u003c\\/span\u003e {\\n            LockOwner owner = compat.getOwner();\\n            \u003cspan class=\\\"code-keyword\\\"\u003ereturn\u003c\\/span\u003e owner != \u003cspan class=\\\"code-keyword\\\"\u003enull\u003c\\/span\u003e &amp;&amp; owner.noWait();\\n        }\\n    }\\n\u003c\\/pre\u003e\\n\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/blockquote\u003e\\n\\n\u003cp\u003eThe else branch is currently used when storing SPSs and by the index statistics daemon. Look for callers of TransactionController.setNoLockWait(). In those cases, waiting is disabled for the entire transaction, even if a no-wait flag isn\'t given as argument to the scan. That means the lock manager will see a request for a timed wait, but it will handle it as a no-wait request because of the flag on the transaction.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_13994926_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_13994926_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/May\\/14 08:21\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-12T08:21:49+0000\'\u003e12\\/May\\/14 08:21\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Sorry for the late response. I missed most of this discussion while the Apache mail server was down. \\n\\n Rick said: \\n\\n \\n I don\'t think so. It appears to me that ConcurrentLockSet.lockObject() returns null if you can\'t get a lock immediately and (AbstractPool.noLockWait(timeout, compatibilitySpace) == true). But I don\'t understand what condition sets up the special \\\"else\\\" case in AbstractPool.noLockWait(): \\n  \\n      static   boolean  noLockWait( int  timeout, CompatibilitySpace compat) {\\n         if  (timeout == C_LockFactory.NO_WAIT) {\\n             return   true ;\\n        }  else  {\\n            LockOwner owner = compat.getOwner();\\n             return  owner !=  null  &amp;&amp; owner.noWait();\\n        }\\n    }\\n \\n   \\n\\n The else branch is currently used when storing SPSs and by the index statistics daemon. Look for callers of TransactionController.setNoLockWait(). In those cases, waiting is disabled for the entire transaction, even if a no-wait flag isn\'t given as argument to the scan. That means the lock manager will see a request for a timed wait, but it will handle it as a no-wait request because of the flag on the transaction.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-14002033\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=14002033&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14002033\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_14002033_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_14002033_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/May\\/14 17:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-19T17:32:05+0000\'\u003e19\\/May\\/14 17:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIt appears to me that this bug is fixed after checking in derby-6554-02-ae-selfDeadlock_sps_compress.diff. Follow-on issues have been created. I am resolving this issue.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_14002033_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_14002033_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/May\\/14 17:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-05-19T17:32:05+0000\'\u003e19\\/May\\/14 17:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    It appears to me that this bug is fixed after checking in derby-6554-02-ae-selfDeadlock_sps_compress.diff. Follow-on issues have been created. I am resolving this issue.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-14147023\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=14147023&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14147023\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_14147023_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_14147023_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Sep\\/14 22:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-09-24T22:50:30+0000\'\u003e24\\/Sep\\/14 22:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI believe the changes are closely related to new code introduced in 10.11 and are not appropriate for backport.  To get this fix one must upgrade to 10.11 or higher release.  marking it as not appropriate for backport.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"mikem\\\" id=\\\"commentauthor_14147023_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=mikem\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"mikem\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Mike Matrigali\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_14147023_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Sep\\/14 22:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2014-09-24T22:50:30+0000\'\u003e24\\/Sep\\/14 22:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I believe the changes are closely related to new code introduced in 10.11 and are not appropriate for backport.  To get this fix one must upgrade to 10.11 or higher release.  marking it as not appropriate for backport.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-15476546\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-6554?focusedCommentId=15476546&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15476546\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_15476546_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_15476546_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Sep\\/16 09:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2016-09-09T09:51:56+0000\'\u003e09\\/Sep\\/16 09:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e[ Automatically closing all resolved issues that haven\'t been updated in more than six months. ]\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_15476546_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_15476546_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'09\\/Sep\\/16 09:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2016-09-09T09:51:56+0000\'\u003e09\\/Sep\\/16 09:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    [ Automatically closing all resolved issues that haven\'t been updated in more than six months. ]              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\"";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["scope-filter-data"]="{\"createScopeActions\":[],\"scopes\":[]}";
WRM._unparsedData["sidebar-collapsed-by-default"]="true";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:can-manage"]="false";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:with-icons"]="false";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:shortcuts"]="[]";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:project-id"]="10594";
WRM._unparsedData["sidebar-id"]="\"\u003cdiv class=\\\"aui-sidebar  projects-sidebar sidebar-pending\\\" \u003e\u003cdiv class=\\\"aui-sidebar-wrapper\\\"\u003e\u003cdiv class=\\\"aui-sidebar-body\\\"\u003e\u003cheader class=\\\"aui-page-header\\\"\u003e\u003cdiv class=\\\"aui-page-header-inner\\\"\u003e\u003cdiv class=\\\"aui-page-header-image\\\"\u003e\u003ca href=\\\"\\/jira\\/projects\\/DERBY\\/summary\\\" title=\\\"Derby\\\" class=\\\"jira-project-avatar\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-large aui-avatar-project\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"\\/jira\\/secure\\/projectavatar?pid=10594&amp;avatarId=10122\\\" alt=\\\"Derby\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e\u003cimg src=\\\"data:image\\/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI\\/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE4LjEuMSwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCINCgkgdmlld0JveD0iMCAwIDMwMCAzMDAiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDMwMCAzMDA7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxnIGlkPSJMYXllcl8yIj4NCgk8cGF0aCBzdHlsZT0iZmlsbDojRjc5MjMyOyIgZD0iTTE1MCwwQzY2LjY2NywwLDAsNjYuNjY3LDAsMTUwczY2LjY2NywxNTAsMTUwLDE1MHMxNTAtNjYuNjY3LDE1MC0xNTBTMjMzLjMzMywwLDE1MCwweg0KCQkgTTEzNi42NjcsMTc4LjMzM0wxMjUsMTkwbC00MS42NjctNDBMOTUsMTM4LjMzM2wzMC0zMEwxMzYuNjY3LDEyMGwtMzAsMzBMMTM2LjY2NywxNzguMzMzeiBNMjA1LDE2MS42NjdsLTMwLDMwTDE2My4zMzMsMTgwDQoJCWwzMC0zMGwtMzAtMzBMMTc1LDEwOC4zMzNMMjE2LjY2NywxNTBMMjA1LDE2MS42Njd6Ii8+DQo8L2c+DQo8Zz4NCgk8cG9seWdvbiBzdHlsZT0iZmlsbDojRkZGRkZGOyIgcG9pbnRzPSIxNzUsMTkxLjY2NyAyMDUsMTYxLjY2NyAyMTYuNjY3LDE1MCAxNzUsMTA4LjMzMyAxNjMuMzMzLDEyMCAxOTMuMzMzLDE1MCAxNjMuMzMzLDE4MCAJIi8+DQoJPHBvbHlnb24gc3R5bGU9ImZpbGw6I0ZGRkZGRjsiIHBvaW50cz0iMTI1LDEwOC4zMzMgOTUsMTM4LjMzMyA4My4zMzMsMTUwIDEyNSwxOTAgMTM2LjY2NywxNzguMzMzIDEwNi42NjcsMTUwIDEzNi42NjcsMTIwIAkiLz4NCjwvZz4NCjwvc3ZnPg0K\\\" alt=\\\"Icon indicating the project type\\\" class=\\\"jira-project-avatar-icon\\\" \\/\u003e\u003c\\/a\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-image --\u003e\u003cdiv class=\\\"aui-page-header-main\\\"\u003e\u003ch1\u003e\u003cdiv class=\\\"aui-group aui-group-split\\\"\u003e\u003cdiv class=\\\"aui-item project-title\\\"\u003e\u003ca href=\\\"\\/jira\\/projects\\/DERBY\\/summary\\\" title=\\\"Derby\\\"\u003eDerby\u003c\\/a\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/h1\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-main --\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-inner --\u003e\u003c\\/header\u003e\u003c!-- .aui-page-header --\u003e\u003cnav class=\\\"aui-navgroup aui-navgroup-vertical\\\"\u003e\u003cdiv class=\\\"aui-navgroup-inner sidebar-content-container\\\"\u003e\u003cdiv class=\\\"aui-sidebar-group aui-sidebar-group-tier-one\\\" data-id=\\\"sidebar-navigation-panel\\\"\u003e\u003cul class=\\\"aui-nav\\\"\u003e\u003cli class=\\\"aui-nav-selected\\\" \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/DERBY\\/issues\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-issue-navigator:sidebar-issue-navigator\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large icon-sidebar-issues\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Issues\\\"\u003eIssues\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003cli  \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/DERBY?selectedItem=com.atlassian.jira.jira-projects-plugin:report-page\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-plugin:report-page\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large agile-icon-report\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Reports\\\"\u003eReports\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003cli  \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/DERBY?selectedItem=com.atlassian.jira.jira-projects-plugin:components-page\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-plugin:components-page\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large icon-sidebar-components\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Components\\\"\u003eComponents\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003c\\/ul\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/nav\u003e\u003c\\/div\u003e\u003cdiv class=\\\"aui-sidebar-footer\\\"\u003e\u003ca class=\\\"aui-button aui-button-subtle aui-sidebar-toggle aui-sidebar-footer-tipsy\\\" data-tooltip=\\\"Expand sidebar ( [ )\\\" href=\\\"#\\\"\u003e\u003cspan class=\\\"aui-icon aui-icon-small\\\"\u003e\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/div\u003e\"";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:bigpipe-init/jira.webresources:bigpipe-init.js" data-wrm-key="jira.webresources:bigpipe-init" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <form id="jira_request_timing_info" class="dont-default-focus"> 
   <fieldset class="parameters hidden"> 
    <input type="hidden" title="jira.request.start.millis" value="1520240932365"> 
    <input type="hidden" title="jira.request.server.time" value="324"> 
    <input type="hidden" title="jira.request.id" value="548x94443554x7"> 
    <input type="hidden" title="jira.session.expiry.time" value="-"> 
    <input type="hidden" title="jira.session.expiry.in.mins" value="-"> 
    <input id="jiraConcurrentRequests" type="hidden" name="jira.request.concurrent.requests" value="5"> 
    <input type="hidden" title="db.reads.time.in.ms" value="50"> 
    <input type="hidden" title="db.conns.time.in.ms" value="57"> 
   </fieldset> 
  </form> 
  <!--
	                 REQUEST ID : 548x94443554x7
	          REQUEST TIMESTAMP : [05/Mar/2018:09:08:52 +0000]
	               REQUEST TIME : 0.3240
	                 ASESSIONID : -
	        CONCURRENT REQUESTS : 5

	                      db.reads : OpSnapshot{name='db.reads', invocationCount=33, elapsedTotal=50587693, elapsedMin=522914, elapsedMax=14548232, resultSetSize=0, cpuTotal=0, cpuMin=0, cpuMax=0}
	                      db.conns : OpSnapshot{name='db.conns', invocationCount=37, elapsedTotal=57286188, elapsedMin=546631, elapsedMax=14577946, resultSetSize=0, cpuTotal=0, cpuMin=0, cpuMax=0}
-->   
 </body>
</html>