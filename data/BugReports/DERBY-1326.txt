<!doctype html>
<html lang="en">
 <head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=Edge"> 
  <meta name="application-name" content="JIRA" data-name="jira" data-version="7.6.3">
  <meta name="ajs-viewissue-use-history-api" content="false"> 
  <meta name="ajs-jira-base-url" content="https://issues.apache.org/jira"> 
  <meta name="ajs-serverRenderedViewIssue" content="true"> 
  <meta name="ajs-dev-mode" content="false"> 
  <meta name="ajs-context-path" content="/jira"> 
  <meta name="ajs-version-number" content="7.6.3"> 
  <meta name="ajs-build-number" content="76005"> 
  <meta name="ajs-is-beta" content="false"> 
  <meta name="ajs-is-rc" content="false"> 
  <meta name="ajs-is-snapshot" content="false"> 
  <meta name="ajs-is-milestone" content="false"> 
  <meta name="ajs-remote-user" content=""> 
  <meta name="ajs-remote-user-fullname" content=""> 
  <meta name="ajs-user-locale" content="en_UK"> 
  <meta name="ajs-user-locale-group-separator" content=","> 
  <meta name="ajs-app-title" content="ASF JIRA"> 
  <meta name="ajs-keyboard-shortcuts-enabled" content="true"> 
  <meta name="ajs-keyboard-accesskey-modifier" content="Ctrl+Alt"> 
  <meta name="ajs-enabled-dark-features" content="[&quot;com.atlassian.jira.agile.darkfeature.editable.detailsview&quot;,&quot;nps.survey.inline.dialog&quot;,&quot;com.atlassian.jira.agile.darkfeature.edit.closed.sprint.enabled&quot;,&quot;jira.plugin.devstatus.phasetwo&quot;,&quot;jira.frother.reporter.field&quot;,&quot;atlassian.rest.xsrf.legacy.enabled&quot;,&quot;jira.issue.status.lozenge&quot;,&quot;com.atlassian.jira.config.BIG_PIPE&quot;,&quot;com.atlassian.jira.projects.issuenavigator&quot;,&quot;com.atlassian.jira.config.PDL&quot;,&quot;jira.plugin.devstatus.phasetwo.enabled&quot;,&quot;atlassian.aui.raphael.disabled&quot;,&quot;app-switcher.new&quot;,&quot;frother.assignee.field&quot;,&quot;com.atlassian.jira.projects.ProjectCentricNavigation.Switch&quot;,&quot;sd.internal.base.off.thread.on.completion.events.enabled&quot;,&quot;jira.onboarding.cyoa&quot;,&quot;com.atlassian.jira.agile.darkfeature.kanplan.enabled&quot;,&quot;sd.slavalue.record.updated.date.enabled&quot;,&quot;com.atlassian.jira.config.ProjectConfig.MENU&quot;,&quot;com.atlassian.jira.projects.sidebar.DEFER_RESOURCES&quot;,&quot;com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions.enabled&quot;,&quot;com.atlassian.jira.agile.darkfeature.sprint.goal.enabled&quot;,&quot;jira.zdu.admin-updates-ui&quot;,&quot;jira.zdu.jmx-monitoring&quot;,&quot;sd.sla.improved.rendering.enabled&quot;,&quot;sd.canned.responses.enabled&quot;,&quot;sd.new.settings.sidebar.location.disabled&quot;,&quot;jira.zdu.cluster-upgrade-state&quot;,&quot;com.atlassian.jira.agile.darkfeature.splitissue&quot;,&quot;com.atlassian.jira.config.CoreFeatures.LICENSE_ROLES_ENABLED&quot;,&quot;com.atlassian.feedback.feedback-button-move-to-header-enable&quot;,&quot;jira.export.csv.enabled&quot;]"> 
  <meta name="ajs-in-admin-mode" content="false"> 
  <meta name="ajs-is-sysadmin" content="false"> 
  <meta name="ajs-is-admin" content="false"> 
  <meta name="ajs-outgoing-mail-enabled" content="true"> 
  <meta name="ajs-date-relativize" content="true"> 
  <meta name="ajs-date-time" content="HH:mm"> 
  <meta name="ajs-date-day" content="EEEE HH:mm"> 
  <meta name="ajs-date-dmy" content="dd/MMM/yy"> 
  <meta name="ajs-date-complete" content="dd/MMM/yy HH:mm"> 
  <script type="text/javascript">var AJS=AJS||{};AJS.debug=true;</script> 
  <meta id="atlassian-token" name="atlassian-token" content="A5KQ-2QAV-T4JA-FDED|2a34d24c4b80198dc72c41c0e82e2fa28c5c31b0|lout"> 
  <link rel="shortcut icon" href="/jira/s/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/_/favicon.ico"> 
  <!--[if IE]><![endif]--> 
  <script type="text/javascript">
    (function() {
        var contextPath = '/jira';
        var eventBuffer = [];

        function printDeprecatedMsg() {
            if (console && console.warn) {
                console.warn('DEPRECATED JS - contextPath global variable has been deprecated since 7.4.0. Use `wrm/context-path` module instead.');
            }
        }

        function sendEvent(analytics, postfix) {
            analytics.send({
                name: 'js.globals.contextPath.' + postfix
            });
        }

        function sendDeprecatedEvent(postfix) {
            try {
                var analytics = require('jira/analytics');
                if (eventBuffer.length) {
                    eventBuffer.forEach(function(value) {
                        sendEvent(analytics, value);
                    });
                    eventBuffer = [];
                }

                if (postfix) {
                    sendEvent(analytics, postfix);
                }
            } catch(ex) {
                eventBuffer.push(postfix);
                setTimeout(sendDeprecatedEvent, 1000);
            }
        }

        Object.defineProperty(window, 'contextPath', {
            get: function() {
                printDeprecatedMsg();
                sendDeprecatedEvent('get');
                return contextPath;
            },
            set: function(value) {
                printDeprecatedMsg();
                sendDeprecatedEvent('set');
                contextPath = value;
            }
        });
    })();

</script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"/jira\"";
WRM._unparsedData["jira.webresources:feature-flags.feature-flag-data"]="{\"enabled-feature-keys\":[\"com.atlassian.jira.agile.darkfeature.editable.detailsview\",\"nps.survey.inline.dialog\",\"com.atlassian.jira.agile.darkfeature.edit.closed.sprint.enabled\",\"jira.plugin.devstatus.phasetwo\",\"jira.frother.reporter.field\",\"atlassian.rest.xsrf.legacy.enabled\",\"jira.issue.status.lozenge\",\"com.atlassian.jira.config.BIG_PIPE\",\"com.atlassian.jira.projects.issuenavigator\",\"com.atlassian.jira.config.PDL\",\"jira.plugin.devstatus.phasetwo.enabled\",\"atlassian.aui.raphael.disabled\",\"app-switcher.new\",\"frother.assignee.field\",\"com.atlassian.jira.projects.ProjectCentricNavigation.Switch\",\"sd.internal.base.off.thread.on.completion.events.enabled\",\"jira.onboarding.cyoa\",\"com.atlassian.jira.agile.darkfeature.kanplan.enabled\",\"sd.slavalue.record.updated.date.enabled\",\"com.atlassian.jira.config.ProjectConfig.MENU\",\"com.atlassian.jira.projects.sidebar.DEFER_RESOURCES\",\"com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions.enabled\",\"com.atlassian.jira.agile.darkfeature.sprint.goal.enabled\",\"jira.zdu.admin-updates-ui\",\"jira.zdu.jmx-monitoring\",\"sd.sla.improved.rendering.enabled\",\"sd.canned.responses.enabled\",\"sd.new.settings.sidebar.location.disabled\",\"jira.zdu.cluster-upgrade-state\",\"com.atlassian.jira.agile.darkfeature.splitissue\",\"com.atlassian.jira.config.CoreFeatures.LICENSE_ROLES_ENABLED\",\"com.atlassian.feedback.feedback-button-move-to-header-enable\",\"jira.export.csv.enabled\"],\"feature-flag-states\":{\"com.atlassian.jira.agile.darkfeature.kanplan\":false,\"sd.internal.base.off.thread.on.completion.events\":false,\"jira.instrumentation.laas\":false,\"com.atlassian.jira.agile.darkfeature.edit.closed.sprint\":false,\"com.atlassian.jira.issuetable.draggable\":true,\"jira.create.linked.issue\":true,\"com.atlassian.jira.agile.darkfeature.sprint.goal\":false,\"jira.sal.host.connect.accessor.existing.transaction.will.create.transactions\":true,\"jira.jql.suggestrecentfields\":false,\"com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions\":false,\"jira.jql.smartautoselectfirst\":false,\"com.atlassian.jira.agile.darkfeature.optimistic.transitions\":true,\"com.atlassian.jira.issuetable.move.links.hidden\":true,\"jira.priorities.per.project\":true,\"com.atlassian.jira.upgrade.startup.fix.index\":true,\"jira.renderer.consider.variable.format\":true}}";
WRM._unparsedData["jira.webresources:default-comment-security-level.DefaultCommentSecurityLevelHelpLink"]="{\"extraClasses\":\"default-comment-level-help\",\"title\":\"Commenting on an Issue\",\"url\":\"https://docs.atlassian.com/jira/jcore-docs-076/Editing+and+collaborating+on+issues#Editingandcollaboratingonissues-restrictacomment\",\"isLocal\":false}";
WRM._unparsedData["jira.webresources:dateFormatProvider.allFormats"]="{\"dateFormats\":{\"meridiem\":[\"AM\",\"PM\"],\"eras\":[\"BC\",\"AD\"],\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"monthsShort\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"weekdaysShort\":[\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\",\"Sat\"],\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]},\"lookAndFeelFormats\":{\"relativize\":\"true\",\"time\":\"HH:mm\",\"day\":\"EEEE HH:mm\",\"dmy\":\"dd/MMM/yy\",\"complete\":\"dd/MMM/yy HH:mm\"}}";
WRM._unparsedData["com.atlassian.jira.jira-issue-nav-components:issueviewer.features"]="{\"rteEnabled\":true}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-dnd-attachment-plugin:dnd-issue-drop-zone.thumbnail-mime-types"]="\"image/vnd.wap.wbmp,image/png,image/x-png,image/jpeg,image/bmp,image/gif\"";
WRM._unparsedData["com.atlassian.jira.plugins.jira-dnd-attachment-plugin:dnd-issue-drop-zone.upload-limit"]="\"62914560\"";
WRM._unparsedData["com.atlassian.plugins.helptips.jira-help-tips:help-tip-manager.JiraHelpTipData"]="{\"anonymous\":true}";
WRM._unparsedData["com.atlassian.jira.jira-view-issue-plugin:controller-subtasks.controller.subtasks.parameters"]="{\"url\":\"/rest/api/2/issue/{issueId}/subtask/move\"}";
WRM._unparsedData["com.atlassian.analytics.analytics-client:policy-update-init.policy-update-data-provider"]="false";
WRM._unparsedData["com.atlassian.analytics.analytics-client:programmatic-analytics-init.programmatic-analytics-data-provider"]="false";
WRM._unparsedData["jira.webresources:avatar-picker.data"]="{}";
WRM._unparsedData["com.atlassian.feedback.jira-feedback-plugin:button-resources-init.data"]="{\"jira.feedback.plugin.issue.collector.core\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"jira.feedback.plugin.issue.collector.default\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"jira.feedback.plugin.issue.collector.service.desk\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?locale=en-UK&collectorId=a698db21\",\"jira.feedback.plugin.issue.collector.software\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"isHeaderFeedbackButtonEnabled\":true}";
WRM._unparsedData["com.atlassian.jira.jira-header-plugin:dismissedFlags.flags"]="{\"dismissed\":[]}";
WRM._unparsedData["com.atlassian.jira.jira-header-plugin:newsletter-signup-tip-init.newsletterSignup"]="{\"signupDescription\":\"Get updates, inspiration and best practices from the team behind JIRA.\",\"formUrl\":\"https://www.atlassian.com/apis/exact-target/{0}/subscribe?mailingListId=1401671\",\"signupTitle\":\"Sign up!\",\"signupId\":\"newsletter-signup-tip\",\"showNewsletterTip\":false}";
WRM._unparsedData["com.atlassian.jira.project-templates-plugin:project-templates-plugin-resources.ptAnalyticsData"]="{\"instanceCreatedDate\":\"2011-01-31\"}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-wiki-editor:wiki-editor-resources.help-data"]="{\"showHelp\":true,\"editorDocumentationUrl\":[\"https://docs.atlassian.com/jira/jcore-docs-076/Visual+editing\"],\"editorDocumentationTitle\":[\"Show me documentation for the visual editor\"]}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-wiki-editor:wiki-editor-resources.thumbnails-allowed"]="false";
WRM._unparsedData["jira.webresources:user-message-flags.adminLockout"]="{}";
WRM._unparsedData["jira.request.correlation-id"]="\"b51cf50b8131a4\"";
WRM._unparsedData["project-id"]="10594";
WRM._unparsedData["project-key"]="\"DERBY\"";
WRM._unparsedData["project-name"]="\"Derby\"";
WRM._unparsedData["project-type"]="\"software\"";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:generic-filters"]="[{\"id\":\"allissues\",\"jql\":\"project = \\\"{0}\\\" ORDER BY {1}\",\"defaultOrderby\":\"created DESC\",\"label\":\"All issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[]},{\"id\":\"allopenissues\",\"jql\":\"project = \\\"{0}\\\" AND resolution = Unresolved ORDER BY {1}\",\"defaultOrderby\":\"priority DESC, updated DESC\",\"label\":\"Open issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"resolution\"]},{\"id\":\"doneissues\",\"jql\":\"project = \\\"{0}\\\" AND statusCategory = Done ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Done issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":false,\"fields\":[\"status\"]},{\"id\":\"recentlyviewed\",\"jql\":\"project = \\\"{0}\\\" AND issuekey in issueHistory() ORDER BY {1}\",\"defaultOrderby\":\"lastViewed DESC\",\"label\":\"Viewed recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"issuekey\"]},{\"id\":\"addedrecently\",\"jql\":\"project = \\\"{0}\\\" AND created \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"created DESC\",\"label\":\"Created recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"created\"]},{\"id\":\"resolvedrecently\",\"jql\":\"project = \\\"{0}\\\" AND resolutiondate \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Resolved recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":false,\"fields\":[\"resolutiondate\"]},{\"id\":\"updatedrecently\",\"jql\":\"project = \\\"{0}\\\" AND updated \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Updated recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"updated\"]}]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:default-filter-priority"]="[\"allopenissues\",\"allissues\"]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:can-manage-filters"]="false";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:project-filters"]="[]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:can-create-issues"]="false";
WRM._unparsedData["projectId"]="10594";
WRM._unparsedData["projectKey"]="\"DERBY\"";
WRM._unparsedData["projectType"]="\"software\"";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:server-rendered"]="true";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/a8a4711bc3f2eb261d8c8fd9fbcbba8b-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1fca1750044f2777c977e8d8cc023344/_/download/contextbatch/css/_super/batch.css" data-wrm-key="_super" data-wrm-batch-type="context" media="all"> 
  <link type="text/css" rel="stylesheet" href="/jira/s/74ac580603ca910fff0cfdf319e54add-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/fbf45109b31165e5b7740a9d72318cea/_/download/contextbatch/css/project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super/batch.css?agile_global_admin_condition=true&amp;hc-enabled=true&amp;is-server-instance=true&amp;jag=true&amp;jira.create.linked.issue=true&amp;nps-acknowledged=true&amp;richediton=true" data-wrm-key="project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super" data-wrm-batch-type="context" media="all"> 
  <link type="text/css" rel="stylesheet" href="/jira/s/611672383f6cab00ab202241ba6f9d68-T/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/7.6.3/_/download/batch/com.atlassian.feedback.jira-feedback-plugin:button-resources-init/com.atlassian.feedback.jira-feedback-plugin:button-resources-init.css" data-wrm-key="com.atlassian.feedback.jira-feedback-plugin:button-resources-init" data-wrm-batch-type="resource" media="all"> 
  <script type="text/javascript" src="/jira/s/98ceb006e504d7924d5ffc411626c6bc-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1fca1750044f2777c977e8d8cc023344/_/download/contextbatch/js/_super/batch.js?locale=en-UK" data-wrm-key="_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/c1e4d26ea276469807c3dc0918df482c-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/fbf45109b31165e5b7740a9d72318cea/_/download/contextbatch/js/project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super/batch.js?agile_global_admin_condition=true&amp;hc-enabled=true&amp;is-server-instance=true&amp;jag=true&amp;jira.create.linked.issue=true&amp;locale=en-UK&amp;nps-acknowledged=true&amp;richediton=true" data-wrm-key="project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/6bf9253c8d533109c3b02e26794be24e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/871d45c9f322a22cb3aa9b7948a69803/_/download/contextbatch/js/atl.global,-_super/batch.js?locale=en-UK" data-wrm-key="atl.global,-_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:calendar-en/jira.webresources:calendar-en.js" data-wrm-key="jira.webresources:calendar-en" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:calendar-localisation-moment/jira.webresources:calendar-localisation-moment.js" data-wrm-key="jira.webresources:calendar-localisation-moment" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/7.6.3/_/download/batch/com.atlassian.feedback.jira-feedback-plugin:button-resources/com.atlassian.feedback.jira-feedback-plugin:button-resources.js" data-wrm-key="com.atlassian.feedback.jira-feedback-plugin:button-resources" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/ccd2e67b523185973473e8bd5735c8f9-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/e0de73613a1027de08f3da6a45e1d1a2/_/download/contextbatch/css/jira.global.look-and-feel,-_super/batch.css" data-wrm-key="jira.global.look-and-feel,-_super" data-wrm-batch-type="context" media="all"> 
  <script type="text/javascript" src="/jira/rest/api/1.0/shortcuts/76005/33e5e0166867c8c9228d44506f60b2e8/shortcuts.js?context=issuenavigation&amp;context=issueaction"></script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.jira.jira-issue-nav-components:inline-edit-enabled"]="true";
WRM._unparsedData["should-display-chaperone"]="false";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/15712b600e9aecf72ffd9fd3704a0c78-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/6b22a15c7b83f87a47b1757076f43542/_/download/contextbatch/css/com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue/batch.css?jira.create.linked.issue=true&amp;richediton=true" data-wrm-key="com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue" data-wrm-batch-type="context" media="all"> 
  <script type="text/javascript" src="/jira/s/6579b6b8ba67abaa496e39b9242a18a4-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/6b22a15c7b83f87a47b1757076f43542/_/download/contextbatch/js/com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue/batch.js?jira.create.linked.issue=true&amp;locale=en-UK&amp;richediton=true" data-wrm-key="com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue" data-wrm-batch-type="context" data-initially-rendered></script> 
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
  <meta name="ajs-can-search-users" content="false"> 
  <meta name="ajs-can-edit-watchers" content="false"> 
  <meta name="ajs-default-avatar-url" content="https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10453"> 
  <meta name="ajs-issue-project-type" content="software"> 
  <meta name="ajs-issue-key" content="DERBY-1326"> 
  <meta name="ajs-server-view-issue-is-editable" content="false"> 
  <title>[DERBY-1326] Network server may abandon sessions when Derby system is shutdown and this causes intermittent hangs in the client - ASF JIRA</title> 
  <link rel="search" type="application/opensearchdescription+xml" href="/jira/osd.jsp" title="[DERBY-1326] Network server may abandon sessions when Derby system is shutdown and this causes intermittent hangs in the client - ASF JIRA"> 
 </head> 
 <body id="jira" class="aui-layout aui-theme-default " data-version="7.6.3"> 
  <div id="page"> 
   <header id="header" role="banner"> 
    <script>
require(["jquery", "jira/license-banner"], function ($, licenseBanner) {
    $(function () {
        licenseBanner.showLicenseBanner("");
        licenseBanner.showLicenseFlag("");
    });
});
</script> 
    <nav class="aui-header aui-dropdown2-trigger-group" role="navigation">
     <div class="aui-header-inner">
      <div class="aui-header-before">
       <a class=" aui-dropdown2-trigger app-switcher-trigger" aria-controls="app-switcher" aria-haspopup="true" role="button" tabindex="0" data-aui-trigger href="#app-switcher"><span class="aui-icon aui-icon-small aui-iconfont-appswitcher">Linked Applications</span></a>
       <div id="app-switcher" class="aui-dropdown2 aui-style-default" role="menu" aria-hidden="true" data-is-switcher="true" data-environment="{&quot;isUserAdmin&quot;:false,&quot;isAppSuggestionAvailable&quot;:false,&quot;isSiteAdminUser&quot;:false}">
        <div role="application">
         <div class="app-switcher-loading">
          Loading…
         </div>
        </div>
       </div>
      </div>
      <div class="aui-header-primary">
       <h1 id="logo" class="aui-header-logo aui-header-logo-custom"><a href="https://issues.apache.org/jira/secure/MyJiraHome.jspa"><img src="/jira/s/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/_/jira-logo-scaled.png" alt="ASF JIRA"></a></h1>
       <ul class="aui-nav">
        <li><a href="/jira/secure/Dashboard.jspa" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="home_link" aria-haspopup="true" aria-controls="home_link-content" title="View and manage your dashboards" accesskey="d">Dashboards</a>
         <div class="aui-dropdown2 aui-style-default" id="home_link-content" data-aui-dropdown2-ajax-key="home_link"></div></li>
        <li><a href="/jira/browse/DERBY" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="browse_link" aria-haspopup="true" aria-controls="browse_link-content" title="View recent projects and browse a list of projects" accesskey="p">Projects</a>
         <div class="aui-dropdown2 aui-style-default" id="browse_link-content" data-aui-dropdown2-ajax-key="browse_link"></div></li>
        <li><a href="/jira/issues/" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="find_link" aria-haspopup="true" aria-controls="find_link-content" title="Search for issues and view recent issues" accesskey="i">Issues</a>
         <div class="aui-dropdown2 aui-style-default" id="find_link-content" data-aui-dropdown2-ajax-key="find_link"></div></li> 
       </ul>
      </div>
      <div class="aui-header-secondary">
       <ul class="aui-nav">
        <li id="quicksearch-menu"> 
         <form action="/jira/secure/QuickSearch.jspa" method="get" id="quicksearch" class="aui-quicksearch dont-default-focus ajs-dirty-warning-exempt"> 
          <input id="quickSearchInput" class="search" type="text" title="Search" placeholder="Search" name="searchString" accessKey="q"> 
          <input type="submit" class="hidden" value="Search"> 
         </form> </li> 
        <li><a class="jira-feedback-plugin" role="button" aria-haspopup="true" id="jira-header-feedback-link" href="#"><span class="aui-icon aui-icon-small jira-feedback-plugin-icon">Give feedback to Atlassian</span></a></li> 
        <li id="system-help-menu"> <a class="aui-nav-link aui-dropdown2-trigger" id="help_menu" aria-haspopup="true" aria-owns="system-help-menu-content" href="https://docs.atlassian.com/jira/jcore-docs-076/" target="$textUtils.htmlEncode($rootHelpMenuItem.params.target)" title="Help"><span class="aui-icon aui-icon-small aui-iconfont-help">Help</span></a> 
         <div id="system-help-menu-content" class="aui-dropdown2 aui-style-default"> 
          <div class="aui-dropdown2-section"> 
           <ul id="jira-help" class="aui-list-truncate"> 
            <li> <a id="view_core_help" class="aui-nav-link " title="Go to the online documentation for JIRA Core" href="https://docs.atlassian.com/jira/jcore-docs-076/" target="_blank">JIRA Core help</a> </li> 
            <li> <a id="keyshortscuthelp" class="aui-nav-link " title="Get more information about JIRA's Keyboard Shortcuts" href="/jira/secure/ViewKeyboardShortcuts!default.jspa" target="_blank">Keyboard Shortcuts</a> </li> 
            <li> <a id="view_about" class="aui-nav-link " title="Get more information about JIRA" href="/jira/secure/AboutPage.jspa">About JIRA</a> </li> 
            <li> <a id="view_credits" class="aui-nav-link " title="See who did what" href="/jira/secure/JiraCreditsPage!default.jspa" target="_blank">JIRA Credits</a> </li> 
           </ul> 
          </div> 
         </div> </li> 
        <li id="user-options"> <a class="aui-nav-link login-link" href="/jira/login.jsp?os_destination=%2Fbrowse%2FDERBY-1326">Log In</a> 
         <div id="user-options-content" class="aui-dropdown2 aui-style-default"> 
          <div class="aui-dropdown2-section"> 
          </div> 
         </div> </li> 
       </ul>
      </div>
     </div>
     <!-- .aui-header-inner-->
    </nav>
    <!-- .aui-header --> 
   </header> 
   <section id="content" role="main"> 
    <big-pipe data-id="sidebar-id" unresolved></big-pipe>
    <div class="aui-sidebar  sidebar-placeholder">
     <div class="aui-sidebar-wrapper">
      <div class="aui-sidebar-body"></div>
      <div class="aui-sidebar-footer">
       <a class="aui-button aui-button-subtle aui-sidebar-toggle aui-sidebar-footer-tipsy" data-tooltip="Expand sidebar ( [ )" href="#"><span class="aui-icon aui-icon-small"></span></a>
      </div>
     </div>
    </div>
    <script id="projects-sidebar-init">
    require(['jira/projects/sidebar/expansion-manager'], function(expansionManager) {
        var scriptTag = document.getElementById('projects-sidebar-init');
        var sidebar = AJS.sidebar('.aui-sidebar');
        expansionManager(sidebar);
        scriptTag.parentElement.removeChild(scriptTag);
    });
    </script>
    <div class="aui-page-panel">
     <div class="aui-page-panel-inner">
      <div class="issue-navigator">
       <div class="content">
        <div class="issue-view">
         <div class="navigation-tools">
          <div class="pager-container"></div>
         </div>
         <div class="issue-container">
          <div id="issue-content" class="issue-edit-form">
           <header id="stalker" class="issue-header js-stalker">
            <div class="issue-header-content">
             <header class="aui-page-header">
              <div class="aui-page-header-inner">
               <div class="aui-page-header-image">
                <span id="10594" class="aui-avatar aui-avatar-large aui-avatar-project"><span class="aui-avatar-inner"><img id="project-avatar" alt="Uploaded image for project: 'Derby'" src="https://issues.apache.org/jira/secure/projectavatar?pid=10594&amp;avatarId=10122"></span></span>
               </div>
               <!-- .aui-page-header-image -->
               <div class="aui-page-header-main">
                <ol class="aui-nav aui-nav-breadcrumbs">
                 <li><a id="project-name-val" href="/jira/browse/DERBY">Derby</a></li>
                 <li><a class="issue-link" data-issue-key="DERBY-1326" href="/jira/browse/DERBY-1326" id="key-val" rel="12340130">DERBY-1326</a></li>
                </ol>
                <h1 id="summary-val">Network server may abandon sessions when Derby system is shutdown and this causes intermittent hangs in the client</h1>
               </div>
               <!-- .aui-page-header-main -->
               <div class="aui-page-header-actions">
                <div id="issue-header-pager"></div>
               </div>
               <!-- .aui-page-header-actions -->
              </div>
              <!-- .aui-page-header-inner -->
             </header>
             <!-- .aui-page-header -->
             <div class="command-bar">
              <div class="ops-cont">
               <div class="ops-menus aui-toolbar">
                <div class="toolbar-split toolbar-split-left">
                 <ul id="opsbar-ops-login-lnk_container" class="toolbar-group pluggable-ops">
                  <li class="toolbar-item"><a id="ops-login-lnk" title="Log In" class="toolbar-trigger" href="/jira/login.jsp?os_destination=%2Fbrowse%2FDERBY-1326"><span class="trigger-label">Log In</span></a></li>
                 </ul>
                 <ul id="opsbar-opsbar-operations" class="toolbar-group pluggable-ops"></ul>
                 <ul id="opsbar-opsbar-transitions" class="toolbar-group pluggable-ops"></ul>
                 <ul id="opsbar-opsbar-admin" class="toolbar-group pluggable-ops"></ul>
                </div>
                <div class="toolbar-split toolbar-split-right">
                 <ul id="opsbar-jira.issue.tools" class="toolbar-group pluggable-ops">
                  <li class="toolbar-item">
                   <div>
                    <a href="#" id="viewissue-export" aria-owns="viewissue-export_drop" aria-haspopup="true" title="Export this issue in another format" class="toolbar-trigger aui-button aui-style-default aui-dropdown2-trigger"><span class="icon icon-default aui-icon aui-icon-small aui-iconfont-export"></span> <span class="dropdown-text">Export</span></a>
                    <div id="viewissue-export_drop" class="aui-style-default aui-dropdown2">
                     <ul>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-xml/DERBY-1326/DERBY-1326.xml" id="jira.issueviews:issue-xml"><span class="trigger-label">XML</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-word/DERBY-1326/DERBY-1326.doc" id="jira.issueviews:issue-word"><span class="trigger-label">Word</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-html/DERBY-1326/DERBY-1326.html" id="jira.issueviews:issue-html"><span class="trigger-label">Printable</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/com.atlassian.jira.plugins.jira-importers-plugin:issue-json/DERBY-1326/DERBY-1326.json" id="com.atlassian.jira.plugins.jira-importers-plugin:issue-json"><span class="trigger-label">JSON</span></a></li>
                     </ul>
                    </div>
                   </div></li>
                 </ul>
                </div>
               </div>
              </div>
             </div>
            </div>
           </header>
           <div class="issue-body-content">
            <div class="aui-group issue-body">
             <div class="aui-item issue-main-column">
              <div id="details-module" class="module toggle-wrap">
               <div id="details-module_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Details</h2>
               </div>
               <div class="mod-content"> 
                <ul id="issuedetails" class="property-list two-cols"> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Type:</strong> 
                   <span id="type-val" class="value"> <img alt="" height="16" src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype" title="Bug - A problem which impairs or prevents the functions of the product." width="16"> Bug </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Status:</strong> 
                   <span id="status-val" class="value"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done jira-issue-status-lozenge-max-width-medium" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </span> 
                  </div> </li> 
                 <li class="item new"> 
                  <div class="wrap"> 
                   <strong class="name">Priority:</strong> 
                   <span id="priority-val" class="value"> <img alt="" height="16" src="/jira/images/icons/priorities/major.svg" title="Major - Major loss of function." width="16"> Major </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Resolution:</strong> 
                   <span id="resolution-val" class="value resolved"> Fixed </span> 
                  </div> </li> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Affects Version/s:</strong> 
                   <span id="versions-val" class="value"> None </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Fix Version/s:</strong> 
                   <span id="fixfor-val" class="value"> <span class="shorten" id="fixVersions-field"> <a href="/jira/issues/?jql=project+%3D+DERBY+AND+fixVersion+%3D+10.2.1.6" title="10.2.1.6 ">10.2.1.6</a>, <a href="/jira/issues/?jql=project+%3D+DERBY+AND+fixVersion+%3D+10.3.1.4" title="10.3.1.4 ">10.3.1.4</a> </span> </span> 
                  </div> </li> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Component/s:</strong> 
                   <span id="components-val" class="value"> <span class="shorten" id="components-field"> <a href="/jira/issues/?jql=project+%3D+DERBY+AND+component+%3D+%22Network+Server%22" title="Network Server ">Network Server</a> </span> </span> 
                  </div> </li> 
                 <li class="item full-width"> 
                  <div class="wrap" id="wrap-labels"> 
                   <strong class="name">Labels:</strong> 
                   <div class="labels-wrap value"> 
                    <span class="labels" id="labels-12340130-value">None</span> 
                   </div> 
                  </div> </li> 
                </ul> 
               </div>
              </div>
              <div id="descriptionmodule" class="module toggle-wrap">
               <div id="descriptionmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Description</h2>
               </div>
               <div class="mod-content">
                <div id="description-val" class="field-ignore-highlight"> 
                 <div class="user-content-block"> 
                  <p>This issue was found when working on <a href="https://issues.apache.org/jira/browse/DERBY-1219" title="jdbcapi/checkDataSource.java and jdbcapi/checkDataSource30.java hang intermittently with client" class="issue-link" data-issue-key="DERBY-1219"><del>DERBY-1219</del></a>. More details can be found in the comments at <a href="http://issues.apache.org/jira/browse/DERBY-1219" class="external-link" rel="nofollow">http://issues.apache.org/jira/browse/DERBY-1219</a></p> 
                 </div> 
                </div> 
               </div>
              </div>
              <div id="dnd-metadata" class="module toggle-wrap">
               <div id="dnd-metadata_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Attachments</h2>
               </div>
               <div class="mod-content">
                <div id="dnd-metadata-webpanel" data-can-attach="false" data-project-type="software" data-upload-limit="62914560" data-thumbnails-allowed="false"></div>
               </div>
              </div>
              <div id="attachmentmodule" class="module toggle-wrap">
               <div id="attachmentmodule_heading" class="mod-header">
                <ul class="ops">
                 <li class="drop">
                  <div class="aui-dd-parent">
                   <a href="#" class="icon drop-menu js-default-dropdown" title="Options"><span>Options</span></a>
                   <div class="aui-dropdown-content aui-list">
                    <ul id="attachment-sorting-options" class="aui-list-section aui-first">
                     <li class="aui-list-item"><a id="attachment-sort-key-name" href="/jira/browse/DERBY-1326?attachmentSortBy=fileName#attachmentmodule" class="aui-list-checked aui-checked aui-list-item-link" title="viewissue.subtasks.tab.show.all.name"><span>Sort By Name</span></a></li>
                     <li class="aui-list-item"><a id="attachment-sort-key-date" href="/jira/browse/DERBY-1326?attachmentSortBy=dateTime#attachmentmodule" class="aui-list-checked aui-list-item-link" title="Sort By Date"><span>Sort By Date</span></a></li>
                    </ul>
                    <ul id="attachment-sorting-order-options" class="aui-list-section aui-last">
                     <li class="aui-list-item"><a id="attachment-sort-direction-asc" href="/jira/browse/DERBY-1326?attachmentOrder=asc#attachmentmodule" class="aui-list-checked aui-checked aui-list-item-link" title="Ascending"><span>Ascending</span></a></li>
                     <li class="aui-list-item"><a id="attachment-sort-direction-desc" href="/jira/browse/DERBY-1326?attachmentOrder=desc#attachmentmodule" class="aui-list-checked aui-list-item-link" title="Descending"><span>Descending</span></a></li>
                    </ul>
                   </div>
                  </div></li>
                </ul>
                <h2 class="toggle-title">Attachments</h2>
               </div>
               <div class="mod-content">
                <ol id="file_attachments" class="item-attachments" data-sort-key="fileName" data-sort-order="asc">
                 <li class="attachment-content js-file-attachment" data-attachment-id="12341066" data-issue-id="12340130" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12341066/derby-1326-checkds.diff" draggable="true" data-downloadurl="text/x-diff:derby-1326-checkds.diff:https://issues.apache.org/jira/secure/attachment/12341066/derby-1326-checkds.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12341066/derby-1326-checkds.diff" title="Latest  18/Sep/06 16:35 - Knut Anders Hatlen" draggable="true" data-downloadurl="text/x-diff:derby-1326-checkds.diff:https://issues.apache.org/jira/secure/attachment/12341066/derby-1326-checkds.diff">derby-1326-checkds.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2006-09-18T16:35:07.000Z">18/Sep/06 16:35</time>
                   </dd>
                   <dd class="attachment-size">
                    3 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12340844" data-issue-id="12340130" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12340844/derby-1326-cleanup_exceptions.diff" draggable="true" data-downloadurl="text/x-patch:derby-1326-cleanup_exceptions.diff:https://issues.apache.org/jira/secure/attachment/12340844/derby-1326-cleanup_exceptions.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12340844/derby-1326-cleanup_exceptions.diff" title="Latest  14/Sep/06 14:39 - Knut Anders Hatlen" draggable="true" data-downloadurl="text/x-patch:derby-1326-cleanup_exceptions.diff:https://issues.apache.org/jira/secure/attachment/12340844/derby-1326-cleanup_exceptions.diff">derby-1326-cleanup_exceptions.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2006-09-14T14:39:40.000Z">14/Sep/06 14:39</time>
                   </dd>
                   <dd class="attachment-size">
                    3 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12341604" data-issue-id="12340130" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12341604/derby-1326-restartTest.diff" draggable="true" data-downloadurl="text/x-diff:derby-1326-restartTest.diff:https://issues.apache.org/jira/secure/attachment/12341604/derby-1326-restartTest.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12341604/derby-1326-restartTest.diff" title="Latest  25/Sep/06 09:06 - Knut Anders Hatlen" draggable="true" data-downloadurl="text/x-diff:derby-1326-restartTest.diff:https://issues.apache.org/jira/secure/attachment/12341604/derby-1326-restartTest.diff">derby-1326-restartTest.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2006-09-25T09:06:09.000Z">25/Sep/06 09:06</time>
                   </dd>
                   <dd class="attachment-size">
                    2 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12340921" data-issue-id="12340130" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12340921/derby-1326-skipThreads.diff" draggable="true" data-downloadurl="text/x-diff:derby-1326-skipThreads.diff:https://issues.apache.org/jira/secure/attachment/12340921/derby-1326-skipThreads.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12340921/derby-1326-skipThreads.diff" title="Latest  15/Sep/06 13:40 - Knut Anders Hatlen" draggable="true" data-downloadurl="text/x-diff:derby-1326-skipThreads.diff:https://issues.apache.org/jira/secure/attachment/12340921/derby-1326-skipThreads.diff">derby-1326-skipThreads.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2006-09-15T13:40:42.000Z">15/Sep/06 13:40</time>
                   </dd>
                   <dd class="attachment-size">
                    1.0 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12334415" data-issue-id="12340130" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12334415/repro1326.java" draggable="true" data-downloadurl="text/java:repro1326.java:https://issues.apache.org/jira/secure/attachment/12334415/repro1326.java"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12334415/repro1326.java" title="Latest  23/May/06 00:18 - Deepa Remesh" draggable="true" data-downloadurl="text/java:repro1326.java:https://issues.apache.org/jira/secure/attachment/12334415/repro1326.java">repro1326.java</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2006-05-23T00:18:49.000Z">23/May/06 00:18</time>
                   </dd>
                   <dd class="attachment-size">
                    1 kB
                   </dd>
                   <dd class="attachment-author">
                    Deepa Remesh
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12335055" data-issue-id="12340130" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12335055/resolve_DRDConnThread_conflict.diff" draggable="true" data-downloadurl="application/octet-stream:resolve_DRDConnThread_conflict.diff:https://issues.apache.org/jira/secure/attachment/12335055/resolve_DRDConnThread_conflict.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12335055/resolve_DRDConnThread_conflict.diff" title="Latest  06/Jun/06 04:54 - Bryan Pendleton" draggable="true" data-downloadurl="application/octet-stream:resolve_DRDConnThread_conflict.diff:https://issues.apache.org/jira/secure/attachment/12335055/resolve_DRDConnThread_conflict.diff">resolve_DRDConnThread_conflict.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2006-06-06T04:54:08.000Z">06/Jun/06 04:54</time>
                   </dd>
                   <dd class="attachment-size">
                    12 kB
                   </dd>
                   <dd class="attachment-author">
                    Bryan Pendleton
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12340643" data-issue-id="12340130" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12340643/Restart.java" draggable="true" data-downloadurl="text/plain:Restart.java:https://issues.apache.org/jira/secure/attachment/12340643/Restart.java"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-txt" title="Text File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12340643/Restart.java" title="Latest  12/Sep/06 11:27 - Knut Anders Hatlen" draggable="true" data-downloadurl="text/plain:Restart.java:https://issues.apache.org/jira/secure/attachment/12340643/Restart.java">Restart.java</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2006-09-12T11:27:45.000Z">12/Sep/06 11:27</time>
                   </dd>
                   <dd class="attachment-size">
                    2 kB
                   </dd>
                   <dd class="attachment-author">
                    Knut Anders Hatlen
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12334630" data-issue-id="12340130" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12334630/sessionMgmt1_and_nosessionsforclosedthreads.diff" draggable="true" data-downloadurl="text/x-patch:sessionMgmt1_and_nosessionsforclosedthreads.diff:https://issues.apache.org/jira/secure/attachment/12334630/sessionMgmt1_and_nosessionsforclosedthreads.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12334630/sessionMgmt1_and_nosessionsforclosedthreads.diff" title="Latest  26/May/06 23:55 - Deepa Remesh" draggable="true" data-downloadurl="text/x-patch:sessionMgmt1_and_nosessionsforclosedthreads.diff:https://issues.apache.org/jira/secure/attachment/12334630/sessionMgmt1_and_nosessionsforclosedthreads.diff">sessionMgmt1_and_nosessionsforclosedthreads.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2006-05-26T23:55:50.000Z">26/May/06 23:55</time>
                   </dd>
                   <dd class="attachment-size">
                    8 kB
                   </dd>
                   <dd class="attachment-author">
                    Deepa Remesh
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12334540" data-issue-id="12340130" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12334540/sessionMgmt1.diff" draggable="true" data-downloadurl="application/octet-stream:sessionMgmt1.diff:https://issues.apache.org/jira/secure/attachment/12334540/sessionMgmt1.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12334540/sessionMgmt1.diff" title="Latest  25/May/06 09:14 - Bryan Pendleton" draggable="true" data-downloadurl="application/octet-stream:sessionMgmt1.diff:https://issues.apache.org/jira/secure/attachment/12334540/sessionMgmt1.diff">sessionMgmt1.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2006-05-25T09:14:05.000Z">25/May/06 09:14</time>
                   </dd>
                   <dd class="attachment-size">
                    7 kB
                   </dd>
                   <dd class="attachment-author">
                    Bryan Pendleton
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12335321" data-issue-id="12340130" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12335321/unify_NSImpl_instances.diff" draggable="true" data-downloadurl="application/octet-stream:unify_NSImpl_instances.diff:https://issues.apache.org/jira/secure/attachment/12335321/unify_NSImpl_instances.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12335321/unify_NSImpl_instances.diff" title="Latest  12/Jun/06 00:47 - Bryan Pendleton" draggable="true" data-downloadurl="application/octet-stream:unify_NSImpl_instances.diff:https://issues.apache.org/jira/secure/attachment/12335321/unify_NSImpl_instances.diff">unify_NSImpl_instances.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2006-06-12T00:47:57.000Z">12/Jun/06 00:47</time>
                   </dd>
                   <dd class="attachment-size">
                    4 kB
                   </dd>
                   <dd class="attachment-author">
                    Bryan Pendleton
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12334997" data-issue-id="12340130" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12334997/withNewThreadAndNoShutdownOfCurrentSession.diff" draggable="true" data-downloadurl="application/octet-stream:withNewThreadAndNoShutdownOfCurrentSession.diff:https://issues.apache.org/jira/secure/attachment/12334997/withNewThreadAndNoShutdownOfCurrentSession.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12334997/withNewThreadAndNoShutdownOfCurrentSession.diff" title="Latest  05/Jun/06 00:11 - Bryan Pendleton" draggable="true" data-downloadurl="application/octet-stream:withNewThreadAndNoShutdownOfCurrentSession.diff:https://issues.apache.org/jira/secure/attachment/12334997/withNewThreadAndNoShutdownOfCurrentSession.diff">withNewThreadAndNoShutdownOfCurrentSession.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2006-06-05T00:11:33.000Z">05/Jun/06 00:11</time>
                   </dd>
                   <dd class="attachment-size">
                    12 kB
                   </dd>
                   <dd class="attachment-author">
                    Bryan Pendleton
                   </dd>
                  </dl></li>
                </ol>
               </div>
              </div>
              <div id="linkingmodule" class="module toggle-wrap">
               <div id="linkingmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Issue Links</h2>
               </div>
               <div class="mod-content"> 
                <div class="links-container" data-default-link-icon="/jira/images/icons/generic_link_16.png"> 
                 <dl class="links-list "> 
                  <dt title="relates to">
                   relates to
                  </dt> 
                  <dd id="internal-12349317_10030"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype" width="16" height="16" title="Bug - A problem which impairs or prevents the functions of the product." alt="Bug - A problem which impairs or prevents the functions of the product."> <span title="DERBY-1817: Race condition in network server's thread pool"> <a href="/jira/browse/DERBY-1817" data-issue-key="DERBY-1817" class="issue-link link-title resolution">DERBY-1817</a> <span class="link-summary">Race condition in network server's thread pool</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                 </dl> 
                </div> 
               </div>
              </div>
              <div id="activitymodule" class="module toggle-wrap">
               <div id="activitymodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Activity</h2>
               </div>
               <div class="mod-content"> 
                <big-pipe data-id="activity-panel-pipe-id" style="height: 70px"> 
                 <div></div> 
                </big-pipe> 
               </div>
              </div>
             </div>
             <div id="viewissuesidebar" class="aui-item issue-side-column">
              <div id="peoplemodule" class="module toggle-wrap">
               <div id="peoplemodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">People</h2>
               </div>
               <div class="mod-content"> 
                <ul class="item-details" id="peopledetails"> 
                 <li class="people-details"> 
                  <dl> 
                   <dt>
                    Assignee:
                   </dt> 
                   <dd> 
                    <span id="assignee-val" class="view-issue-field"> <span class="user-hover" id="issue_summary_assignee_knutanders" rel="knutanders" data-user="{&quot;avatarUrl&quot;:&quot;https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10452&quot;,&quot;displayName&quot;:&quot;Knut Anders Hatlen&quot;,&quot;emailAddress&quot;:&quot;knut.hatlen@oracle.com&quot;,&quot;username&quot;:&quot;knutanders&quot;}"> <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img src="https://issues.apache.org/jira/secure/useravatar?size=small&amp;avatarId=10452" alt="knutanders"></span></span> Knut Anders Hatlen </span> </span> 
                   </dd> 
                  </dl> 
                  <dl> 
                   <dt>
                    Reporter:
                   </dt> 
                   <dd> 
                    <span id="reporter-val" class="view-issue-field"> <span class="user-hover" id="issue_summary_reporter_deepa" rel="deepa" data-user="{&quot;avatarUrl&quot;:&quot;https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=34050&quot;,&quot;displayName&quot;:&quot;Deepa Remesh&quot;,&quot;emailAddress&quot;:&quot;dremesh@gmail.com&quot;,&quot;username&quot;:&quot;deepa&quot;}"> <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img src="https://issues.apache.org/jira/secure/useravatar?size=small&amp;avatarId=34050" alt="deepa"></span></span> Deepa Remesh </span> </span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
                <ul class="item-details"> 
                 <li> 
                  <dl> 
                   <dt>
                    Votes:
                   </dt> 
                   <dd> 
                    <span id="vote-data" class="aui-badge vote-state-off">0</span> 
                    <span id="vote-label" title="You have to be logged in to vote for an issue.">Vote for this issue</span> 
                   </dd> 
                  </dl> 
                  <dl> 
                   <dt>
                    Watchers:
                   </dt> 
                   <dd> 
                    <span id="watcher-data" class="aui-badge watch-state-off">0</span> 
                    <span id="watch-label" title="You have to be logged in to watch an issue.">Start watching this issue</span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
               </div>
              </div>
              <div id="datesmodule" class="module toggle-wrap">
               <div id="datesmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Dates</h2>
               </div>
               <div class="mod-content"> 
                <ul class="item-details"> 
                 <li> 
                  <dl class="dates"> 
                   <dt>
                    Created:
                   </dt> 
                   <dd class="date user-tz" title="16/May/06 00:27"> 
                    <span data-name="Created" id="created-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2006-05-16T00:27:56+0000">16/May/06 00:27</time> </span> 
                   </dd> 
                  </dl> 
                  <dl class="dates"> 
                   <dt>
                    Updated:
                   </dt> 
                   <dd class="date user-tz" title="25/Sep/06 14:54"> 
                    <span data-name="Updated" id="updated-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2006-09-25T14:54:54+0000">25/Sep/06 14:54</time> </span> 
                   </dd> 
                  </dl> 
                  <dl class="dates"> 
                   <dt>
                    Resolved:
                   </dt> 
                   <dd class="date user-tz" title="25/Sep/06 09:14"> 
                    <span data-name="Resolved" id="resolutiondate-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2006-09-25T09:14:24+0000">25/Sep/06 09:14</time> </span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
               </div>
              </div>
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
     <!-- .aui-page-panel-inner -->
    </div>
    <!-- .aui-page-panel -->
    <div class="issue-navigator-init"></div> 
   </section> 
   <footer id="footer" role="contentinfo"> 
    <section class="footer-body"> 
     <ul class="atlassian-footer"> 
      <li> Atlassian JIRA <a class="seo-link" rel="nofollow" href="https://www.atlassian.com/software/jira">Project Management Software</a> <span id="footer-build-information">(v7.6.3#76005-<span title="8a4e38d34af948780dbf52044e7aafb13a7cae58" data-commit-id="8a4e38d34af948780dbf52044e7aafb13a7cae58}">sha1:8a4e38d</span>)</span> </li> 
      <li> <a id="about-link" rel="nofollow" href="/jira/secure/AboutPage.jspa/secure/AboutPage.jspa">About JIRA</a> </li> 
      <li> <a id="footer-report-problem-link" rel="nofollow" href="/jira/secure/CreateIssue!default.jspa">Report a problem</a> </li> 
     </ul> 
     <ul class="atlassian-footer"> 
      <li class="licensemessage"> Powered by a free Atlassian <a rel="nofollow" href="http://www.atlassian.com/software/jira">JIRA</a> open source license for Apache Software Foundation. Try JIRA - <a rel="nofollow" href="http://www.atlassian.com/software/jira">bug tracking software</a> for <i>your</i> team. </li> 
     </ul> 
     <div id="footer-logo">
      <a rel="nofollow" href="http://www.atlassian.com/">Atlassian</a>
     </div> 
    </section> 
    <fieldset class="hidden parameters"> 
     <input type="hidden" title="loggedInUser" value=""> 
     <input type="hidden" title="ajaxTimeout" value="The call to the JIRA server did not complete within the timeout period.  We are unsure of the result of this operation."> 
     <input type="hidden" title="JiraVersion" value="7.6.3"> 
     <input type="hidden" title="ajaxUnauthorised" value="You are not authorised to perform this operation. Please log in."> 
     <input type="hidden" title="baseURL" value="https://issues.apache.org/jira"> 
     <input type="hidden" title="ajaxCommsError" value="The JIRA server could not be contacted. This may be a temporary glitch or the server may be down. "> 
     <input type="hidden" title="ajaxServerError" value="The JIRA server was contacted but has returned an error response. We are unsure of the result of this operation."> 
     <input type="hidden" title="ajaxErrorCloseDialog" value="Close this dialog and press refresh in your browser"> 
     <input type="hidden" title="ajaxErrorDialogHeading" value="Communications Breakdown"> 
     <input type="hidden" title="dirtyMessage" value="You have entered new data on this page. If you navigate away from this page without first saving your data, the changes will be lost."> 
     <input type="hidden" title="dirtyDialogMessage" value="You have entered new data in this dialog. If you navigate away from this dialog without first saving your data, the changes will be lost. Click cancel to return to the dialog."> 
     <input type="hidden" title="keyType" value="Type"> 
     <input type="hidden" title="keyThen" value="then"> 
     <input type="hidden" title="dblClickToExpand" value="Double click to expand"> 
     <input type="hidden" title="actions" value="Actions"> 
     <input type="hidden" title="removeItem" value="Remove"> 
     <input type="hidden" title="workflow" value="Workflow"> 
     <input type="hidden" title="labelNew" value="New Label"> 
     <input type="hidden" title="issueActionsHint" value="Begin typing for available operations or press down to see all"> 
     <input type="hidden" title="closelink" value="Close"> 
     <input type="hidden" title="dotOperations" value="Operations"> 
     <input type="hidden" title="dotLoading" value="Loading..."> 
     <input type="hidden" title="frotherSuggestions" value="Suggestions"> 
     <input type="hidden" title="frotherNomatches" value="No Matches"> 
     <input type="hidden" title="multiselectVersionsError" value="{0} is not a valid version."> 
     <input type="hidden" title="multiselectComponentsError" value="{0} is not a valid component."> 
     <input type="hidden" title="multiselectGenericError" value="The value {0} is invalid."> 
    </fieldset> 
   </footer> 
  </div> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:bigpipe-js/jira.webresources:bigpipe-js.js" data-wrm-key="jira.webresources:bigpipe-js" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["activity-panel-pipe-id"]="\"\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n    \u003cdiv class=\\\"tabwrap tabs2\\\"\u003e\\n\\n        \u003cul id=\\\"issue-tabs\\\" class=\\\"tabs horizontal\\\"\u003e\\n                                \\n            \u003cli  data-id=\\\"all-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\" data-label=\\\"All\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-1326?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"all-tabpanel\\\" href=\\\"\\/jira\\/browse\\/DERBY-1326?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\"\u003e\u003cstrong\u003eAll\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  class=\\\"active\\\" id=\\\"comment-tabpanel\\\"  data-id=\\\"comment-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel\\\" data-label=\\\"Comments\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-1326?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel\\\"\u003e\\n                            \u003cstrong tabindex=\\\"0\\\"\u003eComments\u003c\\/strong\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"worklog-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\" data-label=\\\"Work Log\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-1326?page=com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"worklog-tabpanel\\\" href=\\\"\\/jira\\/browse\\/DERBY-1326?page=com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\"\u003e\u003cstrong\u003eWork Log\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"changehistory-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\" data-label=\\\"History\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-1326?page=com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"changehistory-tabpanel\\\" href=\\\"\\/jira\\/browse\\/DERBY-1326?page=com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\"\u003e\u003cstrong\u003eHistory\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"activity-stream-issue-tab\\\" data-key=\\\"com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\" data-label=\\\"Activity\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-1326?page=com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"activity-stream-issue-tab\\\" href=\\\"\\/jira\\/browse\\/DERBY-1326?page=com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\"\u003e\u003cstrong\u003eActivity\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"transitions-summary-tabpanel\\\" data-key=\\\"com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\" data-label=\\\"Transitions\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-1326?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"transitions-summary-tabpanel\\\" href=\\\"\\/jira\\/browse\\/DERBY-1326?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\"\u003e\u003cstrong\u003eTransitions\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                \u003c\\/ul\u003e\\n\\n                    \u003cdiv class=\\\"sortwrap\\\"\u003e\\n                                    \u003ca class=\\\"issue-activity-sort-link ajax-activity-content\\\" rel=\\\"nofollow\\\" data-tab-sort data-order=\\\"desc\\\" href=\\\"\\/jira\\/browse\\/DERBY-1326?actionOrder=desc\\\" title=\\\"Ascending order - Click to sort in descending order\\\"\u003e\\n                        \u003cspan class=\\\"aui-icon aui-icon-small aui-iconfont-up\\\"\u003eAscending order - Click to sort in descending order\u003c\\/span\u003e\\n                    \u003c\\/a\u003e\\n                            \u003c\\/div\u003e\\n            \u003c\\/div\u003e\\n    \u003cdiv class=\\\"issuePanelWrapper\\\"\u003e\\n        \u003cdiv class=\\\"issuePanelProgress\\\"\u003e\u003c\\/div\u003e\\n        \u003cdiv class=\\\"issuePanelContainer\\\" id=\\\"issue_actions_container\\\"\u003e\\n                                    \\n\\n\\n\u003cdiv id=\\\"comment-12402448\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12402448&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12402448\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12402448_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12402448_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/May\\/06 05:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-05-16T05:48:09+0000\'\u003e16\\/May\\/06 05:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eTo repro this issue, run the test jdbcapi\\/checkDataSource.java with client framework. The test will hang intermittently. \u003c\\/p\u003e\\n\\n\u003cp\u003eTo avoid this hang, the code for system shutdown is currently not executed when running with client driver. This condition has to be removed when this issue is resolved.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12402448_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12402448_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/May\\/06 05:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-05-16T05:48:09+0000\'\u003e16\\/May\\/06 05:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    To repro this issue, run the test jdbcapi\\/checkDataSource.java with client framework. The test will hang intermittently.  \\n\\n To avoid this hang, the code for system shutdown is currently not executed when running with client driver. This condition has to be removed when this issue is resolved.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12412579\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12412579&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12412579\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12412579_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12412579_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/May\\/06 02:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-05-20T02:15:00+0000\'\u003e20\\/May\\/06 02:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI am interested in working on this problem. I have some thoughts and ideas which I will try to develop on the wiki and on the mailing list. As the discussion evolves, hopefully the proper solution will become clear.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12412579_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12412579_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/May\\/06 02:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-05-20T02:15:00+0000\'\u003e20\\/May\\/06 02:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I am interested in working on this problem. I have some thoughts and ideas which I will try to develop on the wiki and on the mailing list. As the discussion evolves, hopefully the proper solution will become clear.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12412653\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12412653&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12412653\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12412653_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12412653_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/May\\/06 06:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-05-21T06:48:17+0000\'\u003e21\\/May\\/06 06:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'ve placed some background notes at \u003ca href=\\\"http:\\/\\/wiki.apache.org\\/db-derby\\/NetworkServerSessionManagement\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/wiki.apache.org\\/db-derby\\/NetworkServerSessionManagement\u003c\\/a\u003e. I\'d like to get some review and checking of this background material before moving on to the next step. Thanks!\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12412653_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12412653_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'21\\/May\\/06 06:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-05-21T06:48:17+0000\'\u003e21\\/May\\/06 06:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'ve placed some background notes at  http:\\/\\/wiki.apache.org\\/db-derby\\/NetworkServerSessionManagement . I\'d like to get some review and checking of this background material before moving on to the next step. Thanks!              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12412804\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12412804&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12412804\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12412804_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12412804_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/May\\/06 00:18\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-05-23T00:18:49+0000\'\u003e23\\/May\\/06 00:18\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eBryan, I took a quick look at excellent Wiki page you created about network server session management. I have one minor comment. In the sections for Session lifetime, it may be good to note that these are also ended when the network server restarts (when Derby system is shutdown) or shuts down. For DRDAConnThread lifetime, it would be good to mention about network server restart as this seems to be the cause of the bugs we are seeing.\u003c\\/p\u003e\\n\\n\u003cp\u003eI am also attaching a smaller repro \'repro1326.java\' I had created to simulate the hang. With this repro too, the hang is intermittent. I have not been able to get a predictable hang so far. To run the repro, start network server on port 1527 and run \'java -Dframework=DerbyNetClient repro1326\'. \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12412804_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12412804_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/May\\/06 00:18\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-05-23T00:18:49+0000\'\u003e23\\/May\\/06 00:18\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Bryan, I took a quick look at excellent Wiki page you created about network server session management. I have one minor comment. In the sections for Session lifetime, it may be good to note that these are also ended when the network server restarts (when Derby system is shutdown) or shuts down. For DRDAConnThread lifetime, it would be good to mention about network server restart as this seems to be the cause of the bugs we are seeing. \\n\\n I am also attaching a smaller repro \'repro1326.java\' I had created to simulate the hang. With this repro too, the hang is intermittent. I have not been able to get a predictable hang so far. To run the repro, start network server on port 1527 and run \'java -Dframework=DerbyNetClient repro1326\'.               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12413203\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12413203&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12413203\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12413203_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12413203_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/May\\/06 09:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-05-25T09:14:05+0000\'\u003e25\\/May\\/06 09:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'ve been experimenting with the attached patch \\\"sessionMgmt1.diff\\\". In my environment, it resolves the hang in checkDataSource, and it also passes Deepa\'s custom \\\"repro1326\\\" test, even after I modified that test to run the shutdown test case 200 times. So I\'m starting to feel it\'s pretty reliable as far as avoiding hangs.\u003c\\/p\u003e\\n\\n\u003cp\u003eHowever, I\'m not completely happy with it. One issue is that I\'m still seeing situations in which a closed() DRDAConnThread is given a non-closed Session to run, which I think is incorrect behavior (non-closed sessions should only be assigned to non-closed threads).\u003c\\/p\u003e\\n\\n\u003cp\u003eSo I\'ve still got a ways to go on this problem. But since I\'ve had some significant progress, I wanted to post the work-in-progress changes in order to get feedback, and in order not to lose them.\u003c\\/p\u003e\\n\\n\u003cp\u003eComments and suggestions most welcome!\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12413203_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12413203_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/May\\/06 09:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-05-25T09:14:05+0000\'\u003e25\\/May\\/06 09:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'ve been experimenting with the attached patch \\\"sessionMgmt1.diff\\\". In my environment, it resolves the hang in checkDataSource, and it also passes Deepa\'s custom \\\"repro1326\\\" test, even after I modified that test to run the shutdown test case 200 times. So I\'m starting to feel it\'s pretty reliable as far as avoiding hangs. \\n\\n However, I\'m not completely happy with it. One issue is that I\'m still seeing situations in which a closed() DRDAConnThread is given a non-closed Session to run, which I think is incorrect behavior (non-closed sessions should only be assigned to non-closed threads). \\n\\n So I\'ve still got a ways to go on this problem. But since I\'ve had some significant progress, I wanted to post the work-in-progress changes in order to get feedback, and in order not to lose them. \\n\\n Comments and suggestions most welcome!              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12413319\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12413319&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12413319\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12413319_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12413319_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/May\\/06 06:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-05-26T06:51:50+0000\'\u003e26\\/May\\/06 06:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eBryan, I applied the patch and ran the repro. I do not get the hang but seeing this exception instead of the usual shutdown exception after a system shutdown:\u003c\\/p\u003e\\n\\n\u003cp\u003eEXPECTED EXCEPTION: Insufficient data while reading from the network - expected a minimum of 6 bytes and received only -1 bytes.  The connection has been terminated.\u003c\\/p\u003e\\n\\n\u003cp\u003einstead of\u003c\\/p\u003e\\n\\n\u003cp\u003eEXPECTED EXCEPTION: DERBY SQL error: SQLCODE: -1, SQLSTATE: XJ015, SQLERRMC: Derby system shutdown.\u003c\\/p\u003e\\n\\n\u003cp\u003eI am still looking at the changes but wanted to check if you get the same results with the patch ?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12413319_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12413319_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/May\\/06 06:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-05-26T06:51:50+0000\'\u003e26\\/May\\/06 06:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Bryan, I applied the patch and ran the repro. I do not get the hang but seeing this exception instead of the usual shutdown exception after a system shutdown: \\n\\n EXPECTED EXCEPTION: Insufficient data while reading from the network - expected a minimum of 6 bytes and received only -1 bytes.  The connection has been terminated. \\n\\n instead of \\n\\n EXPECTED EXCEPTION: DERBY SQL error: SQLCODE: -1, SQLSTATE: XJ015, SQLERRMC: Derby system shutdown. \\n\\n I am still looking at the changes but wanted to check if you get the same results with the patch ?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12413488\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12413488&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12413488\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12413488_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12413488_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/May\\/06 22:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-05-26T22:46:06+0000\'\u003e26\\/May\\/06 22:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi Deepa, thanks very much for looking at the patch!\u003c\\/p\u003e\\n\\n\u003cp\u003eThe new message that you see is definitely  a result of this patch; I see it as well, \u003cbr\\/\u003e\\nand should have mentioned it when I attached the patch. \u003c\\/p\u003e\\n\\n\u003cp\u003eI believe that the new symptom is a result of the code I added to DRDAConnThread\'s\u003cbr\\/\u003e\\nrun() method, to try to handle the case when a thread returns from getNextSession() to\u003cbr\\/\u003e\\nfind itself in the interesting situation of having been given a Session to run, but also having\u003cbr\\/\u003e\\nbeen closed():\u003c\\/p\u003e\\n\\n\u003cp\u003e                if (closed())\u003cbr\\/\u003e\\n+        {\u003cbr\\/\u003e\\n+            \\/\\/ FIXME &#8211; I think that if we return from\u003cbr\\/\u003e\\n+            \\/\\/ getNextSession() with a non-null Session, but\u003cbr\\/\u003e\\n+            \\/\\/ we ourselves have been closed(), this indicates\u003cbr\\/\u003e\\n+            \\/\\/ a bug in the Network Server session management,\u003cbr\\/\u003e\\n+            \\/\\/ as it shouldn\'t have assigned a valid session\u003cbr\\/\u003e\\n+            \\/\\/ to a closed thread. Closing the session here\u003cbr\\/\u003e\\n+            \\/\\/ is rude, but at least it prevents a hard hang. (\u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1326\\\" title=\\\"Network server may abandon sessions when Derby system is shutdown and this causes intermittent hangs in the client\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1326\\\"\u003e\u003cdel\u003eDERBY-1326\u003c\\/del\u003e\u003c\\/a\u003e)\u003cbr\\/\u003e\\n+            try \u003c\\/p\u003e\\n{\\n+                if (session != null)\\n+                    session.close();\\n+            }\\n\u003cp\u003ecatch (Exception e) \u003c\\/p\u003e\\n{ e.printStackTrace(); }\\n\u003cp\u003e                    break;\u003cbr\\/\u003e\\n+        }\u003c\\/p\u003e\\n\\n\u003cp\u003eIt\'s clear that this code is wrong, as evidenced by the symptoms you see.\u003c\\/p\u003e\\n\\n\u003cp\u003eNote also that in my code I didn\'t know what to do if I hit an exception; this is\u003cbr\\/\u003e\\nvery closely related to bug \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1020\\\" title=\\\"Network Server treats errors on cleanup of connections as an unexpected error after intentional shutdown of the database\\/server\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1020\\\"\u003eDERBY-1020\u003c\\/a\u003e (thanks Kathey for pointing this out).\u003c\\/p\u003e\\n\\n\u003cp\u003eThe question I have is (and this is the main question left in this bug, I think):\u003c\\/p\u003e\\n\\n\u003cp\u003e  what should the DRDAConnThread do in this situation?\u003c\\/p\u003e\\n\\n\u003cp\u003eThe possibilities I\'ve thought of include:\u003c\\/p\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eignore that fact that we\'ve been closed; re-open ourselves and handle\u003cbr\\/\u003e\\n   the Session we\'ve been given\u003c\\/li\u003e\\n\\t\u003cli\u003egive the Session back to the NetworkServerControlImpl and ask it to\u003cbr\\/\u003e\\n   assign a different thread to this task\u003c\\/li\u003e\\n\\t\u003cli\u003ehard-close the Session, then exit the thread. This was the solution I tried,\u003cbr\\/\u003e\\n   and as you can see it has some awkard side-effects.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eEither of the first two seems like it might be a reasonable approach in the\u003cbr\\/\u003e\\ncase where the Network Server was restarted, not shut down, but they both\u003cbr\\/\u003e\\nseem wrong in the case where the Network Server was shut down; in that\u003cbr\\/\u003e\\ncase it seems that the Session is doomed and we should just pack our\u003cbr\\/\u003e\\nbags and leave quietly.\u003c\\/p\u003e\\n\\n\u003cp\u003ePlease let me know what you think about how best to handle this case.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12413488_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12413488_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/May\\/06 22:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-05-26T22:46:06+0000\'\u003e26\\/May\\/06 22:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hi Deepa, thanks very much for looking at the patch! \\n\\n The new message that you see is definitely  a result of this patch; I see it as well,  \\nand should have mentioned it when I attached the patch.  \\n\\n I believe that the new symptom is a result of the code I added to DRDAConnThread\'s \\nrun() method, to try to handle the case when a thread returns from getNextSession() to \\nfind itself in the interesting situation of having been given a Session to run, but also having \\nbeen closed(): \\n\\n                 if (closed()) \\n+        { \\n+            \\/\\/ FIXME &#8211; I think that if we return from \\n+            \\/\\/ getNextSession() with a non-null Session, but \\n+            \\/\\/ we ourselves have been closed(), this indicates \\n+            \\/\\/ a bug in the Network Server session management, \\n+            \\/\\/ as it shouldn\'t have assigned a valid session \\n+            \\/\\/ to a closed thread. Closing the session here \\n+            \\/\\/ is rude, but at least it prevents a hard hang. (  DERBY-1326  ) \\n+            try  \\n{\\n+                if (session != null)\\n+                    session.close();\\n+            }\\n catch (Exception e)  \\n{ e.printStackTrace(); }\\n                     break; \\n+        } \\n\\n It\'s clear that this code is wrong, as evidenced by the symptoms you see. \\n\\n Note also that in my code I didn\'t know what to do if I hit an exception; this is \\nvery closely related to bug  DERBY-1020  (thanks Kathey for pointing this out). \\n\\n The question I have is (and this is the main question left in this bug, I think): \\n\\n   what should the DRDAConnThread do in this situation? \\n\\n The possibilities I\'ve thought of include: \\n \\n\\t ignore that fact that we\'ve been closed; re-open ourselves and handle \\n   the Session we\'ve been given \\n\\t give the Session back to the NetworkServerControlImpl and ask it to \\n   assign a different thread to this task \\n\\t hard-close the Session, then exit the thread. This was the solution I tried, \\n   and as you can see it has some awkard side-effects. \\n \\n\\n\\n Either of the first two seems like it might be a reasonable approach in the \\ncase where the Network Server was restarted, not shut down, but they both \\nseem wrong in the case where the Network Server was shut down; in that \\ncase it seems that the Session is doomed and we should just pack our \\nbags and leave quietly. \\n\\n Please let me know what you think about how best to handle this case.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12413495\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12413495&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12413495\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12413495_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12413495_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/May\\/06 23:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-05-26T23:55:50+0000\'\u003e26\\/May\\/06 23:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi Bryan,\u003c\\/p\u003e\\n\\n\u003cp\u003eI saw your question and suggestions in the previous comment while I was working on this new combined patch. So this comment may sound off-base but I am just posting my thoughts. \u003c\\/p\u003e\\n\\n\u003cp\u003eI was experimenting a bit with your patch and I think it is not the code that you added in DRDAConnThread.run method which makes this new exception appear intstead of the old one. Reason I say this is I modified your patch trying to see how we can avoid the closed_thread_getting_valid_session scenario. In this patch, I removed the code you commented with \\/\\/FIXME in DRDAConnThread.run. Even after that, I see the same exception instead of the usual shutdown exception. However, I have not figured out what is causing this new exception.\u003c\\/p\u003e\\n\\n\u003cp\u003eIn the attached trial patch \'sessionMgmt1_and_nosessionsforclosedthreads.diff\', I combined your patches \'sessionMgmt1.diff\' and \'no-sessions-for-closed-threads.diff\'. To me, it looked like \'sessionMgmt1.diff\' solves all problems which we found except for closed_thread_getting_valid_session scenario. This scenario seems to be solved by your previous patch \'no-sessions-for-closed-threads.diff\'. The problem which we found previously with \'no-sessions-for-closed-threads.diff\' was that the \\\"createSession\\\" was thinking there are freeThreads (freeThreads !=0 ). But actually the threads it were thinking as available were already closed. For the combined patch to work, freeThreads must become 0 after a restart. This is to ensure that a new thread is created when a  new session comes in after a restart. I think the interrupt calls and the added synchronization assure that freeThreads will become 0 before we start accepting new sessions. Does this sound right?\u003c\\/p\u003e\\n\\n\u003cp\u003eI have run the repro multiple times with this patch and did not see the hang.  If you think this patch makes sense, can you please try it on the machine where you can repro the hang easily to see if solves the hang? Thanks.\u003c\\/p\u003e\\n\\n\u003cp\u003eI will think more about your question and suggestions in the previous comment as I am planning to look at \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-803\\\" title=\\\"derbynet\\/DerbyNetAutoStart.java test fails intermittently with org.apache.derby.iapi.services.context.ShutdownException\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-803\\\"\u003e\u003cdel\u003eDERBY-803\u003c\\/del\u003e\u003c\\/a\u003e\\/\u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1020\\\" title=\\\"Network Server treats errors on cleanup of connections as an unexpected error after intentional shutdown of the database\\/server\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1020\\\"\u003eDERBY-1020\u003c\\/a\u003e later today.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12413495_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12413495_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'26\\/May\\/06 23:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-05-26T23:55:50+0000\'\u003e26\\/May\\/06 23:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hi Bryan, \\n\\n I saw your question and suggestions in the previous comment while I was working on this new combined patch. So this comment may sound off-base but I am just posting my thoughts.  \\n\\n I was experimenting a bit with your patch and I think it is not the code that you added in DRDAConnThread.run method which makes this new exception appear intstead of the old one. Reason I say this is I modified your patch trying to see how we can avoid the closed_thread_getting_valid_session scenario. In this patch, I removed the code you commented with \\/\\/FIXME in DRDAConnThread.run. Even after that, I see the same exception instead of the usual shutdown exception. However, I have not figured out what is causing this new exception. \\n\\n In the attached trial patch \'sessionMgmt1_and_nosessionsforclosedthreads.diff\', I combined your patches \'sessionMgmt1.diff\' and \'no-sessions-for-closed-threads.diff\'. To me, it looked like \'sessionMgmt1.diff\' solves all problems which we found except for closed_thread_getting_valid_session scenario. This scenario seems to be solved by your previous patch \'no-sessions-for-closed-threads.diff\'. The problem which we found previously with \'no-sessions-for-closed-threads.diff\' was that the \\\"createSession\\\" was thinking there are freeThreads (freeThreads !=0 ). But actually the threads it were thinking as available were already closed. For the combined patch to work, freeThreads must become 0 after a restart. This is to ensure that a new thread is created when a  new session comes in after a restart. I think the interrupt calls and the added synchronization assure that freeThreads will become 0 before we start accepting new sessions. Does this sound right? \\n\\n I have run the repro multiple times with this patch and did not see the hang.  If you think this patch makes sense, can you please try it on the machine where you can repro the hang easily to see if solves the hang? Thanks. \\n\\n I will think more about your question and suggestions in the previous comment as I am planning to look at   DERBY-803  \\/ DERBY-1020  later today.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12414193\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12414193&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12414193\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12414193_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414193_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Jun\\/06 09:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-01T09:52:41+0000\'\u003e01\\/Jun\\/06 09:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI think that the cause of the new \\\"Insufficient data\\\" exception that is appearing with sessionMgmt1.diff\u003cbr\\/\u003e\\nhas to do with a specific part of the change to the NetworkServerControlImpl restart processing.\u003c\\/p\u003e\\n\\n\u003cp\u003eI changed the restart processing so that, instead of just closing the Session objects on the RunQueue,\u003cbr\\/\u003e\\nthe restart code closes \u003cb\u003eall\u003c\\/b\u003e the Session objects in the sessionTable. In general, I think that this is\u003cbr\\/\u003e\\nthe right thing to do, as restart processing needs to close all the sessions, not just those that are\u003cbr\\/\u003e\\ncurrently waiting for a free thread.\u003c\\/p\u003e\\n\\n\u003cp\u003eHowever, the new code is too powerful, because it also closes the current Session, which is the\u003cbr\\/\u003e\\nsession which is performing the shutdown.\u003c\\/p\u003e\\n\\n\u003cp\u003eClosing the current Session terminates it before it has a chance to format and return the Shutdown Exception\u003cbr\\/\u003e\\nmessage back to the client. When the client doesn\'t get the expected Shutdown Exception, it reports\u003cbr\\/\u003e\\nthis as \\\"Insufficient data\\\".\u003c\\/p\u003e\\n\\n\u003cp\u003eIf I tweak the patch so that the restart logic is changed back to just closing the Sessions on the RunQueue,\u003cbr\\/\u003e\\nthe nasty \\\"Insufficient data\\\" exception disappears, and the client gets a much more reasonable message:\u003c\\/p\u003e\\n\\n\u003cp\u003e  ERROR XJ015: DERBY SQL error: SQLCODE: -1, SQLSTATE: XJ015, SQLERRMC: Derby system shutdown.\u003c\\/p\u003e\\n\\n\u003cp\u003eSo I think that the patch should be slightly modified, so that this critical loop in the restart processing\u003cbr\\/\u003e\\ngets implemented as:\u003c\\/p\u003e\\n\\n\u003cp\u003e  \\\"For each Session in the sessionTable, \u003cb\u003eexcept for the Session performing the shutdown\u003c\\/b\u003e, close it\\\"\u003c\\/p\u003e\\n\\n\u003cp\u003eBut I\'m not quite sure how to code that \\\"except\\\" clause.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12414193_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414193_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Jun\\/06 09:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-01T09:52:41+0000\'\u003e01\\/Jun\\/06 09:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I think that the cause of the new \\\"Insufficient data\\\" exception that is appearing with sessionMgmt1.diff \\nhas to do with a specific part of the change to the NetworkServerControlImpl restart processing. \\n\\n I changed the restart processing so that, instead of just closing the Session objects on the RunQueue, \\nthe restart code closes  all  the Session objects in the sessionTable. In general, I think that this is \\nthe right thing to do, as restart processing needs to close all the sessions, not just those that are \\ncurrently waiting for a free thread. \\n\\n However, the new code is too powerful, because it also closes the current Session, which is the \\nsession which is performing the shutdown. \\n\\n Closing the current Session terminates it before it has a chance to format and return the Shutdown Exception \\nmessage back to the client. When the client doesn\'t get the expected Shutdown Exception, it reports \\nthis as \\\"Insufficient data\\\". \\n\\n If I tweak the patch so that the restart logic is changed back to just closing the Sessions on the RunQueue, \\nthe nasty \\\"Insufficient data\\\" exception disappears, and the client gets a much more reasonable message: \\n\\n   ERROR XJ015: DERBY SQL error: SQLCODE: -1, SQLSTATE: XJ015, SQLERRMC: Derby system shutdown. \\n\\n So I think that the patch should be slightly modified, so that this critical loop in the restart processing \\ngets implemented as: \\n\\n   \\\"For each Session in the sessionTable,  except for the Session performing the shutdown , close it\\\" \\n\\n But I\'m not quite sure how to code that \\\"except\\\" clause.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12414198\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12414198&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12414198\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12414198_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414198_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Jun\\/06 10:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-01T10:33:41+0000\'\u003e01\\/Jun\\/06 10:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eDeepa, I was experimenting with your \\\"sessionMgmt1_and_nosessionsforclosedthreads.diff\\\" patch.\u003c\\/p\u003e\\n\\n\u003cp\u003eI definitely cannot reproduce any hang with this diff; the only problem I can reproduce is the\u003cbr\\/\u003e\\n\\\"Insufficient Data\\\" exception which I discussed in the previous comment above\u003cbr\\/\u003e\\n(\u003ca href=\\\"http:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1326#action_12414193\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1326#action_12414193\u003c\\/a\u003e).\u003c\\/p\u003e\\n\\n\u003cp\u003eHowever, I am concerned about a comment you made several weeks back, when we\u003cbr\\/\u003e\\nwere first discussing this problem in the context of \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1219\\\" title=\\\"jdbcapi\\/checkDataSource.java and jdbcapi\\/checkDataSource30.java hang intermittently with client\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1219\\\"\u003e\u003cdel\u003eDERBY-1219\u003c\\/del\u003e\u003c\\/a\u003e:\u003cbr\\/\u003e\\n\u003ca href=\\\"http:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1219#action_12378954\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1219#action_12378954\u003c\\/a\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eI think that your comment is still quite valid, and I am wondering how you think we should address it?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12414198_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414198_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Jun\\/06 10:33\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-01T10:33:41+0000\'\u003e01\\/Jun\\/06 10:33\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Deepa, I was experimenting with your \\\"sessionMgmt1_and_nosessionsforclosedthreads.diff\\\" patch. \\n\\n I definitely cannot reproduce any hang with this diff; the only problem I can reproduce is the \\n\\\"Insufficient Data\\\" exception which I discussed in the previous comment above \\n( http:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1326#action_12414193 ). \\n\\n However, I am concerned about a comment you made several weeks back, when we \\nwere first discussing this problem in the context of   DERBY-1219  : \\n http:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1219#action_12378954  \\n\\n I think that your comment is still quite valid, and I am wondering how you think we should address it?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12414236\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12414236&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12414236\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12414236_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414236_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Jun\\/06 20:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-01T20:57:04+0000\'\u003e01\\/Jun\\/06 20:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eBryan,\u003cbr\\/\u003e\\nCombined with your code changes in \\\"sessionMgmt1.diff \', I think my previous comment about \'no-sessions-for-closed-threads.diff\' does not hold good. This is the reason I think the combined patch is okay:\u003cbr\\/\u003e\\n\\\"\u003cbr\\/\u003e\\nThe problem which we found previously with \'no-sessions-for-closed-threads.diff\' was that the \\\"createSession\\\" was thinking there are freeThreads (freeThreads !=0 ). But actually the threads it were thinking as available were already closed. For the combined patch to work, freeThreads must become 0 after a restart. This is to ensure that a new thread is created when a new session comes in after a restart. I think the interrupt calls and the added synchronization assure that freeThreads will become 0 before we start accepting new sessions.\u003cbr\\/\u003e\\n\\\"\u003c\\/p\u003e\\n\\n\u003cp\u003eTo rephrase it,\u003c\\/p\u003e\\n\\n\u003cp\u003e1) With only \'no-sessions-for-closed-threads.diff\', we can get to the following scenario: When client starts a new session, the \\\"createSession\\\" logic in the server will check if freeThreads are available. Because of the restart, the freeThreads counter may be invalid (freeThreads !=0). This makes the \\\"createSession\\\" logic to think there are some free threads available. Hence, it will not create a new thread for the incoming session. Instead, the incoming session is put on the runQueue. However, all the existing threads were marked closed by the restart. And we do not give sessions to closed threads. So this session keeps waiting for a thread. When we start another session (e.g with ij), the hang goes away. When the connection from ij comes in, the newly created thread is able to work on the waiting session and resolve the hang. I think the patch does the right thing by not giving sessions to closed threads. However, it can sometimes cause the case of stranded sessions because of incorrect value of freeThreads counter in \\\"createSession\\\" logic.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) With the combined patch \\\"sessionMgmt1_and_nosessionsforclosedthreads.diff\\\", I think we can assume freeThreads counter will have the correct value when a new session comes in after a restart. The interrupt calls and the added synchronization assure that freeThreads will become 0 before we start accepting new sessions. If this assumption is correct, then we will not have the case of stranded sessions mentioned in 1) above.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12414236_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414236_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'01\\/Jun\\/06 20:57\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-01T20:57:04+0000\'\u003e01\\/Jun\\/06 20:57\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Bryan, \\nCombined with your code changes in \\\"sessionMgmt1.diff \', I think my previous comment about \'no-sessions-for-closed-threads.diff\' does not hold good. This is the reason I think the combined patch is okay: \\n\\\" \\nThe problem which we found previously with \'no-sessions-for-closed-threads.diff\' was that the \\\"createSession\\\" was thinking there are freeThreads (freeThreads !=0 ). But actually the threads it were thinking as available were already closed. For the combined patch to work, freeThreads must become 0 after a restart. This is to ensure that a new thread is created when a new session comes in after a restart. I think the interrupt calls and the added synchronization assure that freeThreads will become 0 before we start accepting new sessions. \\n\\\" \\n\\n To rephrase it, \\n\\n 1) With only \'no-sessions-for-closed-threads.diff\', we can get to the following scenario: When client starts a new session, the \\\"createSession\\\" logic in the server will check if freeThreads are available. Because of the restart, the freeThreads counter may be invalid (freeThreads !=0). This makes the \\\"createSession\\\" logic to think there are some free threads available. Hence, it will not create a new thread for the incoming session. Instead, the incoming session is put on the runQueue. However, all the existing threads were marked closed by the restart. And we do not give sessions to closed threads. So this session keeps waiting for a thread. When we start another session (e.g with ij), the hang goes away. When the connection from ij comes in, the newly created thread is able to work on the waiting session and resolve the hang. I think the patch does the right thing by not giving sessions to closed threads. However, it can sometimes cause the case of stranded sessions because of incorrect value of freeThreads counter in \\\"createSession\\\" logic. \\n\\n 2) With the combined patch \\\"sessionMgmt1_and_nosessionsforclosedthreads.diff\\\", I think we can assume freeThreads counter will have the correct value when a new session comes in after a restart. The interrupt calls and the added synchronization assure that freeThreads will become 0 before we start accepting new sessions. If this assumption is correct, then we will not have the case of stranded sessions mentioned in 1) above.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12414497\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12414497&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12414497\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12414497_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414497_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Jun\\/06 01:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-03T01:54:27+0000\'\u003e03\\/Jun\\/06 01:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi Deepa, thank you for the excellent analysis. It is very helpful.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe only part that troubles me is this:\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; The interrupt calls and the added synchronization assure that freeThreads will \u003cbr\\/\u003e\\n&gt; become 0 before we start accepting new sessions\u003c\\/p\u003e\\n\\n\u003cp\u003eI am not yet able to see why that is necessarily true.\u003c\\/p\u003e\\n\\n\u003cp\u003eI agree that we issue the interrupt() calls prior to completing the restart and prior\u003cbr\\/\u003e\\nto accepting new sessions.\u003c\\/p\u003e\\n\\n\u003cp\u003eHowever, the thread which is interrupted responds to this interrupt asynchronously.\u003c\\/p\u003e\\n\\n\u003cp\u003eI believe that the only guarantee made by Java is that the thread which we are interrupting\u003cbr\\/\u003e\\nwill receive that interrupt some time in the future, but not necessarily immediately,\u003cbr\\/\u003e\\nand not necessarily before we reach the end of the startNetworkServer() method\u003cbr\\/\u003e\\nand declare the restart complete.\u003c\\/p\u003e\\n\\n\u003cp\u003eIn practice, given that the startNetworkServer() method is going to unload the \u003cbr\\/\u003e\\nembedded engine, call System.gc(), and then reload the embedded engine,\u003cbr\\/\u003e\\nthat\'s probably enough work so that we have a very good chance that all the\u003cbr\\/\u003e\\nold threads have received and responded to their interrupt() before we complete.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut I don\'t think it\'s actually \u003cb\u003eguaranteed\u003c\\/b\u003e by the current changes in the combined patch.\u003c\\/p\u003e\\n\\n\u003cp\u003eI may be being too picky here. What do you think?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12414497_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414497_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Jun\\/06 01:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-03T01:54:27+0000\'\u003e03\\/Jun\\/06 01:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hi Deepa, thank you for the excellent analysis. It is very helpful. \\n\\n The only part that troubles me is this: \\n\\n &gt; The interrupt calls and the added synchronization assure that freeThreads will  \\n&gt; become 0 before we start accepting new sessions \\n\\n I am not yet able to see why that is necessarily true. \\n\\n I agree that we issue the interrupt() calls prior to completing the restart and prior \\nto accepting new sessions. \\n\\n However, the thread which is interrupted responds to this interrupt asynchronously. \\n\\n I believe that the only guarantee made by Java is that the thread which we are interrupting \\nwill receive that interrupt some time in the future, but not necessarily immediately, \\nand not necessarily before we reach the end of the startNetworkServer() method \\nand declare the restart complete. \\n\\n In practice, given that the startNetworkServer() method is going to unload the  \\nembedded engine, call System.gc(), and then reload the embedded engine, \\nthat\'s probably enough work so that we have a very good chance that all the \\nold threads have received and responded to their interrupt() before we complete. \\n\\n But I don\'t think it\'s actually  guaranteed  by the current changes in the combined patch. \\n\\n I may be being too picky here. What do you think?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12414508\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12414508&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12414508\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12414508_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414508_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Jun\\/06 02:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-03T02:46:52+0000\'\u003e03\\/Jun\\/06 02:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi Bryan, I don\'t think you are being picky. After reading your explanation, I agree the combined patch still has some chance of causing a hang. As you explain, the following need not be always true: \\\"The interrupt calls and the added synchronization assure that freeThreads will become 0 before we start accepting new sessions \\\". So the assumption that we will have the right value for freeThreads (=0) when a new session comes in after a restart does not hold good. \u003c\\/p\u003e\\n\\n\u003cp\u003eKeeping the code to reset \\\"freeThreads = 0\\\" during restart seems to be an option. But that will cause the problem that you describe under \\\"freeThreads counter maintenance\\\" in \u003ca href=\\\"http:\\/\\/wiki.apache.org\\/db-derby\\/NetworkServerSessionManagement\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/wiki.apache.org\\/db-derby\\/NetworkServerSessionManagement\u003c\\/a\u003e. The counter can become negative. \u003c\\/p\u003e\\n\\n\u003cp\u003eIf we plan to use this patch, we need to find out some way to ensure freeThreads counter is maintained correctly. \u003c\\/p\u003e\\n\\n\\n\\n\\n\\n\\n\\n\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12414508_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414508_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Jun\\/06 02:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-03T02:46:52+0000\'\u003e03\\/Jun\\/06 02:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hi Bryan, I don\'t think you are being picky. After reading your explanation, I agree the combined patch still has some chance of causing a hang. As you explain, the following need not be always true: \\\"The interrupt calls and the added synchronization assure that freeThreads will become 0 before we start accepting new sessions \\\". So the assumption that we will have the right value for freeThreads (=0) when a new session comes in after a restart does not hold good.  \\n\\n Keeping the code to reset \\\"freeThreads = 0\\\" during restart seems to be an option. But that will cause the problem that you describe under \\\"freeThreads counter maintenance\\\" in  http:\\/\\/wiki.apache.org\\/db-derby\\/NetworkServerSessionManagement . The counter can become negative.  \\n\\n If we plan to use this patch, we need to find out some way to ensure freeThreads counter is maintained correctly.  \\n\\n\\n\\n\\n\\n\\n\\n\\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12414585\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12414585&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12414585\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12414585_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414585_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Jun\\/06 22:19\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-03T22:19:51+0000\'\u003e03\\/Jun\\/06 22:19\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI had an idea about how to address the \\\"failure to create a new thread\\\" aspect\u003cbr\\/\u003e\\nof the hang, as follows:\u003c\\/p\u003e\\n\\n\u003cp\u003eSuppose that, at the end of restart processing, we go ahead and create a new\u003cbr\\/\u003e\\nDRDAConnThread instance, even though at this instance there may not be\u003cbr\\/\u003e\\nany sessions for it to process yet. If not, it will just go into getNextSession and wait.\u003c\\/p\u003e\\n\\n\u003cp\u003eWith the current combined patch, during restart processing, we \\\"poison\\\" each\u003cbr\\/\u003e\\nof the DRDAConnThread instances by closing and interrupting them, so that\u003cbr\\/\u003e\\nwe know that at some point those threads will die.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe problem that we had was that if a new session came in while all those\u003cbr\\/\u003e\\npoisoned threads were still in the process of dieing, then the create-new-session\u003cbr\\/\u003e\\nlogic might not realize that it needed to create a new thread because it might\u003cbr\\/\u003e\\nmistakenly see a non-zero freeThreads count which was counting only poisoned\u003cbr\\/\u003e\\nthreads.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut if we always create at least one new thread, then we know that the new\u003cbr\\/\u003e\\nsession will eventually get processed by that new thread.\u003c\\/p\u003e\\n\\n\u003cp\u003eIn order for this to be 100% solid I think we have to change runQueueAdd to do\u003cbr\\/\u003e\\na notifyAll(), but that\'s a slightly different topic, and I think I\'ll put that bit into\u003cbr\\/\u003e\\nthe Wiki page, because it should live beyond this bug.\u003c\\/p\u003e\\n\\n\u003cp\u003eSo, in conclusion, here is my latest idea:\u003cbr\\/\u003e\\n1) At the end of restart processing, create a new thread even though we may not\u003cbr\\/\u003e\\nhave any new sessions for it to process yet.\u003cbr\\/\u003e\\n2) change runQueueAdd to do a notifyAll(), not a notify().\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12414585_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414585_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'03\\/Jun\\/06 22:19\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-03T22:19:51+0000\'\u003e03\\/Jun\\/06 22:19\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I had an idea about how to address the \\\"failure to create a new thread\\\" aspect \\nof the hang, as follows: \\n\\n Suppose that, at the end of restart processing, we go ahead and create a new \\nDRDAConnThread instance, even though at this instance there may not be \\nany sessions for it to process yet. If not, it will just go into getNextSession and wait. \\n\\n With the current combined patch, during restart processing, we \\\"poison\\\" each \\nof the DRDAConnThread instances by closing and interrupting them, so that \\nwe know that at some point those threads will die. \\n\\n The problem that we had was that if a new session came in while all those \\npoisoned threads were still in the process of dieing, then the create-new-session \\nlogic might not realize that it needed to create a new thread because it might \\nmistakenly see a non-zero freeThreads count which was counting only poisoned \\nthreads. \\n\\n But if we always create at least one new thread, then we know that the new \\nsession will eventually get processed by that new thread. \\n\\n In order for this to be 100% solid I think we have to change runQueueAdd to do \\na notifyAll(), but that\'s a slightly different topic, and I think I\'ll put that bit into \\nthe Wiki page, because it should live beyond this bug. \\n\\n So, in conclusion, here is my latest idea: \\n1) At the end of restart processing, create a new thread even though we may not \\nhave any new sessions for it to process yet. \\n2) change runQueueAdd to do a notifyAll(), not a notify().              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12414654\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12414654&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12414654\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12414654_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414654_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Jun\\/06 00:11\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-05T00:11:33+0000\'\u003e05\\/Jun\\/06 00:11\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThis latest attachment, \'withNewThreadAndNoShutdownOfCurrentSession.diff\',\u003cbr\\/\u003e\\ncontains the following changes relative to the previous patch proposal\u003cbr\\/\u003e\\n(sessionMgmt1_and_nosessionsforclosedthreads.diff):\u003c\\/p\u003e\\n\\n\u003cp\u003e1) runQueueAdd now calls runQueue.notifyAll() rather than runQueue.notify()\u003cbr\\/\u003e\\n2) startNetworkServer now primes the thread pool by starting the first\u003cbr\\/\u003e\\nDRDAConnThread right away, rather than waiting for the first Session to come\u003cbr\\/\u003e\\nin. To make this work, I had to make a few small tweaks to DRDAConnThread\u003cbr\\/\u003e\\ninitialization so that it would defer its initialization until it had its first Session.\u003cbr\\/\u003e\\n3) startNetworkServer now takes the calling Session as an argument. In the\u003cbr\\/\u003e\\ninitial server start case this is null, but if a restart is triggered by a shutdown\u003cbr\\/\u003e\\nexception, the caller passes its Session in. startNetworkServer uses this to\u003cbr\\/\u003e\\navoid closing the Session which is triggering the restart, so it can stay open\u003cbr\\/\u003e\\nlong enough to return the shutdown exception back to the client.\u003cbr\\/\u003e\\n4) The client-masters for checkDataSource and checkDataSource30 are\u003cbr\\/\u003e\\nmodified to add the shutdown exception. This modification of the master file\u003cbr\\/\u003e\\ngoes hand-in-hand with the modification of the test program to re-enable\u003cbr\\/\u003e\\nthe server shutdown\\/restart during the test.\u003c\\/p\u003e\\n\\n\u003cp\u003ePlease take a look at this latest proposal and let me know your comments.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12414654_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414654_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'05\\/Jun\\/06 00:11\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-05T00:11:33+0000\'\u003e05\\/Jun\\/06 00:11\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    This latest attachment, \'withNewThreadAndNoShutdownOfCurrentSession.diff\', \\ncontains the following changes relative to the previous patch proposal \\n(sessionMgmt1_and_nosessionsforclosedthreads.diff): \\n\\n 1) runQueueAdd now calls runQueue.notifyAll() rather than runQueue.notify() \\n2) startNetworkServer now primes the thread pool by starting the first \\nDRDAConnThread right away, rather than waiting for the first Session to come \\nin. To make this work, I had to make a few small tweaks to DRDAConnThread \\ninitialization so that it would defer its initialization until it had its first Session. \\n3) startNetworkServer now takes the calling Session as an argument. In the \\ninitial server start case this is null, but if a restart is triggered by a shutdown \\nexception, the caller passes its Session in. startNetworkServer uses this to \\navoid closing the Session which is triggering the restart, so it can stay open \\nlong enough to return the shutdown exception back to the client. \\n4) The client-masters for checkDataSource and checkDataSource30 are \\nmodified to add the shutdown exception. This modification of the master file \\ngoes hand-in-hand with the modification of the test program to re-enable \\nthe server shutdown\\/restart during the test. \\n\\n Please take a look at this latest proposal and let me know your comments.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12414853\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12414853&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12414853\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12414853_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414853_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jun\\/06 03:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-06T03:55:51+0000\'\u003e06\\/Jun\\/06 03:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI read through the changes in \'withNewThreadAndNoShutdownOfCurrentSession.diff\' patch and I think they address all the problems found in the previous comments. I could not apply the patch to my workspace. I think some intermediate check-ins changed the same file. \u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12414853_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414853_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jun\\/06 03:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-06T03:55:51+0000\'\u003e06\\/Jun\\/06 03:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I read through the changes in \'withNewThreadAndNoShutdownOfCurrentSession.diff\' patch and I think they address all the problems found in the previous comments. I could not apply the patch to my workspace. I think some intermediate check-ins changed the same file.  \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12414869\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12414869&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12414869\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12414869_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414869_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jun\\/06 04:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-06T04:54:08+0000\'\u003e06\\/Jun\\/06 04:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks for desk-checking the patch, Deepa! I updated my workspace and resolved the merge conflicts in DRDAConnThread, and am re-attaching the patch proposal as \'resolve_DRDAConnThread_conflict.diff\'. Hopefully you can now apply this patch to the head of the trunk.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12414869_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414869_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jun\\/06 04:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-06T04:54:08+0000\'\u003e06\\/Jun\\/06 04:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks for desk-checking the patch, Deepa! I updated my workspace and resolved the merge conflicts in DRDAConnThread, and am re-attaching the patch proposal as \'resolve_DRDAConnThread_conflict.diff\'. Hopefully you can now apply this patch to the head of the trunk.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12414883\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12414883&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12414883\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12414883_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414883_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jun\\/06 06:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-06T06:50:45+0000\'\u003e06\\/Jun\\/06 06:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI applied \'resolve_DRDConnThread_conflict.diff\' and ran the repro 50 times without any hang. This patch solves the hang mentioned in this issue. Also resolves the problems discovered while working on this issue.\u003c\\/p\u003e\\n\\n\u003cp\u003eI have only minor comments:\u003c\\/p\u003e\\n\u003cul\u003e\\n\\t\u003cli\u003eIndentation seems to be out of place in NetworkServerControlImpl.java in the comment added to startNetworkServer method. Also in the changes in checkDataSource.java\u003c\\/li\u003e\\n\\t\u003cli\u003eIt may be useful to have some more comment in startNetworkServer method as to why we interrupt the threads in addition to calling close on them.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\\n\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12414883_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12414883_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Jun\\/06 06:50\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-06T06:50:45+0000\'\u003e06\\/Jun\\/06 06:50\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I applied \'resolve_DRDConnThread_conflict.diff\' and ran the repro 50 times without any hang. This patch solves the hang mentioned in this issue. Also resolves the problems discovered while working on this issue. \\n\\n I have only minor comments: \\n \\n\\t Indentation seems to be out of place in NetworkServerControlImpl.java in the comment added to startNetworkServer method. Also in the changes in checkDataSource.java \\n\\t It may be useful to have some more comment in startNetworkServer method as to why we interrupt the threads in addition to calling close on them. \\n \\n\\n\\n\\n\\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12415066\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12415066&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12415066\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12415066_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12415066_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/Jun\\/06 05:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-07T05:59:10+0000\'\u003e07\\/Jun\\/06 05:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI am seeing a hang in the test derbynet\\/DerbyNetNewServer.java with \'resolve_DRDConnThread_conflict.diff\'\' patch. \u003c\\/p\u003e\\n\\n\u003cp\u003eI was using the same workspace where I had applied this patch to try out some things for \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-803\\\" title=\\\"derbynet\\/DerbyNetAutoStart.java test fails intermittently with org.apache.derby.iapi.services.context.ShutdownException\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-803\\\"\u003e\u003cdel\u003eDERBY-803\u003c\\/del\u003e\u003c\\/a\u003e. I started seeing a hang in derbynet\\/DerbyNetNewServer.java test. On looking at the .tmp file, I found that the test itself was running to the end. It looked like it was waiting for network server process to stop. I rechecked by reverting my changes, reapplying the patch and running a full build. I was still getting a hang in the test. It looks like there are additional changes in network server shutdown introduced by this patch. \u003c\\/p\u003e\\n\\n\u003cp\u003eIn an earlier mail, Bryan had mentioned that derbyall ran successfully with this patch. This could be because of \\\"timeout=60\\\" property specified in derbynetclientmats suite. To check this, I ran the test by specifying \\\"-Dtimeout=3\\\" on the command line. Then, the test process ran to the end within the timeout period and the test passed. It had this additional line on the console:\u003cbr\\/\u003e\\n\\\"Server Process did not complete in time. Destroying...\\\"\u003c\\/p\u003e\\n\\n\u003cp\u003eBryan, if you still have the results from derbyall run with this patch, can you please check to see how long the test derbynet\\/DerbyNetNewServer.java took? If it took close to an hour to complete, it will confirm what I just observed. Otherwise, it may be a problem with my test environment.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12415066_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12415066_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'07\\/Jun\\/06 05:59\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-07T05:59:10+0000\'\u003e07\\/Jun\\/06 05:59\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I am seeing a hang in the test derbynet\\/DerbyNetNewServer.java with \'resolve_DRDConnThread_conflict.diff\'\' patch.  \\n\\n I was using the same workspace where I had applied this patch to try out some things for   DERBY-803  . I started seeing a hang in derbynet\\/DerbyNetNewServer.java test. On looking at the .tmp file, I found that the test itself was running to the end. It looked like it was waiting for network server process to stop. I rechecked by reverting my changes, reapplying the patch and running a full build. I was still getting a hang in the test. It looks like there are additional changes in network server shutdown introduced by this patch.  \\n\\n In an earlier mail, Bryan had mentioned that derbyall ran successfully with this patch. This could be because of \\\"timeout=60\\\" property specified in derbynetclientmats suite. To check this, I ran the test by specifying \\\"-Dtimeout=3\\\" on the command line. Then, the test process ran to the end within the timeout period and the test passed. It had this additional line on the console: \\n\\\"Server Process did not complete in time. Destroying...\\\" \\n\\n Bryan, if you still have the results from derbyall run with this patch, can you please check to see how long the test derbynet\\/DerbyNetNewServer.java took? If it took close to an hour to complete, it will confirm what I just observed. Otherwise, it may be a problem with my test environment.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12415277\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12415277&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12415277\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12415277_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12415277_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jun\\/06 12:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-08T12:05:48+0000\'\u003e08\\/Jun\\/06 12:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWell this is very interesting! There is always something new to learn \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eThe test program intends to do the following:\u003c\\/p\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003estart up the Network Server\u003c\\/li\u003e\\n\\t\u003cli\u003echeck that it started successfully\u003c\\/li\u003e\\n\\t\u003cli\u003eshut it down\u003c\\/li\u003e\\n\\t\u003cli\u003estart it up with a slightly different configuration\u003c\\/li\u003e\\n\\t\u003cli\u003echeck that it started successfully\u003c\\/li\u003e\\n\\t\u003cli\u003eshut it down\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eSo we think we are starting it up twice and shutting it down twice\u003c\\/p\u003e\\n\\n\u003cp\u003eWhen I investigated the hang that Deepa discovered, however, I learned that\u003cbr\\/\u003e\\nin fact we are starting up the Network Server \u003cb\u003efour\u003c\\/b\u003e times, and shutting it down\u003cbr\\/\u003e\\ntwice. These extra Network Server instances didn\'t harm anything in the past,\u003cbr\\/\u003e\\nbecause it was just a waste of memory to start up the extra instances.\u003c\\/p\u003e\\n\\n\u003cp\u003eHowever, when I added the new thread creation code in the network server\u003cbr\\/\u003e\\nstartup, it meant that whenever the network server started, a DRDAConnThread\u003cbr\\/\u003e\\nwas also started. And if that network server wasn\'t shut down, then the\u003cbr\\/\u003e\\nDRDAConnThread instance remained, and prevented the server from shutting\u003cbr\\/\u003e\\ndown, causing the hang.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe reason that we are getting the extra NetworkServerControlImpl instances is very\u003cbr\\/\u003e\\nsimple: when you call NetworkServerControlImpl.start, it does the following:\u003c\\/p\u003e\\n\\n\u003cp\u003epublic void start(PrintWriter consoleWriter)\u003cbr\\/\u003e\\n    throws Exception\u003cbr\\/\u003e\\n{\u003cbr\\/\u003e\\n    DRDAServerStarter starter = new DRDAServerStarter();\u003cbr\\/\u003e\\n    starter.setStartInfo(hostAddress,portNumber,consoleWriter);\u003cbr\\/\u003e\\n    startNetworkServer(null);\u003cbr\\/\u003e\\n    starter.boot(false,null);\u003cbr\\/\u003e\\n}\u003c\\/p\u003e\\n\\n\u003cp\u003eThat is, it directly starts this instance, then it spawns a background thread to\u003cbr\\/\u003e\\nrun the DRDAServerStarter code, which instantiates \u003cb\u003eanother\u003c\\/b\u003e NetworkServerControlImpl\u003c\\/p\u003e\\n\\n\u003cp\u003eMy first idea was to remove the call to startNetworkServer() from this method, and just\u003cbr\\/\u003e\\nlet DRDAServerStarter start up the Network Server.\u003c\\/p\u003e\\n\\n\u003cp\u003eSure enough, this fixes the hang in DerbyNetNewServer.\u003c\\/p\u003e\\n\\n\u003cp\u003eAnd, conceptually, it seems like a good change to make, because it doesn\'t seem\u003cbr\\/\u003e\\nlike we should be starting the Network Server twice.\u003c\\/p\u003e\\n\\n\u003cp\u003eHowever, removing the call to startNetworkServer causes test failures in a bunch of\u003cbr\\/\u003e\\nother Network Server tests, such as NSinSameJVM, dataSourcePermissions_net,\u003cbr\\/\u003e\\nownServerTests, and testSecMec.\u003c\\/p\u003e\\n\\n\u003cp\u003eSo, there\'s a bunch more investigation to do here \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12415277_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12415277_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'08\\/Jun\\/06 12:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-08T12:05:48+0000\'\u003e08\\/Jun\\/06 12:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Well this is very interesting! There is always something new to learn   \\n\\n The test program intends to do the following: \\n \\n\\t start up the Network Server \\n\\t check that it started successfully \\n\\t shut it down \\n\\t start it up with a slightly different configuration \\n\\t check that it started successfully \\n\\t shut it down \\n \\n\\n\\n So we think we are starting it up twice and shutting it down twice \\n\\n When I investigated the hang that Deepa discovered, however, I learned that \\nin fact we are starting up the Network Server  four  times, and shutting it down \\ntwice. These extra Network Server instances didn\'t harm anything in the past, \\nbecause it was just a waste of memory to start up the extra instances. \\n\\n However, when I added the new thread creation code in the network server \\nstartup, it meant that whenever the network server started, a DRDAConnThread \\nwas also started. And if that network server wasn\'t shut down, then the \\nDRDAConnThread instance remained, and prevented the server from shutting \\ndown, causing the hang. \\n\\n The reason that we are getting the extra NetworkServerControlImpl instances is very \\nsimple: when you call NetworkServerControlImpl.start, it does the following: \\n\\n public void start(PrintWriter consoleWriter) \\n    throws Exception \\n{ \\n    DRDAServerStarter starter = new DRDAServerStarter(); \\n    starter.setStartInfo(hostAddress,portNumber,consoleWriter); \\n    startNetworkServer(null); \\n    starter.boot(false,null); \\n} \\n\\n That is, it directly starts this instance, then it spawns a background thread to \\nrun the DRDAServerStarter code, which instantiates  another  NetworkServerControlImpl \\n\\n My first idea was to remove the call to startNetworkServer() from this method, and just \\nlet DRDAServerStarter start up the Network Server. \\n\\n Sure enough, this fixes the hang in DerbyNetNewServer. \\n\\n And, conceptually, it seems like a good change to make, because it doesn\'t seem \\nlike we should be starting the Network Server twice. \\n\\n However, removing the call to startNetworkServer causes test failures in a bunch of \\nother Network Server tests, such as NSinSameJVM, dataSourcePermissions_net, \\nownServerTests, and testSecMec. \\n\\n So, there\'s a bunch more investigation to do here                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12415766\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12415766&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12415766\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12415766_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12415766_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Jun\\/06 00:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-12T00:47:57+0000\'\u003e12\\/Jun\\/06 00:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttached is \'unify_NSImpl_instances.diff\', with these notes to explain. This\u003cbr\\/\u003e\\npatch belongs with the rest of the \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1326\\\" title=\\\"Network server may abandon sessions when Derby system is shutdown and this causes intermittent hangs in the client\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1326\\\"\u003e\u003cdel\u003eDERBY-1326\u003c\\/del\u003e\u003c\\/a\u003e changes, but I\'ve extracted it\u003cbr\\/\u003e\\nout into a standalone patch to make it easier to study and review.\u003c\\/p\u003e\\n\\n\u003cp\u003eRecently, I\'ve been investigating that hang that Deepa uncovered which occurs\u003cbr\\/\u003e\\nwith the latest patch proposal for \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1326\\\" title=\\\"Network server may abandon sessions when Derby system is shutdown and this causes intermittent hangs in the client\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1326\\\"\u003e\u003cdel\u003eDERBY-1326\u003c\\/del\u003e\u003c\\/a\u003e.\u003cbr\\/\u003e\\n\u003ca href=\\\"http:\\/\\/issues.apache.org\\/jira\\/secure\\/attachment\\/12334997\\/withNewThreadAndNoShutdownOfCurrentSession.diff\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/issues.apache.org\\/jira\\/secure\\/attachment\\/12334997\\/withNewThreadAndNoShutdownOfCurrentSession.diff\u003c\\/a\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eInvestigating that problem has taken me through some interesting analysis\u003cbr\\/\u003e\\nof NetworkServer startup\\/shutdown issues, which I\'d like to describe here, to\u003cbr\\/\u003e\\nsee what sort of reaction I get from the team.\u003c\\/p\u003e\\n\\n\u003cp\u003eThere are several different ways to start up the Network Server, but after\u003cbr\\/\u003e\\nsome twists and turns there appear to be two essential techniques:\u003cbr\\/\u003e\\n1) You can instantiate a NetworkServerControl object, and call the start()\u003cbr\\/\u003e\\n   method on it.\u003cbr\\/\u003e\\n2) You can define the derby.drda.startNetworkServer property to true, and then\u003cbr\\/\u003e\\n   start the embedded engine.\u003c\\/p\u003e\\n\\n\u003cp\u003eThese two code paths proceed somewhat differently, but end up getting to the\u003cbr\\/\u003e\\nsame place:\u003cbr\\/\u003e\\n1) NetworkServerControl.start() delegates to NetworkServerControlImpl.start(),\u003cbr\\/\u003e\\n   which calls NetworkServerControlImpl.startNetworkServer(), then instantiates\u003cbr\\/\u003e\\n   a DRDAServerStarter object and calls its boot() method.\u003cbr\\/\u003e\\n2) Loading the embedded engine eventually calls JDBCBoot.boot(), which notices\u003cbr\\/\u003e\\n   that derby.drda.startNetworkServer has been set, and calls\u003cbr\\/\u003e\\n   Monitor.startSystemModule() to instantiate a DRDAServerStarter object and\u003cbr\\/\u003e\\n   call its boot() method.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe DRDAServerStarter.boot() method uses reflection to:\u003c\\/p\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003edynamically load the Network Server code\u003c\\/li\u003e\\n\\t\u003cli\u003ecreate an instance of NetworkServerControlImpl\u003c\\/li\u003e\\n\\t\u003cli\u003ecreate a daemon server thread, which will then:\u003c\\/li\u003e\\n\\t\u003cli\u003ecall NetworkServerControlImpl.blockingStart()\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eSo whichever way that we start the Network Server, we end up constructing\u003cbr\\/\u003e\\na NetworkServerControlImpl instance and calling blockingStart() on that\u003cbr\\/\u003e\\ninstance from a background thread. This is good.\u003c\\/p\u003e\\n\\n\u003cp\u003eHowever, there is an important and interesting difference between the two\u003cbr\\/\u003e\\nstartup methods:\u003c\\/p\u003e\\n\\n\u003cp\u003e   DRDAServerStarter.boot() always creates its own instance of the\u003cbr\\/\u003e\\n   NetworkServerControlImpl object and calls blockingStart() on that instance.\u003cbr\\/\u003e\\n   So if you start the Network Server by instantiating a NetworkServerControl\u003cbr\\/\u003e\\n   object in your own code, that NetworkServerControl instance creates a\u003cbr\\/\u003e\\n   NetworkServerControlImpl instance, but then when it calls DRDAServerStarter,\u003cbr\\/\u003e\\n   we end up creating a \u003cb\u003esecond\u003c\\/b\u003e NetworkServerControlImpl instance to use as\u003cbr\\/\u003e\\n   the master instance, and we never really use the NetworkServerControlImpl\u003cbr\\/\u003e\\n   instance that was used by the NetworkServerControl object that you created.\u003c\\/p\u003e\\n\\n\u003cp\u003eWorse, \u003cb\u003eboth\u003c\\/b\u003e NetworkServerControlImpl instances are started up, in a certain\u003cbr\\/\u003e\\nsense, because NetworkServerControlImpl.startNetworkServer() is called on\u003cbr\\/\u003e\\neach instance:\u003c\\/p\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eNetworkServerControlImpl.start() calls startNetworkServer() on itself before\u003cbr\\/\u003e\\n   it instantiates the DRDAServerStarter object and calls boot()\u003c\\/li\u003e\\n\\t\u003cli\u003eNetworkServerControlImpl.blockingStart() calls startNetworkServer() on\u003cbr\\/\u003e\\n   itself as its first action.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eSo if you start up the Network Server by calling NetworkServerControl.start(),\u003cbr\\/\u003e\\nyou end up actually creating \u003cb\u003etwo\u003c\\/b\u003e Network Server instances, although one of\u003cbr\\/\u003e\\nthem doesn\'t really do very much. This is the source of the hang that I created\u003cbr\\/\u003e\\nwith the most recent patch proposal to \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1326\\\" title=\\\"Network server may abandon sessions when Derby system is shutdown and this causes intermittent hangs in the client\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1326\\\"\u003e\u003cdel\u003eDERBY-1326\u003c\\/del\u003e\u003c\\/a\u003e: when I changed the\u003cbr\\/\u003e\\nstartNetworkServer() method to create a new thread, that code ends up being\u003cbr\\/\u003e\\ncalled twice, but we don\'t shut down both of these instances, so we never\u003cbr\\/\u003e\\nshut down the extra thread that I created, and that caused the process to\u003cbr\\/\u003e\\nhang and not terminate.\u003c\\/p\u003e\\n\\n\u003cp\u003eClearly, one way out of this problem is to re-arrange the thread creation logic\u003cbr\\/\u003e\\nso that the thread is only created when the \u003cb\u003ereal\u003c\\/b\u003e NetworkServerControlImpl\u003cbr\\/\u003e\\ninstance is started.\u003c\\/p\u003e\\n\\n\u003cp\u003eBut I was curious about why there were two NetworkServerControlImpl instances,\u003cbr\\/\u003e\\nsince it seems quite clear to me that the NetworkServerControlImpl class is\u003cbr\\/\u003e\\ndesigned to behave as a singleton object. I thought that if I had made this\u003cbr\\/\u003e\\nassumption that there would only ever be a single instance in a Java app,\u003cbr\\/\u003e\\nothers might tend to make this same assumption in the future, and more bugs\u003cbr\\/\u003e\\nlike the one I accidentally introduced might get introduced in the future.\u003c\\/p\u003e\\n\\n\u003cp\u003eSo, for the last week or so, I\'ve been studying this code, trying to figure\u003cbr\\/\u003e\\nout if we really need to have two NetworkServerControlImpl instances, or\u003cbr\\/\u003e\\nwhether it would be cleaner to just have a single instance.\u003c\\/p\u003e\\n\\n\u003cp\u003eMy conclusion is that, for the most part, we \u003cb\u003edon\'t\u003c\\/b\u003e need to have both\u003cbr\\/\u003e\\ninstances, and it \u003cb\u003eis\u003c\\/b\u003e cleaner to just have a single instance, but there\u003cbr\\/\u003e\\nare a few messy details.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe changes that I\'ve been experimenting with in this area are as follows:\u003cbr\\/\u003e\\n1) Refactor the DRDAServerStarter code slightly so that the caller can\u003cbr\\/\u003e\\n   optionally pass in the NetworkServerControlImpl instance to use. If the\u003cbr\\/\u003e\\n   caller does not pass in an instance, DRDAServerStarter creates one via\u003cbr\\/\u003e\\n   reflection, as it does now.\u003cbr\\/\u003e\\n2) Simplify NetworkServerControlImpl.start() so that it no longer calls\u003cbr\\/\u003e\\n   startNetworkServer() on itself, but instead simply calls DRDAServerStarter,\u003cbr\\/\u003e\\n   passing the \\\"this\\\" pointer in as the instance to use for starting the server.\u003cbr\\/\u003e\\n3) Modify the DRDAServerStarter boot code so that it loads the embedded\u003cbr\\/\u003e\\n   engine. The current DRDAServerStarter code assumes that the embedded engine\u003cbr\\/\u003e\\n   has already been started; I believe that this is the main reason for the\u003cbr\\/\u003e\\n   current code\'s call to startNetworkServer() from NetworkServerControlImpl\'s\u003cbr\\/\u003e\\n   start() method, as a side effect of startNetworkServer() is to load the\u003cbr\\/\u003e\\n   embedded engine. It seems simple to have DRDAServerStarter load the\u003cbr\\/\u003e\\n   embedded engine itself, but an alternative would be to load the embedded\u003cbr\\/\u003e\\n   engine in NetworkServerControlImpl.start().\u003c\\/p\u003e\\n\\n\u003cp\u003eWith these changes in place, the Network Server startup and shutdown code\u003cbr\\/\u003e\\nseems substantially cleaner to me, and the tests seem to run very well.\u003cbr\\/\u003e\\nI\'m pleased with the results.\u003c\\/p\u003e\\n\\n\u003cp\u003eHowever, there is one messy detail that remains to be resolved, and it\u003cbr\\/\u003e\\ninvolves the Network Server shutdown processing. The shutdown() method for\u003cbr\\/\u003e\\nthe Network Server, in NetworkServerControlImpl.shutdown(), uses the following\u003cbr\\/\u003e\\nalgorithm:\u003c\\/p\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003etell the server to shut down\u003c\\/li\u003e\\n\\t\u003cli\u003eloop for a while, ping\'ing the Network server, until we get an error\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eUnfortunately, during this \\\"ping loop\\\", the code wants to ensure that no\u003cbr\\/\u003e\\nstray messages from the failed ping operation escape to the user, so the\u003cbr\\/\u003e\\ncode intentionally disables the Network Server console.\u003c\\/p\u003e\\n\\n\u003cp\u003eWhen there were two NetworkServerControlImpl instances in play, intentionally\u003cbr\\/\u003e\\ndisabling the console of the one instance was a relatively safe thing to do.\u003c\\/p\u003e\\n\\n\u003cp\u003eHowever, when there is only a single instance in the process, disabling the\u003cbr\\/\u003e\\nconsole is a quite disruptive action, because it affects \u003cb\u003eall\u003c\\/b\u003e the messages\u003cbr\\/\u003e\\nthat the Network Server might want to print, including the \\\"normal shutdown\\\"\u003cbr\\/\u003e\\nmessage that the Network Server prints at the conclusion of shutdown.\u003c\\/p\u003e\\n\\n\u003cp\u003eTherefore, I\'m coming to believe that we shouldn\'t disable the console\u003cbr\\/\u003e\\nduring shutdown, but rather should implement a variant \\\"ping\\\" operation which\u003cbr\\/\u003e\\ndoesn\'t print any messages when it fails, but instead just throws an exception,\u003cbr\\/\u003e\\nwhich the shutdown code could catch and handle. Unfortunately, this is not\u003cbr\\/\u003e\\na trivial one-line change, as the code which prints error messages to the\u003cbr\\/\u003e\\nNetwork Server console is buried \u003cb\u003edeep\u003c\\/b\u003e in the Network Server command\u003cbr\\/\u003e\\nprocessing code.\u003c\\/p\u003e\\n\\n\u003cp\u003eObviously, I\'ve still got more work to do here. But I\'m attaching the current\u003cbr\\/\u003e\\nstate of my changes anyway, since I think it\'s a useful intermediate stage\u003cbr\\/\u003e\\nand would be interesting to reviewers.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe other comment to be made is that this change is now becoming quite large,\u003cbr\\/\u003e\\nand probably should be split into multiple smaller patches. I\'ll pursue that\u003cbr\\/\u003e\\nstrategy later, once I get to a point where I have code that seems solid.\u003c\\/p\u003e\\n\\n\u003cp\u003eThanks in advance for all comments, suggestions, and other feedback!\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12415766_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12415766_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Jun\\/06 00:47\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-12T00:47:57+0000\'\u003e12\\/Jun\\/06 00:47\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attached is \'unify_NSImpl_instances.diff\', with these notes to explain. This \\npatch belongs with the rest of the   DERBY-1326   changes, but I\'ve extracted it \\nout into a standalone patch to make it easier to study and review. \\n\\n Recently, I\'ve been investigating that hang that Deepa uncovered which occurs \\nwith the latest patch proposal for   DERBY-1326  . \\n http:\\/\\/issues.apache.org\\/jira\\/secure\\/attachment\\/12334997\\/withNewThreadAndNoShutdownOfCurrentSession.diff  \\n\\n Investigating that problem has taken me through some interesting analysis \\nof NetworkServer startup\\/shutdown issues, which I\'d like to describe here, to \\nsee what sort of reaction I get from the team. \\n\\n There are several different ways to start up the Network Server, but after \\nsome twists and turns there appear to be two essential techniques: \\n1) You can instantiate a NetworkServerControl object, and call the start() \\n   method on it. \\n2) You can define the derby.drda.startNetworkServer property to true, and then \\n   start the embedded engine. \\n\\n These two code paths proceed somewhat differently, but end up getting to the \\nsame place: \\n1) NetworkServerControl.start() delegates to NetworkServerControlImpl.start(), \\n   which calls NetworkServerControlImpl.startNetworkServer(), then instantiates \\n   a DRDAServerStarter object and calls its boot() method. \\n2) Loading the embedded engine eventually calls JDBCBoot.boot(), which notices \\n   that derby.drda.startNetworkServer has been set, and calls \\n   Monitor.startSystemModule() to instantiate a DRDAServerStarter object and \\n   call its boot() method. \\n\\n The DRDAServerStarter.boot() method uses reflection to: \\n \\n\\t dynamically load the Network Server code \\n\\t create an instance of NetworkServerControlImpl \\n\\t create a daemon server thread, which will then: \\n\\t call NetworkServerControlImpl.blockingStart() \\n \\n\\n\\n So whichever way that we start the Network Server, we end up constructing \\na NetworkServerControlImpl instance and calling blockingStart() on that \\ninstance from a background thread. This is good. \\n\\n However, there is an important and interesting difference between the two \\nstartup methods: \\n\\n    DRDAServerStarter.boot() always creates its own instance of the \\n   NetworkServerControlImpl object and calls blockingStart() on that instance. \\n   So if you start the Network Server by instantiating a NetworkServerControl \\n   object in your own code, that NetworkServerControl instance creates a \\n   NetworkServerControlImpl instance, but then when it calls DRDAServerStarter, \\n   we end up creating a  second  NetworkServerControlImpl instance to use as \\n   the master instance, and we never really use the NetworkServerControlImpl \\n   instance that was used by the NetworkServerControl object that you created. \\n\\n Worse,  both  NetworkServerControlImpl instances are started up, in a certain \\nsense, because NetworkServerControlImpl.startNetworkServer() is called on \\neach instance: \\n \\n\\t NetworkServerControlImpl.start() calls startNetworkServer() on itself before \\n   it instantiates the DRDAServerStarter object and calls boot() \\n\\t NetworkServerControlImpl.blockingStart() calls startNetworkServer() on \\n   itself as its first action. \\n \\n\\n\\n So if you start up the Network Server by calling NetworkServerControl.start(), \\nyou end up actually creating  two  Network Server instances, although one of \\nthem doesn\'t really do very much. This is the source of the hang that I created \\nwith the most recent patch proposal to   DERBY-1326  : when I changed the \\nstartNetworkServer() method to create a new thread, that code ends up being \\ncalled twice, but we don\'t shut down both of these instances, so we never \\nshut down the extra thread that I created, and that caused the process to \\nhang and not terminate. \\n\\n Clearly, one way out of this problem is to re-arrange the thread creation logic \\nso that the thread is only created when the  real  NetworkServerControlImpl \\ninstance is started. \\n\\n But I was curious about why there were two NetworkServerControlImpl instances, \\nsince it seems quite clear to me that the NetworkServerControlImpl class is \\ndesigned to behave as a singleton object. I thought that if I had made this \\nassumption that there would only ever be a single instance in a Java app, \\nothers might tend to make this same assumption in the future, and more bugs \\nlike the one I accidentally introduced might get introduced in the future. \\n\\n So, for the last week or so, I\'ve been studying this code, trying to figure \\nout if we really need to have two NetworkServerControlImpl instances, or \\nwhether it would be cleaner to just have a single instance. \\n\\n My conclusion is that, for the most part, we  don\'t  need to have both \\ninstances, and it  is  cleaner to just have a single instance, but there \\nare a few messy details. \\n\\n The changes that I\'ve been experimenting with in this area are as follows: \\n1) Refactor the DRDAServerStarter code slightly so that the caller can \\n   optionally pass in the NetworkServerControlImpl instance to use. If the \\n   caller does not pass in an instance, DRDAServerStarter creates one via \\n   reflection, as it does now. \\n2) Simplify NetworkServerControlImpl.start() so that it no longer calls \\n   startNetworkServer() on itself, but instead simply calls DRDAServerStarter, \\n   passing the \\\"this\\\" pointer in as the instance to use for starting the server. \\n3) Modify the DRDAServerStarter boot code so that it loads the embedded \\n   engine. The current DRDAServerStarter code assumes that the embedded engine \\n   has already been started; I believe that this is the main reason for the \\n   current code\'s call to startNetworkServer() from NetworkServerControlImpl\'s \\n   start() method, as a side effect of startNetworkServer() is to load the \\n   embedded engine. It seems simple to have DRDAServerStarter load the \\n   embedded engine itself, but an alternative would be to load the embedded \\n   engine in NetworkServerControlImpl.start(). \\n\\n With these changes in place, the Network Server startup and shutdown code \\nseems substantially cleaner to me, and the tests seem to run very well. \\nI\'m pleased with the results. \\n\\n However, there is one messy detail that remains to be resolved, and it \\ninvolves the Network Server shutdown processing. The shutdown() method for \\nthe Network Server, in NetworkServerControlImpl.shutdown(), uses the following \\nalgorithm: \\n \\n\\t tell the server to shut down \\n\\t loop for a while, ping\'ing the Network server, until we get an error \\n \\n\\n\\n Unfortunately, during this \\\"ping loop\\\", the code wants to ensure that no \\nstray messages from the failed ping operation escape to the user, so the \\ncode intentionally disables the Network Server console. \\n\\n When there were two NetworkServerControlImpl instances in play, intentionally \\ndisabling the console of the one instance was a relatively safe thing to do. \\n\\n However, when there is only a single instance in the process, disabling the \\nconsole is a quite disruptive action, because it affects  all  the messages \\nthat the Network Server might want to print, including the \\\"normal shutdown\\\" \\nmessage that the Network Server prints at the conclusion of shutdown. \\n\\n Therefore, I\'m coming to believe that we shouldn\'t disable the console \\nduring shutdown, but rather should implement a variant \\\"ping\\\" operation which \\ndoesn\'t print any messages when it fails, but instead just throws an exception, \\nwhich the shutdown code could catch and handle. Unfortunately, this is not \\na trivial one-line change, as the code which prints error messages to the \\nNetwork Server console is buried  deep  in the Network Server command \\nprocessing code. \\n\\n Obviously, I\'ve still got more work to do here. But I\'m attaching the current \\nstate of my changes anyway, since I think it\'s a useful intermediate stage \\nand would be interesting to reviewers. \\n\\n The other comment to be made is that this change is now becoming quite large, \\nand probably should be split into multiple smaller patches. I\'ll pursue that \\nstrategy later, once I get to a point where I have code that seems solid. \\n\\n Thanks in advance for all comments, suggestions, and other feedback! \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12415929\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12415929&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12415929\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12415929_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12415929_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Jun\\/06 05:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-13T05:49:41+0000\'\u003e13\\/Jun\\/06 05:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks again for posting a detailed description. I read through the description and patch \\\"unify_NSImpl_instances.diff \\\" quickly. \u003c\\/p\u003e\\n\\n\u003cp\u003eI have few small comments\\/questions:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eCurrently, the patch does the following \\\"Modify the DRDAServerStarter boot code so that it loads the embedded engine. \\\" The description also mentions this: \\\"an alternative would be to load the embedded engine in NetworkServerControlImpl.start()\\\". I like this alternative. I am thinking of the scenario where derby.drda.startNetowrkServer property is set and we boot embedded driver. In this scenario, if we load the embedded engine in the DRDAServerStarter boot code, it will appear that we are trying to boot the embedded driver twice. However, this will not do any harm as it will be a no-op. I think it would be better to avoid doing this as it causes confusion why we are loading the driver again when we trace the path from loading embedded engine.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eThere is a slightly different code path when we start network server from the command line. In this case, we create an instance of NetworkServerControlImpl and then call executeWork which processes the \\\"start\\\" command by calling blockingStart(). There is no DRDAServerStarter involved here as we do not need to launch another thread. This is not very relevant for the current patch but just mentioning it in case we plan to re-organize the code.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eIt looks like the only purpose of calling DRDAServerStarter in NetworkServerControlImpl.start method is to launch a separate thread. The javadoc comment for NetworkServerControlImpl.start says:\u003cbr\\/\u003e\\n\\t\\/**\u003c\\/li\u003e\\n\\t\u003cli\u003eStart a network server.  Launches a separate thread with\u003c\\/li\u003e\\n\\t\u003cli\u003eDRDAServerStarter.  Want to use Monitor.startModule,\u003c\\/li\u003e\\n\\t\u003cli\u003eso it can all get shutdown when cloudscape shuts down, but\u003c\\/li\u003e\\n\\t\u003cli\u003ecan\'t get it working right now.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003eFrom  current behaviour, we do not shutdown network server when we shutdown Derby. Does anyone know if there is any plan to do as indicated by the comment: \\\"Want to use Monitor.startModule, so it can all get shutdown when cloudscape shuts down, but can\'t get it working right now.\\\" ? \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12415929_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12415929_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Jun\\/06 05:49\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-13T05:49:41+0000\'\u003e13\\/Jun\\/06 05:49\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks again for posting a detailed description. I read through the description and patch \\\"unify_NSImpl_instances.diff \\\" quickly.  \\n\\n I have few small comments\\/questions: \\n\\n \\n\\t Currently, the patch does the following \\\"Modify the DRDAServerStarter boot code so that it loads the embedded engine. \\\" The description also mentions this: \\\"an alternative would be to load the embedded engine in NetworkServerControlImpl.start()\\\". I like this alternative. I am thinking of the scenario where derby.drda.startNetowrkServer property is set and we boot embedded driver. In this scenario, if we load the embedded engine in the DRDAServerStarter boot code, it will appear that we are trying to boot the embedded driver twice. However, this will not do any harm as it will be a no-op. I think it would be better to avoid doing this as it causes confusion why we are loading the driver again when we trace the path from loading embedded engine. \\n \\n\\n\\n \\n\\t There is a slightly different code path when we start network server from the command line. In this case, we create an instance of NetworkServerControlImpl and then call executeWork which processes the \\\"start\\\" command by calling blockingStart(). There is no DRDAServerStarter involved here as we do not need to launch another thread. This is not very relevant for the current patch but just mentioning it in case we plan to re-organize the code. \\n \\n\\n\\n \\n\\t It looks like the only purpose of calling DRDAServerStarter in NetworkServerControlImpl.start method is to launch a separate thread. The javadoc comment for NetworkServerControlImpl.start says: \\n\\t\\/** \\n\\t Start a network server.  Launches a separate thread with \\n\\t DRDAServerStarter.  Want to use Monitor.startModule, \\n\\t so it can all get shutdown when cloudscape shuts down, but \\n\\t can\'t get it working right now. \\n \\n\\n\\n From  current behaviour, we do not shutdown network server when we shutdown Derby. Does anyone know if there is any plan to do as indicated by the comment: \\\"Want to use Monitor.startModule, so it can all get shutdown when cloudscape shuts down, but can\'t get it working right now.\\\" ?               \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12416494\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12416494&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12416494\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"johnemb\\\" id=\\\"commentauthor_12416494_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=johnemb\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"johnemb\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e John H. Embretsen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12416494_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Jun\\/06 20:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-16T20:48:48+0000\'\u003e16\\/Jun\\/06 20:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; Deepa Remesh commented:\u003cbr\\/\u003e\\n&gt; -----------------------\u003c\\/p\u003e\\n\\n\u003cp\u003e\u003cspan class=\\\"error\\\"\u003e&#91;snip&#93;\u003c\\/span\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; From  current behaviour, we do not shutdown network server when we shutdown Derby. Does anyone know if there is any plan to do as indicated by the comment: \\\"Want to use Monitor.startModule, so it can all get shutdown when cloudscape shuts down, but can\'t get it working right now.\\\" ? \u003c\\/p\u003e\\n\\n\\n\u003cp\u003eSpeaking of current behaviour, here are some observations I have made recently:\u003c\\/p\u003e\\n\\n\u003cp\u003ea) In the \\\"embedded server using properties\\\" scenario, the Network Server starts when the embedded driver is loaded and stops when it is \\\"unloaded\\\", i.e. when the Derby system is shut down: DriverManager.getConnection(\\\"jdbc:derby:;shutdown=true\\\");\u003c\\/p\u003e\\n\\n\u003cp\u003eb) In the \\\"embedded server using NetworkServerControl API\\\" scenario, the Network server of course starts when NetworkServerControl.start() is called, and stops when shutdown() is called. However, if the Derby system is shut down (by loading the embedded driver and doing as shown above), clients can no longer connect (getting \\\"No suitable driver\\\". Why?). The Network Server port seems to be listening on the same port still, though, according to netstat. Then, if I try to restart the server using the API (without calling shutdown() first), I get the message \\\"Could not listen on port 1527 on host 0.0.0.0.\\\". This makes sense, since the port is already in use. However, after start() is called the second time, clients \u003cem\u003eare\u003c\\/em\u003e in fact able to connect. There seems to be something happening when start() is called, even if the port is busy, that is needed to make the server able to accept connections again.\u003c\\/p\u003e\\n\\n\u003cp\u003eI have not done any code inspection in these cases, so I don\'t know if this is very helpful with regards to this Jira issue. I just reacted when I saw the above comment.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"johnemb\\\" id=\\\"commentauthor_12416494_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=johnemb\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"johnemb\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e John H. Embretsen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12416494_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'16\\/Jun\\/06 20:48\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-06-16T20:48:48+0000\'\u003e16\\/Jun\\/06 20:48\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; Deepa Remesh commented: \\n&gt; ----------------------- \\n\\n  &#91;snip&#93;  \\n\\n &gt; From  current behaviour, we do not shutdown network server when we shutdown Derby. Does anyone know if there is any plan to do as indicated by the comment: \\\"Want to use Monitor.startModule, so it can all get shutdown when cloudscape shuts down, but can\'t get it working right now.\\\" ?  \\n\\n\\n Speaking of current behaviour, here are some observations I have made recently: \\n\\n a) In the \\\"embedded server using properties\\\" scenario, the Network Server starts when the embedded driver is loaded and stops when it is \\\"unloaded\\\", i.e. when the Derby system is shut down: DriverManager.getConnection(\\\"jdbc:derby:;shutdown=true\\\"); \\n\\n b) In the \\\"embedded server using NetworkServerControl API\\\" scenario, the Network server of course starts when NetworkServerControl.start() is called, and stops when shutdown() is called. However, if the Derby system is shut down (by loading the embedded driver and doing as shown above), clients can no longer connect (getting \\\"No suitable driver\\\". Why?). The Network Server port seems to be listening on the same port still, though, according to netstat. Then, if I try to restart the server using the API (without calling shutdown() first), I get the message \\\"Could not listen on port 1527 on host 0.0.0.0.\\\". This makes sense, since the port is already in use. However, after start() is called the second time, clients  are  in fact able to connect. There seems to be something happening when start() is called, even if the port is busy, that is needed to make the server able to accept connections again. \\n\\n I have not done any code inspection in these cases, so I don\'t know if this is very helpful with regards to this Jira issue. I just reacted when I saw the above comment.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12419031\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12419031&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12419031\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12419031_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12419031_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Jul\\/06 06:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-07-04T06:35:02+0000\'\u003e04\\/Jul\\/06 06:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI want to thank all the reviewers for their helpful feedback! Those are very good suggestions.\u003c\\/p\u003e\\n\\n\u003cp\u003eI am hoping to return to this bug and continue working on it, incorporating the various ideas.\u003c\\/p\u003e\\n\\n\u003cp\u003eI was dismayed by how hard it seemed it was going to be to make a variation of the Network Server \\\"ping\\\" API which was silent.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12419031_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12419031_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'04\\/Jul\\/06 06:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-07-04T06:35:02+0000\'\u003e04\\/Jul\\/06 06:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I want to thank all the reviewers for their helpful feedback! Those are very good suggestions. \\n\\n I am hoping to return to this bug and continue working on it, incorporating the various ideas. \\n\\n I was dismayed by how hard it seemed it was going to be to make a variation of the Network Server \\\"ping\\\" API which was silent.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12432883\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12432883&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12432883\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12432883_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12432883_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Sep\\/06 15:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-06T15:58:59+0000\'\u003e06\\/Sep\\/06 15:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'m not actively working on this. I hope to return to it in the future, but if somebody else has time in the meantime, please feel free to explore this issue.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12432883_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12432883_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'06\\/Sep\\/06 15:58\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-06T15:58:59+0000\'\u003e06\\/Sep\\/06 15:58\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'m not actively working on this. I hope to return to it in the future, but if somebody else has time in the meantime, please feel free to explore this issue.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434123\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434123&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434123\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434123_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434123_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Sep\\/06 11:27\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-12T11:27:45+0000\'\u003e12\\/Sep\\/06 11:27\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching a repro (Restart.java) which always causes a hang in my environment. What it does is:\u003c\\/p\u003e\\n\\n\u003cp\u003e  1) Open 20 connections to the server.\u003cbr\\/\u003e\\n  2) Close all connections.\u003cbr\\/\u003e\\n  3) Shut down the engine (will make the server restart).\u003cbr\\/\u003e\\n  4) Open and close a connection 20 times (usually hangs on the second connection).\u003c\\/p\u003e\\n\\n\u003cp\u003eAfter (3), the server has 20 threads sleeping in runQueue.wait(). All of these are closed, but when they start waking up in (4), they don\'t notice that they have been closed until they have picked up a session from the run queue. That session will be abandoned, and the client hangs.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434123_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434123_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Sep\\/06 11:27\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-12T11:27:45+0000\'\u003e12\\/Sep\\/06 11:27\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attaching a repro (Restart.java) which always causes a hang in my environment. What it does is: \\n\\n   1) Open 20 connections to the server. \\n  2) Close all connections. \\n  3) Shut down the engine (will make the server restart). \\n  4) Open and close a connection 20 times (usually hangs on the second connection). \\n\\n After (3), the server has 20 threads sleeping in runQueue.wait(). All of these are closed, but when they start waking up in (4), they don\'t notice that they have been closed until they have picked up a session from the run queue. That session will be abandoned, and the client hangs.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434209\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434209&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434209\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12434209_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434209_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Sep\\/06 16:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-12T16:36:37+0000\'\u003e12\\/Sep\\/06 16:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eRestart.java reliably reproduces the hang in my environment as well. Very nice.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12434209_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434209_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Sep\\/06 16:36\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-12T16:36:37+0000\'\u003e12\\/Sep\\/06 16:36\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Restart.java reliably reproduces the hang in my environment as well. Very nice.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434296\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434296&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434296\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434296_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434296_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Sep\\/06 22:19\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-12T22:19:46+0000\'\u003e12\\/Sep\\/06 22:19\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIt is not clear to me why an engine shutdown should close down all DRDAConnThreads. I kind of understand why the sessions are closed (although that would happen implicitly anyway) since their embedded connections are closed as part of the engine shutdown. The DRDAConnThreads are however merely worker threads which don\'t have any dependencies on the engine instance that was active when they were created, so there is no reason why they can\'t be reused after the restart of the engine. Does anyone see problems with reusing the threads? In my opinion, it would be easier to ensure a consistent state after a restart if the threads were kept.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434296_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434296_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Sep\\/06 22:19\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-12T22:19:46+0000\'\u003e12\\/Sep\\/06 22:19\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    It is not clear to me why an engine shutdown should close down all DRDAConnThreads. I kind of understand why the sessions are closed (although that would happen implicitly anyway) since their embedded connections are closed as part of the engine shutdown. The DRDAConnThreads are however merely worker threads which don\'t have any dependencies on the engine instance that was active when they were created, so there is no reason why they can\'t be reused after the restart of the engine. Does anyone see problems with reusing the threads? In my opinion, it would be easier to ensure a consistent state after a restart if the threads were kept.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434299\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434299&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434299\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12434299_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434299_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Sep\\/06 22:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-12T22:35:00+0000\'\u003e12\\/Sep\\/06 22:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; Does anyone see problems with reusing the threads?\u003c\\/p\u003e\\n\\n\u003cp\u003eDeepa and I discussed this a fair amount in \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1219\\\" title=\\\"jdbcapi\\/checkDataSource.java and jdbcapi\\/checkDataSource30.java hang intermittently with client\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1219\\\"\u003e\u003cdel\u003eDERBY-1219\u003c\\/del\u003e\u003c\\/a\u003e; you should\u003cbr\\/\u003e\\nprobably review that discussion to see if there\'s more you can learn from it.\u003cbr\\/\u003e\\nIn particular, the discussion regarding \\\"skipThreads.diff\\\" at:\u003cbr\\/\u003e\\n\u003ca href=\\\"http:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1219#action_12378300\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1219#action_12378300\u003c\\/a\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eIf we didn\'t close down the threads, would we do anything to notify them of\u003cbr\\/\u003e\\nthe shutdown? Were you proposing to leave them alone entirely? Or were\u003cbr\\/\u003e\\nyou proposing to notify them of the shutdown, but not require the threads to exit?\u003c\\/p\u003e\\n\\n\u003cp\u003eAre you sure a DRDAConnThread doesn\'t have dependencies on the engine\u003cbr\\/\u003e\\ninstance? The thread has a pointer to a session, and a session seems like\u003cbr\\/\u003e\\nit could point to database objects (like Connection objects, e.g.)\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12434299_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434299_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Sep\\/06 22:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-12T22:35:00+0000\'\u003e12\\/Sep\\/06 22:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; Does anyone see problems with reusing the threads? \\n\\n Deepa and I discussed this a fair amount in   DERBY-1219  ; you should \\nprobably review that discussion to see if there\'s more you can learn from it. \\nIn particular, the discussion regarding \\\"skipThreads.diff\\\" at: \\n http:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1219#action_12378300  \\n\\n If we didn\'t close down the threads, would we do anything to notify them of \\nthe shutdown? Were you proposing to leave them alone entirely? Or were \\nyou proposing to notify them of the shutdown, but not require the threads to exit? \\n\\n Are you sure a DRDAConnThread doesn\'t have dependencies on the engine \\ninstance? The thread has a pointer to a session, and a session seems like \\nit could point to database objects (like Connection objects, e.g.)              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434306\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434306&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434306\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"forsini\\\" id=\\\"commentauthor_12434306_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=forsini\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"forsini\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Francois Orsini\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434306_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Sep\\/06 22:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-12T22:51:50+0000\'\u003e12\\/Sep\\/06 22:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eWell, we do connect to the Derby engine instance from the network server layer so if the embedded Derby engine goes down, we would have to reinstantiate the database connections (logic is not there right now if am not mistaken), which means some state(s) have to be kept around and some logic has to be added. But then, how do you handle incoming request from the client(s), especially if it takes some time to recover the database(s)...What is there is a corruption and some database cannot be recovered? What if after a reboot of the engine some derby properties have affected the behavior and configuration of the recovered databases - For instance, some database properties are static, so they won\'t be taken into account until the next reboot, which can also mean that a client (user) would no longer be allowed to authenticate if the authentication provider was changed before the next reboot - This is true for Strong Password Substitute which only works with BUILT-IN or NONE authentication providers right now...Hence in this last case, a security mechanism negotiation needs to happen between the client and the network server...Another case if that if you enable authentication at the engine level but derby instance has not rebooted yet, you will then not be able to re-authenticate based on the cached database info per DRDA session - Simply because a password may not be cached at all since there was no authentication required beforehand and now there is because the static property got picked-up by the database in question at the next engine\\/database reboot...The connection with the database would not work and the client would probably get confused with some authentication exception where he\\/she was already authenticated before the Derby engine got shutdown...\u003c\\/p\u003e\\n\\n\u003cp\u003eWere you actually implying some auto database reconnect of the current DRDA threads created in the network server once the Derby engine or\\/and databases are brought back up?\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"forsini\\\" id=\\\"commentauthor_12434306_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=forsini\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"forsini\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Francois Orsini\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434306_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'12\\/Sep\\/06 22:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-12T22:51:50+0000\'\u003e12\\/Sep\\/06 22:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Well, we do connect to the Derby engine instance from the network server layer so if the embedded Derby engine goes down, we would have to reinstantiate the database connections (logic is not there right now if am not mistaken), which means some state(s) have to be kept around and some logic has to be added. But then, how do you handle incoming request from the client(s), especially if it takes some time to recover the database(s)...What is there is a corruption and some database cannot be recovered? What if after a reboot of the engine some derby properties have affected the behavior and configuration of the recovered databases - For instance, some database properties are static, so they won\'t be taken into account until the next reboot, which can also mean that a client (user) would no longer be allowed to authenticate if the authentication provider was changed before the next reboot - This is true for Strong Password Substitute which only works with BUILT-IN or NONE authentication providers right now...Hence in this last case, a security mechanism negotiation needs to happen between the client and the network server...Another case if that if you enable authentication at the engine level but derby instance has not rebooted yet, you will then not be able to re-authenticate based on the cached database info per DRDA session - Simply because a password may not be cached at all since there was no authentication required beforehand and now there is because the static property got picked-up by the database in question at the next engine\\/database reboot...The connection with the database would not work and the client would probably get confused with some authentication exception where he\\/she was already authenticated before the Derby engine got shutdown... \\n\\n Were you actually implying some auto database reconnect of the current DRDA threads created in the network server once the Derby engine or\\/and databases are brought back up?              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434398\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434398&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434398\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434398_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434398_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Sep\\/06 10:13\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-13T10:13:13+0000\'\u003e13\\/Sep\\/06 10:13\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eFrancois wrote:\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; Were you actually implying some auto database reconnect of the\u003cbr\\/\u003e\\n&gt; current DRDA threads created in the network server once the Derby\u003cbr\\/\u003e\\n&gt; engine or\\/and databases are brought back up?\u003c\\/p\u003e\\n\\n\u003cp\u003eYes, when the server detects that one of the clients has shut down the\u003cbr\\/\u003e\\nengine (it checks the SQLSTATE of exceptions before sending them to\u003cbr\\/\u003e\\nthe client), it (a) closes all sessions that are in the run queue\u003cbr\\/\u003e\\nwaiting for a thread, (b) poisons all DRDAConnThreads, and (c) reboots\u003cbr\\/\u003e\\nthe engine. Because the poisoned DRDAConnThreads are left around, they\u003cbr\\/\u003e\\nwill eventually pick up a session but abandon it.\u003c\\/p\u003e\\n\\n\u003cp\u003eBryan wrote:\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; Deepa and I discussed this a fair amount in \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1219\\\" title=\\\"jdbcapi\\/checkDataSource.java and jdbcapi\\/checkDataSource30.java hang intermittently with client\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1219\\\"\u003e\u003cdel\u003eDERBY-1219\u003c\\/del\u003e\u003c\\/a\u003e; you should\u003cbr\\/\u003e\\n&gt; probably review that discussion to see if there\'s more you can learn\u003cbr\\/\u003e\\n&gt; from it.  In particular, the discussion regarding \\\"skipThreads.diff\\\"\u003cbr\\/\u003e\\n&gt; at: \u003ca href=\\\"http:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1219#action_12378300\\\" class=\\\"external-link\\\" rel=\\\"nofollow\\\"\u003ehttp:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1219#action_12378300\u003c\\/a\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eThere are many interesting patches attached to that issue (though I am\u003cbr\\/\u003e\\ndefinitely not going for any solution which involves\u003cbr\\/\u003e\\nThread.interrupt()). skipThreads.diff seems to do exactly what I\u003cbr\\/\u003e\\nproposed. From the comments, it seems like there were two objections:\u003c\\/p\u003e\\n\\n\u003cp\u003e  1) It didn\'t fix all of the hangs.\u003cbr\\/\u003e\\n  2) Removing the cleanup code didn\'t feel quite right, but if the\u003cbr\\/\u003e\\n     threads could be reused after a restart, it should be okay.\u003c\\/p\u003e\\n\\n\u003cp\u003eThe hangs mentioned in (1) could be the same ones as \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1817\\\" title=\\\"Race condition in network server&#39;s thread pool\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1817\\\"\u003e\u003cdel\u003eDERBY-1817\u003c\\/del\u003e\u003c\\/a\u003e\u003cbr\\/\u003e\\nfixed. I also believe that the threads can be reused after a restart.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; If we didn\'t close down the threads, would we do anything to notify\u003cbr\\/\u003e\\n&gt; them of the shutdown? Were you proposing to leave them alone\u003cbr\\/\u003e\\n&gt; entirely? Or were you proposing to notify them of the shutdown, but\u003cbr\\/\u003e\\n&gt; not require the threads to exit?\u003c\\/p\u003e\\n\\n\u003cp\u003eI don\'t think we need to notify them about the shutdown. If a thread\u003cbr\\/\u003e\\nis waiting for runQueue notification in getNextSession(), it is not\u003cbr\\/\u003e\\nbound to a session and hence doesn\'t need to know about the\u003cbr\\/\u003e\\nshutdown. If a thread has a session bound to it, it would stay\u003cbr\\/\u003e\\nsleeping (and unavailable for new sessions) until the client closes\u003cbr\\/\u003e\\nthe connection or disconnects. This is quite similar to the current\u003cbr\\/\u003e\\nbehaviour (the closed threads are not freed until there is some\u003cbr\\/\u003e\\nactivity on them).\u003c\\/p\u003e\\n\\n\u003cp\u003eFor the latter (threads with sessions), it would make sense to notify\u003cbr\\/\u003e\\nthem about the shutdown so they could drop their invalid sessions\u003cbr\\/\u003e\\nearlier, but that would be an optimization and not a correctness\u003cbr\\/\u003e\\nissue, I think.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; Are you sure a DRDAConnThread doesn\'t have dependencies on the\u003cbr\\/\u003e\\n&gt; engine instance? The thread has a pointer to a session, and a\u003cbr\\/\u003e\\n&gt; session seems like it could point to database objects (like\u003cbr\\/\u003e\\n&gt; Connection objects, e.g.)\u003c\\/p\u003e\\n\\n\u003cp\u003eAll DRDAConnThread\'s dependencies on the engine go through the session\u003cbr\\/\u003e\\npointer. For free threads, the session pointer is null, hence there\u003cbr\\/\u003e\\nare no dependencies. If it picks up a new session, it would depend on\u003cbr\\/\u003e\\nthe new session\'s engine, not the old one.\u003c\\/p\u003e\\n\\n\u003cp\u003eFor active DRDAConnThread instances, there are dependencies on the old\u003cbr\\/\u003e\\nengine after the shutdown. However, this is also the case for the\u003cbr\\/\u003e\\ncurrent code (the thread is marked as closed, but the session is not\u003cbr\\/\u003e\\nabandoned and the thread is not stopped until the client tries to\u003cbr\\/\u003e\\nperform an operation on the connection).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434398_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434398_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Sep\\/06 10:13\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-13T10:13:13+0000\'\u003e13\\/Sep\\/06 10:13\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Francois wrote: \\n\\n &gt; Were you actually implying some auto database reconnect of the \\n&gt; current DRDA threads created in the network server once the Derby \\n&gt; engine or\\/and databases are brought back up? \\n\\n Yes, when the server detects that one of the clients has shut down the \\nengine (it checks the SQLSTATE of exceptions before sending them to \\nthe client), it (a) closes all sessions that are in the run queue \\nwaiting for a thread, (b) poisons all DRDAConnThreads, and (c) reboots \\nthe engine. Because the poisoned DRDAConnThreads are left around, they \\nwill eventually pick up a session but abandon it. \\n\\n Bryan wrote: \\n\\n &gt; Deepa and I discussed this a fair amount in   DERBY-1219  ; you should \\n&gt; probably review that discussion to see if there\'s more you can learn \\n&gt; from it.  In particular, the discussion regarding \\\"skipThreads.diff\\\" \\n&gt; at:  http:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1219#action_12378300  \\n\\n There are many interesting patches attached to that issue (though I am \\ndefinitely not going for any solution which involves \\nThread.interrupt()). skipThreads.diff seems to do exactly what I \\nproposed. From the comments, it seems like there were two objections: \\n\\n   1) It didn\'t fix all of the hangs. \\n  2) Removing the cleanup code didn\'t feel quite right, but if the \\n     threads could be reused after a restart, it should be okay. \\n\\n The hangs mentioned in (1) could be the same ones as   DERBY-1817   \\nfixed. I also believe that the threads can be reused after a restart. \\n\\n &gt; If we didn\'t close down the threads, would we do anything to notify \\n&gt; them of the shutdown? Were you proposing to leave them alone \\n&gt; entirely? Or were you proposing to notify them of the shutdown, but \\n&gt; not require the threads to exit? \\n\\n I don\'t think we need to notify them about the shutdown. If a thread \\nis waiting for runQueue notification in getNextSession(), it is not \\nbound to a session and hence doesn\'t need to know about the \\nshutdown. If a thread has a session bound to it, it would stay \\nsleeping (and unavailable for new sessions) until the client closes \\nthe connection or disconnects. This is quite similar to the current \\nbehaviour (the closed threads are not freed until there is some \\nactivity on them). \\n\\n For the latter (threads with sessions), it would make sense to notify \\nthem about the shutdown so they could drop their invalid sessions \\nearlier, but that would be an optimization and not a correctness \\nissue, I think. \\n\\n &gt; Are you sure a DRDAConnThread doesn\'t have dependencies on the \\n&gt; engine instance? The thread has a pointer to a session, and a \\n&gt; session seems like it could point to database objects (like \\n&gt; Connection objects, e.g.) \\n\\n All DRDAConnThread\'s dependencies on the engine go through the session \\npointer. For free threads, the session pointer is null, hence there \\nare no dependencies. If it picks up a new session, it would depend on \\nthe new session\'s engine, not the old one. \\n\\n For active DRDAConnThread instances, there are dependencies on the old \\nengine after the shutdown. However, this is also the case for the \\ncurrent code (the thread is marked as closed, but the session is not \\nabandoned and the thread is not stopped until the client tries to \\nperform an operation on the connection).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434428\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434428&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434428\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434428_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434428_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Sep\\/06 12:39\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-13T12:39:29+0000\'\u003e13\\/Sep\\/06 12:39\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'m also exploring these options:\u003cbr\\/\u003e\\n  1) Poisoning all active threads (those with session != null) and keeping the free threads.\u003cbr\\/\u003e\\n  2) Poisoning all threads and make poisoned threads put sessions back in runQueue. This would also require moving the creation of new threads to runQueueAdd() in order to prevent the queue from growing bigger than the pool of free threads.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434428_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434428_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Sep\\/06 12:39\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-13T12:39:29+0000\'\u003e13\\/Sep\\/06 12:39\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'m also exploring these options: \\n  1) Poisoning all active threads (those with session != null) and keeping the free threads. \\n  2) Poisoning all threads and make poisoned threads put sessions back in runQueue. This would also require moving the creation of new threads to runQueueAdd() in order to prevent the queue from growing bigger than the pool of free threads.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434481\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434481&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434481\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12434481_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434481_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Sep\\/06 15:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-13T15:53:22+0000\'\u003e13\\/Sep\\/06 15:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; For the latter (threads with sessions), it would make sense to notify\u003cbr\\/\u003e\\n&gt; them about the shutdown so they could drop their invalid sessions\u003cbr\\/\u003e\\n&gt; earlier, but that would be an optimization and not a correctness\u003cbr\\/\u003e\\n&gt; issue, I think. \u003c\\/p\u003e\\n\\n\u003cp\u003eI think there could be a correctness issue here, actually.\u003c\\/p\u003e\\n\\n\u003cp\u003eOne of my worries had to do with \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-51\\\" title=\\\"Need NetworkServerControl shutdown API method that does not shutdown derby embedded\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-51\\\"\u003eDERBY-51\u003c\\/a\u003e, and whether there was\u003cbr\\/\u003e\\nany implicit or explicit contract about how Network Server shutdown and\u003cbr\\/\u003e\\nengine\\/database shutdown were linked.\u003c\\/p\u003e\\n\\n\u003cp\u003eThat is, it seems to me that a user might expect that if they shut down\u003cbr\\/\u003e\\nthe Network Server, that when that call returned to them, their application\u003cbr\\/\u003e\\ncould assume that the database was also shut down as of that point.\u003c\\/p\u003e\\n\\n\u003cp\u003eNOTE: I\'m not saying that this is how things currently work; I\'m just saying\u003cbr\\/\u003e\\nthat it seems to me that users might make that assumption and we\u003cbr\\/\u003e\\nhaven\'t been explicit about it one way or another. But that\'s \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-51\\\" title=\\\"Need NetworkServerControl shutdown API method that does not shutdown derby embedded\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-51\\\"\u003eDERBY-51\u003c\\/a\u003e,\u003cbr\\/\u003e\\nproperly, not this bug.\u003c\\/p\u003e\\n\\n\u003cp\u003eStill, if we make a change for this bug that forces our hand w.r.t. \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-51\\\" title=\\\"Need NetworkServerControl shutdown API method that does not shutdown derby embedded\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-51\\\"\u003eDERBY-51\u003c\\/a\u003e,\u003cbr\\/\u003e\\nwe should make it clear that we\'re doing so intentionally so that we don\'t\u003cbr\\/\u003e\\nlater reverse that change and re-introduce this problem.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12434481_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434481_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Sep\\/06 15:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-13T15:53:22+0000\'\u003e13\\/Sep\\/06 15:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; For the latter (threads with sessions), it would make sense to notify \\n&gt; them about the shutdown so they could drop their invalid sessions \\n&gt; earlier, but that would be an optimization and not a correctness \\n&gt; issue, I think.  \\n\\n I think there could be a correctness issue here, actually. \\n\\n One of my worries had to do with  DERBY-51 , and whether there was \\nany implicit or explicit contract about how Network Server shutdown and \\nengine\\/database shutdown were linked. \\n\\n That is, it seems to me that a user might expect that if they shut down \\nthe Network Server, that when that call returned to them, their application \\ncould assume that the database was also shut down as of that point. \\n\\n NOTE: I\'m not saying that this is how things currently work; I\'m just saying \\nthat it seems to me that users might make that assumption and we \\nhaven\'t been explicit about it one way or another. But that\'s  DERBY-51 , \\nproperly, not this bug. \\n\\n Still, if we make a change for this bug that forces our hand w.r.t.  DERBY-51 , \\nwe should make it clear that we\'re doing so intentionally so that we don\'t \\nlater reverse that change and re-introduce this problem.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434547\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434547&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434547\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12434547_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434547_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Sep\\/06 21:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-13T21:26:12+0000\'\u003e13\\/Sep\\/06 21:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks Knut for working on this.\u003c\\/p\u003e\\n\\n\u003cp\u003eSome questions\\/thoughts:\u003c\\/p\u003e\\n\u003cul\u003e\\n\\t\u003cli\u003eI think it is okay to re-use free\\/idle threads without closing them. It may not be okay to re-use active threads without closing\\/poisoning them. If we do this, wouldn\'t we end up with threads getting invalid\\/closed sessions to work on?\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eIsn\'t this a possible scenario which can cause a hang in a client: When restart is in progress, a new client session comes in and gets added to runQueue. After the session is added, the restart code closes the new session or clears the runQueue. So the server just discards the new session and the client keeps waiting.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12434547_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434547_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'13\\/Sep\\/06 21:26\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-13T21:26:12+0000\'\u003e13\\/Sep\\/06 21:26\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks Knut for working on this. \\n\\n Some questions\\/thoughts: \\n \\n\\t I think it is okay to re-use free\\/idle threads without closing them. It may not be okay to re-use active threads without closing\\/poisoning them. If we do this, wouldn\'t we end up with threads getting invalid\\/closed sessions to work on? \\n \\n\\n\\n \\n\\t Isn\'t this a possible scenario which can cause a hang in a client: When restart is in progress, a new client session comes in and gets added to runQueue. After the session is added, the restart code closes the new session or clears the runQueue. So the server just discards the new session and the client keeps waiting. \\n \\n\\n\\n\\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434697\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434697&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434697\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434697_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434697_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Sep\\/06 14:39\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-14T14:39:40+0000\'\u003e14\\/Sep\\/06 14:39\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching a patch (derby-1326-cleanup_exceptions.diff) with two small\u003cbr\\/\u003e\\ncleanups in preparation for the real fix (for which the approach\u003cbr\\/\u003e\\nhasn\'t been chosen yet). None of the two cleanups will fix the hang.\u003c\\/p\u003e\\n\\n\u003cp\u003eDescription of cleanup in DRDAConnThread.handleException(): When I was\u003cbr\\/\u003e\\nstress testing one possible fix for the hang, I noticed a new type of\u003cbr\\/\u003e\\nhang that I didn\'t understand. After a bit of investigation, I found\u003cbr\\/\u003e\\nthat the stress test triggered a NullPointerException while running\u003cbr\\/\u003e\\nhandleException(). handleException() is written so that all code paths\u003cbr\\/\u003e\\nend with closeSession() and close(). However, if a runtime exception\u003cbr\\/\u003e\\nis thrown, closeSession() and close() are skipped, and the\u003cbr\\/\u003e\\nDRDAConnThread stops without closing the session (which leads to a\u003cbr\\/\u003e\\nhang on the client). To fix this, I refactored handleException() so\u003cbr\\/\u003e\\nthat closeSession() and close() are called from a finally clause.\u003c\\/p\u003e\\n\\n\u003cp\u003eDescription of cleanup in NetworkServerControlImpl.startNetworkServer():\u003cbr\\/\u003e\\nCurrently, the restart code closes and removes all sessions in\u003cbr\\/\u003e\\nrunQueue, but it leaves them in sessionTable as long as the network\u003cbr\\/\u003e\\nserver runs. Fix: Remove them from sessionTable as well. Also, a\u003cbr\\/\u003e\\nsynchronized block was added around the runQueue loop in case\u003cbr\\/\u003e\\naddSession() or getNextSession() modifies the size of runQueue while\u003cbr\\/\u003e\\nthe loop is running.\u003c\\/p\u003e\\n\\n\u003cp\u003eI thought it would be better to get in these changes in advance to\u003cbr\\/\u003e\\nmake the real fix smaller and cleaner.\u003c\\/p\u003e\\n\\n\u003cp\u003eDerbyall ran cleanly with these changes.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434697_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434697_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Sep\\/06 14:39\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-14T14:39:40+0000\'\u003e14\\/Sep\\/06 14:39\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attaching a patch (derby-1326-cleanup_exceptions.diff) with two small \\ncleanups in preparation for the real fix (for which the approach \\nhasn\'t been chosen yet). None of the two cleanups will fix the hang. \\n\\n Description of cleanup in DRDAConnThread.handleException(): When I was \\nstress testing one possible fix for the hang, I noticed a new type of \\nhang that I didn\'t understand. After a bit of investigation, I found \\nthat the stress test triggered a NullPointerException while running \\nhandleException(). handleException() is written so that all code paths \\nend with closeSession() and close(). However, if a runtime exception \\nis thrown, closeSession() and close() are skipped, and the \\nDRDAConnThread stops without closing the session (which leads to a \\nhang on the client). To fix this, I refactored handleException() so \\nthat closeSession() and close() are called from a finally clause. \\n\\n Description of cleanup in NetworkServerControlImpl.startNetworkServer(): \\nCurrently, the restart code closes and removes all sessions in \\nrunQueue, but it leaves them in sessionTable as long as the network \\nserver runs. Fix: Remove them from sessionTable as well. Also, a \\nsynchronized block was added around the runQueue loop in case \\naddSession() or getNextSession() modifies the size of runQueue while \\nthe loop is running. \\n\\n I thought it would be better to get in these changes in advance to \\nmake the real fix smaller and cleaner. \\n\\n Derbyall ran cleanly with these changes.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434718\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434718&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434718\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434718_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434718_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Sep\\/06 15:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-14T15:53:20+0000\'\u003e14\\/Sep\\/06 15:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eBryan, I\'m not sure I understand what impact this could have on\u003cbr\\/\u003e\\n\u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-51\\\" title=\\\"Need NetworkServerControl shutdown API method that does not shutdown derby embedded\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-51\\\"\u003eDERBY-51\u003c\\/a\u003e. \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-51\\\" title=\\\"Need NetworkServerControl shutdown API method that does not shutdown derby embedded\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-51\\\"\u003eDERBY-51\u003c\\/a\u003e is about server shutdown, whereas this issue is\u003cbr\\/\u003e\\nabout a client opening a connection which has the side effect of\u003cbr\\/\u003e\\nshutting down the engine.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; That is, it seems to me that a user might expect that if they shut\u003cbr\\/\u003e\\n&gt; down the Network Server, that when that call returned to them, their\u003cbr\\/\u003e\\n&gt; application could assume that the database was also shut down as of\u003cbr\\/\u003e\\n&gt; that point.\u003c\\/p\u003e\\n\\n\u003cp\u003eIf the network server is started from command line and the user\u003cbr\\/\u003e\\ninvokes NetworkServerControl.shutdown() this is exactly what happens\u003cbr\\/\u003e\\nin Derby 10.2. In 10.1, and in 10.2 when the server is not started\u003cbr\\/\u003e\\nfrom command line, the server does not shut down the engine\\/databases\u003cbr\\/\u003e\\non shutdown. However, getConnection(\\\"...;shutdown=true\\\") does not shut\u003cbr\\/\u003e\\ndown the server, only the engine.\u003c\\/p\u003e\\n\\n\u003cp\u003eI don\'t see that poisoning or not poisoning the threads should affect\u003cbr\\/\u003e\\nthat behaviour or \\\"force our hands\\\" in any way w.r.t. \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-51\\\" title=\\\"Need NetworkServerControl shutdown API method that does not shutdown derby embedded\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-51\\\"\u003eDERBY-51\u003c\\/a\u003e. When\u003cbr\\/\u003e\\nthe \u003cb\u003eserver\u003c\\/b\u003e at a later point is told to shut down, it is free to shut\u003cbr\\/\u003e\\ndown (or not to shut down) the \u003cb\u003eengine\u003c\\/b\u003e regardless of threads with old\u003cbr\\/\u003e\\nsessions hanging around. Also, threads with old sessions can be\u003cbr\\/\u003e\\npresent on the server for a long time after an engine shutdown even in\u003cbr\\/\u003e\\nthe current code (there is no call to Thread.interrupt() after the\u003cbr\\/\u003e\\nengine has been shut down).\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434718_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434718_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Sep\\/06 15:53\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-14T15:53:20+0000\'\u003e14\\/Sep\\/06 15:53\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Bryan, I\'m not sure I understand what impact this could have on \\n DERBY-51 .  DERBY-51  is about server shutdown, whereas this issue is \\nabout a client opening a connection which has the side effect of \\nshutting down the engine. \\n\\n &gt; That is, it seems to me that a user might expect that if they shut \\n&gt; down the Network Server, that when that call returned to them, their \\n&gt; application could assume that the database was also shut down as of \\n&gt; that point. \\n\\n If the network server is started from command line and the user \\ninvokes NetworkServerControl.shutdown() this is exactly what happens \\nin Derby 10.2. In 10.1, and in 10.2 when the server is not started \\nfrom command line, the server does not shut down the engine\\/databases \\non shutdown. However, getConnection(\\\"...;shutdown=true\\\") does not shut \\ndown the server, only the engine. \\n\\n I don\'t see that poisoning or not poisoning the threads should affect \\nthat behaviour or \\\"force our hands\\\" in any way w.r.t.  DERBY-51 . When \\nthe  server  at a later point is told to shut down, it is free to shut \\ndown (or not to shut down) the  engine  regardless of threads with old \\nsessions hanging around. Also, threads with old sessions can be \\npresent on the server for a long time after an engine shutdown even in \\nthe current code (there is no call to Thread.interrupt() after the \\nengine has been shut down).              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434752\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434752&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434752\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434752_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434752_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Sep\\/06 17:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-14T17:56:51+0000\'\u003e14\\/Sep\\/06 17:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eDeepa wrote:\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; * I think it is okay to re-use free\\/idle threads without closing\u003cbr\\/\u003e\\n&gt;   them. It may not be okay to re-use active threads without\u003cbr\\/\u003e\\n&gt;   closing\\/poisoning them. If we do this, wouldn\'t we end up with\u003cbr\\/\u003e\\n&gt;   threads getting invalid\\/closed sessions to work on?\u003c\\/p\u003e\\n\\n\u003cp\u003eYes, that is correct. This is also the case with the current code. The\u003cbr\\/\u003e\\nactive threads remain alive until the client sends a new\u003cbr\\/\u003e\\ncommand. Since the embedded connection is closed, it gets a\u003cbr\\/\u003e\\nconnection-closed exception and closes the session, before it\u003cbr\\/\u003e\\ndiscovers that the thread is closed as well, and exits. If we don\'t\u003cbr\\/\u003e\\nclose the threads, we get the same behaviour, except that the thread\u003cbr\\/\u003e\\nis reused instead of closed down after the connection-closed\u003cbr\\/\u003e\\nexception.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; * Isn\'t this a possible scenario which can cause a hang in a client:\u003cbr\\/\u003e\\n&gt;   When restart is in progress, a new client session comes in and gets\u003cbr\\/\u003e\\n&gt;   added to runQueue. After the session is added, the restart code\u003cbr\\/\u003e\\n&gt;   closes the new session or clears the runQueue. So the server just\u003cbr\\/\u003e\\n&gt;   discards the new session and the client keeps waiting.\u003c\\/p\u003e\\n\\n\u003cp\u003eThis is a possible scenario, but it won\'t cause a hang. Since the\u003cbr\\/\u003e\\nsession and its socket streams have been closed, the client will get\u003cbr\\/\u003e\\nan IOException on read() (seen as DRDAProtocolException, for instance:\u003cbr\\/\u003e\\ninsufficient data, read -1 bytes, expected 6).\u003c\\/p\u003e\\n\\n\u003cp\u003e(But there is in fact a similar situation that can occur in the\u003cbr\\/\u003e\\ncurrent code, and that will cause a hang: If a new session is added to\u003cbr\\/\u003e\\nrunQueue after the restart code has closed all sessions in runQueue,\u003cbr\\/\u003e\\nbut before it has called runQueue.clear(), the new session will be\u003cbr\\/\u003e\\nremoved from runQueue without being closed, and the client will\u003cbr\\/\u003e\\nhang. derby-1326-cleanup_exceptions.diff should fix that issue.)\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434752_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434752_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Sep\\/06 17:56\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-14T17:56:51+0000\'\u003e14\\/Sep\\/06 17:56\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Deepa wrote: \\n\\n &gt; * I think it is okay to re-use free\\/idle threads without closing \\n&gt;   them. It may not be okay to re-use active threads without \\n&gt;   closing\\/poisoning them. If we do this, wouldn\'t we end up with \\n&gt;   threads getting invalid\\/closed sessions to work on? \\n\\n Yes, that is correct. This is also the case with the current code. The \\nactive threads remain alive until the client sends a new \\ncommand. Since the embedded connection is closed, it gets a \\nconnection-closed exception and closes the session, before it \\ndiscovers that the thread is closed as well, and exits. If we don\'t \\nclose the threads, we get the same behaviour, except that the thread \\nis reused instead of closed down after the connection-closed \\nexception. \\n\\n &gt; * Isn\'t this a possible scenario which can cause a hang in a client: \\n&gt;   When restart is in progress, a new client session comes in and gets \\n&gt;   added to runQueue. After the session is added, the restart code \\n&gt;   closes the new session or clears the runQueue. So the server just \\n&gt;   discards the new session and the client keeps waiting. \\n\\n This is a possible scenario, but it won\'t cause a hang. Since the \\nsession and its socket streams have been closed, the client will get \\nan IOException on read() (seen as DRDAProtocolException, for instance: \\ninsufficient data, read -1 bytes, expected 6). \\n\\n (But there is in fact a similar situation that can occur in the \\ncurrent code, and that will cause a hang: If a new session is added to \\nrunQueue after the restart code has closed all sessions in runQueue, \\nbut before it has called runQueue.clear(), the new session will be \\nremoved from runQueue without being closed, and the client will \\nhang. derby-1326-cleanup_exceptions.diff should fix that issue.)              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434834\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434834&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434834\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12434834_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434834_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Sep\\/06 22:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-14T22:29:16+0000\'\u003e14\\/Sep\\/06 22:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi Knut Anders, thanks for the clarifications. I am comfortable with your explanation.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12434834_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434834_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Sep\\/06 22:29\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-14T22:29:16+0000\'\u003e14\\/Sep\\/06 22:29\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hi Knut Anders, thanks for the clarifications. I am comfortable with your explanation.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434851\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434851&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434851\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12434851_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434851_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Sep\\/06 23:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-14T23:55:15+0000\'\u003e14\\/Sep\\/06 23:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks Knut for the answers. I still cannot wrap my head around old sessions hanging around in the server. I think this concerns the current code and not related to your patch. The cleanups you suggested sound good to me.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12434851_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434851_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'14\\/Sep\\/06 23:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-14T23:55:15+0000\'\u003e14\\/Sep\\/06 23:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks Knut for the answers. I still cannot wrap my head around old sessions hanging around in the server. I think this concerns the current code and not related to your patch. The cleanups you suggested sound good to me. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434908\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434908&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434908\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434908_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434908_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Sep\\/06 08:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-15T08:14:32+0000\'\u003e15\\/Sep\\/06 08:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eCommitted derby-1326-cleanup_exceptions.diff with revision 446538.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434908_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434908_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Sep\\/06 08:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-15T08:14:32+0000\'\u003e15\\/Sep\\/06 08:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Committed derby-1326-cleanup_exceptions.diff with revision 446538.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434975\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434975&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434975\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434975_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434975_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Sep\\/06 13:40\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-15T13:40:42+0000\'\u003e15\\/Sep\\/06 13:40\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching patch (derby-1326-skipThreads.diff) which modifies NetworkServerControlImpl the same way as Bryan\'s skipThreads.diff (attached to \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1219\\\" title=\\\"jdbcapi\\/checkDataSource.java and jdbcapi\\/checkDataSource30.java hang intermittently with client\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1219\\\"\u003e\u003cdel\u003eDERBY-1219\u003c\\/del\u003e\u003c\\/a\u003e). I cannot reproduce the hang with the patch. Derbyall ran cleanly on Solaris 10 x86, Sun JVM 1.5.0.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434975_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434975_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Sep\\/06 13:40\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-15T13:40:42+0000\'\u003e15\\/Sep\\/06 13:40\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attaching patch (derby-1326-skipThreads.diff) which modifies NetworkServerControlImpl the same way as Bryan\'s skipThreads.diff (attached to   DERBY-1219  ). I cannot reproduce the hang with the patch. Derbyall ran cleanly on Solaris 10 x86, Sun JVM 1.5.0.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434985\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434985&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434985\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434985_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434985_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Sep\\/06 14:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-15T14:05:12+0000\'\u003e15\\/Sep\\/06 14:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eDeepa wrote:\u003cbr\\/\u003e\\n&gt; I still cannot wrap my head around old sessions hanging around in the server.\u003c\\/p\u003e\\n\\n\u003cp\u003eThey hang around in the server because the DRDAConnThread could be blocked in a read() call. read() will block until the socket stream is closed (either by the client or the server) or the client sends data. Calling close() on the DRDAConnThread only sets a flag, so this won\'t interrupt read(). I think Bryan was very close to solving this when he went through sessionTable and closed each session (which will take down the socket stream and make read() return -1 immediately). See one of his earlier comments about this. I don\'t think that issue is directly related to the hang or abandoning of sessions, so it should probably be filed as a separate issue.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12434985_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434985_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Sep\\/06 14:05\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-15T14:05:12+0000\'\u003e15\\/Sep\\/06 14:05\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Deepa wrote: \\n&gt; I still cannot wrap my head around old sessions hanging around in the server. \\n\\n They hang around in the server because the DRDAConnThread could be blocked in a read() call. read() will block until the socket stream is closed (either by the client or the server) or the client sends data. Calling close() on the DRDAConnThread only sets a flag, so this won\'t interrupt read(). I think Bryan was very close to solving this when he went through sessionTable and closed each session (which will take down the socket stream and make read() return -1 immediately). See one of his earlier comments about this. I don\'t think that issue is directly related to the hang or abandoning of sessions, so it should probably be filed as a separate issue.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12434998\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12434998&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12434998\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12434998_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434998_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Sep\\/06 14:42\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-15T14:42:55+0000\'\u003e15\\/Sep\\/06 14:42\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI\'ll file a separate issue for removing all the existing sessions after a restart. From Knut\'s comments, this is only an optimization issue.\u003c\\/p\u003e\\n\\n\u003cp\u003eAs derby-1326-skipThreads.diff resolves this hang, we can re-enable the shutdown in the test jdbcapi\\/checkDataSource.java. This was commented out as it caused the test to hang intermittently. It may be good to add the new repro \\\"Restart.java\\\" to the regression tests as it reliably reproduces this hang.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12434998_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12434998_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'15\\/Sep\\/06 14:42\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-15T14:42:55+0000\'\u003e15\\/Sep\\/06 14:42\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I\'ll file a separate issue for removing all the existing sessions after a restart. From Knut\'s comments, this is only an optimization issue. \\n\\n As derby-1326-skipThreads.diff resolves this hang, we can re-enable the shutdown in the test jdbcapi\\/checkDataSource.java. This was commented out as it caused the test to hang intermittently. It may be good to add the new repro \\\"Restart.java\\\" to the regression tests as it reliably reproduces this hang.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12435462\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12435462&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12435462\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12435462_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12435462_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Sep\\/06 11:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-18T11:45:42+0000\'\u003e18\\/Sep\\/06 11:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks for the suggestions, Deepa. I committed skipThreads with revision 447375. Will post a new patch with the suggested test changes.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12435462_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12435462_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Sep\\/06 11:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-18T11:45:42+0000\'\u003e18\\/Sep\\/06 11:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks for the suggestions, Deepa. I committed skipThreads with revision 447375. Will post a new patch with the suggested test changes.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12435519\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12435519&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12435519\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12435519_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12435519_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Sep\\/06 16:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-18T16:35:07+0000\'\u003e18\\/Sep\\/06 16:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ederby-1326-checkds.diff re-enables the shutdown in checkDataSource. Without the skipThreads patch, checkDataSource and checkDataSource30 hung intermittently. With the skipThreads patch, they didn\'t. Derbyall ran cleanly. Committed with revision 447462.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12435519_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12435519_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Sep\\/06 16:35\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-18T16:35:07+0000\'\u003e18\\/Sep\\/06 16:35\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    derby-1326-checkds.diff re-enables the shutdown in checkDataSource. Without the skipThreads patch, checkDataSource and checkDataSource30 hung intermittently. With the skipThreads patch, they didn\'t. Derbyall ran cleanly. Committed with revision 447462.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12437487\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12437487&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12437487\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12437487_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12437487_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Sep\\/06 09:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-25T09:06:09+0000\'\u003e25\\/Sep\\/06 09:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching a patch which makes derbynet\\/ShutDownDBWhenNSShutsDownTest.junit run the repro (Restart.java) as a JUnit test case.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12437487_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12437487_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Sep\\/06 09:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-25T09:06:09+0000\'\u003e25\\/Sep\\/06 09:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attaching a patch which makes derbynet\\/ShutDownDBWhenNSShutsDownTest.junit run the repro (Restart.java) as a JUnit test case.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12437489\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12437489&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12437489\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12437489_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12437489_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Sep\\/06 09:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-25T09:14:24+0000\'\u003e25\\/Sep\\/06 09:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eCommitted derby-1326-restartTest.diff with revision 449616. Marking as fixed in 10.2.1.5 since the fix (but not all tests) made it into the release candidate.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12437489_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12437489_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Sep\\/06 09:14\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-25T09:14:24+0000\'\u003e25\\/Sep\\/06 09:14\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Committed derby-1326-restartTest.diff with revision 449616. Marking as fixed in 10.2.1.5 since the fix (but not all tests) made it into the release candidate.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12437581\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1326?focusedCommentId=12437581&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12437581\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12437581_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12437581_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Sep\\/06 14:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-25T14:54:54+0000\'\u003e25\\/Sep\\/06 14:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eClosing the issue as the fix is available in 10.2 and trunk. Thanks to Knut, Bryan (and others involved) in resolving this issue.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"deepa\\\" id=\\\"commentauthor_12437581_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=deepa\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=34050\\\" alt=\\\"deepa\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Deepa Remesh\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12437581_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Sep\\/06 14:54\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-09-25T14:54:54+0000\'\u003e25\\/Sep\\/06 14:54\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Closing the issue as the fix is available in 10.2 and trunk. Thanks to Knut, Bryan (and others involved) in resolving this issue.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\"";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["scope-filter-data"]="{\"createScopeActions\":[],\"scopes\":[]}";
WRM._unparsedData["sidebar-collapsed-by-default"]="true";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:can-manage"]="false";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:with-icons"]="false";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:shortcuts"]="[]";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:project-id"]="10594";
WRM._unparsedData["sidebar-id"]="\"\u003cdiv class=\\\"aui-sidebar  projects-sidebar sidebar-pending\\\" \u003e\u003cdiv class=\\\"aui-sidebar-wrapper\\\"\u003e\u003cdiv class=\\\"aui-sidebar-body\\\"\u003e\u003cheader class=\\\"aui-page-header\\\"\u003e\u003cdiv class=\\\"aui-page-header-inner\\\"\u003e\u003cdiv class=\\\"aui-page-header-image\\\"\u003e\u003ca href=\\\"\\/jira\\/projects\\/DERBY\\/summary\\\" title=\\\"Derby\\\" class=\\\"jira-project-avatar\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-large aui-avatar-project\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"\\/jira\\/secure\\/projectavatar?pid=10594&amp;avatarId=10122\\\" alt=\\\"Derby\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e\u003cimg src=\\\"data:image\\/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI\\/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE4LjEuMSwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCINCgkgdmlld0JveD0iMCAwIDMwMCAzMDAiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDMwMCAzMDA7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxnIGlkPSJMYXllcl8yIj4NCgk8cGF0aCBzdHlsZT0iZmlsbDojRjc5MjMyOyIgZD0iTTE1MCwwQzY2LjY2NywwLDAsNjYuNjY3LDAsMTUwczY2LjY2NywxNTAsMTUwLDE1MHMxNTAtNjYuNjY3LDE1MC0xNTBTMjMzLjMzMywwLDE1MCwweg0KCQkgTTEzNi42NjcsMTc4LjMzM0wxMjUsMTkwbC00MS42NjctNDBMOTUsMTM4LjMzM2wzMC0zMEwxMzYuNjY3LDEyMGwtMzAsMzBMMTM2LjY2NywxNzguMzMzeiBNMjA1LDE2MS42NjdsLTMwLDMwTDE2My4zMzMsMTgwDQoJCWwzMC0zMGwtMzAtMzBMMTc1LDEwOC4zMzNMMjE2LjY2NywxNTBMMjA1LDE2MS42Njd6Ii8+DQo8L2c+DQo8Zz4NCgk8cG9seWdvbiBzdHlsZT0iZmlsbDojRkZGRkZGOyIgcG9pbnRzPSIxNzUsMTkxLjY2NyAyMDUsMTYxLjY2NyAyMTYuNjY3LDE1MCAxNzUsMTA4LjMzMyAxNjMuMzMzLDEyMCAxOTMuMzMzLDE1MCAxNjMuMzMzLDE4MCAJIi8+DQoJPHBvbHlnb24gc3R5bGU9ImZpbGw6I0ZGRkZGRjsiIHBvaW50cz0iMTI1LDEwOC4zMzMgOTUsMTM4LjMzMyA4My4zMzMsMTUwIDEyNSwxOTAgMTM2LjY2NywxNzguMzMzIDEwNi42NjcsMTUwIDEzNi42NjcsMTIwIAkiLz4NCjwvZz4NCjwvc3ZnPg0K\\\" alt=\\\"Icon indicating the project type\\\" class=\\\"jira-project-avatar-icon\\\" \\/\u003e\u003c\\/a\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-image --\u003e\u003cdiv class=\\\"aui-page-header-main\\\"\u003e\u003ch1\u003e\u003cdiv class=\\\"aui-group aui-group-split\\\"\u003e\u003cdiv class=\\\"aui-item project-title\\\"\u003e\u003ca href=\\\"\\/jira\\/projects\\/DERBY\\/summary\\\" title=\\\"Derby\\\"\u003eDerby\u003c\\/a\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/h1\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-main --\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-inner --\u003e\u003c\\/header\u003e\u003c!-- .aui-page-header --\u003e\u003cnav class=\\\"aui-navgroup aui-navgroup-vertical\\\"\u003e\u003cdiv class=\\\"aui-navgroup-inner sidebar-content-container\\\"\u003e\u003cdiv class=\\\"aui-sidebar-group aui-sidebar-group-tier-one\\\" data-id=\\\"sidebar-navigation-panel\\\"\u003e\u003cul class=\\\"aui-nav\\\"\u003e\u003cli class=\\\"aui-nav-selected\\\" \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/DERBY\\/issues\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-issue-navigator:sidebar-issue-navigator\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large icon-sidebar-issues\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Issues\\\"\u003eIssues\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003cli  \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/DERBY?selectedItem=com.atlassian.jira.jira-projects-plugin:report-page\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-plugin:report-page\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large agile-icon-report\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Reports\\\"\u003eReports\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003cli  \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/DERBY?selectedItem=com.atlassian.jira.jira-projects-plugin:components-page\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-plugin:components-page\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large icon-sidebar-components\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Components\\\"\u003eComponents\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003c\\/ul\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/nav\u003e\u003c\\/div\u003e\u003cdiv class=\\\"aui-sidebar-footer\\\"\u003e\u003ca class=\\\"aui-button aui-button-subtle aui-sidebar-toggle aui-sidebar-footer-tipsy\\\" data-tooltip=\\\"Expand sidebar ( [ )\\\" href=\\\"#\\\"\u003e\u003cspan class=\\\"aui-icon aui-icon-small\\\"\u003e\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/div\u003e\"";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:bigpipe-init/jira.webresources:bigpipe-init.js" data-wrm-key="jira.webresources:bigpipe-init" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <form id="jira_request_timing_info" class="dont-default-focus"> 
   <fieldset class="parameters hidden"> 
    <input type="hidden" title="jira.request.start.millis" value="1520238294045"> 
    <input type="hidden" title="jira.request.server.time" value="250"> 
    <input type="hidden" title="jira.request.id" value="504x94353317x2"> 
    <input type="hidden" title="jira.session.expiry.time" value="-"> 
    <input type="hidden" title="jira.session.expiry.in.mins" value="-"> 
    <input id="jiraConcurrentRequests" type="hidden" name="jira.request.concurrent.requests" value="5"> 
    <input type="hidden" title="db.reads.time.in.ms" value="22"> 
    <input type="hidden" title="db.conns.time.in.ms" value="27"> 
   </fieldset> 
  </form> 
  <!--
	                 REQUEST ID : 504x94353317x2
	          REQUEST TIMESTAMP : [05/Mar/2018:08:24:54 +0000]
	               REQUEST TIME : 0.2500
	                 ASESSIONID : -
	        CONCURRENT REQUESTS : 5

	                      db.reads : OpSnapshot{name='db.reads', invocationCount=26, elapsedTotal=22652848, elapsedMin=441845, elapsedMax=6825275, resultSetSize=0, cpuTotal=0, cpuMin=0, cpuMax=0}
	                      db.conns : OpSnapshot{name='db.conns', invocationCount=30, elapsedTotal=27826029, elapsedMin=465717, elapsedMax=6854223, resultSetSize=0, cpuTotal=0, cpuMin=0, cpuMax=0}
-->   
 </body>
</html>