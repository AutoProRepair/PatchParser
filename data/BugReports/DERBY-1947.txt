<!doctype html>
<html lang="en">
 <head> 
  <meta charset="utf-8"> 
  <meta http-equiv="X-UA-Compatible" content="IE=Edge"> 
  <meta name="application-name" content="JIRA" data-name="jira" data-version="7.6.3">
  <meta name="ajs-viewissue-use-history-api" content="false"> 
  <meta name="ajs-jira-base-url" content="https://issues.apache.org/jira"> 
  <meta name="ajs-serverRenderedViewIssue" content="true"> 
  <meta name="ajs-dev-mode" content="false"> 
  <meta name="ajs-context-path" content="/jira"> 
  <meta name="ajs-version-number" content="7.6.3"> 
  <meta name="ajs-build-number" content="76005"> 
  <meta name="ajs-is-beta" content="false"> 
  <meta name="ajs-is-rc" content="false"> 
  <meta name="ajs-is-snapshot" content="false"> 
  <meta name="ajs-is-milestone" content="false"> 
  <meta name="ajs-remote-user" content=""> 
  <meta name="ajs-remote-user-fullname" content=""> 
  <meta name="ajs-user-locale" content="en_UK"> 
  <meta name="ajs-user-locale-group-separator" content=","> 
  <meta name="ajs-app-title" content="ASF JIRA"> 
  <meta name="ajs-keyboard-shortcuts-enabled" content="true"> 
  <meta name="ajs-keyboard-accesskey-modifier" content="Ctrl+Alt"> 
  <meta name="ajs-enabled-dark-features" content="[&quot;com.atlassian.jira.agile.darkfeature.editable.detailsview&quot;,&quot;nps.survey.inline.dialog&quot;,&quot;com.atlassian.jira.agile.darkfeature.edit.closed.sprint.enabled&quot;,&quot;jira.plugin.devstatus.phasetwo&quot;,&quot;jira.frother.reporter.field&quot;,&quot;atlassian.rest.xsrf.legacy.enabled&quot;,&quot;jira.issue.status.lozenge&quot;,&quot;com.atlassian.jira.config.BIG_PIPE&quot;,&quot;com.atlassian.jira.projects.issuenavigator&quot;,&quot;com.atlassian.jira.config.PDL&quot;,&quot;jira.plugin.devstatus.phasetwo.enabled&quot;,&quot;atlassian.aui.raphael.disabled&quot;,&quot;app-switcher.new&quot;,&quot;frother.assignee.field&quot;,&quot;com.atlassian.jira.projects.ProjectCentricNavigation.Switch&quot;,&quot;sd.internal.base.off.thread.on.completion.events.enabled&quot;,&quot;jira.onboarding.cyoa&quot;,&quot;com.atlassian.jira.agile.darkfeature.kanplan.enabled&quot;,&quot;sd.slavalue.record.updated.date.enabled&quot;,&quot;com.atlassian.jira.config.ProjectConfig.MENU&quot;,&quot;com.atlassian.jira.projects.sidebar.DEFER_RESOURCES&quot;,&quot;com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions.enabled&quot;,&quot;com.atlassian.jira.agile.darkfeature.sprint.goal.enabled&quot;,&quot;jira.zdu.admin-updates-ui&quot;,&quot;jira.zdu.jmx-monitoring&quot;,&quot;sd.sla.improved.rendering.enabled&quot;,&quot;sd.canned.responses.enabled&quot;,&quot;sd.new.settings.sidebar.location.disabled&quot;,&quot;jira.zdu.cluster-upgrade-state&quot;,&quot;com.atlassian.jira.agile.darkfeature.splitissue&quot;,&quot;com.atlassian.jira.config.CoreFeatures.LICENSE_ROLES_ENABLED&quot;,&quot;com.atlassian.feedback.feedback-button-move-to-header-enable&quot;,&quot;jira.export.csv.enabled&quot;]"> 
  <meta name="ajs-in-admin-mode" content="false"> 
  <meta name="ajs-is-sysadmin" content="false"> 
  <meta name="ajs-is-admin" content="false"> 
  <meta name="ajs-outgoing-mail-enabled" content="true"> 
  <meta name="ajs-date-relativize" content="true"> 
  <meta name="ajs-date-time" content="HH:mm"> 
  <meta name="ajs-date-day" content="EEEE HH:mm"> 
  <meta name="ajs-date-dmy" content="dd/MMM/yy"> 
  <meta name="ajs-date-complete" content="dd/MMM/yy HH:mm"> 
  <script type="text/javascript">var AJS=AJS||{};AJS.debug=true;</script> 
  <meta id="atlassian-token" name="atlassian-token" content="A5KQ-2QAV-T4JA-FDED|f3173c08192bf71401e2bf8e29c33d7250794e08|lout"> 
  <link rel="shortcut icon" href="/jira/s/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/_/favicon.ico"> 
  <!--[if IE]><![endif]--> 
  <script type="text/javascript">
    (function() {
        var contextPath = '/jira';
        var eventBuffer = [];

        function printDeprecatedMsg() {
            if (console && console.warn) {
                console.warn('DEPRECATED JS - contextPath global variable has been deprecated since 7.4.0. Use `wrm/context-path` module instead.');
            }
        }

        function sendEvent(analytics, postfix) {
            analytics.send({
                name: 'js.globals.contextPath.' + postfix
            });
        }

        function sendDeprecatedEvent(postfix) {
            try {
                var analytics = require('jira/analytics');
                if (eventBuffer.length) {
                    eventBuffer.forEach(function(value) {
                        sendEvent(analytics, value);
                    });
                    eventBuffer = [];
                }

                if (postfix) {
                    sendEvent(analytics, postfix);
                }
            } catch(ex) {
                eventBuffer.push(postfix);
                setTimeout(sendDeprecatedEvent, 1000);
            }
        }

        Object.defineProperty(window, 'contextPath', {
            get: function() {
                printDeprecatedMsg();
                sendDeprecatedEvent('get');
                return contextPath;
            },
            set: function(value) {
                printDeprecatedMsg();
                sendDeprecatedEvent('set');
                contextPath = value;
            }
        });
    })();

</script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"/jira\"";
WRM._unparsedData["jira.webresources:feature-flags.feature-flag-data"]="{\"enabled-feature-keys\":[\"com.atlassian.jira.agile.darkfeature.editable.detailsview\",\"nps.survey.inline.dialog\",\"com.atlassian.jira.agile.darkfeature.edit.closed.sprint.enabled\",\"jira.plugin.devstatus.phasetwo\",\"jira.frother.reporter.field\",\"atlassian.rest.xsrf.legacy.enabled\",\"jira.issue.status.lozenge\",\"com.atlassian.jira.config.BIG_PIPE\",\"com.atlassian.jira.projects.issuenavigator\",\"com.atlassian.jira.config.PDL\",\"jira.plugin.devstatus.phasetwo.enabled\",\"atlassian.aui.raphael.disabled\",\"app-switcher.new\",\"frother.assignee.field\",\"com.atlassian.jira.projects.ProjectCentricNavigation.Switch\",\"sd.internal.base.off.thread.on.completion.events.enabled\",\"jira.onboarding.cyoa\",\"com.atlassian.jira.agile.darkfeature.kanplan.enabled\",\"sd.slavalue.record.updated.date.enabled\",\"com.atlassian.jira.config.ProjectConfig.MENU\",\"com.atlassian.jira.projects.sidebar.DEFER_RESOURCES\",\"com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions.enabled\",\"com.atlassian.jira.agile.darkfeature.sprint.goal.enabled\",\"jira.zdu.admin-updates-ui\",\"jira.zdu.jmx-monitoring\",\"sd.sla.improved.rendering.enabled\",\"sd.canned.responses.enabled\",\"sd.new.settings.sidebar.location.disabled\",\"jira.zdu.cluster-upgrade-state\",\"com.atlassian.jira.agile.darkfeature.splitissue\",\"com.atlassian.jira.config.CoreFeatures.LICENSE_ROLES_ENABLED\",\"com.atlassian.feedback.feedback-button-move-to-header-enable\",\"jira.export.csv.enabled\"],\"feature-flag-states\":{\"com.atlassian.jira.agile.darkfeature.kanplan\":false,\"sd.internal.base.off.thread.on.completion.events\":false,\"jira.instrumentation.laas\":false,\"com.atlassian.jira.agile.darkfeature.edit.closed.sprint\":false,\"com.atlassian.jira.issuetable.draggable\":true,\"jira.create.linked.issue\":true,\"com.atlassian.jira.agile.darkfeature.sprint.goal\":false,\"jira.sal.host.connect.accessor.existing.transaction.will.create.transactions\":true,\"jira.jql.suggestrecentfields\":false,\"com.atlassian.jira.agile.darkfeature.kanplan.epics.and.versions\":false,\"jira.jql.smartautoselectfirst\":false,\"com.atlassian.jira.agile.darkfeature.optimistic.transitions\":true,\"com.atlassian.jira.issuetable.move.links.hidden\":true,\"jira.priorities.per.project\":true,\"com.atlassian.jira.upgrade.startup.fix.index\":true,\"jira.renderer.consider.variable.format\":true}}";
WRM._unparsedData["jira.webresources:default-comment-security-level.DefaultCommentSecurityLevelHelpLink"]="{\"extraClasses\":\"default-comment-level-help\",\"title\":\"Commenting on an Issue\",\"url\":\"https://docs.atlassian.com/jira/jcore-docs-076/Editing+and+collaborating+on+issues#Editingandcollaboratingonissues-restrictacomment\",\"isLocal\":false}";
WRM._unparsedData["jira.webresources:dateFormatProvider.allFormats"]="{\"dateFormats\":{\"meridiem\":[\"AM\",\"PM\"],\"eras\":[\"BC\",\"AD\"],\"months\":[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"monthsShort\":[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"weekdaysShort\":[\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\",\"Sat\"],\"weekdays\":[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"]},\"lookAndFeelFormats\":{\"relativize\":\"true\",\"time\":\"HH:mm\",\"day\":\"EEEE HH:mm\",\"dmy\":\"dd/MMM/yy\",\"complete\":\"dd/MMM/yy HH:mm\"}}";
WRM._unparsedData["com.atlassian.jira.jira-issue-nav-components:issueviewer.features"]="{\"rteEnabled\":true}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-dnd-attachment-plugin:dnd-issue-drop-zone.thumbnail-mime-types"]="\"image/vnd.wap.wbmp,image/png,image/x-png,image/jpeg,image/bmp,image/gif\"";
WRM._unparsedData["com.atlassian.jira.plugins.jira-dnd-attachment-plugin:dnd-issue-drop-zone.upload-limit"]="\"62914560\"";
WRM._unparsedData["com.atlassian.plugins.helptips.jira-help-tips:help-tip-manager.JiraHelpTipData"]="{\"anonymous\":true}";
WRM._unparsedData["com.atlassian.jira.jira-view-issue-plugin:controller-subtasks.controller.subtasks.parameters"]="{\"url\":\"/rest/api/2/issue/{issueId}/subtask/move\"}";
WRM._unparsedData["com.atlassian.analytics.analytics-client:policy-update-init.policy-update-data-provider"]="false";
WRM._unparsedData["com.atlassian.analytics.analytics-client:programmatic-analytics-init.programmatic-analytics-data-provider"]="false";
WRM._unparsedData["jira.webresources:avatar-picker.data"]="{}";
WRM._unparsedData["com.atlassian.feedback.jira-feedback-plugin:button-resources-init.data"]="{\"jira.feedback.plugin.issue.collector.core\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"jira.feedback.plugin.issue.collector.default\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"jira.feedback.plugin.issue.collector.service.desk\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?locale=en-UK&collectorId=a698db21\",\"jira.feedback.plugin.issue.collector.software\":\"https://jira.atlassian.com/s/576e9ab86257d4f65f6ea5b6dd50de44-T/en_UK3ljiw5/71006/b6b48b2829824b869586ac216d119363/2.0.11/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-UK&collectorId=abbf546d\",\"isHeaderFeedbackButtonEnabled\":true}";
WRM._unparsedData["com.atlassian.jira.jira-header-plugin:dismissedFlags.flags"]="{\"dismissed\":[]}";
WRM._unparsedData["com.atlassian.jira.jira-header-plugin:newsletter-signup-tip-init.newsletterSignup"]="{\"signupDescription\":\"Get updates, inspiration and best practices from the team behind JIRA.\",\"formUrl\":\"https://www.atlassian.com/apis/exact-target/{0}/subscribe?mailingListId=1401671\",\"signupTitle\":\"Sign up!\",\"signupId\":\"newsletter-signup-tip\",\"showNewsletterTip\":false}";
WRM._unparsedData["com.atlassian.jira.project-templates-plugin:project-templates-plugin-resources.ptAnalyticsData"]="{\"instanceCreatedDate\":\"2011-01-31\"}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-wiki-editor:wiki-editor-resources.help-data"]="{\"showHelp\":true,\"editorDocumentationUrl\":[\"https://docs.atlassian.com/jira/jcore-docs-076/Visual+editing\"],\"editorDocumentationTitle\":[\"Show me documentation for the visual editor\"]}";
WRM._unparsedData["com.atlassian.jira.plugins.jira-wiki-editor:wiki-editor-resources.thumbnails-allowed"]="false";
WRM._unparsedData["jira.webresources:user-message-flags.adminLockout"]="{}";
WRM._unparsedData["jira.request.correlation-id"]="\"3c88c8e045983c\"";
WRM._unparsedData["project-id"]="10594";
WRM._unparsedData["project-key"]="\"DERBY\"";
WRM._unparsedData["project-name"]="\"Derby\"";
WRM._unparsedData["project-type"]="\"software\"";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:generic-filters"]="[{\"id\":\"allissues\",\"jql\":\"project = \\\"{0}\\\" ORDER BY {1}\",\"defaultOrderby\":\"created DESC\",\"label\":\"All issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[]},{\"id\":\"allopenissues\",\"jql\":\"project = \\\"{0}\\\" AND resolution = Unresolved ORDER BY {1}\",\"defaultOrderby\":\"priority DESC, updated DESC\",\"label\":\"Open issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"resolution\"]},{\"id\":\"doneissues\",\"jql\":\"project = \\\"{0}\\\" AND statusCategory = Done ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Done issues\",\"requiresUser\":false,\"supportsInlineIssueCreate\":false,\"fields\":[\"status\"]},{\"id\":\"recentlyviewed\",\"jql\":\"project = \\\"{0}\\\" AND issuekey in issueHistory() ORDER BY {1}\",\"defaultOrderby\":\"lastViewed DESC\",\"label\":\"Viewed recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"issuekey\"]},{\"id\":\"addedrecently\",\"jql\":\"project = \\\"{0}\\\" AND created \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"created DESC\",\"label\":\"Created recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"created\"]},{\"id\":\"resolvedrecently\",\"jql\":\"project = \\\"{0}\\\" AND resolutiondate \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Resolved recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":false,\"fields\":[\"resolutiondate\"]},{\"id\":\"updatedrecently\",\"jql\":\"project = \\\"{0}\\\" AND updated \u003e= -1w ORDER BY {1}\",\"defaultOrderby\":\"updated DESC\",\"label\":\"Updated recently\",\"requiresUser\":false,\"supportsInlineIssueCreate\":true,\"fields\":[\"updated\"]}]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:default-filter-priority"]="[\"allopenissues\",\"allissues\"]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:can-manage-filters"]="false";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:project-filters"]="[]";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:can-create-issues"]="false";
WRM._unparsedData["projectId"]="10594";
WRM._unparsedData["projectKey"]="\"DERBY\"";
WRM._unparsedData["projectType"]="\"software\"";
WRM._unparsedData["com.atlassian.jira.jira-projects-issue-navigator:server-rendered"]="true";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/a8a4711bc3f2eb261d8c8fd9fbcbba8b-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1fca1750044f2777c977e8d8cc023344/_/download/contextbatch/css/_super/batch.css" data-wrm-key="_super" data-wrm-batch-type="context" media="all"> 
  <link type="text/css" rel="stylesheet" href="/jira/s/74ac580603ca910fff0cfdf319e54add-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/fbf45109b31165e5b7740a9d72318cea/_/download/contextbatch/css/project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super/batch.css?agile_global_admin_condition=true&amp;hc-enabled=true&amp;is-server-instance=true&amp;jag=true&amp;jira.create.linked.issue=true&amp;nps-acknowledged=true&amp;richediton=true" data-wrm-key="project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super" data-wrm-batch-type="context" media="all"> 
  <link type="text/css" rel="stylesheet" href="/jira/s/611672383f6cab00ab202241ba6f9d68-T/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/7.6.3/_/download/batch/com.atlassian.feedback.jira-feedback-plugin:button-resources-init/com.atlassian.feedback.jira-feedback-plugin:button-resources-init.css" data-wrm-key="com.atlassian.feedback.jira-feedback-plugin:button-resources-init" data-wrm-batch-type="resource" media="all"> 
  <script type="text/javascript" src="/jira/s/98ceb006e504d7924d5ffc411626c6bc-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1fca1750044f2777c977e8d8cc023344/_/download/contextbatch/js/_super/batch.js?locale=en-UK" data-wrm-key="_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/c1e4d26ea276469807c3dc0918df482c-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/fbf45109b31165e5b7740a9d72318cea/_/download/contextbatch/js/project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super/batch.js?agile_global_admin_condition=true&amp;hc-enabled=true&amp;is-server-instance=true&amp;jag=true&amp;jira.create.linked.issue=true&amp;locale=en-UK&amp;nps-acknowledged=true&amp;richediton=true" data-wrm-key="project.issue.navigator,jira.view.issue,jira.global,atl.general,jira.general,-_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/6bf9253c8d533109c3b02e26794be24e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/871d45c9f322a22cb3aa9b7948a69803/_/download/contextbatch/js/atl.global,-_super/batch.js?locale=en-UK" data-wrm-key="atl.global,-_super" data-wrm-batch-type="context" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:calendar-en/jira.webresources:calendar-en.js" data-wrm-key="jira.webresources:calendar-en" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:calendar-localisation-moment/jira.webresources:calendar-localisation-moment.js" data-wrm-key="jira.webresources:calendar-localisation-moment" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/7.6.3/_/download/batch/com.atlassian.feedback.jira-feedback-plugin:button-resources/com.atlassian.feedback.jira-feedback-plugin:button-resources.js" data-wrm-key="com.atlassian.feedback.jira-feedback-plugin:button-resources" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/ccd2e67b523185973473e8bd5735c8f9-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/e0de73613a1027de08f3da6a45e1d1a2/_/download/contextbatch/css/jira.global.look-and-feel,-_super/batch.css" data-wrm-key="jira.global.look-and-feel,-_super" data-wrm-batch-type="context" media="all"> 
  <script type="text/javascript" src="/jira/rest/api/1.0/shortcuts/76005/33e5e0166867c8c9228d44506f60b2e8/shortcuts.js?context=issuenavigation&amp;context=issueaction"></script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.jira.jira-issue-nav-components:inline-edit-enabled"]="true";
WRM._unparsedData["should-display-chaperone"]="false";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <link type="text/css" rel="stylesheet" href="/jira/s/15712b600e9aecf72ffd9fd3704a0c78-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/6b22a15c7b83f87a47b1757076f43542/_/download/contextbatch/css/com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue/batch.css?jira.create.linked.issue=true&amp;richediton=true" data-wrm-key="com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue" data-wrm-batch-type="context" media="all"> 
  <script type="text/javascript" src="/jira/s/6579b6b8ba67abaa496e39b9242a18a4-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/6b22a15c7b83f87a47b1757076f43542/_/download/contextbatch/js/com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue/batch.js?jira.create.linked.issue=true&amp;locale=en-UK&amp;richediton=true" data-wrm-key="com.atlassian.jira.projects.sidebar.init,-_super,-project.issue.navigator,-jira.view.issue" data-wrm-batch-type="context" data-initially-rendered></script> 
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
  <meta name="ajs-can-search-users" content="false"> 
  <meta name="ajs-can-edit-watchers" content="false"> 
  <meta name="ajs-default-avatar-url" content="https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10453"> 
  <meta name="ajs-issue-project-type" content="software"> 
  <meta name="ajs-issue-key" content="DERBY-1947"> 
  <meta name="ajs-server-view-issue-is-editable" content="false"> 
  <title>[DERBY-1947] OutOfMemoryError after repeated calls to boot and shutdown a database - ASF JIRA</title> 
  <link rel="search" type="application/opensearchdescription+xml" href="/jira/osd.jsp" title="[DERBY-1947] OutOfMemoryError after repeated calls to boot and shutdown a database - ASF JIRA"> 
 </head> 
 <body id="jira" class="aui-layout aui-theme-default " data-version="7.6.3"> 
  <div id="page"> 
   <header id="header" role="banner"> 
    <script>
require(["jquery", "jira/license-banner"], function ($, licenseBanner) {
    $(function () {
        licenseBanner.showLicenseBanner("");
        licenseBanner.showLicenseFlag("");
    });
});
</script> 
    <nav class="aui-header aui-dropdown2-trigger-group" role="navigation">
     <div class="aui-header-inner">
      <div class="aui-header-before">
       <a class=" aui-dropdown2-trigger app-switcher-trigger" aria-controls="app-switcher" aria-haspopup="true" role="button" tabindex="0" data-aui-trigger href="#app-switcher"><span class="aui-icon aui-icon-small aui-iconfont-appswitcher">Linked Applications</span></a>
       <div id="app-switcher" class="aui-dropdown2 aui-style-default" role="menu" aria-hidden="true" data-is-switcher="true" data-environment="{&quot;isUserAdmin&quot;:false,&quot;isAppSuggestionAvailable&quot;:false,&quot;isSiteAdminUser&quot;:false}">
        <div role="application">
         <div class="app-switcher-loading">
          Loading…
         </div>
        </div>
       </div>
      </div>
      <div class="aui-header-primary">
       <h1 id="logo" class="aui-header-logo aui-header-logo-custom"><a href="https://issues.apache.org/jira/secure/MyJiraHome.jspa"><img src="/jira/s/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/_/jira-logo-scaled.png" alt="ASF JIRA"></a></h1>
       <ul class="aui-nav">
        <li><a href="/jira/secure/Dashboard.jspa" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="home_link" aria-haspopup="true" aria-controls="home_link-content" title="View and manage your dashboards" accesskey="d">Dashboards</a>
         <div class="aui-dropdown2 aui-style-default" id="home_link-content" data-aui-dropdown2-ajax-key="home_link"></div></li>
        <li><a href="/jira/browse/DERBY" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="browse_link" aria-haspopup="true" aria-controls="browse_link-content" title="View recent projects and browse a list of projects" accesskey="p">Projects</a>
         <div class="aui-dropdown2 aui-style-default" id="browse_link-content" data-aui-dropdown2-ajax-key="browse_link"></div></li>
        <li><a href="/jira/issues/" class=" aui-nav-link aui-dropdown2-trigger aui-dropdown2-ajax" id="find_link" aria-haspopup="true" aria-controls="find_link-content" title="Search for issues and view recent issues" accesskey="i">Issues</a>
         <div class="aui-dropdown2 aui-style-default" id="find_link-content" data-aui-dropdown2-ajax-key="find_link"></div></li> 
       </ul>
      </div>
      <div class="aui-header-secondary">
       <ul class="aui-nav">
        <li id="quicksearch-menu"> 
         <form action="/jira/secure/QuickSearch.jspa" method="get" id="quicksearch" class="aui-quicksearch dont-default-focus ajs-dirty-warning-exempt"> 
          <input id="quickSearchInput" class="search" type="text" title="Search" placeholder="Search" name="searchString" accessKey="q"> 
          <input type="submit" class="hidden" value="Search"> 
         </form> </li> 
        <li><a class="jira-feedback-plugin" role="button" aria-haspopup="true" id="jira-header-feedback-link" href="#"><span class="aui-icon aui-icon-small jira-feedback-plugin-icon">Give feedback to Atlassian</span></a></li> 
        <li id="system-help-menu"> <a class="aui-nav-link aui-dropdown2-trigger" id="help_menu" aria-haspopup="true" aria-owns="system-help-menu-content" href="https://docs.atlassian.com/jira/jcore-docs-076/" target="$textUtils.htmlEncode($rootHelpMenuItem.params.target)" title="Help"><span class="aui-icon aui-icon-small aui-iconfont-help">Help</span></a> 
         <div id="system-help-menu-content" class="aui-dropdown2 aui-style-default"> 
          <div class="aui-dropdown2-section"> 
           <ul id="jira-help" class="aui-list-truncate"> 
            <li> <a id="view_core_help" class="aui-nav-link " title="Go to the online documentation for JIRA Core" href="https://docs.atlassian.com/jira/jcore-docs-076/" target="_blank">JIRA Core help</a> </li> 
            <li> <a id="keyshortscuthelp" class="aui-nav-link " title="Get more information about JIRA's Keyboard Shortcuts" href="/jira/secure/ViewKeyboardShortcuts!default.jspa" target="_blank">Keyboard Shortcuts</a> </li> 
            <li> <a id="view_about" class="aui-nav-link " title="Get more information about JIRA" href="/jira/secure/AboutPage.jspa">About JIRA</a> </li> 
            <li> <a id="view_credits" class="aui-nav-link " title="See who did what" href="/jira/secure/JiraCreditsPage!default.jspa" target="_blank">JIRA Credits</a> </li> 
           </ul> 
          </div> 
         </div> </li> 
        <li id="user-options"> <a class="aui-nav-link login-link" href="/jira/login.jsp?os_destination=%2Fbrowse%2FDERBY-1947">Log In</a> 
         <div id="user-options-content" class="aui-dropdown2 aui-style-default"> 
          <div class="aui-dropdown2-section"> 
          </div> 
         </div> </li> 
       </ul>
      </div>
     </div>
     <!-- .aui-header-inner-->
    </nav>
    <!-- .aui-header --> 
   </header> 
   <section id="content" role="main"> 
    <big-pipe data-id="sidebar-id" unresolved></big-pipe>
    <div class="aui-sidebar  sidebar-placeholder">
     <div class="aui-sidebar-wrapper">
      <div class="aui-sidebar-body"></div>
      <div class="aui-sidebar-footer">
       <a class="aui-button aui-button-subtle aui-sidebar-toggle aui-sidebar-footer-tipsy" data-tooltip="Expand sidebar ( [ )" href="#"><span class="aui-icon aui-icon-small"></span></a>
      </div>
     </div>
    </div>
    <script id="projects-sidebar-init">
    require(['jira/projects/sidebar/expansion-manager'], function(expansionManager) {
        var scriptTag = document.getElementById('projects-sidebar-init');
        var sidebar = AJS.sidebar('.aui-sidebar');
        expansionManager(sidebar);
        scriptTag.parentElement.removeChild(scriptTag);
    });
    </script>
    <div class="aui-page-panel">
     <div class="aui-page-panel-inner">
      <div class="issue-navigator">
       <div class="content">
        <div class="issue-view">
         <div class="navigation-tools">
          <div class="pager-container"></div>
         </div>
         <div class="issue-container">
          <div id="issue-content" class="issue-edit-form">
           <header id="stalker" class="issue-header js-stalker">
            <div class="issue-header-content">
             <header class="aui-page-header">
              <div class="aui-page-header-inner">
               <div class="aui-page-header-image">
                <span id="10594" class="aui-avatar aui-avatar-large aui-avatar-project"><span class="aui-avatar-inner"><img id="project-avatar" alt="Uploaded image for project: 'Derby'" src="https://issues.apache.org/jira/secure/projectavatar?pid=10594&amp;avatarId=10122"></span></span>
               </div>
               <!-- .aui-page-header-image -->
               <div class="aui-page-header-main">
                <ol class="aui-nav aui-nav-breadcrumbs">
                 <li><a id="project-name-val" href="/jira/browse/DERBY">Derby</a></li>
                 <li><a class="issue-link" data-issue-key="DERBY-1947" href="/jira/browse/DERBY-1947" id="key-val" rel="12352818">DERBY-1947</a></li>
                </ol>
                <h1 id="summary-val">OutOfMemoryError after repeated calls to boot and shutdown a database</h1>
               </div>
               <!-- .aui-page-header-main -->
               <div class="aui-page-header-actions">
                <div id="issue-header-pager"></div>
               </div>
               <!-- .aui-page-header-actions -->
              </div>
              <!-- .aui-page-header-inner -->
             </header>
             <!-- .aui-page-header -->
             <div class="command-bar">
              <div class="ops-cont">
               <div class="ops-menus aui-toolbar">
                <div class="toolbar-split toolbar-split-left">
                 <ul id="opsbar-ops-login-lnk_container" class="toolbar-group pluggable-ops">
                  <li class="toolbar-item"><a id="ops-login-lnk" title="Log In" class="toolbar-trigger" href="/jira/login.jsp?os_destination=%2Fbrowse%2FDERBY-1947"><span class="trigger-label">Log In</span></a></li>
                 </ul>
                 <ul id="opsbar-opsbar-operations" class="toolbar-group pluggable-ops"></ul>
                 <ul id="opsbar-opsbar-transitions" class="toolbar-group pluggable-ops"></ul>
                 <ul id="opsbar-opsbar-admin" class="toolbar-group pluggable-ops"></ul>
                </div>
                <div class="toolbar-split toolbar-split-right">
                 <ul id="opsbar-jira.issue.tools" class="toolbar-group pluggable-ops">
                  <li class="toolbar-item">
                   <div>
                    <a href="#" id="viewissue-export" aria-owns="viewissue-export_drop" aria-haspopup="true" title="Export this issue in another format" class="toolbar-trigger aui-button aui-style-default aui-dropdown2-trigger"><span class="icon icon-default aui-icon aui-icon-small aui-iconfont-export"></span> <span class="dropdown-text">Export</span></a>
                    <div id="viewissue-export_drop" class="aui-style-default aui-dropdown2">
                     <ul>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-xml/DERBY-1947/DERBY-1947.xml" id="jira.issueviews:issue-xml"><span class="trigger-label">XML</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-word/DERBY-1947/DERBY-1947.doc" id="jira.issueviews:issue-word"><span class="trigger-label">Word</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/jira.issueviews:issue-html/DERBY-1947/DERBY-1947.html" id="jira.issueviews:issue-html"><span class="trigger-label">Printable</span></a></li>
                      <li class="aui-list-item"><a href="/jira/si/com.atlassian.jira.plugins.jira-importers-plugin:issue-json/DERBY-1947/DERBY-1947.json" id="com.atlassian.jira.plugins.jira-importers-plugin:issue-json"><span class="trigger-label">JSON</span></a></li>
                     </ul>
                    </div>
                   </div></li>
                 </ul>
                </div>
               </div>
              </div>
             </div>
            </div>
           </header>
           <div class="issue-body-content">
            <div class="aui-group issue-body">
             <div class="aui-item issue-main-column">
              <div id="details-module" class="module toggle-wrap">
               <div id="details-module_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Details</h2>
               </div>
               <div class="mod-content"> 
                <ul id="issuedetails" class="property-list two-cols"> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Type:</strong> 
                   <span id="type-val" class="value"> <img alt="" height="16" src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype" title="Bug - A problem which impairs or prevents the functions of the product." width="16"> Bug </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Status:</strong> 
                   <span id="status-val" class="value"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done jira-issue-status-lozenge-max-width-medium" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </span> 
                  </div> </li> 
                 <li class="item new"> 
                  <div class="wrap"> 
                   <strong class="name">Priority:</strong> 
                   <span id="priority-val" class="value"> <img alt="" height="16" src="/jira/images/icons/priorities/major.svg" title="Major - Major loss of function." width="16"> Major </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Resolution:</strong> 
                   <span id="resolution-val" class="value resolved"> Fixed </span> 
                  </div> </li> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Affects Version/s:</strong> 
                   <span id="versions-val" class="value"> <span class="shorten" id="versions-field"> <span title="10.0.2.0 initial source drop">10.0.2.0</span>, <span title="10.0.2.1 snapshot">10.0.2.1</span>, <span title="10.1.1.0 ">10.1.1.0</span>, <span title="10.1.2.1 ">10.1.2.1</span>, <span title="10.1.3.1 ">10.1.3.1</span>, <span title="10.2.1.6 ">10.2.1.6</span> </span> </span> 
                  </div> </li> 
                 <li class="item item-right"> 
                  <div class="wrap"> 
                   <strong class="name">Fix Version/s:</strong> 
                   <span id="fixfor-val" class="value"> <span class="shorten" id="fixVersions-field"> <a href="/jira/issues/?jql=project+%3D+DERBY+AND+fixVersion+%3D+10.3.1.4" title="10.3.1.4 ">10.3.1.4</a> </span> </span> 
                  </div> </li> 
                 <li class="item"> 
                  <div class="wrap"> 
                   <strong class="name">Component/s:</strong> 
                   <span id="components-val" class="value"> <span class="shorten" id="components-field"> <a href="/jira/issues/?jql=project+%3D+DERBY+AND+component+%3D+Services" title="Services ">Services</a> </span> </span> 
                  </div> </li> 
                 <li class="item full-width"> 
                  <div class="wrap" id="wrap-labels"> 
                   <strong class="name">Labels:</strong> 
                   <div class="labels-wrap value"> 
                    <span class="labels" id="labels-12352818-value">None</span> 
                   </div> 
                  </div> </li> 
                 <li class="item full-width"> 
                  <div class="wrap"> 
                   <strong class="name">Environment:</strong> 
                   <div id="environment-val" class="value">
                     Any 
                   </div> 
                  </div> </li> 
                </ul> 
                <div id="customfieldmodule"> 
                 <div class="aui-tabs horizontal-tabs" id="customfield-tabs"> 
                  <div id="customfield-panel-1" class="tabs-pane active-pane"> 
                   <ul class="property-list"> 
                    <li id="rowForcustomfield_12310050" class="item"> 
                     <div class="wrap"> 
                      <strong title="Urgency" class="name">Urgency:</strong> 
                      <div id="customfield_12310050-val" class="value type-select" data-fieldtype="select" data-fieldtypecompletekey="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        Normal 
                      </div> 
                     </div> </li> 
                   </ul> 
                  </div> 
                 </div>
                </div> 
               </div>
              </div>
              <div id="descriptionmodule" class="module toggle-wrap">
               <div id="descriptionmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Description</h2>
               </div>
               <div class="mod-content">
                <div id="description-val" class="field-ignore-highlight"> 
                 <div class="user-content-block"> 
                  <p>I came across this OOM issue while running some system tests involving<br> backup and restore against Derby. The test is expected to run forever but<br> using the default heap space it runs into OOM within 2 days. I earlier mentioned about this<br> in my reply to the 10.2.1.6 vote - <a href="http://www.nabble.com/Re%3A--VOTE--10.2.1.6-release-p6650528.html" class="external-link" rel="nofollow">http://www.nabble.com/Re%3A--VOTE--10.2.1.6-release-p6650528.html</a></p> 
                  <p>Also there has been some discussions on the list on the related topic:<br> <a href="http://issues.apache.org/jira/browse/DERBY-23" class="external-link" rel="nofollow">http://issues.apache.org/jira/browse/DERBY-23</a> and<br> <a href="http://www.nabble.com/question-about-shutdown-tf2300504.html" class="external-link" rel="nofollow">http://www.nabble.com/question-about-shutdown-tf2300504.html</a></p> 
                  <p>Basic Analysis:<br> --------------------</p> 
                  <p>Wrote a simple Java app (attached to this issue) that booted and shutdown the same <br> database multiple times. Depending on the heapsize the program ran into the<br> OOM at some point, as expected. Some heap dump analysis using the IBM HeapAnalyzer <br> and revealed that the HashSet (allContexts) within org.apache.derby.iapi.services.context.ContextService <br> class seemed to be location of the leak (snapshot of the heapanalysis attached).</p> 
                  <p>A little bit of debugging shows that:</p> 
                  <ul class="alternate" type="square"> 
                   <li>for every:connection two ContextManager objects (say, cm1, cm2) are added to the HashSet</li> 
                   <li>for every shutdown a new ContextManager object (say, cm3) is added and two objects are removed</li> 
                   <li>the object removed are cm2 and cm3 - in that sequence</li> 
                   <li>but the object cm1 gets left behind</li> 
                  </ul> 
                  <p>This happens for every connect/shutdown sequence and since one of the ContextManager objects added to the <br> HashSet is not removed as a part of the cleanup, it contributes to growth in memory usage, hence<br> an OOM eventually.</p> 
                  <p>For example:<br> ============<br> A 64M heap could allow about 1107 iterations of connect/shutdown only before running into OOM and <br> created 1108 un-used ContextManager objects in the memory.</p> 
                  <p>java -Xmx64M testEmbedAndClient<br> ++++Debug: add() Size of allContexts HashSet obj= 1<br> ----Debug: remove() Size of allContexts HashSet obj= 0<br> ++++Debug: add() Size of allContexts HashSet obj= 1<br> ----Debug: remove() Size of allContexts HashSet obj= 0<br> ++++Debug: add() Size of allContexts HashSet obj= 1<br> ++++Debug: add() Size of allContexts HashSet obj= 2</p> 
                  <p>==== Database booted in embedded ====</p> 
                  <p>++++Debug: add() Size of allContexts HashSet obj= 3<br> ----Debug: remove() Size of allContexts HashSet obj= 2<br> ----Debug: remove() Size of allContexts HashSet obj= 1</p> 
                  <p>==== Shutdown complete in embedded ====</p> 
                  <p>++++Debug: add() Size of allContexts HashSet obj= 2<br> ++++Debug: add() Size of allContexts HashSet obj= 3</p> 
                  <p>==== Database booted in embedded ====</p> 
                  <p>++++Debug: add() Size of allContexts HashSet obj= 4<br> ----Debug: remove() Size of allContexts HashSet obj= 3<br> ----Debug: remove() Size of allContexts HashSet obj= 2<br> ..<br> ..<br> ..<br> ==== Database booted in embedded ====</p> 
                  <p>++++Debug: add() Size of allContexts HashSet obj= 1109<br> ----Debug: remove() Size of allContexts HashSet obj= 1108<br> ----Debug: remove() Size of allContexts HashSet obj= 1107</p> 
                  <p>==== Shutdown complete in embedded ====</p> 
                  <p>++++Debug: add() Size of allContexts HashSet obj= 1108<br> ++++Debug: add() Size of allContexts HashSet obj= 1109<br> ----Debug: remove() Size of allContexts HashSet obj= 1108<br> java.sql.SQLException: Failed to start database 'testdb', see the next exception<br> for details.<br> at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:45)<br> at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:89)<br> at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Util.java:95)<br> at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Util.java:174)</p> 
                  <p> at org.apache.derby.impl.jdbc.EmbedConnection.newSQLException(EmbedConnection.java:1985)<br> at org.apache.derby.impl.jdbc.EmbedConnection.bootDatabase(EmbedConnection.java:1649)<br> at org.apache.derby.impl.jdbc.EmbedConnection.&lt;init&gt;(EmbedConnection.java:223)<br> at org.apache.derby.impl.jdbc.EmbedConnection30.&lt;init&gt;(EmbedConnection30.java:73)<br> at org.apache.derby.jdbc.Driver30.getNewEmbedConnection(Driver30.java:74)<br> at org.apache.derby.jdbc.InternalDriver.connect(InternalDriver.java:210)</p> 
                  <p>----Debug: remove() Size of allContexts HashSet obj= 1107<br> at org.apache.derby.jdbc.AutoloadedDriver.connect(AutoloadedDriver.java:117)<br> at java.sql.DriverManager.getConnection(DriverManager.java:525)<br> at java.sql.DriverManager.getConnection(DriverManager.java:193)<br> at testEmbedAndClient.testInEmbedded(testEmbedAndClient.java:40)<br> at testEmbedAndClient.main(testEmbedAndClient.java:19)<br> java.lang.OutOfMemoryError: Java heap space</p> 
                  <p>OOM happened after 1107 iterations</p> 
                 </div> 
                </div> 
               </div>
              </div>
              <div id="dnd-metadata" class="module toggle-wrap">
               <div id="dnd-metadata_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Attachments</h2>
               </div>
               <div class="mod-content">
                <div id="dnd-metadata-webpanel" data-can-attach="false" data-project-type="software" data-upload-limit="62914560" data-thumbnails-allowed="false"></div>
               </div>
              </div>
              <div id="attachmentmodule" class="module toggle-wrap">
               <div id="attachmentmodule_heading" class="mod-header">
                <ul class="ops">
                 <li class="drop">
                  <div class="aui-dd-parent">
                   <a href="#" class="icon drop-menu js-default-dropdown" title="Options"><span>Options</span></a>
                   <div class="aui-dropdown-content aui-list">
                    <ul id="attachment-sorting-options" class="aui-list-section aui-first">
                     <li class="aui-list-item"><a id="attachment-sort-key-name" href="/jira/browse/DERBY-1947?attachmentSortBy=fileName#attachmentmodule" class="aui-list-checked aui-checked aui-list-item-link" title="viewissue.subtasks.tab.show.all.name"><span>Sort By Name</span></a></li>
                     <li class="aui-list-item"><a id="attachment-sort-key-date" href="/jira/browse/DERBY-1947?attachmentSortBy=dateTime#attachmentmodule" class="aui-list-checked aui-list-item-link" title="Sort By Date"><span>Sort By Date</span></a></li>
                    </ul>
                    <ul id="attachment-sorting-order-options" class="aui-list-section aui-last">
                     <li class="aui-list-item"><a id="attachment-sort-direction-asc" href="/jira/browse/DERBY-1947?attachmentOrder=asc#attachmentmodule" class="aui-list-checked aui-checked aui-list-item-link" title="Ascending"><span>Ascending</span></a></li>
                     <li class="aui-list-item"><a id="attachment-sort-direction-desc" href="/jira/browse/DERBY-1947?attachmentOrder=desc#attachmentmodule" class="aui-list-checked aui-list-item-link" title="Descending"><span>Descending</span></a></li>
                    </ul>
                   </div>
                  </div></li>
                </ul>
                <h2 class="toggle-title">Attachments</h2>
               </div>
               <div class="mod-content">
                <ol id="file_attachments" class="item-attachments" data-sort-key="fileName" data-sort-order="asc">
                 <li class="attachment-content js-file-attachment" data-attachment-id="12354147" data-issue-id="12352818" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12354147/DERBY-1947-1.diff" draggable="true" data-downloadurl="text/x-patch:DERBY-1947-1.diff:https://issues.apache.org/jira/secure/attachment/12354147/DERBY-1947-1.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12354147/DERBY-1947-1.diff" title="Latest  24/Mar/07 16:32 - Dag H. Wanvik" draggable="true" data-downloadurl="text/x-patch:DERBY-1947-1.diff:https://issues.apache.org/jira/secure/attachment/12354147/DERBY-1947-1.diff">DERBY-1947-1.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-03-24T16:32:21.770Z">24/Mar/07 16:32</time>
                   </dd>
                   <dd class="attachment-size">
                    2 kB
                   </dd>
                   <dd class="attachment-author">
                    Dag H. Wanvik
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12354148" data-issue-id="12352818" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12354148/DERBY-1947-1.stat" draggable="true" data-downloadurl="application/x-subversion-stat:DERBY-1947-1.stat:https://issues.apache.org/jira/secure/attachment/12354148/DERBY-1947-1.stat"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12354148/DERBY-1947-1.stat" title="Latest  24/Mar/07 16:32 - Dag H. Wanvik" draggable="true" data-downloadurl="application/x-subversion-stat:DERBY-1947-1.stat:https://issues.apache.org/jira/secure/attachment/12354148/DERBY-1947-1.stat">DERBY-1947-1.stat</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-03-24T16:32:21.872Z">24/Mar/07 16:32</time>
                   </dd>
                   <dd class="attachment-size">
                    0.1 kB
                   </dd>
                   <dd class="attachment-author">
                    Dag H. Wanvik
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12354369" data-issue-id="12352818" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12354369/DERBY-1947-2.diff" draggable="true" data-downloadurl="text/x-patch:DERBY-1947-2.diff:https://issues.apache.org/jira/secure/attachment/12354369/DERBY-1947-2.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12354369/DERBY-1947-2.diff" title="Latest  27/Mar/07 22:00 - Dag H. Wanvik" draggable="true" data-downloadurl="text/x-patch:DERBY-1947-2.diff:https://issues.apache.org/jira/secure/attachment/12354369/DERBY-1947-2.diff">DERBY-1947-2.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-03-27T22:00:16.946Z">27/Mar/07 22:00</time>
                   </dd>
                   <dd class="attachment-size">
                    3 kB
                   </dd>
                   <dd class="attachment-author">
                    Dag H. Wanvik
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12354370" data-issue-id="12352818" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12354370/DERBY-1947-2.stat" draggable="true" data-downloadurl="application/x-subversion-stat:DERBY-1947-2.stat:https://issues.apache.org/jira/secure/attachment/12354370/DERBY-1947-2.stat"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12354370/DERBY-1947-2.stat" title="Latest  27/Mar/07 22:00 - Dag H. Wanvik" draggable="true" data-downloadurl="application/x-subversion-stat:DERBY-1947-2.stat:https://issues.apache.org/jira/secure/attachment/12354370/DERBY-1947-2.stat">DERBY-1947-2.stat</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-03-27T22:00:22.772Z">27/Mar/07 22:00</time>
                   </dd>
                   <dd class="attachment-size">
                    0.1 kB
                   </dd>
                   <dd class="attachment-author">
                    Dag H. Wanvik
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12355775" data-issue-id="12352818" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12355775/DERBY-1947-3.diff" draggable="true" data-downloadurl="text/x-patch:DERBY-1947-3.diff:https://issues.apache.org/jira/secure/attachment/12355775/DERBY-1947-3.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12355775/DERBY-1947-3.diff" title="Latest  18/Apr/07 17:06 - Dag H. Wanvik" draggable="true" data-downloadurl="text/x-patch:DERBY-1947-3.diff:https://issues.apache.org/jira/secure/attachment/12355775/DERBY-1947-3.diff">DERBY-1947-3.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-04-18T17:06:05.357Z">18/Apr/07 17:06</time>
                   </dd>
                   <dd class="attachment-size">
                    4 kB
                   </dd>
                   <dd class="attachment-author">
                    Dag H. Wanvik
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12355776" data-issue-id="12352818" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12355776/DERBY-1947-3.stat" draggable="true" data-downloadurl="application/x-subversion-stat:DERBY-1947-3.stat:https://issues.apache.org/jira/secure/attachment/12355776/DERBY-1947-3.stat"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12355776/DERBY-1947-3.stat" title="Latest  18/Apr/07 17:06 - Dag H. Wanvik" draggable="true" data-downloadurl="application/x-subversion-stat:DERBY-1947-3.stat:https://issues.apache.org/jira/secure/attachment/12355776/DERBY-1947-3.stat">DERBY-1947-3.stat</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-04-18T17:06:06.508Z">18/Apr/07 17:06</time>
                   </dd>
                   <dd class="attachment-size">
                    0.2 kB
                   </dd>
                   <dd class="attachment-author">
                    Dag H. Wanvik
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12355927" data-issue-id="12352818" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12355927/DERBY-1947-4.diff" draggable="true" data-downloadurl="text/x-diff:DERBY-1947-4.diff:https://issues.apache.org/jira/secure/attachment/12355927/DERBY-1947-4.diff"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12355927/DERBY-1947-4.diff" title="Latest  20/Apr/07 13:52 - Dag H. Wanvik" draggable="true" data-downloadurl="text/x-diff:DERBY-1947-4.diff:https://issues.apache.org/jira/secure/attachment/12355927/DERBY-1947-4.diff">DERBY-1947-4.diff</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-04-20T13:52:16.303Z">20/Apr/07 13:52</time>
                   </dd>
                   <dd class="attachment-size">
                    3 kB
                   </dd>
                   <dd class="attachment-author">
                    Dag H. Wanvik
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12355928" data-issue-id="12352818" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12355928/DERBY-1947-4.stat" draggable="true" data-downloadurl="application/x-subversion-stat:DERBY-1947-4.stat:https://issues.apache.org/jira/secure/attachment/12355928/DERBY-1947-4.stat"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-devtools-file" title="File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12355928/DERBY-1947-4.stat" title="Latest  20/Apr/07 13:52 - Dag H. Wanvik" draggable="true" data-downloadurl="application/x-subversion-stat:DERBY-1947-4.stat:https://issues.apache.org/jira/secure/attachment/12355928/DERBY-1947-4.stat">DERBY-1947-4.stat</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-04-20T13:52:16.403Z">20/Apr/07 13:52</time>
                   </dd>
                   <dd class="attachment-size">
                    0.1 kB
                   </dd>
                   <dd class="attachment-author">
                    Dag H. Wanvik
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12342610" data-issue-id="12352818" data-attachment-type="image" data-attachment-thumbnail="false">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12342610/HeapAnalysis_op.jpg" draggable="true" data-downloadurl="image/jpeg:HeapAnalysis_op.jpg:https://issues.apache.org/jira/secure/attachment/12342610/HeapAnalysis_op.jpg" file-preview-id="12342610" file-preview-title="HeapAnalysis_op.jpg" file-preview-type="image"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-image" title="JPEG File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12342610/HeapAnalysis_op.jpg" title="Latest  10/Oct/06 03:45 - Rajesh Kartha" draggable="true" data-downloadurl="image/jpeg:HeapAnalysis_op.jpg:https://issues.apache.org/jira/secure/attachment/12342610/HeapAnalysis_op.jpg" file-preview-id="12342610" file-preview-title="HeapAnalysis_op.jpg" file-preview-type="image">HeapAnalysis_op.jpg</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2006-10-10T03:45:26.000Z">10/Oct/06 03:45</time>
                   </dd>
                   <dd class="attachment-size">
                    140 kB
                   </dd>
                   <dd class="attachment-author">
                    Rajesh Kartha
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12355722" data-issue-id="12352818" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12355722/ProcedureInTriggerTest-threadstacks.txt" draggable="true" data-downloadurl="text/plain:ProcedureInTriggerTest-threadstacks.txt:https://issues.apache.org/jira/secure/attachment/12355722/ProcedureInTriggerTest-threadstacks.txt"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-txt" title="Text File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12355722/ProcedureInTriggerTest-threadstacks.txt" title="Latest  18/Apr/07 00:04 - Dag H. Wanvik" draggable="true" data-downloadurl="text/plain:ProcedureInTriggerTest-threadstacks.txt:https://issues.apache.org/jira/secure/attachment/12355722/ProcedureInTriggerTest-threadstacks.txt">ProcedureInTriggerTest-threadstacks.txt</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2007-04-18T00:04:21.311Z">18/Apr/07 00:04</time>
                   </dd>
                   <dd class="attachment-size">
                    5 kB
                   </dd>
                   <dd class="attachment-author">
                    Dag H. Wanvik
                   </dd>
                  </dl></li>
                 <li class="attachment-content js-file-attachment" data-attachment-id="12342609" data-issue-id="12352818" data-attachment-type="file">
                  <div class="attachment-thumb">
                   <a href="/jira/secure/attachment/12342609/testEmbedAndClient.java" draggable="true" data-downloadurl="text/plain:testEmbedAndClient.java:https://issues.apache.org/jira/secure/attachment/12342609/testEmbedAndClient.java"><span class="aui-icon aui-icon-small attachment-icon aui-iconfont-file-txt" title="Text File"></span></a>
                  </div>
                  <dl>
                   <dt class="attachment-title">
                    <a href="/jira/secure/attachment/12342609/testEmbedAndClient.java" title="Latest  10/Oct/06 03:45 - Rajesh Kartha" draggable="true" data-downloadurl="text/plain:testEmbedAndClient.java:https://issues.apache.org/jira/secure/attachment/12342609/testEmbedAndClient.java">testEmbedAndClient.java</a>
                   </dt>
                   <dd class="attachment-delete">
                    <span class="icon"></span>
                   </dd>
                   <dd class="attachment-date">
                    <time class="livestamp" datetime="2006-10-10T03:45:26.000Z">10/Oct/06 03:45</time>
                   </dd>
                   <dd class="attachment-size">
                    1 kB
                   </dd>
                   <dd class="attachment-author">
                    Rajesh Kartha
                   </dd>
                  </dl></li>
                </ol>
               </div>
              </div>
              <div id="linkingmodule" class="module toggle-wrap">
               <div id="linkingmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Issue Links</h2>
               </div>
               <div class="mod-content"> 
                <div class="links-container" data-default-link-icon="/jira/images/icons/generic_link_16.png"> 
                 <dl class="links-list "> 
                  <dt title="relates to">
                   relates to
                  </dt> 
                  <dd id="internal-12346613_10030"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype" width="16" height="16" title="Bug - A problem which impairs or prevents the functions of the product." alt="Bug - A problem which impairs or prevents the functions of the product."> <span title="DERBY-1585: derbylang/procedureInTrigger: not able to create trigger due to an open ResultSet"> <a href="/jira/browse/DERBY-1585" data-issue-key="DERBY-1585" class="issue-link link-title resolution">DERBY-1585</a> <span class="link-summary">derbylang/procedureInTrigger: not able to create trigger due to an open ResultSet</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/major.svg" width="16" height="16" title="Major - Major loss of function." alt="Major - Major loss of function."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                  <dd id="internal-12365617_10030"> 
                   <div class="link-content"> 
                    <p> <img src="/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype" width="16" height="16" title="Bug - A problem which impairs or prevents the functions of the product." alt="Bug - A problem which impairs or prevents the functions of the product."> <span title="DERBY-2480: DriverManager.getConnection leaks memory when connecting to a non-existent database"> <a href="/jira/browse/DERBY-2480" data-issue-key="DERBY-2480" class="issue-link link-title resolution">DERBY-2480</a> <span class="link-summary">DriverManager.getConnection leaks memory when connecting to a non-existent database</span> </span> </p> 
                    <ul class="link-snapshot"> 
                     <li class="priority"> <img src="/jira/images/icons/priorities/minor.svg" width="16" height="16" title="Minor - Minor loss of function, or other problem where easy workaround is present." alt="Minor - Minor loss of function, or other problem where easy workaround is present."> </li> 
                     <li class="status"> <span class=" jira-issue-status-lozenge aui-lozenge jira-issue-status-lozenge-green jira-issue-status-lozenge-done aui-lozenge-subtle jira-issue-status-lozenge-max-width-short" data-tooltip="<span class=&quot;jira-issue-status-tooltip-title&quot;>Closed</span><br><span class=&quot;jira-issue-status-tooltip-desc&quot;>The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.</span>">Closed</span> </li> 
                    </ul> 
                   </div> 
                  </dd> 
                 </dl> 
                </div> 
               </div>
              </div>
              <div id="activitymodule" class="module toggle-wrap">
               <div id="activitymodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Activity</h2>
               </div>
               <div class="mod-content"> 
                <big-pipe data-id="activity-panel-pipe-id" style="height: 70px"> 
                 <div></div> 
                </big-pipe> 
               </div>
              </div>
             </div>
             <div id="viewissuesidebar" class="aui-item issue-side-column">
              <div id="peoplemodule" class="module toggle-wrap">
               <div id="peoplemodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">People</h2>
               </div>
               <div class="mod-content"> 
                <ul class="item-details" id="peopledetails"> 
                 <li class="people-details"> 
                  <dl> 
                   <dt>
                    Assignee:
                   </dt> 
                   <dd> 
                    <span id="assignee-val" class="view-issue-field"> <span class="user-hover" id="issue_summary_assignee_dagw" rel="dagw" data-user="{&quot;avatarUrl&quot;:&quot;https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10452&quot;,&quot;displayName&quot;:&quot;Dag H. Wanvik&quot;,&quot;emailAddress&quot;:&quot;dag.wanvik@oracle.com&quot;,&quot;username&quot;:&quot;dagw&quot;}"> <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img src="https://issues.apache.org/jira/secure/useravatar?size=small&amp;avatarId=10452" alt="dagw"></span></span> Dag H. Wanvik </span> </span> 
                   </dd> 
                  </dl> 
                  <dl> 
                   <dt>
                    Reporter:
                   </dt> 
                   <dd> 
                    <span id="reporter-val" class="view-issue-field"> <span class="user-hover" id="issue_summary_reporter_kartha" rel="kartha" data-user="{&quot;avatarUrl&quot;:&quot;https://issues.apache.org/jira/secure/useravatar?size=xsmall&amp;avatarId=10452&quot;,&quot;displayName&quot;:&quot;Rajesh Kartha&quot;,&quot;emailAddress&quot;:&quot;kartha02@gmail.com&quot;,&quot;username&quot;:&quot;kartha&quot;}"> <span class="aui-avatar aui-avatar-small"><span class="aui-avatar-inner"><img src="https://issues.apache.org/jira/secure/useravatar?size=small&amp;avatarId=10452" alt="kartha"></span></span> Rajesh Kartha </span> </span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
                <ul class="item-details"> 
                 <li> 
                  <dl> 
                   <dt>
                    Votes:
                   </dt> 
                   <dd> 
                    <span id="vote-data" class="aui-badge vote-state-off">1</span> 
                    <span id="vote-label" title="You have to be logged in to vote for an issue.">Vote for this issue</span> 
                   </dd> 
                  </dl> 
                  <dl> 
                   <dt>
                    Watchers:
                   </dt> 
                   <dd> 
                    <span id="watcher-data" class="aui-badge watch-state-off">3</span> 
                    <span id="watch-label" title="You have to be logged in to watch an issue.">Start watching this issue</span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
               </div>
              </div>
              <div id="datesmodule" class="module toggle-wrap">
               <div id="datesmodule_heading" class="mod-header">
                <ul class="ops"></ul>
                <h2 class="toggle-title">Dates</h2>
               </div>
               <div class="mod-content"> 
                <ul class="item-details"> 
                 <li> 
                  <dl class="dates"> 
                   <dt>
                    Created:
                   </dt> 
                   <dd class="date user-tz" title="10/Oct/06 03:43"> 
                    <span data-name="Created" id="created-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2006-10-10T03:43:30+0000">10/Oct/06 03:43</time> </span> 
                   </dd> 
                  </dl> 
                  <dl class="dates"> 
                   <dt>
                    Updated:
                   </dt> 
                   <dd class="date user-tz" title="16/Nov/07 15:13"> 
                    <span data-name="Updated" id="updated-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2007-11-16T15:13:36+0000">16/Nov/07 15:13</time> </span> 
                   </dd> 
                  </dl> 
                  <dl class="dates"> 
                   <dt>
                    Resolved:
                   </dt> 
                   <dd class="date user-tz" title="23/Apr/07 22:47"> 
                    <span data-name="Resolved" id="resolutiondate-val" data-fieldtype="datetime"> <time class="livestamp" datetime="2007-04-23T22:47:25+0000">23/Apr/07 22:47</time> </span> 
                   </dd> 
                  </dl> </li> 
                </ul> 
               </div>
              </div>
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
     <!-- .aui-page-panel-inner -->
    </div>
    <!-- .aui-page-panel -->
    <div class="issue-navigator-init"></div> 
   </section> 
   <footer id="footer" role="contentinfo"> 
    <section class="footer-body"> 
     <ul class="atlassian-footer"> 
      <li> Atlassian JIRA <a class="seo-link" rel="nofollow" href="https://www.atlassian.com/software/jira">Project Management Software</a> <span id="footer-build-information">(v7.6.3#76005-<span title="8a4e38d34af948780dbf52044e7aafb13a7cae58" data-commit-id="8a4e38d34af948780dbf52044e7aafb13a7cae58}">sha1:8a4e38d</span>)</span> </li> 
      <li> <a id="about-link" rel="nofollow" href="/jira/secure/AboutPage.jspa/secure/AboutPage.jspa">About JIRA</a> </li> 
      <li> <a id="footer-report-problem-link" rel="nofollow" href="/jira/secure/CreateIssue!default.jspa">Report a problem</a> </li> 
     </ul> 
     <ul class="atlassian-footer"> 
      <li class="licensemessage"> Powered by a free Atlassian <a rel="nofollow" href="http://www.atlassian.com/software/jira">JIRA</a> open source license for Apache Software Foundation. Try JIRA - <a rel="nofollow" href="http://www.atlassian.com/software/jira">bug tracking software</a> for <i>your</i> team. </li> 
     </ul> 
     <div id="footer-logo">
      <a rel="nofollow" href="http://www.atlassian.com/">Atlassian</a>
     </div> 
    </section> 
    <fieldset class="hidden parameters"> 
     <input type="hidden" title="loggedInUser" value=""> 
     <input type="hidden" title="ajaxTimeout" value="The call to the JIRA server did not complete within the timeout period.  We are unsure of the result of this operation."> 
     <input type="hidden" title="JiraVersion" value="7.6.3"> 
     <input type="hidden" title="ajaxUnauthorised" value="You are not authorised to perform this operation. Please log in."> 
     <input type="hidden" title="baseURL" value="https://issues.apache.org/jira"> 
     <input type="hidden" title="ajaxCommsError" value="The JIRA server could not be contacted. This may be a temporary glitch or the server may be down. "> 
     <input type="hidden" title="ajaxServerError" value="The JIRA server was contacted but has returned an error response. We are unsure of the result of this operation."> 
     <input type="hidden" title="ajaxErrorCloseDialog" value="Close this dialog and press refresh in your browser"> 
     <input type="hidden" title="ajaxErrorDialogHeading" value="Communications Breakdown"> 
     <input type="hidden" title="dirtyMessage" value="You have entered new data on this page. If you navigate away from this page without first saving your data, the changes will be lost."> 
     <input type="hidden" title="dirtyDialogMessage" value="You have entered new data in this dialog. If you navigate away from this dialog without first saving your data, the changes will be lost. Click cancel to return to the dialog."> 
     <input type="hidden" title="keyType" value="Type"> 
     <input type="hidden" title="keyThen" value="then"> 
     <input type="hidden" title="dblClickToExpand" value="Double click to expand"> 
     <input type="hidden" title="actions" value="Actions"> 
     <input type="hidden" title="removeItem" value="Remove"> 
     <input type="hidden" title="workflow" value="Workflow"> 
     <input type="hidden" title="labelNew" value="New Label"> 
     <input type="hidden" title="issueActionsHint" value="Begin typing for available operations or press down to see all"> 
     <input type="hidden" title="closelink" value="Close"> 
     <input type="hidden" title="dotOperations" value="Operations"> 
     <input type="hidden" title="dotLoading" value="Loading..."> 
     <input type="hidden" title="frotherSuggestions" value="Suggestions"> 
     <input type="hidden" title="frotherNomatches" value="No Matches"> 
     <input type="hidden" title="multiselectVersionsError" value="{0} is not a valid version."> 
     <input type="hidden" title="multiselectComponentsError" value="{0} is not a valid component."> 
     <input type="hidden" title="multiselectGenericError" value="The value {0} is invalid."> 
    </fieldset> 
   </footer> 
  </div> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:bigpipe-js/jira.webresources:bigpipe-js.js" data-wrm-key="jira.webresources:bigpipe-js" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["activity-panel-pipe-id"]="\"\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n    \u003cdiv class=\\\"tabwrap tabs2\\\"\u003e\\n\\n        \u003cul id=\\\"issue-tabs\\\" class=\\\"tabs horizontal\\\"\u003e\\n                                \\n            \u003cli  data-id=\\\"all-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\" data-label=\\\"All\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-1947?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"all-tabpanel\\\" href=\\\"\\/jira\\/browse\\/DERBY-1947?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel\\\"\u003e\u003cstrong\u003eAll\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  class=\\\"active\\\" id=\\\"comment-tabpanel\\\"  data-id=\\\"comment-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel\\\" data-label=\\\"Comments\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-1947?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel\\\"\u003e\\n                            \u003cstrong tabindex=\\\"0\\\"\u003eComments\u003c\\/strong\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"worklog-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\" data-label=\\\"Work Log\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-1947?page=com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"worklog-tabpanel\\\" href=\\\"\\/jira\\/browse\\/DERBY-1947?page=com.atlassian.jira.plugin.system.issuetabpanels:worklog-tabpanel\\\"\u003e\u003cstrong\u003eWork Log\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"changehistory-tabpanel\\\" data-key=\\\"com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\" data-label=\\\"History\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-1947?page=com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"changehistory-tabpanel\\\" href=\\\"\\/jira\\/browse\\/DERBY-1947?page=com.atlassian.jira.plugin.system.issuetabpanels:changehistory-tabpanel\\\"\u003e\u003cstrong\u003eHistory\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"activity-stream-issue-tab\\\" data-key=\\\"com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\" data-label=\\\"Activity\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-1947?page=com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"activity-stream-issue-tab\\\" href=\\\"\\/jira\\/browse\\/DERBY-1947?page=com.atlassian.streams.streams-jira-plugin:activity-stream-issue-tab\\\"\u003e\u003cstrong\u003eActivity\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                                \\n            \u003cli  data-id=\\\"transitions-summary-tabpanel\\\" data-key=\\\"com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\" data-label=\\\"Transitions\\\" data-href=\\\"\\/jira\\/browse\\/DERBY-1947?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\"\u003e\\n                            \u003ca class=\\\"ajax-activity-content\\\" id=\\\"transitions-summary-tabpanel\\\" href=\\\"\\/jira\\/browse\\/DERBY-1947?page=com.googlecode.jira-suite-utilities:transitions-summary-tabpanel\\\"\u003e\u003cstrong\u003eTransitions\u003c\\/strong\u003e\u003c\\/a\u003e\\n                        \u003c\\/li\u003e\\n                \u003c\\/ul\u003e\\n\\n                    \u003cdiv class=\\\"sortwrap\\\"\u003e\\n                                    \u003ca class=\\\"issue-activity-sort-link ajax-activity-content\\\" rel=\\\"nofollow\\\" data-tab-sort data-order=\\\"desc\\\" href=\\\"\\/jira\\/browse\\/DERBY-1947?actionOrder=desc\\\" title=\\\"Ascending order - Click to sort in descending order\\\"\u003e\\n                        \u003cspan class=\\\"aui-icon aui-icon-small aui-iconfont-up\\\"\u003eAscending order - Click to sort in descending order\u003c\\/span\u003e\\n                    \u003c\\/a\u003e\\n                            \u003c\\/div\u003e\\n            \u003c\\/div\u003e\\n    \u003cdiv class=\\\"issuePanelWrapper\\\"\u003e\\n        \u003cdiv class=\\\"issuePanelProgress\\\"\u003e\u003c\\/div\u003e\\n        \u003cdiv class=\\\"issuePanelContainer\\\" id=\\\"issue_actions_container\\\"\u003e\\n                                    \\n\\n\\n\u003cdiv id=\\\"comment-12441042\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1947?focusedCommentId=12441042&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12441042\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"kartha\\\" id=\\\"commentauthor_12441042_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=kartha\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"kartha\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rajesh Kartha\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12441042_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Oct\\/06 03:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-10-10T03:45:26+0000\'\u003e10\\/Oct\\/06 03:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eAttaching the files I mentioned in the description of this issue.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"kartha\\\" id=\\\"commentauthor_12441042_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=kartha\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"kartha\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rajesh Kartha\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12441042_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'10\\/Oct\\/06 03:45\'\u003e\u003ctime class=\'livestamp\' datetime=\'2006-10-10T03:45:26+0000\'\u003e10\\/Oct\\/06 03:45\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Attaching the files I mentioned in the description of this issue.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12483854\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1947?focusedCommentId=12483854&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12483854\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12483854_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12483854_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Mar\\/07 16:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-03-24T16:32:21+0000\'\u003e24\\/Mar\\/07 16:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMy analysis of this problem:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eWhen EmbedConnection#close is called from testEmbedAndClient.java:50, the\u003cbr\\/\u003e\\n  call fails to clean up the connection properly, since the call to the\u003cbr\\/\u003e\\n  private EmbedConnection#close(StandardException) never happens.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e  This is due to the fact that the public close method first checks if\u003cbr\\/\u003e\\n  the connection is already closed via a call to\u003cbr\\/\u003e\\n  EmbedConnection#isClosed(). If so, close just returns,\u003c\\/p\u003e\\n\\n\u003cp\u003e  EmbedConnection#isClosed() returns true even though the connection is still\u003cbr\\/\u003e\\n  marked as active, because the underlying database has been shut down. This\u003cbr\\/\u003e\\n  fact makes TransactionResourceImpl#isActive() return false.\u003c\\/p\u003e\\n\\n\u003cp\u003e  Now, the connection objects and the TransactionResourceImpl will eventually\u003cbr\\/\u003e\\n  be garbage collected, but the ContextManager object owned by\u003cbr\\/\u003e\\n  TransactionResourceImpl, will not, leading to the memory leak.  This is\u003cbr\\/\u003e\\n  because the ContextManager object is referenced from the HashSet\u003cbr\\/\u003e\\n  \'allContexts\' of the ContextService.\u003c\\/p\u003e\\n\\n\u003cp\u003e  Normally, the context manager object is removed from \'allContexts\' when the\u003cbr\\/\u003e\\n  EmbedConnection#close(exceptionclose) calls\u003cbr\\/\u003e\\n  TransactionResourceImpl#cleanupOnError. However, it does not happen here\u003cbr\\/\u003e\\n  since isClosed returns true, so EmbedConnection#close() never gets\u003cbr\\/\u003e\\n  to call EmbedConnection#close(exceptionclose).\u003c\\/p\u003e\\n\\n\u003cp\u003e  Modifying the repro to never close the connection object, I also see\u003cbr\\/\u003e\\n  the leak, since EmbedConnection#finalize similarly fails to call\u003cbr\\/\u003e\\n  EmbedConnection#close(exceptionclose) when isClosed() returns true.\u003c\\/p\u003e\\n\\n\u003cp\u003e  More detail (feel free to skip \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/wink.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003e  TransactionResourceImpl#cleanupOnError, in turn, calls\u003cbr\\/\u003e\\n  ContextManager#cleanupOnError which, when popping its stack of contexts\u003cbr\\/\u003e\\n  finally calls the stack\'s bottom SystemContext#cleanupOnError, which again\u003cbr\\/\u003e\\n  makes this call on line 62:\u003c\\/p\u003e\\n\\n\u003cp\u003e      :\u003cbr\\/\u003e\\n      getContextManager().owningCsf.removeContext(getContextManager());\u003cbr\\/\u003e\\n      :\u003c\\/p\u003e\\n\\n\u003cp\u003e  which releases the context manager from \'allContexts\' so it can be garbage\u003cbr\\/\u003e\\n  collected.\u003c\\/p\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eI have made a patch which makes the repro (and the modified repro I\u003cbr\\/\u003e\\n  mentioned) work without running out of space: \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1947\\\" title=\\\"OutOfMemoryError after repeated calls to boot and shutdown a database\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1947\\\"\u003e\u003cdel\u003eDERBY-1947\u003c\\/del\u003e\u003c\\/a\u003e-1.\\n{diff,stat}\\n\u003cp\u003e.\u003c\\/p\u003e\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e  It modifies EmbedConnection#close to clean up in the case described\u003cbr\\/\u003e\\n  above.\u003c\\/p\u003e\\n\\n\u003cp\u003e  It also adds a finalizer method to TransactionResourceImpl which\u003cbr\\/\u003e\\n  calls ContextManager#cleanupOnError with an argument of\u003cbr\\/\u003e\\n  StandardException.closeException(), if not done already.  This\u003cbr\\/\u003e\\n  catches the case when no close is called on the connection.  This\u003cbr\\/\u003e\\n  change would make the leak go away on its own for both repro cases,\u003cbr\\/\u003e\\n  but I added the change to EmbedConnection#close also, since it\u003cbr\\/\u003e\\n  purports to release database resources in its Javadoc.\u003c\\/p\u003e\\n\\n\u003cp\u003e  So, when the connection is closed or garbage collected, the\u003cbr\\/\u003e\\n  ContextManager will be cleaned up as well, and the leak is plugged.\u003c\\/p\u003e\\n\\n\u003cp\u003e  suites.All and derbyall ran without incident on Sun JDK 1.6, Solaris\u003cbr\\/\u003e\\n  10\\/x86.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eThere is a related issue, \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-2480\\\" title=\\\"DriverManager.getConnection leaks memory when connecting to a non-existent database\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-2480\\\"\u003e\u003cdel\u003eDERBY-2480\u003c\\/del\u003e\u003c\\/a\u003e, for which Jeff Clary has\u003cbr\\/\u003e\\n  produced a patch. They overlap, in that that both patches makes a\u003cbr\\/\u003e\\n  changes to EmbedConnection#close, so we need to reconcile them for\u003cbr\\/\u003e\\n  that method. \u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12483854_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12483854_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Mar\\/07 16:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-03-24T16:32:21+0000\'\u003e24\\/Mar\\/07 16:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    My analysis of this problem: \\n\\n \\n\\t When EmbedConnection#close is called from testEmbedAndClient.java:50, the \\n  call fails to clean up the connection properly, since the call to the \\n  private EmbedConnection#close(StandardException) never happens. \\n \\n\\n\\n   This is due to the fact that the public close method first checks if \\n  the connection is already closed via a call to \\n  EmbedConnection#isClosed(). If so, close just returns, \\n\\n   EmbedConnection#isClosed() returns true even though the connection is still \\n  marked as active, because the underlying database has been shut down. This \\n  fact makes TransactionResourceImpl#isActive() return false. \\n\\n   Now, the connection objects and the TransactionResourceImpl will eventually \\n  be garbage collected, but the ContextManager object owned by \\n  TransactionResourceImpl, will not, leading to the memory leak.  This is \\n  because the ContextManager object is referenced from the HashSet \\n  \'allContexts\' of the ContextService. \\n\\n   Normally, the context manager object is removed from \'allContexts\' when the \\n  EmbedConnection#close(exceptionclose) calls \\n  TransactionResourceImpl#cleanupOnError. However, it does not happen here \\n  since isClosed returns true, so EmbedConnection#close() never gets \\n  to call EmbedConnection#close(exceptionclose). \\n\\n   Modifying the repro to never close the connection object, I also see \\n  the leak, since EmbedConnection#finalize similarly fails to call \\n  EmbedConnection#close(exceptionclose) when isClosed() returns true. \\n\\n   More detail (feel free to skip   \\n\\n   TransactionResourceImpl#cleanupOnError, in turn, calls \\n  ContextManager#cleanupOnError which, when popping its stack of contexts \\n  finally calls the stack\'s bottom SystemContext#cleanupOnError, which again \\n  makes this call on line 62: \\n\\n       : \\n      getContextManager().owningCsf.removeContext(getContextManager()); \\n      : \\n\\n   which releases the context manager from \'allContexts\' so it can be garbage \\n  collected. \\n\\n\\n \\n\\t I have made a patch which makes the repro (and the modified repro I \\n  mentioned) work without running out of space:   DERBY-1947  -1.\\n{diff,stat}\\n .  \\n \\n\\n\\n   It modifies EmbedConnection#close to clean up in the case described \\n  above. \\n\\n   It also adds a finalizer method to TransactionResourceImpl which \\n  calls ContextManager#cleanupOnError with an argument of \\n  StandardException.closeException(), if not done already.  This \\n  catches the case when no close is called on the connection.  This \\n  change would make the leak go away on its own for both repro cases, \\n  but I added the change to EmbedConnection#close also, since it \\n  purports to release database resources in its Javadoc. \\n\\n   So, when the connection is closed or garbage collected, the \\n  ContextManager will be cleaned up as well, and the leak is plugged. \\n\\n   suites.All and derbyall ran without incident on Sun JDK 1.6, Solaris \\n  10\\/x86. \\n\\n \\n\\t There is a related issue,   DERBY-2480  , for which Jeff Clary has \\n  produced a patch. They overlap, in that that both patches makes a \\n  changes to EmbedConnection#close, so we need to reconcile them for \\n  that method.  \\n \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12483856\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1947?focusedCommentId=12483856&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12483856\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12483856_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12483856_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Mar\\/07 16:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-03-24T16:41:56+0000\'\u003e24\\/Mar\\/07 16:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003ePlease disregard the paragraph quoted below in my previous comment, the\u003cbr\\/\u003e\\ncorrect version is given below (the original text reflects my first attempt\u003cbr\\/\u003e\\nat the patch \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; It also adds a finalizer method to TransactionResourceImpl which\u003cbr\\/\u003e\\n&gt; calls ContextManager#cleanupOnError with an argument of\u003cbr\\/\u003e\\n&gt; StandardException.closeException(), if not done already. \u003c\\/p\u003e\\n\\n\u003cp\u003eIt also adds a finalizer method to EmbedConnection which\u003cbr\\/\u003e\\ncalls TransactionResourceImpl#cleanupOnError with an argument of\u003cbr\\/\u003e\\nStandardException.closeException(), if not done already.  \u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12483856_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12483856_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'24\\/Mar\\/07 16:41\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-03-24T16:41:56+0000\'\u003e24\\/Mar\\/07 16:41\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Please disregard the paragraph quoted below in my previous comment, the \\ncorrect version is given below (the original text reflects my first attempt \\nat the patch   \\n\\n &gt; It also adds a finalizer method to TransactionResourceImpl which \\n&gt; calls ContextManager#cleanupOnError with an argument of \\n&gt; StandardException.closeException(), if not done already.  \\n\\n It also adds a finalizer method to EmbedConnection which \\ncalls TransactionResourceImpl#cleanupOnError with an argument of \\nStandardException.closeException(), if not done already.                \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12483951\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1947?focusedCommentId=12483951&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12483951\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12483951_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12483951_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Mar\\/07 15:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-03-25T15:32:10+0000\'\u003e25\\/Mar\\/07 15:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eIt seems like it would be nice if, instead of adding more code to\u003cbr\\/\u003e\\nEmbedConnection.close(), we could instead just have EmbedConnection.close()\u003cbr\\/\u003e\\ncall EmbedConnection.close(StandardException), and have all the\u003cbr\\/\u003e\\nEmbedConnection closing logic in one place. Right now there seems to\u003cbr\\/\u003e\\nbe logic in two EmbedConnection.close() methods, and also in the\u003cbr\\/\u003e\\nfinalize() method. Can it all be moved to the one close(exception) method\u003cbr\\/\u003e\\nand have the other two be 1-line wrappers?\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12483951_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12483951_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'25\\/Mar\\/07 15:32\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-03-25T15:32:10+0000\'\u003e25\\/Mar\\/07 15:32\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    It seems like it would be nice if, instead of adding more code to \\nEmbedConnection.close(), we could instead just have EmbedConnection.close() \\ncall EmbedConnection.close(StandardException), and have all the \\nEmbedConnection closing logic in one place. Right now there seems to \\nbe logic in two EmbedConnection.close() methods, and also in the \\nfinalize() method. Can it all be moved to the one close(exception) method \\nand have the other two be 1-line wrappers? \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12484614\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1947?focusedCommentId=12484614&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12484614\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12484614_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12484614_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Mar\\/07 22:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-03-27T22:00:36+0000\'\u003e27\\/Mar\\/07 22:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks for looking at this, Bryan!\u003c\\/p\u003e\\n\\n\u003cp\u003eUploading a modified patch \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1947\\\" title=\\\"OutOfMemoryError after repeated calls to boot and shutdown a database\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1947\\\"\u003e\u003cdel\u003eDERBY-1947\u003c\\/del\u003e\u003c\\/a\u003e-2 (supercedes \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1947\\\" title=\\\"OutOfMemoryError after repeated calls to boot and shutdown a database\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1947\\\"\u003e\u003cdel\u003eDERBY-1947\u003c\\/del\u003e\u003c\\/a\u003e-1)\u003cbr\\/\u003e\\nwhich addresses Bryan\'s comment, although I did not \u003cb\u003equite\u003c\\/b\u003e manage to\u003cbr\\/\u003e\\nmake it a one-liner \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/wink.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n\\n\u003cp\u003eI also noticed that the isClosed() method changes the internal state\u003cbr\\/\u003e\\nvariable \'active\', thwarting the logic needed to get the cleanup done,\u003cbr\\/\u003e\\nso I removed the call to setInactive() from isClosed(). I believe this\u003cbr\\/\u003e\\nis safe. [Alterately, one call do all the cleanup needed from inside\u003cbr\\/\u003e\\nisClosed() if the underlying transaction is not active.]\u003c\\/p\u003e\\n\\n\u003cp\u003eI further simplified the finalizer by removing the test for rootConnection\u003cbr\\/\u003e\\nsince this is done inside close(StandardException) anyway.\u003c\\/p\u003e\\n\\n\u003cp\u003eI verified the patch against the repro again, including the modified one\u003cbr\\/\u003e\\nI described for the previous patch. I did not add a new test for this issue.\u003c\\/p\u003e\\n\\n\u003cp\u003eI ran derbyall and suites.All again with the patch against svn 521401\u003cbr\\/\u003e\\nwith successfully (modulo the often seen dblook error in derbyall),\u003cbr\\/\u003e\\nSolaris 10\\/x86, Sun JDK1.6.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12484614_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12484614_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'27\\/Mar\\/07 22:00\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-03-27T22:00:36+0000\'\u003e27\\/Mar\\/07 22:00\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks for looking at this, Bryan! \\n\\n Uploading a modified patch   DERBY-1947  -2 (supercedes   DERBY-1947  -1) \\nwhich addresses Bryan\'s comment, although I did not  quite  manage to \\nmake it a one-liner   \\n\\n I also noticed that the isClosed() method changes the internal state \\nvariable \'active\', thwarting the logic needed to get the cleanup done, \\nso I removed the call to setInactive() from isClosed(). I believe this \\nis safe. [Alterately, one call do all the cleanup needed from inside \\nisClosed() if the underlying transaction is not active.] \\n\\n I further simplified the finalizer by removing the test for rootConnection \\nsince this is done inside close(StandardException) anyway. \\n\\n I verified the patch against the repro again, including the modified one \\nI described for the previous patch. I did not add a new test for this issue. \\n\\n I ran derbyall and suites.All again with the patch against svn 521401 \\nwith successfully (modulo the often seen dblook error in derbyall), \\nSolaris 10\\/x86, Sun JDK1.6.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12484667\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1947?focusedCommentId=12484667&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12484667\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12484667_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12484667_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Mar\\/07 01:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-03-28T01:15:52+0000\'\u003e28\\/Mar\\/07 01:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi Dag, the new patch looks very good to me. This sort of close\u003cbr\\/\u003e\\nlogic always seems to be a bit finicky, but I think you\'ve got it\u003cbr\\/\u003e\\nnicely packaged now.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"bryanpendleton\\\" id=\\\"commentauthor_12484667_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=bryanpendleton\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"bryanpendleton\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Bryan Pendleton\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12484667_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'28\\/Mar\\/07 01:15\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-03-28T01:15:52+0000\'\u003e28\\/Mar\\/07 01:15\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hi Dag, the new patch looks very good to me. This sort of close \\nlogic always seems to be a bit finicky, but I think you\'ve got it \\nnicely packaged now.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12489576\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1947?focusedCommentId=12489576&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12489576\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12489576_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12489576_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Apr\\/07 00:04\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-18T00:04:21+0000\'\u003e18\\/Apr\\/07 00:04\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eI was getting ready to commit the patch for this issue, but then I\u003cbr\\/\u003e\\nupdated my trunk and found that the following newly\u003cbr\\/\u003e\\nintroduced\\/converted JUnit test makes Derby deadlock when the patch\u003cbr\\/\u003e\\n(\u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1947\\\" title=\\\"OutOfMemoryError after repeated calls to boot and shutdown a database\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1947\\\"\u003e\u003cdel\u003eDERBY-1947\u003c\\/del\u003e\u003c\\/a\u003e-2) is active:\u003c\\/p\u003e\\n\\n\u003cp\u003e  ProcedureInTriggerTest\u003c\\/p\u003e\\n\\n\u003cp\u003eIt looks like a deadlock in the VM (see also enclosed stacks of\u003cbr\\/\u003e\\ninvolved threads) caused by the patch\'s use of finalizer code which\u003cbr\\/\u003e\\nleads to synchronization, and I am at a loss presently for how to\u003cbr\\/\u003e\\nresolve this best.\u003c\\/p\u003e\\n\\n\u003cp\u003eWhat seems to happen is this:\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eIn ProcedureInTriggerTest:388, a call to Stement#execute is performed:\u003cbr\\/\u003e\\n   &gt; s.execute(\\\"create trigger select_from_trig_table no cascade before \\\" + \u003cbr\\/\u003e\\n                               \\\"delete on t1 for each STATEMENT call proc_reads_sql(1)\\\");\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e  This call synchronizes on the current (root) connection object.\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eAt this time I believe there are still two nested connection objects\u003cbr\\/\u003e\\n  from previous statements (the test uses triggers and stored\u003cbr\\/\u003e\\n  procedures called from them), which are no longer referenced but for\u003cbr\\/\u003e\\n  whom the finalizer has yet to run (not yet garbage collected).\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eNow, the CreateTriggerConstantAction#executeConstantAction in line\u003cbr\\/\u003e\\n  275 uses the Dependency manager to send an invalidate to the trigger\u003cbr\\/\u003e\\n  table so that DML statements on this table will be recompiled.  (see\u003cbr\\/\u003e\\n  stack of thread \\\"main\\\" in attachment\u003cbr\\/\u003e\\n  ProcedureInTriggerTest-threadstacks.txt).\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eAs a result of this, GenericPreparedStatement#prepareToInvalidate is\u003cbr\\/\u003e\\n  called which again calls\u003cbr\\/\u003e\\n  GenericLanguageConnectionContext#verifyNoOpenResultSets\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003everifyNoOpenResultSets contains this sequence of calls:\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e  \\t\\/\\/ There may be open ResultSet\'s that are yet to be garbage collected\u003cbr\\/\u003e\\n        \\/\\/ let\'s try and force these out rather than throw an error\u003cbr\\/\u003e\\n        System.gc();\u003cbr\\/\u003e\\n        System.runFinalization();\u003c\\/p\u003e\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eThis last call causes deadlock. This seems to happens because the\u003cbr\\/\u003e\\n  said nested connection\'s finalizers are attempted executed.  With\u003cbr\\/\u003e\\n  the patch, the finalizer of EmbedConnection contains a call to\u003cbr\\/\u003e\\n  EmbedConnection#close which synchronizes on the root connection\u003cbr\\/\u003e\\n  object (already locked by the \\\"main\\\" thread as part of the execute).\u003cbr\\/\u003e\\n  The execution of the finalizer happens in a thread forked by the\u003cbr\\/\u003e\\n  call to System.runFinalization(), which hangs waiting for the\u003cbr\\/\u003e\\n  finalizer thread to complete (see Finalizer#forkSecondaryFinalizer\'s\u003cbr\\/\u003e\\n  call to sft.join() ca line 115 in Sun JDK 1.6). Now, the finalizers\u003cbr\\/\u003e\\n  are stuck waiting for the lock held my \\\"main\\\", so deadlock ensues.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul\u003e\\n\\t\u003cli\u003eNow, without the call to System.runFinalization(); the test runs\u003cbr\\/\u003e\\n  successfully, presumably because the two connection objects will\u003cbr\\/\u003e\\n  then be garbage collected later, after s.execute() has terminated.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e  Also, removing the call to System.gc() removes the deadlock, but\u003cbr\\/\u003e\\n  this breaks the test however (verifyNoOpenResultSets throws X0X95.S\u003c\\/p\u003e\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eLANG_CANT_INVALIDATE_OPEN_RESULT_SET in line 1733):\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e     \\\"Operation \'CREATE TRIGGER\' cannot be performed on object \'T1\'\u003cbr\\/\u003e\\n      because there is an open ResultSet dependent on that object.\\\"\u003c\\/p\u003e\\n\\n\u003cp\u003e  So it would seem that calling System.gc() is sufficient, but\u003cbr\\/\u003e\\n  System.runFinalization is harmful, since it will wait for\u003cbr\\/\u003e\\n  finalization to finish, which is a dangerous thing if the thread\u003cbr\\/\u003e\\n  already holds locks. \u003cb\u003eOr\u003c\\/b\u003e one could argue that the finalizers should\u003cbr\\/\u003e\\n  never call anything that could require a lock (too strict in my\u003cbr\\/\u003e\\n  view).\u003c\\/p\u003e\\n\\n\u003cp\u003eSo, now I am trying to understand what would be the correct approach\u003cbr\\/\u003e\\nto resolve this.\u003c\\/p\u003e\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eWithout the call to close in the finalizer of EmbedConnection, we\u003cbr\\/\u003e\\n  have \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1947\\\" title=\\\"OutOfMemoryError after repeated calls to boot and shutdown a database\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1947\\\"\u003e\u003cdel\u003eDERBY-1947\u003c\\/del\u003e\u003c\\/a\u003e, that is, ContextManager objects is referenced from\u003cbr\\/\u003e\\n  the HashSet \'allContexts\' of the ContextService may leak.\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cul class=\\\"alternate\\\" type=\\\"square\\\"\u003e\\n\\t\u003cli\u003eWith the call to close in the finalizer of EmbedConnection, we risk\u003cbr\\/\u003e\\n  deadlock as long as any Derby code calls System.runFinalization()\u003cbr\\/\u003e\\n  anywhere. Grepping, i see this happens in three places in the\u003cbr\\/\u003e\\n  engine:\u003c\\/li\u003e\\n\u003c\\/ul\u003e\\n\\n\\n\u003cp\u003e  LowMemory.java:95: System.runFinalization();\u003cbr\\/\u003e\\n  GenericLanguageConnectionContext.java:1617: System.runFinalization();\u003cbr\\/\u003e\\n  GenericLanguageConnectionContext.java:1709: System.runFinalization();\u003c\\/p\u003e\\n\\n\u003cp\u003ePossible approaches:\u003c\\/p\u003e\\n\\n\u003cp\u003e1) Maybe we could change the HashSet \'allContexts\' of the\u003cbr\\/\u003e\\n   ContextService to use weak hash map perhaps, a WeakHashSet, if there\u003cbr\\/\u003e\\n   is such a thing. That way, the ContextManager objects would be\u003cbr\\/\u003e\\n   cleaned eventually.\u003c\\/p\u003e\\n\\n\u003cp\u003e2) Remove the explicit calls to System.runFinalization. It seems that\u003cbr\\/\u003e\\n   keeping just the System.gc() call is less risky, but may be less\u003cbr\\/\u003e\\n   efficient, so could break existing apps? The System.gc() is not\u003cbr\\/\u003e\\n   guaranteed to yield results anyway..\u003c\\/p\u003e\\n\\n\u003cp\u003e3) Figure out a way to explicitly close the result sets in question,\u003cbr\\/\u003e\\n   so the gc calls would be redundant. I am not sure how easy this\u003cbr\\/\u003e\\n   would be; they are probably there for a good reason.\u003c\\/p\u003e\\n\\n\u003cp\u003e4) Remove the calls and allow the execution to fail as indicated in\u003cbr\\/\u003e\\n   the comment of verifyNoOpenResultSets:\u003c\\/p\u003e\\n\\n\u003cp\u003e   \\/\\/ There may be open ResultSet\'s that are yet to be garbage collected\u003cbr\\/\u003e\\n   \\/\\/ let\'s try and force these out rather than throw an error\u003cbr\\/\u003e\\n   System.gc();\u003cbr\\/\u003e\\n   System.runFinalization();\u003c\\/p\u003e\\n\\n\u003cp\u003e   This could break existing apps.\u003c\\/p\u003e\\n\\n\u003cp\u003e5) other ideas..? \u003c\\/p\u003e\\n\\n\u003cp\u003eFinally, can this deadlock be considered a Java run-time error? If\u003cbr\\/\u003e\\nnot, what is the contract being broken by Derby app code in the above?\u003cbr\\/\u003e\\nI tried to search a bit around advisability of explicitly running\u003cbr\\/\u003e\\nrunFinalization, in the presence of held Java locks, and finalizers\u003cbr\\/\u003e\\nwhich can cause locks, but I didn\'t find anything conclusive...\u003c\\/p\u003e\\n\\n\u003cp\u003eAny advise is appreciated \u003cimg class=\\\"emoticon\\\" src=\\\"\\/jira\\/images\\/icons\\/emoticons\\/smile.png\\\" height=\\\"16\\\" width=\\\"16\\\" align=\\\"absmiddle\\\" alt=\\\"\\\" border=\\\"0\\\"\\/\u003e\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12489576_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12489576_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Apr\\/07 00:04\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-18T00:04:21+0000\'\u003e18\\/Apr\\/07 00:04\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    I was getting ready to commit the patch for this issue, but then I \\nupdated my trunk and found that the following newly \\nintroduced\\/converted JUnit test makes Derby deadlock when the patch \\n(  DERBY-1947  -2) is active: \\n\\n   ProcedureInTriggerTest \\n\\n It looks like a deadlock in the VM (see also enclosed stacks of \\ninvolved threads) caused by the patch\'s use of finalizer code which \\nleads to synchronization, and I am at a loss presently for how to \\nresolve this best. \\n\\n What seems to happen is this: \\n\\n \\n\\t In ProcedureInTriggerTest:388, a call to Stement#execute is performed: \\n   &gt; s.execute(\\\"create trigger select_from_trig_table no cascade before \\\" +  \\n                               \\\"delete on t1 for each STATEMENT call proc_reads_sql(1)\\\"); \\n \\n\\n\\n   This call synchronizes on the current (root) connection object. \\n\\n \\n\\t At this time I believe there are still two nested connection objects \\n  from previous statements (the test uses triggers and stored \\n  procedures called from them), which are no longer referenced but for \\n  whom the finalizer has yet to run (not yet garbage collected). \\n \\n\\n\\n \\n\\t Now, the CreateTriggerConstantAction#executeConstantAction in line \\n  275 uses the Dependency manager to send an invalidate to the trigger \\n  table so that DML statements on this table will be recompiled.  (see \\n  stack of thread \\\"main\\\" in attachment \\n  ProcedureInTriggerTest-threadstacks.txt). \\n \\n\\n\\n \\n\\t As a result of this, GenericPreparedStatement#prepareToInvalidate is \\n  called which again calls \\n  GenericLanguageConnectionContext#verifyNoOpenResultSets \\n \\n\\n\\n \\n\\t verifyNoOpenResultSets contains this sequence of calls: \\n \\n\\n\\n   \\t\\/\\/ There may be open ResultSet\'s that are yet to be garbage collected \\n        \\/\\/ let\'s try and force these out rather than throw an error \\n        System.gc(); \\n        System.runFinalization(); \\n\\n \\n\\t This last call causes deadlock. This seems to happens because the \\n  said nested connection\'s finalizers are attempted executed.  With \\n  the patch, the finalizer of EmbedConnection contains a call to \\n  EmbedConnection#close which synchronizes on the root connection \\n  object (already locked by the \\\"main\\\" thread as part of the execute). \\n  The execution of the finalizer happens in a thread forked by the \\n  call to System.runFinalization(), which hangs waiting for the \\n  finalizer thread to complete (see Finalizer#forkSecondaryFinalizer\'s \\n  call to sft.join() ca line 115 in Sun JDK 1.6). Now, the finalizers \\n  are stuck waiting for the lock held my \\\"main\\\", so deadlock ensues. \\n \\n\\n\\n \\n\\t Now, without the call to System.runFinalization(); the test runs \\n  successfully, presumably because the two connection objects will \\n  then be garbage collected later, after s.execute() has terminated. \\n \\n\\n\\n   Also, removing the call to System.gc() removes the deadlock, but \\n  this breaks the test however (verifyNoOpenResultSets throws X0X95.S \\n \\n\\t LANG_CANT_INVALIDATE_OPEN_RESULT_SET in line 1733): \\n \\n\\n\\n      \\\"Operation \'CREATE TRIGGER\' cannot be performed on object \'T1\' \\n      because there is an open ResultSet dependent on that object.\\\" \\n\\n   So it would seem that calling System.gc() is sufficient, but \\n  System.runFinalization is harmful, since it will wait for \\n  finalization to finish, which is a dangerous thing if the thread \\n  already holds locks.  Or  one could argue that the finalizers should \\n  never call anything that could require a lock (too strict in my \\n  view). \\n\\n So, now I am trying to understand what would be the correct approach \\nto resolve this. \\n\\n \\n\\t Without the call to close in the finalizer of EmbedConnection, we \\n  have   DERBY-1947  , that is, ContextManager objects is referenced from \\n  the HashSet \'allContexts\' of the ContextService may leak. \\n \\n\\n\\n \\n\\t With the call to close in the finalizer of EmbedConnection, we risk \\n  deadlock as long as any Derby code calls System.runFinalization() \\n  anywhere. Grepping, i see this happens in three places in the \\n  engine: \\n \\n\\n\\n   LowMemory.java:95: System.runFinalization(); \\n  GenericLanguageConnectionContext.java:1617: System.runFinalization(); \\n  GenericLanguageConnectionContext.java:1709: System.runFinalization(); \\n\\n Possible approaches: \\n\\n 1) Maybe we could change the HashSet \'allContexts\' of the \\n   ContextService to use weak hash map perhaps, a WeakHashSet, if there \\n   is such a thing. That way, the ContextManager objects would be \\n   cleaned eventually. \\n\\n 2) Remove the explicit calls to System.runFinalization. It seems that \\n   keeping just the System.gc() call is less risky, but may be less \\n   efficient, so could break existing apps? The System.gc() is not \\n   guaranteed to yield results anyway.. \\n\\n 3) Figure out a way to explicitly close the result sets in question, \\n   so the gc calls would be redundant. I am not sure how easy this \\n   would be; they are probably there for a good reason. \\n\\n 4) Remove the calls and allow the execution to fail as indicated in \\n   the comment of verifyNoOpenResultSets: \\n\\n    \\/\\/ There may be open ResultSet\'s that are yet to be garbage collected \\n   \\/\\/ let\'s try and force these out rather than throw an error \\n   System.gc(); \\n   System.runFinalization(); \\n\\n    This could break existing apps. \\n\\n 5) other ideas..?  \\n\\n Finally, can this deadlock be considered a Java run-time error? If \\nnot, what is the contract being broken by Derby app code in the above? \\nI tried to search a bit around advisability of explicitly running \\nrunFinalization, in the presence of held Java locks, and finalizers \\nwhich can cause locks, but I didn\'t find anything conclusive... \\n\\n Any advise is appreciated   \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12489808\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1947?focusedCommentId=12489808&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12489808\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_12489808_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12489808_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Apr\\/07 16:19\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-18T16:19:15+0000\'\u003e18\\/Apr\\/07 16:19\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eHi Dag,\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt;1) Maybe we could change the HashSet \'allContexts\' of the\u003cbr\\/\u003e\\n&gt;   ContextService to use weak hash map perhaps, a WeakHashSet, if there\u003cbr\\/\u003e\\n&gt;   is such a thing. That way, the ContextManager objects would be\u003cbr\\/\u003e\\n&gt;   cleaned eventually.\u003c\\/p\u003e\\n\\n\u003cp\u003eMaybe you could press java.util.WeakHashMap into service. Its javadoc suggests the following issues:\u003c\\/p\u003e\\n\\n\u003cp\u003ea) You would need to choose something innocuous for the values in this map. You\'re only interested in the keys and garbage-collectible values would need to be wrapped in WeakReferences.\u003c\\/p\u003e\\n\\n\u003cp\u003eb) ContextService.notifyAllActiveThreads() would need to be insulated from disappearing keys. Also, for the record, it looks to me as though the Thread.interrupt() call needs to be wrapped in a privileged action block.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"rhillegas\\\" id=\\\"commentauthor_12489808_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=rhillegas\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"rhillegas\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Rick Hillegas\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12489808_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Apr\\/07 16:19\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-18T16:19:15+0000\'\u003e18\\/Apr\\/07 16:19\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Hi Dag, \\n\\n &gt;1) Maybe we could change the HashSet \'allContexts\' of the \\n&gt;   ContextService to use weak hash map perhaps, a WeakHashSet, if there \\n&gt;   is such a thing. That way, the ContextManager objects would be \\n&gt;   cleaned eventually. \\n\\n Maybe you could press java.util.WeakHashMap into service. Its javadoc suggests the following issues: \\n\\n a) You would need to choose something innocuous for the values in this map. You\'re only interested in the keys and garbage-collectible values would need to be wrapped in WeakReferences. \\n\\n b) ContextService.notifyAllActiveThreads() would need to be insulated from disappearing keys. Also, for the record, it looks to me as though the Thread.interrupt() call needs to be wrapped in a privileged action block.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12489814\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1947?focusedCommentId=12489814&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12489814\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12489814_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12489814_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Apr\\/07 16:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-18T16:38:05+0000\'\u003e18\\/Apr\\/07 16:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eA data point: In addition to the patch, I removed both calls to\u003cbr\\/\u003e\\nSystem.runFinalization() from GenericLanguageConnectionContext.java,\u003cbr\\/\u003e\\nbut kept the calls to System.gc().\u003c\\/p\u003e\\n\\n\u003cp\u003eI ran suites.All end derbyall successfully with both Sun JDK1.4.2 and\u003cbr\\/\u003e\\n1.6 (sane jars), so I wonder if this may be the simplest way to resolve this. \u003c\\/p\u003e\\n\\n\u003cp\u003eDoes anyone know if\\/why the calls to System.runFinalization() are\u003cbr\\/\u003e\\n(sometimes only, it would seem) necessary?\u003c\\/p\u003e\\n\\n\u003cp\u003eThe calls to System.runFinalization() has been there since incubation\u003cbr\\/\u003e\\nas far as I can tell.\u003c\\/p\u003e\\n\\n\u003cp\u003eIn any case, I will prepare a patch which contains this change as\u003cbr\\/\u003e\\nwell, maybe then someone can test on other VMs; I wonder whether the\u003cbr\\/\u003e\\nbehavior could differ in a significant way between VMs here.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12489814_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12489814_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Apr\\/07 16:38\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-18T16:38:05+0000\'\u003e18\\/Apr\\/07 16:38\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    A data point: In addition to the patch, I removed both calls to \\nSystem.runFinalization() from GenericLanguageConnectionContext.java, \\nbut kept the calls to System.gc(). \\n\\n I ran suites.All end derbyall successfully with both Sun JDK1.4.2 and \\n1.6 (sane jars), so I wonder if this may be the simplest way to resolve this.  \\n\\n Does anyone know if\\/why the calls to System.runFinalization() are \\n(sometimes only, it would seem) necessary? \\n\\n The calls to System.runFinalization() has been there since incubation \\nas far as I can tell. \\n\\n In any case, I will prepare a patch which contains this change as \\nwell, maybe then someone can test on other VMs; I wonder whether the \\nbehavior could differ in a significant way between VMs here.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12489816\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1947?focusedCommentId=12489816&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12489816\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12489816_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12489816_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Apr\\/07 17:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-18T17:06:06+0000\'\u003e18\\/Apr\\/07 17:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eUploaded patch \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1947\\\" title=\\\"OutOfMemoryError after repeated calls to boot and shutdown a database\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1947\\\"\u003e\u003cdel\u003eDERBY-1947\u003c\\/del\u003e\u003c\\/a\u003e-3, which is the same as *-2, except\u003cbr\\/\u003e\\nthat two calls to System.runFinalization have been commented out,\u003cbr\\/\u003e\\nplease see previous comment.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12489816_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12489816_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'18\\/Apr\\/07 17:06\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-18T17:06:06+0000\'\u003e18\\/Apr\\/07 17:06\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Uploaded patch   DERBY-1947  -3, which is the same as *-2, except \\nthat two calls to System.runFinalization have been commented out, \\nplease see previous comment.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12490202\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1947?focusedCommentId=12490202&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12490202\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12490202_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12490202_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Apr\\/07 23:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-19T23:51:39+0000\'\u003e19\\/Apr\\/07 23:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eMore data:\u003cbr\\/\u003e\\nUnfortunately, without the call to System.runFinalization(),\u003cbr\\/\u003e\\nProcedureInTriggerTest fails on Linux with Sun JDKs\u003cbr\\/\u003e\\nwith LANG_CANT_INVALIDATE_OPEN_RESULT_SET.\u003cbr\\/\u003e\\nKeeping the call, it deadlocks, as on Solaris.\u003c\\/p\u003e\\n\\n\u003cp\u003eFor the IBM 1.5 VM, keeping the call, there is no deadlock,\u003cbr\\/\u003e\\nbut the error happens. As soon as the finalizer of the nested\u003cbr\\/\u003e\\nEmbedConnection objects (non-root) synchronize,\u003cbr\\/\u003e\\nthe failure happens, but at least the VM doesn\'t deadlock...\u003cbr\\/\u003e\\nPresumably the failure happens because the finalizers can\'t complete\u003cbr\\/\u003e\\nwhen gc() and runFinalization() is called, barring the\u003cbr\\/\u003e\\nresult sets from being garbage collected as well.\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'ll have to try another tack than removing the call to\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12490202_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12490202_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Apr\\/07 23:51\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-19T23:51:39+0000\'\u003e19\\/Apr\\/07 23:51\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    More data: \\nUnfortunately, without the call to System.runFinalization(), \\nProcedureInTriggerTest fails on Linux with Sun JDKs \\nwith LANG_CANT_INVALIDATE_OPEN_RESULT_SET. \\nKeeping the call, it deadlocks, as on Solaris. \\n\\n For the IBM 1.5 VM, keeping the call, there is no deadlock, \\nbut the error happens. As soon as the finalizer of the nested \\nEmbedConnection objects (non-root) synchronize, \\nthe failure happens, but at least the VM doesn\'t deadlock... \\nPresumably the failure happens because the finalizers can\'t complete \\nwhen gc() and runFinalization() is called, barring the \\nresult sets from being garbage collected as well. \\n\\n I\'ll have to try another tack than removing the call to              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12490203\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1947?focusedCommentId=12490203&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12490203\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12490203_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12490203_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Apr\\/07 23:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-19T23:55:29+0000\'\u003e19\\/Apr\\/07 23:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e.. to complete the sentence of the previous comment:\u003c\\/p\u003e\\n\\n\u003cp\u003eI\'ll have to try another tack than removing the call to\u003cbr\\/\u003e\\nSystem.runFinalization().\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12490203_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12490203_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'19\\/Apr\\/07 23:55\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-19T23:55:29+0000\'\u003e19\\/Apr\\/07 23:55\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    .. to complete the sentence of the previous comment: \\n\\n I\'ll have to try another tack than removing the call to \\nSystem.runFinalization().              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12490311\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1947?focusedCommentId=12490311&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12490311\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12490311_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12490311_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Apr\\/07 10:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-20T10:22:58+0000\'\u003e20\\/Apr\\/07 10:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003e&gt; Presumably the failure happens because the finalizers can\'t complete\u003cbr\\/\u003e\\n&gt; when gc() and runFinalization() is called, barring the\u003cbr\\/\u003e\\n&gt; result sets from being garbage collected as well.\u003c\\/p\u003e\\n\\n\u003cp\u003eIt could also be that gc() just makes the garbage collection start, possibly in another thread, so that runFinalization() is called before the objects are marked as unreferenced. IIRC, gc() doesn\'t block whereas runFinalization() does.\u003c\\/p\u003e\\n\\n\u003cp\u003eNote that the IBM 1.5 VM implemented a much more aggressive gc than previous versions. I remember that many tests had to be rewritten when people started running tests with that VM because ResultSets were closed earlier, etc. That probably explains why you don\'t see the deadlock in runFinalization() on IBM 1.5, since the objects most likely are gc\'ed and finalized before you come to that point.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"knutanders\\\" id=\\\"commentauthor_12490311_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=knutanders\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"knutanders\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Knut Anders Hatlen\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12490311_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Apr\\/07 10:22\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-20T10:22:58+0000\'\u003e20\\/Apr\\/07 10:22\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    &gt; Presumably the failure happens because the finalizers can\'t complete \\n&gt; when gc() and runFinalization() is called, barring the \\n&gt; result sets from being garbage collected as well. \\n\\n It could also be that gc() just makes the garbage collection start, possibly in another thread, so that runFinalization() is called before the objects are marked as unreferenced. IIRC, gc() doesn\'t block whereas runFinalization() does. \\n\\n Note that the IBM 1.5 VM implemented a much more aggressive gc than previous versions. I remember that many tests had to be rewritten when people started running tests with that VM because ResultSets were closed earlier, etc. That probably explains why you don\'t see the deadlock in runFinalization() on IBM 1.5, since the objects most likely are gc\'ed and finalized before you come to that point.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12490357\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1947?focusedCommentId=12490357&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12490357\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12490357_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12490357_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Apr\\/07 13:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-20T13:37:27+0000\'\u003e20\\/Apr\\/07 13:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThanks for looking at this Knut! \u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; It could also be that gc() just makes the garbage collection start,\u003cbr\\/\u003e\\n&gt; possibly in another thread, so that runFinalization() is called before\u003cbr\\/\u003e\\n&gt; the objects are marked as unreferenced. IIRC, gc() doesn\'t block\u003cbr\\/\u003e\\n&gt; whereas runFinalization() does.\u003c\\/p\u003e\\n\\n\u003cp\u003eOn Solaris, gc() alone manages to clear up the result set objects in\u003cbr\\/\u003e\\ntime: Not sure how that works; possibly the marking of the nested\u003cbr\\/\u003e\\nconnection objects makes it possible to also mark the result set\u003cbr\\/\u003e\\nobjects which are then effectively collected in time for the test in\u003cbr\\/\u003e\\n#prepareToInvalidate() even though the connection objects can\'t yet be\u003cbr\\/\u003e\\nfinalized (blocked). As you say, since gc() doesn\'t block, there is no deadlock,\u003cbr\\/\u003e\\nand it works.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; Note that the IBM 1.5 VM implemented a much more aggressive gc than\u003cbr\\/\u003e\\n&gt; previous versions. I remember that many tests had to be rewritten when\u003cbr\\/\u003e\\n&gt; people started running tests with that VM because ResultSets were\u003c\\/p\u003e\\n\\n\u003cp\u003eOn Linux with SUN VM and with the IBM VM, gc() alone are not able to\u003cbr\\/\u003e\\nfree the result set objects in time, but this is could be timing\u003cbr\\/\u003e\\ndependent.\u003c\\/p\u003e\\n\\n\u003cp\u003e&gt; closed earlier, etc. That probably explains why you don\'t see the\u003cbr\\/\u003e\\n&gt; deadlock in runFinalization() on IBM 1.5, since the objects most\u003cbr\\/\u003e\\n&gt; likely are gc\'ed and finalized before you come to that point.\u003c\\/p\u003e\\n\\n\u003cp\u003eNo, I get the error with the IBM VM too, so the calls are\u003cbr\\/\u003e\\nnecessary. But they will not succeed in finalizing the nested\u003cbr\\/\u003e\\nconnection objects (unless they are collected earlier but result set\u003cbr\\/\u003e\\nobjects are not) but at least it doesn\'t deadlock.\u003c\\/p\u003e\\n\\n\u003cp\u003eI will upload a new patch which avoids synchronization in the\u003cbr\\/\u003e\\nfinalizer of nested connection objects, which solves the deadlock\u003cbr\\/\u003e\\nproblem.\u003c\\/p\u003e \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12490357_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12490357_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Apr\\/07 13:37\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-20T13:37:27+0000\'\u003e20\\/Apr\\/07 13:37\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Thanks for looking at this Knut!  \\n\\n &gt; It could also be that gc() just makes the garbage collection start, \\n&gt; possibly in another thread, so that runFinalization() is called before \\n&gt; the objects are marked as unreferenced. IIRC, gc() doesn\'t block \\n&gt; whereas runFinalization() does. \\n\\n On Solaris, gc() alone manages to clear up the result set objects in \\ntime: Not sure how that works; possibly the marking of the nested \\nconnection objects makes it possible to also mark the result set \\nobjects which are then effectively collected in time for the test in \\n#prepareToInvalidate() even though the connection objects can\'t yet be \\nfinalized (blocked). As you say, since gc() doesn\'t block, there is no deadlock, \\nand it works. \\n\\n &gt; Note that the IBM 1.5 VM implemented a much more aggressive gc than \\n&gt; previous versions. I remember that many tests had to be rewritten when \\n&gt; people started running tests with that VM because ResultSets were \\n\\n On Linux with SUN VM and with the IBM VM, gc() alone are not able to \\nfree the result set objects in time, but this is could be timing \\ndependent. \\n\\n &gt; closed earlier, etc. That probably explains why you don\'t see the \\n&gt; deadlock in runFinalization() on IBM 1.5, since the objects most \\n&gt; likely are gc\'ed and finalized before you come to that point. \\n\\n No, I get the error with the IBM VM too, so the calls are \\nnecessary. But they will not succeed in finalizing the nested \\nconnection objects (unless they are collected earlier but result set \\nobjects are not) but at least it doesn\'t deadlock. \\n\\n I will upload a new patch which avoids synchronization in the \\nfinalizer of nested connection objects, which solves the deadlock \\nproblem.              \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12490362\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1947?focusedCommentId=12490362&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12490362\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12490362_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12490362_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Apr\\/07 13:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-20T13:52:16+0000\'\u003e20\\/Apr\\/07 13:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eThis version of the patch, \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1947\\\" title=\\\"OutOfMemoryError after repeated calls to boot and shutdown a database\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1947\\\"\u003e\u003cdel\u003eDERBY-1947\u003c\\/del\u003e\u003c\\/a\u003e-4.* supercedes all earlier versions.\u003cbr\\/\u003e\\nIt removes the call to close() from the finalizer of EmbedConnection for nested\u003cbr\\/\u003e\\nconnection objects introduced in earlier versions of this patch as it is not strictly necessary. This solves the deadlock issue.\u003c\\/p\u003e\\n\\n\u003cp\u003esuites.All and derbyall + the repro run cleanly with Sun 1.4 on Solaris.\u003cbr\\/\u003e\\nI have verified the repro and ProcudureInTriggerTest against Sun 1.4 and IBM 1.5 on Linux as well.\u003c\\/p\u003e\\n\\n\u003cp\u003eUnless I get feedback on this version I will commit it on Monday.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12490362_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12490362_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'20\\/Apr\\/07 13:52\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-20T13:52:16+0000\'\u003e20\\/Apr\\/07 13:52\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    This version of the patch,   DERBY-1947  -4.* supercedes all earlier versions. \\nIt removes the call to close() from the finalizer of EmbedConnection for nested \\nconnection objects introduced in earlier versions of this patch as it is not strictly necessary. This solves the deadlock issue. \\n\\n suites.All and derbyall + the repro run cleanly with Sun 1.4 on Solaris. \\nI have verified the repro and ProcudureInTriggerTest against Sun 1.4 and IBM 1.5 on Linux as well. \\n\\n Unless I get feedback on this version I will commit it on Monday. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \\n\\n\\n\u003cdiv id=\\\"comment-12491094\\\" class=\\\"issue-data-block activity-comment twixi-block  expanded\\\"\u003e\\n    \u003cdiv class=\\\"twixi-wrap verbose actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Collapse comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-expanded\\\"\u003e\u003cspan\u003eHide\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-links\\\"\u003e\\n                \u003ca href=\\\"\\/jira\\/browse\\/DERBY-1947?focusedCommentId=12491094&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12491094\\\"\\n                   title=\\\"Right click and copy link for a permanent link to this comment.\\\" class=\\\"activitymodule-link issue-comment-action\\\"\u003e\\n                    \u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-link\\\"\u003ePermalink\u003c\\/span\u003e\u003c\\/a\u003e\\n                                            \u003c\\/div\u003e\\n            \u003cdiv class=\\\"action-details\\\"\u003e        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12491094_verbose\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12491094_verbose subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Apr\\/07 22:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-23T22:46:45+0000\'\u003e23\\/Apr\\/07 22:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e  \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n        \u003cdiv class=\\\"action-body flooded\\\"\u003e\u003cp\u003eCommitted \u003ca href=\\\"https:\\/\\/issues.apache.org\\/jira\\/browse\\/DERBY-1947\\\" title=\\\"OutOfMemoryError after repeated calls to boot and shutdown a database\\\" class=\\\"issue-link\\\" data-issue-key=\\\"DERBY-1947\\\"\u003e\u003cdel\u003eDERBY-1947\u003c\\/del\u003e\u003c\\/a\u003e-4.* as svn 531638 and resolving it.\u003c\\/p\u003e\\n \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n    \u003cdiv class=\\\"twixi-wrap concise actionContainer\\\"\u003e\\n        \u003cdiv class=\\\"action-head\\\"\u003e\\n            \u003ca href=\\\"#\\\" title=\\\"Expand comment\\\" class=\\\"twixi\\\"\u003e\u003cspan class=\\\"icon-default aui-icon aui-icon-small aui-iconfont-collapsed\\\"\u003e\u003cspan\u003eShow\u003c\\/span\u003e\u003c\\/span\u003e\u003c\\/a\u003e\\n            \u003cdiv class=\\\"action-details flooded\\\"\u003e\\n                        \\n    \\n    \\n    \\n                \\n\\n    \u003ca class=\\\"user-hover user-avatar\\\" rel=\\\"dagw\\\" id=\\\"commentauthor_12491094_concise\\\" href=\\\"\\/jira\\/secure\\/ViewProfile.jspa?name=dagw\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-xsmall\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"https:\\/\\/issues.apache.org\\/jira\\/secure\\/useravatar?size=xsmall&amp;avatarId=10452\\\" alt=\\\"dagw\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e Dag H. Wanvik\u003c\\/a\u003e\\n added a comment  - \u003cspan class=\'commentdate_12491094_concise subText\'\u003e\u003cspan class=\'date user-tz\' title=\'23\\/Apr\\/07 22:46\'\u003e\u003ctime class=\'livestamp\' datetime=\'2007-04-23T22:46:45+0000\'\u003e23\\/Apr\\/07 22:46\u003c\\/time\u003e\u003c\\/span\u003e\u003c\\/span\u003e                    Committed   DERBY-1947  -4.* as svn 531638 and resolving it. \\n             \u003c\\/div\u003e\\n        \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\u003c\\/div\u003e\\n                             \u003c\\/div\u003e\\n    \u003c\\/div\u003e\\n\"";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["scope-filter-data"]="{\"createScopeActions\":[],\"scopes\":[]}";
WRM._unparsedData["sidebar-collapsed-by-default"]="true";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:can-manage"]="false";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:with-icons"]="false";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:shortcuts"]="[]";
WRM._unparsedData["com.atlassian.jira.projects.shortcuts:project-id"]="10594";
WRM._unparsedData["sidebar-id"]="\"\u003cdiv class=\\\"aui-sidebar  projects-sidebar sidebar-pending\\\" \u003e\u003cdiv class=\\\"aui-sidebar-wrapper\\\"\u003e\u003cdiv class=\\\"aui-sidebar-body\\\"\u003e\u003cheader class=\\\"aui-page-header\\\"\u003e\u003cdiv class=\\\"aui-page-header-inner\\\"\u003e\u003cdiv class=\\\"aui-page-header-image\\\"\u003e\u003ca href=\\\"\\/jira\\/projects\\/DERBY\\/summary\\\" title=\\\"Derby\\\" class=\\\"jira-project-avatar\\\"\u003e\u003cspan class=\\\"aui-avatar aui-avatar-large aui-avatar-project\\\"\u003e\u003cspan class=\\\"aui-avatar-inner\\\"\u003e\u003cimg src=\\\"\\/jira\\/secure\\/projectavatar?pid=10594&amp;avatarId=10122\\\" alt=\\\"Derby\\\" \\/\u003e\u003c\\/span\u003e\u003c\\/span\u003e\u003cimg src=\\\"data:image\\/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI\\/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE4LjEuMSwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCINCgkgdmlld0JveD0iMCAwIDMwMCAzMDAiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDMwMCAzMDA7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxnIGlkPSJMYXllcl8yIj4NCgk8cGF0aCBzdHlsZT0iZmlsbDojRjc5MjMyOyIgZD0iTTE1MCwwQzY2LjY2NywwLDAsNjYuNjY3LDAsMTUwczY2LjY2NywxNTAsMTUwLDE1MHMxNTAtNjYuNjY3LDE1MC0xNTBTMjMzLjMzMywwLDE1MCwweg0KCQkgTTEzNi42NjcsMTc4LjMzM0wxMjUsMTkwbC00MS42NjctNDBMOTUsMTM4LjMzM2wzMC0zMEwxMzYuNjY3LDEyMGwtMzAsMzBMMTM2LjY2NywxNzguMzMzeiBNMjA1LDE2MS42NjdsLTMwLDMwTDE2My4zMzMsMTgwDQoJCWwzMC0zMGwtMzAtMzBMMTc1LDEwOC4zMzNMMjE2LjY2NywxNTBMMjA1LDE2MS42Njd6Ii8+DQo8L2c+DQo8Zz4NCgk8cG9seWdvbiBzdHlsZT0iZmlsbDojRkZGRkZGOyIgcG9pbnRzPSIxNzUsMTkxLjY2NyAyMDUsMTYxLjY2NyAyMTYuNjY3LDE1MCAxNzUsMTA4LjMzMyAxNjMuMzMzLDEyMCAxOTMuMzMzLDE1MCAxNjMuMzMzLDE4MCAJIi8+DQoJPHBvbHlnb24gc3R5bGU9ImZpbGw6I0ZGRkZGRjsiIHBvaW50cz0iMTI1LDEwOC4zMzMgOTUsMTM4LjMzMyA4My4zMzMsMTUwIDEyNSwxOTAgMTM2LjY2NywxNzguMzMzIDEwNi42NjcsMTUwIDEzNi42NjcsMTIwIAkiLz4NCjwvZz4NCjwvc3ZnPg0K\\\" alt=\\\"Icon indicating the project type\\\" class=\\\"jira-project-avatar-icon\\\" \\/\u003e\u003c\\/a\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-image --\u003e\u003cdiv class=\\\"aui-page-header-main\\\"\u003e\u003ch1\u003e\u003cdiv class=\\\"aui-group aui-group-split\\\"\u003e\u003cdiv class=\\\"aui-item project-title\\\"\u003e\u003ca href=\\\"\\/jira\\/projects\\/DERBY\\/summary\\\" title=\\\"Derby\\\"\u003eDerby\u003c\\/a\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/h1\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-main --\u003e\u003c\\/div\u003e\u003c!-- .aui-page-header-inner --\u003e\u003c\\/header\u003e\u003c!-- .aui-page-header --\u003e\u003cnav class=\\\"aui-navgroup aui-navgroup-vertical\\\"\u003e\u003cdiv class=\\\"aui-navgroup-inner sidebar-content-container\\\"\u003e\u003cdiv class=\\\"aui-sidebar-group aui-sidebar-group-tier-one\\\" data-id=\\\"sidebar-navigation-panel\\\"\u003e\u003cul class=\\\"aui-nav\\\"\u003e\u003cli class=\\\"aui-nav-selected\\\" \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/DERBY\\/issues\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-issue-navigator:sidebar-issue-navigator\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large icon-sidebar-issues\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Issues\\\"\u003eIssues\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003cli  \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/DERBY?selectedItem=com.atlassian.jira.jira-projects-plugin:report-page\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-plugin:report-page\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large agile-icon-report\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Reports\\\"\u003eReports\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003cli  \u003e\u003ca class=\\\"aui-nav-item \\\" href=\\\"\\/jira\\/projects\\/DERBY?selectedItem=com.atlassian.jira.jira-projects-plugin:components-page\\\" data-link-id=\\\"com.atlassian.jira.jira-projects-plugin:components-page\\\" \u003e\u003cspan class=\\\"aui-icon aui-icon-large icon-sidebar-components\\\"\u003e\u003c\\/span\u003e\u003cspan class=\\\"aui-nav-item-label\\\" title=\\\"Components\\\"\u003eComponents\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/li\u003e\u003c\\/ul\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/nav\u003e\u003c\\/div\u003e\u003cdiv class=\\\"aui-sidebar-footer\\\"\u003e\u003ca class=\\\"aui-button aui-button-subtle aui-sidebar-toggle aui-sidebar-footer-tipsy\\\" data-tooltip=\\\"Expand sidebar ( [ )\\\" href=\\\"#\\\"\u003e\u003cspan class=\\\"aui-icon aui-icon-small\\\"\u003e\u003c\\/span\u003e\u003c\\/a\u003e\u003c\\/div\u003e\u003c\\/div\u003e\u003c\\/div\u003e\"";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script> 
  <script type="text/javascript" src="/jira/s/d41d8cd98f00b204e9800998ecf8427e-CDN/3pgavk/76005/1c78b578e5c0e813799ab2baea47b6f7/1.0/_/download/batch/jira.webresources:bigpipe-init/jira.webresources:bigpipe-init.js" data-wrm-key="jira.webresources:bigpipe-init" data-wrm-batch-type="resource" data-initially-rendered></script> 
  <form id="jira_request_timing_info" class="dont-default-focus"> 
   <fieldset class="parameters hidden"> 
    <input type="hidden" title="jira.request.start.millis" value="1520238593509"> 
    <input type="hidden" title="jira.request.server.time" value="188"> 
    <input type="hidden" title="jira.request.id" value="509x94362456x1"> 
    <input type="hidden" title="jira.session.expiry.time" value="-"> 
    <input type="hidden" title="jira.session.expiry.in.mins" value="-"> 
    <input id="jiraConcurrentRequests" type="hidden" name="jira.request.concurrent.requests" value="2"> 
    <input type="hidden" title="db.reads.time.in.ms" value="29"> 
    <input type="hidden" title="db.conns.time.in.ms" value="34"> 
   </fieldset> 
  </form> 
  <!--
	                 REQUEST ID : 509x94362456x1
	          REQUEST TIMESTAMP : [05/Mar/2018:08:29:53 +0000]
	               REQUEST TIME : 0.1880
	                 ASESSIONID : -
	        CONCURRENT REQUESTS : 2

	                      db.reads : OpSnapshot{name='db.reads', invocationCount=21, elapsedTotal=29354079, elapsedMin=443889, elapsedMax=16718840, resultSetSize=0, cpuTotal=0, cpuMin=0, cpuMax=0}
	                      db.conns : OpSnapshot{name='db.conns', invocationCount=25, elapsedTotal=34901067, elapsedMin=473003, elapsedMax=16753163, resultSetSize=0, cpuTotal=0, cpuMin=0, cpuMax=0}
-->   
 </body>
</html>